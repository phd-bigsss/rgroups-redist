---
title: "Network segregation, Social Isolation and Preference for Redistribution across societies"
css: "input/css/custom.css" # custom CSS para html
linestretch: '1.5'          # interlineado 
link-citations: yes         # citas linkeadas
# date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
date: "`r format(Sys.Date(), '%d %B %Y')`"
author:
# - name: Julio Iturra-Sanhueza
#   affiliation: University of Bremen
#   email: jiturra@uni-bremen.de
#   number: 1
# - name: Justin d'Ottawa
#   affiliation: University of Ottawa
#   number: 2
# - name: Pedro Torres
#   number: 1,2 
# Nota: Autores que comparten filiacion, poner el mismo number y declarar filiación una sola vez.  
# abstract: "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do *eiusmod tempor* incididunt ut labore et dolore magna aliqua. Ut enimad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat."
output:
  bookdown::html_document2:
    toc: yes
    code_folding: hide
    toc_float: 
      collapsed: true
      smooth_scroll: false
      number_sections: false    
  bookdown::pdf_document2:
    template: null
    toc: false
    keep_tex: false
    pandoc_args:
      - --template=input/mytemplate.tex #custom template para usar autores con afiliacion  
linkcolor: blue                         # enlaces y citas en color azul
bibliography: input/bib/library.bib     # bibliografia en bibtex
editor_options:
  chunk_output_type: console            # en RStudio, mostrar output en consola
geometry: "left=2cm,right=2cm,top=3cm,bottom=3cm" # márgenes de página
header-includes:
  - \usepackage{times}           # Times New Roman
  - \usepackage{caption}
  - \captionsetup[figure, table]{labelfont={bf},labelformat={default},labelsep=period}
  - \usepackage{graphicx}
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
---

- considerar ISEI08 como alternativa de social class
- darle una oportunidad al h-index


```{r setup, include=FALSE}
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(knitr, kableExtra, dplyr, ggplot2,sjmisc,texreg) # librerias
knitr::opts_chunk$set(warning = FALSE,  # mensaje de warning
                      message = FALSE,  # mensajes/avisos de librerias  
                      cache = TRUE,    # cache de los chunks,usar analisis pesados
                      out.width = '100%',
                      fig.pos= "H",     # posicion figuras H = HERE
                      fig.align = "center",
                      echo = FALSE      # incluir chunk en output
                      )
options(scipen=999) # notacion cientifica
rm(list=ls())       # limpiar workspace
options(knitr.kable.NA = '') # NA en kable = ''
```
#  Introduction

The escalating economic inequality and the current sanitary crisis have threatened social cohesion among citizens. However, these consequences have been unevenly experienced across the social structure. The upper and intermediate classes, benefiting from privileged access to social resources, have shown resilience. Conversely, working-class families have faced deteriorating material conditions, leading to a heightened sense of marginalisation and increasing the demand for welfare support. Particularly, social resources through network ties have been suggested to have a direct link with an individual’s welfare through instrumental and expressive outcomes, such as providing information or help in moments of need. Consequently, inequalities in access to certain social positions (i.e. occupations) are translated into a lack of social resources beyond individual economic and cultural capital. Additionally, it has been argued that social isolation not only plays a role in terms of resources but given that higher levels of segregation can bolster opinions, it is argued that being isolated from other social classes can polarise attitudes mainly in the working and upper-middle classes. Employing data from the International Social Survey Programme - Social Networks  this research aims to understand to what extent the demand for redistribution is linked to social ties. For addresing this, ego-centred social networks are used to represent the degree of class-based homogeneity of social ties. The results of multilevel estimations show that being socially segregated increases demand for redistribution. Additionally, this influence is conditional to social class, where the working and intermediate classes with highly homogeneous networks demand more governmental redistribution than the upper class. At the macro level, as the current distribution of economic resources influences the opportunity structure, it has been hypothesised that income inequality could bolster the influence of social segregation on the demand for redistribution. However, cross-level interactions do not provide supporting evidence on this behalf. 

<!-- The structure of the social network provide access to social resources. On the one hand, contacts can be translated into resources, access to the life of others that could provide information and life opportunities.  -->

<!-- - stratified access to resources -->
<!-- - class and networks (focus of this paper) -->

<!-- Some research has connected social capital with economic rational dimension, while others have conected it to more value-driven or moralistic dimension  -->

<!-- Both assume direct effects, but other literature such as Otero et al has suggested that experiences might vary across social classes. -->

<!-- For example, we trust other people because we know about them (connected) -->


# Data, variables and methods

*Data* 

*Variables*

Homogeneity: 

Thus, an EI score of 1 means complete homophily- the individual only has relationships with actors of the same “type” as they themselves are. An EI score of -1 means complete heterophily- all the alters are of a different “type” than they themselves are. Finally, an EI score of 0 means that an equal number of alters are of both the same “type” as the ego, and different types.





*Methods*

<!-- Across all countries, a nurse (41.2%) and a schoolteacher (39.6%) are mentioned the most often and a human resource manager (19.2%) and a lawyer (22.2%) the least often. Considering the scope of the network, Suriname (42%), the United States (41.4%), and Iceland (41.3%) are the countries in which respondents are connected to the widest array of occupations, while Thailand (13.2%), Japan (15%), and Taiwan (18.9%) represent the other end. The social network thus is larger and more diverse in the former countries -->

# Results

## Descriptive


```{r redistribution,fig.height=5,fig.width=8,fig.cap=c("Redistributive preferences by country in the ISSP 2017"), out.width = '80%'}
# x country
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
# df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
df1$redistF <- factor(df1$redist,levels = 1:5,labels = sjlabelled::get_labels(df1$redist))
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()

percentage_data <- df1 %>%
  group_by(country2, redistF) %>%
  summarise(count = n()) %>%
  group_by(country2) %>%
  na.omit() %>% 
  mutate(percentage = count / sum(count)) %>% 
  arrange(country2,redistF,percentage) %>% 
  mutate(pct_lab = paste0(round(percentage*100,1),"%")) %>% 
  mutate(pct_lab=ifelse(!redistF %in% c("Strongly agree"),NA,pct_lab))

order <- 
percentage_data %>% 
  filter(redistF=="Strongly agree") %>% 
  arrange(percentage) %>% 
  dplyr::select(country2)

order$orden <- 1:31
ggplot(percentage_data, aes(x=country2,y=percentage*100,fill=redistF,group=redistF,label = pct_lab))+
  geom_bar(stat = 'identity') +
  # geom_text(position = position_fill(vjust =100)) +
  scale_y_continuous(name=NULL,labels = scales::percent_format(scale = 1),limits = c(0,101), expand = c(0, 0)) +
  scale_x_discrete(limits=order$country2,name=NULL) +  
  scale_fill_ordinal(guide = guide_legend(reverse = TRUE)) +
  theme_classic() +
  ggtitle(label= "REdistributive preferences") + 
  theme(legend.position = 'bottom',legend.title = element_blank())  +
  coord_flip()
```

```{r homogeneity,fig.height=4,fig.width=8,fig.cap=c("Class-based network homogeneity by country in the ISSP 2017"), out.width = '90%'}
# x country
dfreg <- bind_cols(dfreg,sjmisc::to_dummy(x = dfreg$class3,suffix = "numeric"))
resits_count <- dfreg %>%
  group_by(country2,country) %>%
  summarise_at(c("redist","homclass",
                 "class3_1","class3_2","class3_3"), mean, na.rm = TRUE) %>% 
  as.data.frame()
resits_count$country3 <- countrycode::countrycode(sourcevar = resits_count$country,origin = "iso3n",destination = "iso3c")

myorder <-  resits_count$country2[order(resits_count$homclass)]
ggplot(data = resits_count,aes(x =country2,y = homclass)) + 
  geom_segment(aes(x=country2, xend=country2, y=0, yend=homclass), color="black") +
  geom_point() +
  scale_x_discrete(limits=myorder) +
  ylab("Class-based homogeneity")+
  xlab("") +
  theme(axis.text.x = element_text(angle = 45))
```

```{r class-hom,fig.height=11,fig.width=11,fig.cap=c("Redistribution, Network homogeneity and Social Class in the ISSP 2017"), out.width = '100%'}
predis <- 
resits_count %>%  
ggplot(aes(y=redist, x=homclass)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3)) +
  # scale_x_continuous(limits = c(0.3,0.5))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Class homogeneity")+
  ylab("Redistributive preferences") +
  labs(title = "Redistributive preferences and Class homogeneity",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$redist),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$redist)


p1 <- resits_count %>%  
ggplot(aes(y=homclass, x=class3_3)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Working class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Working class (%)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$class3_3),digits = 2),""))

# cor.test(resits_count$homclass,resits_count$class3_3)

p2 <- resits_count %>%  
ggplot(aes(y=homclass, x=class3_2)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Intermediate class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Intermediate class (%)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$class3_2),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$class3_2)
p3 <- resits_count %>%  
ggplot(aes(y=homclass, x=class3_1)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Service class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Service class (%)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$class3_1),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$class3_3)
grid.arrange(predis,p1,p2,p3,nrow = 2,top = "Network homogeneity × Social Class")
```


<!-- - perceived isolation x redistribution (1 plot) -->
<!-- - homogeneity x perceived isolation (1 plot) -->

## Individual level

1. Class: 
    - having a working class position is associated with higher redistributive preferences
    - class homogeneity is higher among the working class, and lower in the upper-class

2. Network segregation
    - being more segregated increase redistributive preferences

<!-- - Perceived isolation -->
<!--   - perceived isolation increases redistributive preferences -->
  
<!-- Note: network segregation decreases perceived isolation *   -->

3. Network segregation x Social Class
    - The influence of homogeneity is positive among the working and intermediate classes, and negative among the upper class 
    

```{r microlevel,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
df1$eindex2<- (df1$ingroup-df1$outgroup)/(df1$outgroup+df1$ingroup)

dfreg <- df1 %>% dplyr::select(redist,
                        class3,class5,
                        homclass,
                        Q05pcm,
                        Q03pcm,
                        # isei08,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

```{r marg1,fig.dim=c(4.1,2.6),fig.cap=c("Conditional marginal effects of Network homogeneity on redistributive preferences"),out.width = "50%"}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
# Conditional Marginal effect
interplot <- 
interplot::interplot(m = int_homo,var1 = "homclass",var2="class3")
df_int <- interplot$data
df_int <- df_int[c(1,2,4),]
df_int$value <- c("Intermediate class (III+IV)","Service Class (I+II)","Working Class (V+VI+VII)")
df_int$value <- factor(df_int$value,ordered = T,
                       levels = c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)"))

df_int %>% 
ggplot() +
  geom_point(aes(x = value,y = coef1)) + 
  geom_errorbar(aes(x = value, ymin = lb, ymax = ub),color="black",width=0.1,size=1) +
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  ylab("Class-based homogeneity")+
  xlab("Social Class")+
  ggtitle("Redistributive preferences") +
  geom_hline(yintercept = 0) + 
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +    
  theme_minimal()+
  theme(plot.title = element_text(size = 8))  
```

```{r pred1,fig.height=3.6,fig.width=5.7,fig.cap=c("Predictions for Redistributive Preferences"),out.width = '50%'}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)       
# Predicted values 
pred1<- sjPlot::plot_model(int_homo,type = "pred",terms = c("homclass [0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1]","class3"))
pred_data <- data.frame(pred1$data)
pred_data <- pred_data %>% arrange(pred_data$group)
pred_data$group <- factor(pred_data$group,ordered = T,
                       levels = c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)"))

pred_data %>% 
ggplot() +
  geom_point(aes(x = x,y = predicted)) +
  geom_line(aes(x = x,y = predicted))+
  geom_errorbar(aes(x = x, ymin = conf.low, ymax = conf.high),color="black",width=0.05,size=1) +
  facet_grid(. ~ group) +
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") + 
  theme_minimal()
```


\pagebreak
## Macro level

  - expected: economic inequality increases segregation (maybe weak or null effect)
  - expected: economic inequality increase the influence of network homogeneity
  
```{r ineq-homo,fig.height=5,fig.width=10,fig.cap=c("Network Homogeneity and Income Inequality in the ISSP 2017"), out.width = '100%'}
resits_count <- dfreg %>%
  group_by(country2,country) %>%
  summarise_at(c("redist","homclass",
                 "gini_disp","gini_mkt"), mean, na.rm = TRUE) %>% 
  as.data.frame()
resits_count$country3 <- countrycode::countrycode(sourcevar = resits_count$country,origin = "iso3n",destination = "iso3c")
p1 <- resits_count %>%  
ggplot(aes(y=homclass, x=gini_disp)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Gini (Disposable)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Income Inequality (Disposable)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$gini_disp),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$gini_disp)
p2 <- resits_count %>%  
ggplot(aes(y=homclass, x=gini_mkt)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Gini (Market)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Income Inequality (Market)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$gini_mkt),digits = 2),""))

# cor.test(resits_count$homclass,resits_count$class3_3)
grid.arrange(p1,p2,nrow = 1,top = "Network homogeneity and Economic Inequality")
```

  <!-- - expected: in unequal countries the effect of network segregation and perceived isolation will be stronger  -->

```{r intermacro,results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")


dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        labst,
                        labst1) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# T03dim(dfreg)

main <- "redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2"

giniD_gdp<-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(1|country2)")),data=dfreg)
giniD_rs <-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(homclass|country2)")),data=dfreg)
# anova(giniD_gdp,giniD_rs)
giniD_int<- lmer(formula(paste0(main,"+homclass*gini_disp+logrgdpna","+(homclass|country2)")),data=dfreg)
# summary(giniD_int)

giniM_gdp<- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1|country2),data=dfreg)
giniM_rs<- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+homclass|country2),data=dfreg)
# anova(giniM_gdp,giniM_rs)
giniM_int <- lmer(redist~class3+ homclass*gini_mkt+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+homclass|country2),data=dfreg)

models <- list(giniD_gdp,giniD_rs,giniD_int,
               giniM_gdp,giniM_rs,giniM_int)

texreg::knitreg(models,
                caption=paste("(\\#tab:modinter1)","Cross-level interaction for Network homogeneity and Economic Inequality"),
                caption.above=T,
                  # include.thresholds=FALSE,
                  custom.coef.map=list(logrgdpna="log GDP","gini_disp"="Gini (Disposable) ",
                                       "homclass:gini_disp"="Homogeneity x Gini (D)",
                                       "gini_mkt"="Gini (Market) ",
                                       "homclass:gini_mkt"="Homogeneity x Gini (M)"),
                  # groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r crosslevel}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,gridExtra)  
p1<- interplot::interplot(m = giniD_int,var1 = "homclass",var2="gini_disp")+
  ylab("Class-based homogeneity coefficient")+ xlab("Gini disposable") +
  geom_point()+ geom_hline(yintercept = 0)

p2<- interplot::interplot(m = giniM_int,var1 = "homclass",var2="gini_mkt") +
  xlab("Gini market") +geom_point()+ geom_hline(yintercept = 0)

# Predicted values 
pred1<- plot_model(giniD_int,type = "int", mdrt.values = "meansd")
pred_data <- data.frame(pred1$data)
pred_data <- pred_data %>% arrange(pred_data$group)

predval1 <- 
pred_data %>% 
ggplot() +
  geom_point(aes(x = x,y = predicted)) +
  geom_line(aes(x = x,y = predicted))+
  geom_errorbar(aes(x = x, ymin = conf.low, ymax = conf.high),color="black",width=0.05,size=1) +
  facet_grid(. ~ group) +
  labs(caption = paste0("N=",nobs(giniD_int),", Countries=",lme4::ngrps(giniD_int))) +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") + 
  theme_minimal()

# Predicted values 
pred1<- plot_model(giniM_int,type = "int", mdrt.values = "meansd")
pred_data <- data.frame(pred1$data)
pred_data <- pred_data %>% arrange(pred_data$group)

predval2 <- 
pred_data %>% 
ggplot() +
  geom_point(aes(x = x,y = predicted)) +
  geom_line(aes(x = x,y = predicted))+
  geom_errorbar(aes(x = x, ymin = conf.low, ymax = conf.high),color="black",width=0.05,size=1) +
  facet_grid(. ~ group) +
  labs(caption = paste0("N=",nobs(giniD_int),", Countries=",lme4::ngrps(giniD_int))) +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") + 
  theme_minimal()
```

```{r crossginiD, fig.height=5,fig.width=12,fig.cap=c("Cross-level interaction for Network homogeneity and Economic Inequality I")}
grid.arrange(p1,predval1,nrow = 1,top = "Network homogeneity × Gini (Disposable)")
```

```{r crossginiM, fig.height=5,fig.width=12,fig.cap=c("Cross-level interaction for Network homogeneity and Economic Inequality II")}
grid.arrange(p2,predval2,nrow = 1,top = "Network homogeneity × Gini (Market)")
```

\pagebreak
# Other analysis

- strong ties
- weak ties
- R's data only

```{r strongties,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_s,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~isei08+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity (strong) and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

```{r weakties,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_w,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity (weak) and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

```{r ownclass, cache=TRUE, results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$class3spo <- relevel(df1$class3spo,ref =  "Intermediate class (III+IV)")

df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3=class3res,
                        class3spo,
                        # homclass,
                        homclass=homclass_res,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+ (1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
rob4 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ class3spo +(1|country2),data=dfreg)

# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ class3spo +(1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and Own social class " 
coefmap <-  list(homclass ="Class-based network homogeneity - Resp.",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class',
                 'class3spoService Class (I+II)' ='Service Class (Partner)',
                 "class3spoWorking Class (V+VI+VII)"='Working Class (Partner)'
                
                 )
coefgroup <- list("Social Class - Resp. (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,rob4,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```
