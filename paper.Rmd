---
title: "Network segregation and Preferences for Redistribution across societies"
css: "input/css/custom.css" # custom CSS para html
linestretch: '1.5'          # interlineado 
link-citations: yes         # citas linkeadas
# date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
date: "`r format(Sys.Date(), '%d %B %Y')`"
author:
- name: Julio Iturra-Sanhueza
- name: Julio Iturra-Sanhueza
#   affiliation: University of Bremen
#   email: jiturra@uni-bremen.de
#   number: 1
# - name: Justin d'Ottawa
#   affiliation: University of Ottawa
#   number: 2
# - name: Pedro Torres
#   number: 1,2 
# Nota: Autores que comparten filiacion, poner el mismo number y declarar filiación una sola vez.  
abstract: |
 The escalating economic inequality and the current sanitary crisis have threatened social cohesion among citizens. However, these consequences have been unevenly experienced across the social structure. The upper and intermediate classes, benefiting from privileged access to social resources, have shown resilience. Conversely, working-class families have faced deteriorating material conditions, leading to a heightened sense of marginalisation and increasing the demand for welfare support. Particularly, social resources through network ties have been suggested to have a direct link with an individual’s welfare through instrumental and expressive outcomes, such as providing information or help in moments of need. Consequently, inequalities in access to certain social positions (i.e. occupations) are translated into a lack of social resources beyond individual economic and cultural capital. Additionally, it has been argued that social isolation not only plays a role in terms of resources but given that higher levels of segregation can bolster opinions, it is argued that being isolated from other social classes can polarise attitudes mainly in the working and upper-middle classes. Employing data from the International Social Survey Programme - Social Networks  this research aims to understand to what extent the demand for redistribution is linked to social ties. To addresss this, ego-centred social networks are used to represent the degree of class-based homogeneity of social ties. The results of multilevel estimations show that being socially segregated increases demand for redistribution. Additionally, this influence is conditional to social class, where the working and intermediate classes with highly homogeneous networks demand more governmental redistribution than the upper class. At the macro level, as the current distribution of economic resources influences the opportunity structure, it has been hypothesised that income inequality could bolster the influence of social segregation on the demand for redistribution. However, cross-level interactions do not provide supporting evidence on this behalf. 

   **Keywords**: network segregation, redistributive preferences, economic inequality 
output:
  bookdown::pdf_document2:
    template: null
    toc: false
    keep_tex: false
    pandoc_args:
      - --template=input/mytemplate.tex #custom template para usar autores con afiliacion  
  bookdown::html_document2:
    toc: yes
    code_folding: hide
    toc_float:
      collapsed: false
      smooth_scroll: false
    number_sections: false   
always_allow_html: true      
linkcolor: blue                         # enlaces y citas en color azul
bibliography: input/bib/rgroup-redist.bib     # bibliografia en bibtex
csl: input/bib/apa6.csl
editor_options:
  chunk_output_type: console            # en RStudio, mostrar output en consola
geometry: "left=2cm,right=2cm,top=3cm,bottom=3cm" # márgenes de página
header-includes:
  - \usepackage{times}           # Times New Roman
  - \usepackage{caption}
  - \captionsetup[figure, table]{labelfont={bf},labelformat={default},labelsep=period}
  - \usepackage{graphicx}
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
---

```{r eval=FALSE, include=FALSE}
 # for render in pdf run rmarkdown::render_site("docs/paper.Rmd", output_format = "all")
 # clean #in the yml
 rmarkdown::render("paper.Rmd", output_format = "bookdown::pdf_document2")
 rmarkdown::render("paper.Rmd", output_format = "bookdown::html_document2")
 rmarkdown::render("paper.Rmd", output_format = "bookdown::word_document2")
```


<!-- - considerar ISEI08 como alternativa de social class por la correlacion con homogeneidad -->
<!-- - darle una oportunidad al h-index -->
<!--     - en general es prácticamente lo mismo que el indicador de homogeneidad -->
<!-- - controlaria por social activities index () -->
<!-- - social resources  -->
    
```{r setup, include=FALSE}
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(knitr, kableExtra, dplyr, ggplot2,sjmisc,texreg) # librerias
knitr::opts_chunk$set(warning = FALSE,  # mensaje de warning
                      message = FALSE,  # mensajes/avisos de librerias  
                      cache = F,    # cache de los chunks,usar analisis pesados
                      out.width = '100%',
                      fig.pos= "H",     # posicion figuras H = HERE
                      fig.align = "center",
                      echo = FALSE      # incluir chunk en output
                      )
options(scipen=999) # notacion cientifica
rm(list=ls())       # limpiar workspace
options(knitr.kable.NA = '') # NA en kable = ''
```

```{r}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(theme_minimal())
ggplot2::theme_update(text=element_text(size=10,  family="serif"))  
```


```{r}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(theme_minimal())
ggplot2::theme_update(text=element_text(size=10,  family="serif"))  
```

#  Introduction

The escalating economic inequality and the current sanitary crisis have threatened social cohesion among citizens. However, these consequences have been unevenly experienced across the social structure. The upper and intermediate classes, benefiting from privileged access to social resources, have shown resilience. Conversely, working-class families have faced deteriorating material conditions, leading to a heightened sense of marginalisation and increasing the demand for welfare support. Particularly, social resources through network ties have been suggested to have a direct link with an individual’s welfare through instrumental and expressive outcomes, such as providing information or help in moments of need. Consequently, inequalities in access to certain social positions (i.e. occupations) are translated into a lack of social resources beyond individual economic and cultural capital. Additionally, it has been argued that social isolation not only plays a role in terms of resources but given that higher levels of segregation can bolster opinions, it is argued that being isolated from other social classes can polarise attitudes mainly in the working and upper-middle classes. Employing data from the International Social Survey Programme - Social Networks  this research aims to understand to what extent the demand for redistribution is linked to social ties. To addresss this, ego-centred social networks are used to represent the degree of class-based homogeneity of social ties. The results of multilevel estimations show that being socially segregated increases demand for redistribution. Additionally, this influence is conditional to social class, where the working and intermediate classes with highly homogeneous networks demand more governmental redistribution than the upper class. At the macro level, as the current distribution of economic resources influences the opportunity structure, it has been hypothesised that income inequality could bolster the influence of social segregation on the demand for redistribution. However, cross-level interactions do not provide supporting evidence on this behalf. 

<!-- * network segregation decreases  attachment to society (Otero et al., 2022)  -->


<!-- * subjective marginalization increases alienation (Gidron & Hall, 2020) -->


<!-- * social ties with lower or upper class influence welfare attitudes aligned to class interests (Paskov & Weisstanner, 2022; Lindh et al., 2021)  -->


<!-- Focus on the sociability/relational dimension and its consequences on inequality attitudes - redistributive and welfare attitudes -->

<!-- The literature review (possible structure) -->

<!-- * Class and political attitudes (Svallfors, Edlund & Lindh) -->
<!-- * Inequality in social networks (Lin, Wright, Bourdieu, Volker) -->
<!-- * Interplay of class, networks and attitudes toward inequality (Lindh, McCall)  -->

<!-- The literature have discussed two complementary social mechanisms that could explain what role does social ties play in shaping people's demand for redistribution.  -->

## Class interests and redistribution

The following paragraph will briefly present the class-preference link. While previous research have focus more extensevely on the economic dimension of social class such as employment relations and occupation, the focus of this research is idea  to argue that the patterns of social interactions (social ties) are also a constituent dimension of how classes shape their interests.    

- The "Democratic" class struggle [@edlund_democratic_2015]

- Class interests in the economic domain [@lindh_class_2020]
- The moral economy of class - the attitudinal domain of redistribution and the role of the state [@Svallfors2006]

<!-- en paises donde el bienestar material a incrementado y las diferencias entre las clases ha disminuido se espera que el conflicto distributivo sea menor.  

se cree que en lops paises escandinavos con un estado de bienestar mas desarrollado la hipotesis debiese ser mas valida que en paises anglosajones  

Hi: la desigualdad o distancia entre grupos
Hi: el tamagno del wlefare state
-->

## Class-based inequality in social networks


This section will review the state of the art on the link between class/status and social networks, particularly the existing literature on the different forms of social capital. 

Recent studies have focused on social capital formation processes [@volker_social_2020], concentrating on structural processes, such as intergenerational social mobility and class inequalities, demonstrating how meeting opportunities and association preferences are stratified [@lin_theory_2008]. Consequently, access to higher and diverse resources through social ties follows a pattern of accumulation that reproduces pre-existing inequalities, in which class positions are vital in accounting for mechanisms of exclusion and segregation across the class structure.

According to Weber [-@weber_economy_1978], classes are a common basis for action, defined by the labour market position and access to opportunities and goods. Additionally, the degree of intergenerational exchange leads to the development of social classes, characterised by the reproduction of socialisation patterns and lifestyles over time. Therefore, marriages, friendships, and social relationships between individuals of similar status groups represent class sociability practices. Similarly, two processes are described in class formation [@goldthorpe_sobre_1992]. First, demographic identity refers to when classes become identifiable as collectivities regarding how individuals and families retain their class positions across generations. Second, cultural identity is expressed in distinctive shared lifestyles along with preferred patterns of association, which class members perform. As Bourdieu [-@bourdieu_distinction_1984] suggested, cultural capital is the pivotal attribute of these distinctive practices in class *habitus*, in which educational credentials represent the most salient cultural resources [@bourdieu_distinction_1984]. Hence, the socialisation of common lifestyles and shared worldviews facilitates the consolidation of social classes. Moreover, upper classes also choose socially segregated environments, increasing their chances of establishing ties with similar others, maintaining privileged social positions, and excluding lower classes [@bourdieu_reproduccion_1981]. Altogether, these processes further reinforce social distinctions between classes and contribute to the persistence of class structures.

Class-based research shows that class permeability is affected by property-based boundaries, in which owners are less likely to connect to the working class through friendship ties, whereas interactions between supervisors and workers might explain why the authority dimension is more permeable [@wright_relative_1992a]. Similarly, extended network diversity is lower in the upper-middle class than in the intermediate class, whereas friendship diversity increases for upwardly mobile individuals [@cepic_how_2020]. However, the gain for this group is moderated by class background, where upward mobility cannot equalise access to social capital compared to those stable in the upper class [@carrascosa_class_2023]. Moreover, the distribution of ties between the two extremes of the class structure depicts the higher permeability of intermediate classes, in contrast to the higher exclusion of the working class and self-selected upper-class homogenous networks [@otero_open_2021]. Additionally, engagement in formal organisations increases the chances of the upper class bridging with diverse people, while the working class is homogeneous in their civic engagement behaviour, limiting its access to social capital [@pichler_social_2009]. This tendency is strengthened over time, where social capital increases for those with higher education compared to those with less education [@volker_social_2020].

## Social ties on the demand for redistribution and welfare

This section will focus on the link between social ties and attitude formation in the economic domain. Also, it will address neighbouring evidence that could support the argument. At this point, at least two mechanisms are discussed in the literature. The first one is social influence or socialization mechanism. The second one is attitude polarization as a result of network segregation. 

<!-- Following Lin's approach to the role fo social ties, these are understood as resources that provide opportunities for action. Therefore, lacking of them can be interpreted as lower resources. Homogeneity in terms of social ties could represent the concentration of high-resource social ties, in the case of the upper-classes, and the opposite in the case of the lower-classes. -->

As mentioned above, social networks influence people's experience of social life, self-evaluations, and the surrounding social and economic conditions. Notably, it has been shown that social perceptions of economic inequality influence their preferences towards it. However, it is less known about how the composition and resources embedded in social networks influence what people prefer in terms of economic inequality, mainly what are their views regarding the role of government in terms of social policy measures, which in turn are expressed in demands for economic redistribution and social welfare. Despite this, some insights in the literature highlight the role of social networks on redistributive preferences by describing the impact of civic engagement in voluntary organisations, cross-class embeddedness through kinship and friendship ties, and socioeconomic network diversity.

As mentioned, the literature has previously addressed efforts to address the link between social networks and redistributive preferences. For example, a study in Japan by @yamamura_social_2012 argued that participation in community organisations boosts connections among different income groups. Consequently, contact might trigger envy from the poorer groups toward the wealthy, suggesting that negative externalities like unhappiness and crime rates will motivate altruistic behaviour, showing that the highest community participation rates increase support for redistribution for those above the median income of each prefecture. Also, research has focused on class-based networks, particularly how embeddedness in cross-class relationships influences attitudes through a synthetic scope that entails class material interests, socio-cultural or normative views, and political preferences [@lindh_class_2020]. Hence, the discussion regarding how social class and network segregation intersect for explaining attitudes can be summarised in two mechanisms: (i) social influence and (ii) socialisation processes.

@lindh_missing_2021 scrutinised how social influence and class segregation affect redistributive and social welfare preferences in Sweden, arguing that people tend to assimilate their opinions and attitudes according to their surrounding peers (*influence*), which is reinforced by class homophily (*segregation*). Therefore, higher contacts in the managerial class negatively impact redistributive demands, while ties to the working class increase them. Additionally, contact with socio-cultural professionals that entail more inclusive and egalitarian attitudes lowers welfare chauvinism, while it rises with working-class ties that might perceive immigrants as a threat. Similarly, aside from the current class position, additional socialisation sources are cross-class ties through the family of origin and partners. For instance, @lee_consider_2023 found that family of origin class position shapes economic redistributive and tax preferences, being crucial for political socialisation during childhood and early adulthood, where class interests and norms are nurtured. As a result, those with parents from the upper classes are less supportive of redistribution, while those having working-class origins hold favourable attitudes. Also,  @paskov_crossclass_2022 found that the class position of family and partners shapes redistributive preferences, where kinship ties are considered a source of inter-group contact, suggesting that heterogeneity in class ties can reduce negative prejudges toward out groups as contact theory suggests [@pettigrew_intergroup_1998], what in turn might motivate changes in political attitudes [@nathan_context_2023]. As a result, homogeneity in ties polarises preferences between lower and upper classes. However, this gradient is blurred as heterogeneity increases according to the class position of the partner and family of origin.

Friendship ties are also relevant in preference formation. In this regard, @londono-velez_impact_2022 suggests that socioeconomic diversity at the school level introduces changes in friendship ties that influence (i) perceived inequality and (ii) support for redistribution in affluent students, claiming that homogeneous networks restrict economic inequality inferences. Therefore, exposure to diverse reference groups (e.g. friends) influences redistributive demands via self-interest, mobility prospects and distributive justice. On the one hand, contrary to self-interest, redistributive preferences increase when exposure to low-income peers improves accuracy in perceived inequality. On the other hand, heterogeneity has a null effect on mobility prospects. Finally, heterogeneity triggers concerns about the fairness of market-based life outcomes for low-income students, motivating higher support for government intervention. Similarly, @beck_explorando_2019 demonstrate that occupational network heterogeneity diminishes preferences for the marketisation of welfare provision in Chile, suggesting that contact diversity shortens the social distance between low and upper-status groups, providing them with broader images of inequality and the living conditions of others.

The literature on social networks and inequality preferences makes two major contributions. First, it comprises the social influence and socialisation processes in social networks, where segregation entails a certain degree of social closure regarding others' life experiences and living conditions. In addition, heterogeneity provides a broader image of society in terms of social and economic inequality, contributing to preference formation. Consequently, studying preferences toward economic inequality from a social network perspective goes beyond the individual perspective by including the relational dimension. Hence, considering the degree of embeddedness of people in a network provides a more explicit image of how social environments are composed and of the social distance between individuals and groups.


<!-- The structure of the social network provide access to social resources. On the one hand, contacts can be translated into resources, access to the life of others that could provide information and life opportunities.  -->

<!-- - stratified access to resources -->
<!-- - class and networks (focus of this paper) -->

<!-- Some research has connected social capital with economic rational dimension, while others have conected it to more value-driven or moralistic dimension  -->

<!-- Both assume direct effects, but other literature such as Otero et al has suggested that experiences might vary across social classes. -->

<!-- For example, we trust other people because we know about them (connected) -->

\pagebreak

# Data, variables and methods

**Data**

International Social Survey - Social Networks 2017 


**Variables**

_Redistributive preferences_

A widely used method for evaluating people's views on redistribution is by employing a standard measure commonly found in the literature. The measure involves asking respondents to indicate their level of agreement with the statement, "It is the responsibility of the government to decrease the income gap between individuals with high and low incomes." Respondents are asked to indicate their level of agreement on a scale of one to five, with one being "Strongly agree" and five being "Strongly disagree." In this case, a reverse code is utilized to interpret higher values as indicating greater support for redistribution.

_Social Class_

A synthetic version of the EGP class was used, including three main classes: Service class (I+II), Intermediate class (III+IV) and Working class (V+VI+VII)

<!-- -  in this research the *unit* for class is assumed as the family unit.  -->

_Class-based network homogeneity_

For measuring the personal network of the respondent, a short version of the position generator was included in the survey, which presents a set of ten occupations that seek to represent the hierarchical status order in society [@joye_measuring_2019], declaring four possible response alternatives: "Family or relative", "Close friend", "Someone else I know" or "No one". For this research, a binary variable is created by coding the first three categories as 1 and the last one as 0, representing if the person knows (or not) one of the occupations. The following text corresponds to the original phrasing of the questionnaire:  

> *Here is a list of jobs that people you know may have. These people could be family or relatives, close friends or someone else you know. By "knowing" a person, we mean that you know him/her by name and well enough to contact him/her. If you know several people who have a job from the list below, please only tick the box for the person who you feel closest to. Each of these jobs could be held by a woman or a man.*

Therefore, Table \@ref(tab:posgen) shows the classification of each occupation into three status groups according to their scores in the International Socioeconomic Index (ISEI)[@ganzeboom_internationally_1996].  

```{r posgen}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,knitr,kableExtra)
rm(list=ls())
options(knitr.kable.NA = '') # NA en kable = ''
cap <- "Clasification of occupations of the position generator in the ISSP 2017"
read.csv(file = "input/tables/tables.csv") %>% 
  kable(caption = cap,booktabs = T,col.names = c("Status","Occupation","ISEI")) %>% 
  kable_styling(full_width = F,latex_options = "HOLD_position") 
```

Consequently, we calculate the number of contacts that belong to a similar class/status to create the number of ingroup and outgroup contacts. It is considered ingroup (i) when the ego's class matches the Alter's status. This measure represents the proportion of similar contacts, where 0 implies that all contacts are different to Ego's social class, while 1 represents complete network homogeneity. Therefore, higher values represent greater social distance from other groups in society. The calculation of the class-based network homogeneity variables is as follows:  

$$H_i= \frac{\text{Ingroup}}{(\text{Ingroup}+\text{Outgroup})}$$ 

_Perceived Isolation_ 

"The next questions are about how you feel about different aspects of your life. For each one, please indicate how often during the past 4 weeks you have felt that way. How often in the past 4 weeks have you felt that..." 1) "companionship lacking?",(2) "isolated from others?" and (3) "left out?". 

The response categories are  (1)"Never", (2)"Rarely", (3) "Sometimes", (4)"Often" and  (5)"Very often". As the indicators show an acceptable internal consistency ($\alpha$=.85), an index of the three items was created. Positive values indicate higher perceived isolation. 

**Methods**

- Multilevel regression with random intercept and slopes 

<!-- Across all countries, a nurse (41.2%) and a schoolteacher (39.6%) are mentioned the most often and a human resource manager (19.2%) and a lawyer (22.2%) the least often. Considering the scope of the network, Suriname (42%), the United States (41.4%), and Iceland (41.3%) are the countries in which respondents are connected to the widest array of occupations, while Thailand (13.2%), Japan (15%), and Taiwan (18.9%) represent the other end. The social network thus is larger and more diverse in the former countries -->

# Results

## Descriptive

```{r homogeneity,fig.height=3.4,fig.width=6,fig.cap=c("Class-based network homogeneity by country in the ISSP 2017"), out.width = '100%'}
# x country   
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist,
                        class3, 
                        homclass,
                        # homclass=eindex,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# x country
dfreg <- bind_cols(dfreg,sjmisc::to_dummy(x = dfreg$class3,suffix = "numeric"))
resits_count <- dfreg %>%
  group_by(country2,country) %>%
  summarise_at(c("redist","homclass",
                 "class3_1","class3_2","class3_3"), mean, na.rm = TRUE) %>% 
  as.data.frame()
resits_count$country3 <- countrycode::countrycode(sourcevar = resits_count$country,origin = "iso3n",destination = "iso3c")

myorder <-  resits_count$country2[order(resits_count$homclass)]
ggplot(data = resits_count,aes(x =country3,y = homclass)) + 
  geom_segment(aes(x=country2, xend=country3, y=0, yend=homclass), color="black") +
  geom_point() +
  scale_x_discrete(limits=myorder) +
  ylab("Class-based homogeneity")+   
  xlab("") +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1.2))    
```

```{r class-hom,fig.height=7,fig.width=7,fig.cap=c("Redistribution, Network homogeneity and Social Class in the ISSP 2017"), out.width = '100%'}
sizetext <- 2.5

predis <-  
resits_count %>%  
ggplot(aes(y=redist, x=homclass)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0.3,0.5))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Class homogeneity")+
  ylab("Redistributive preferences") +
  labs(title = "Redistributive preferences and Class homogeneity",
       caption =paste("r=",round(cor(resits_count$homclass, 
                                     resits_count$redist),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$redist)


p1 <- resits_count %>%  
ggplot(aes(y=homclass, x=class3_3)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Working class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Working class (%)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$class3_3),digits = 2),""))

# cor.test(resits_count$homclass,resits_count$class3_3)

p2 <- resits_count %>%  
ggplot(aes(y=homclass, x=class3_2)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Intermediate class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Intermediate class (%)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$class3_2),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$class3_2)
p3 <- resits_count %>%  
ggplot(aes(y=homclass, x=class3_1)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Service class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Service class (%)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$class3_1),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$class3_3)
grid.arrange(predis,p1,p2,p3,nrow = 2)
```


\pagebreak

## Individual level

1. Class: 
    - having a working class position is associated with higher redistributive preferences
    - class homogeneity is higher among the working class, and lower in the upper-class

2. Network segregation
    - being more segregated in terms of network homogeneity increase demand for redistribution 
    
<!-- - Perceived isolation -->
<!--   - perceived isolation increases redistributive preferences -->
  
<!-- Note: network segregation decreases perceived isolation *   -->

3. Network segregation x Social Class
    - The influence of homogeneity is positive among the working and intermediate classes, and negative among the upper class 
    
```{r mod-homclass,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        class5,
                        homclass,
                        Q03pcm,
                        # Q03pcm=Q03rm,
                        # Q03pcm=Q03rm,
                        # Q03pcm=zincpc,
                        # Q03rm=
                        # isei08,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        workst,
                        # isolation,  
                        # MAINSTAT,
                        # activities,
                        # WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt"
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
  na.omit()

# frq(df1$region)
# frq(dfreg$country2)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst + union+ female+agenum +age2 +  (1|country2),data=dfreg)
rob4 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst + union+ female+agenum +age2 + (homclass|country2),data=dfreg)
# anova(rob3,rob4)

# plot_model(rob4,type = "re",show.values = T)

# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# int_homo2 <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+  (homclass + class3*homclass|country2),data=dfreg)
# anova(int_homo,int_homo2)
# plot_model(int_homo2,type = "re",show.values = F,vline.color = "black")

# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Intermediate class (III+IV)' ='Intermediate Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "workstNot in paid work"="Not in labor force",
                 "unionYes" = 'Union membership: Yes',
                 'class3Intermediate class (III+IV):homclass'='Homogeneity x Intermediate Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Service Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                                float.pos="h!",
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

```{r coefplot,eval=FALSE, include=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,dotwhisker,ggplot2,broom.mixed) 


m1_df <-
    broom.mixed::tidy(rob3) %>% filter(term %in%  c("class3Intermediate class (III+IV)",
                                                    "class3Working Class (V+VI+VII)",
                                                    "homclass")) %>% mutate(model = "Model 1")
m2_df <-
    broom.mixed::tidy(int_homo) %>% filter(term %in%  c("class3Intermediate class (III+IV)",
                                                        "class3Working Class (V+VI+VII)",
                                                        "homclass",
                                                        "class3Intermediate class (III+IV):homclass",
                                                        "class3Working Class (V+VI+VII):homclass")) %>% mutate(model = "Model 2")

two_models <- rbind(m1_df)


  dwplot(two_models,
       vline = geom_vline(xintercept = 0,colour = "black",linetype = 1,size=0.01),
       style = "dotwhisker",
       dot_args =  list(size=5),
       whisker_args = list(size=2),
       vars_order = c("homclass",
                      "class3Intermediate class (III+IV)",
          "class3Working Class (V+VI+VII)",
          "class3Intermediate class (III+IV):homclass",
          "class3Working Class (V+VI+VII):homclass")) %>% 

     relabel_predictors(
        c("homclass"="Class based network homogeneity",
          "class3Intermediate class (III+IV)"="Intermediate Class (ref: Service class)",
          "class3Working Class (V+VI+VII)"="Working Class",
          "class3Intermediate class (III+IV):homclass"="Homogeneity x Intermediate Class",
          "class3Working Class (V+VI+VII):homclass"="Homogeneity x Working Class"))+
      ggtitle("Multilevel regression for Network segregation, social class and redistributive preferences") +
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  theme(
        plot.title = element_text(face = "bold"),
        legend.position = c(0.007, 0.01),
        legend.justification = c(0, 0),
        legend.background = element_rect(colour = "grey80"),
        legend.title = element_blank(),
        axis.text.y.left = element_text(face = "bold",size = 12)
  )
```


```{r leverage1, eval=FALSE, include=FALSE}
pacman::p_load(influence.ME,lattice)
# dfbetas-----------------------------------------------------------------------
influence <- influence(rob3, "country2")
dfbetas(influence,parameters=c(1,4)) 
n_groups <- lme4::ngrps(rob3)

influence_est=as.data.frame(dfbetas(influence))
influence_est %>%  filter(homclass > 2/sqrt(n_groups))

plot(influence, which="dfbetas", 
     parameters=c(1,4),
     xlab="DFbetaS", ylab="Country",cutoff = 2/sqrt(n_groups))

# cook-distance-----------------------------------------------------------------
# cooks.distance(rob3, sort = TRUE)
plot(influence, which="cook",
     cutoff=4/n_groups, sort=TRUE,
     xlab="Cooks Distance",
     ylab="Country")

sigtest1<- sigtest(influence, test=-1.96)
sigtest1$homclass
```


```{r marg1,fig.dim=c(4.1,2.6),fig.cap=c("Conditional marginal effects of Network homogeneity on redistributive preferences"),out.width = "75%"}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)   
# Conditional Marginal effect
interplot <- 
interplot::interplot(m = int_homo,var1 = "homclass",var2="class3")
df_int <- interplot$data
df_int <- df_int[c(1,2,4),]
df_int$value <- c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)")
df_int$value <- factor(df_int$value,ordered = T,
                       levels = c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)")) 

df_int %>% 
ggplot() +
  geom_point(aes(x = value,y = coef1)) + 
  geom_errorbar(aes(x = value, ymin = lb, ymax = ub),color="black",width=0.1,size=1) +
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  ylab("Class-based homogeneity")+
  xlab("Social Class")+
  ggtitle("Redistributive preferences") +
  geom_hline(yintercept = 0) + 
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +    
  theme(plot.title = element_text(size = 8))  
```

```{r pred1,fig.height=3.6,fig.width=5.7,fig.cap=c("Conditional linear Predictions for network homogeneity on redistributive Preferences"),out.width = '75%'}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,gridExtra,papaja)        
# Predicted values 

plot_predictions(int_homo, condition = c("homclass","class3")) +
  facet_grid(~factor(class3, levels=c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)")))+
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "none", legend.title = element_blank())
  # scale_fill_grey(start = 0.40, end = 0.6) +
  # scale_color_grey(start = 0.40, end = 0.6)
```

\pagebreak

## Macro level

  - Expectation: Economic inequality increases segregation (maybe weak or null effect)
  - Expectation: Economic inequality increase the influence of network homogeneity/segregation
  
```{r ineq-homo,fig.height=4,fig.width=7.5,fig.cap=c("Network Homogeneity and Income Inequality in the ISSP 2017"), out.width = '100%'}
sizetext <- 2.5
resits_count <- dfreg %>%
  group_by(country2,country) %>%
  summarise_at(c("redist","homclass", 
                 "gini_disp","gini_mkt"), mean, na.rm = TRUE) %>% 
  as.data.frame()
resits_count$country3 <- countrycode::countrycode(sourcevar = resits_count$country,origin = "iso3n",destination = "iso3c")
p1 <- resits_count %>%  
ggplot(aes(y=homclass, x=gini_disp)) +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Gini (Disposable)")+
  ylab("Class homogeneity") +
  labs(
    # title = "Class homogeneity and Income Inequality (Disposable)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$gini_disp),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$gini_disp)
p2 <- resits_count %>%  
ggplot(aes(y=homclass, x=gini_mkt)) +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Gini (Market)")+
  ylab("Class homogeneity") +
  labs(
    # title = "Class homogeneity and Income Inequality (Market)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$gini_mkt),digits = 2),"")) 

# cor.test(resits_count$homclass,resits_count$class3_3)
grid.arrange(p1,p2,nrow = 1)
```

  <!-- - expected: in unequal countries the effect of network segregation and perceived isolation will be stronger  -->


```{r mod-intermacro,results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjlabelled,haven,stringr,sjPlot)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_gc,
                        # homclass=eindex,
                        # homclass=ingroup,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        # giniot=gini,
                        giniot=gv_spen,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        workst) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>%
  na.omit()
# T03dim(dfreg)

main <- "redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2"

giniD_gdp<-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(1|country2)")),data=dfreg)
giniD_rs <-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(homclass|country2)")),data=dfreg)
# anova(giniD_gdp,giniD_rs)
giniD_int<- lmer(formula(paste0(main,"+homclass*gini_disp+logrgdpna","+(homclass|country2)")),data=dfreg)
# summary(giniD_int)

giniM_gdp<- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1|country2),data=dfreg)
giniM_rs<- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+homclass|country2),data=dfreg)
# anova(giniM_gdp,giniM_rs)
giniM_int <- lmer(redist~class3+ homclass*gini_mkt+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+homclass|country2),data=dfreg)
# anova(giniOT_gdp,giniOT_rs)

models <- list(giniD_gdp,giniD_rs,giniD_int,
               giniM_gdp,giniM_rs,giniM_int)

texreg::knitreg(models,
                caption=paste("(\\#tab:modinter1)","Cross-level interaction for Network homogeneity and Economic Inequality"),
                caption.above=T,float.pos="h!",
                # include.thresholds=FALSE,
                custom.coef.map=list(homclass="Network Homogeneity",
                                     logrgdpna="log GDP","gini_disp"="Gini (Disposable) ",
                                     "homclass:gini_disp"="Homogeneity x Gini (D)",
                                     "gini_mkt"="Gini (Market) ",
                                     "homclass:gini_mkt"="Homogeneity x Gini (M)"),
                  # groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

\pagebreak
```{r crosslevel}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,gridExtra)       
p1<- interplot::interplot(m = giniD_int,var1 = "homclass",var2="gini_disp")+
  ylab("Class-based homogeneity coefficient")+ xlab("Gini disposable") + 
  geom_point()+ geom_hline(yintercept = 0)

gini_sig <- 
p1$data %>% 
  filter(ub>0 & lb >0) %>% 
  dplyr::select(fake)

dfreg %>% filter(gini_disp >= min(gini_sig$fake),gini_disp <= max(gini_sig$fake)) %>% dplyr::select(country2)


table(dfreg$gini_disp)

dfreg %>% filter(gini_disp %in%)

p2<- interplot::interplot(m = giniM_int,var1 = "homclass",var2="gini_mkt") +
  ylab("Class-based homogeneity coefficient")+ xlab("Gini market") +geom_point()+ geom_hline(yintercept = 0)

 
# Predicted values 
predval1 <- 
plot_predictions(giniD_int, condition = list("homclass",gini_disp=range),gray = F) +
  labs(caption = paste0("N=",nobs(giniD_int),", Countries=",lme4::ngrps(giniD_int)),
       colour='Gini (Disposable)',fill='Gini (Disposable)') +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")

# Predicted values 
predval2 <- 
plot_predictions(giniM_int, condition = list("homclass",gini_mkt=range),gray = F)+
  labs(caption = paste0("N=",nobs(giniM_int),", Countries=",lme4::ngrps(giniM_int)),
       colour='Gini (Market)',fill='Gini (Market)') +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")
```

```{r crossginiD, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Network homogeneity and Gini (Disposable)"),out.width='100%'}
grid.arrange(p1,predval1,nrow = 1 
             # top = "Network homogeneity × Gini (Disposable)"   
             )
```

```{r crossginiM, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Network homogeneity and Gini (Market)"),out.width='100%'}
grid.arrange(p2,predval2,nrow = 1  
             # top = "Network homogeneity × Gini (Market)"
             ) 
```

\pagebreak

# Additional analysis

- Homogeneity x other macro variables
- Egalitarian economic preferences (Index)
- Network homogeneity (Strong ties)
- Network homogeneity (Weak ties)
- R's and Partner social class

## Other macro variables 

Source: https://www4.wider.unu.edu/?ind=1&type=ChoroplethSeq&year=70&byCountry=false&slider=buttons

* The **Palma ratio** is the share of all income received by the 10% people with highest disposable income divided by the share of all income received by the 40% people with the lowest disposable income.
* **90/10 ratio** = the ratio of Decile 10 income to Decile 1 income
* **90/50 ratio** = the ratio of Decile 10 income to Decile 5 income (the median)
<!-- * 50/10 ratio = the ratio of Decile 5 income (the median) to Decile 1 income. -->

```{r mod-other-macro,fig.height=3,fig.width=6,out.width='70%',results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_gc,
                        # homclass=homclass_res,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        giniindex,ttheilge1,
                        gv_spen=gv_spen,
                        top10,
                        middle50,
                        palmaratio,
                        d10d1,
                        rgdpna,
                        individualism,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
    # filter(!country2 %in% c("Turkey","Estonia")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>%
   na.omit()


int_palma <- lmer(redist~class3+ homclass*palmaratio+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna + (1+homclass|country2),data=dfreg)
int_pc10  <- lmer(redist~class3+ homclass*top10+edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_pc50  <- lmer(redist~class3+homclass*middle50+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_d10d1<- lmer(redist~class3+ homclass*d10d1+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_gini_wiid  <- lmer(redist~class3+ homclass*giniindex+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_theil  <- lmer(redist~class3+ homclass*ttheilge1+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)

models_m <- list(int_palma,int_pc10,int_pc50,int_d10d1
                 # int_gini_wiid,int_theil
                 )

cap1=c("Cross-level interaction for Network homogeneity and Economic Inequality")
customcoef <- 
list(homclass = "Class-based network homogeneity",
  logrgdpna           = "log GDP",
  palmaratio               = "Palma Ratio",
  "homclass:palmawd"      = "Homogeneity x Palma Ratio",
  top10             = "Share National Income - top 10%",
  "homclass:top10"    = "Homogeneity x top 10",
  middle50             = "Share National Income -  bottom 50%",
  "homclass:middle50"    = "Homogeneity x bottom 50",
  individualism         = "Individualism Index*",
  "homclass:individualism" = "Homogeneity x Individualism",
  gv_spen               = "Gov. Spending (% GDP)*",
  "homclass:gv_spen"      = "Homogeneity x Gov. Spend.",
    d10d1             = "Ratio D10/D01",
  "homclass:d10d1"    = "Homogeneity x Ratio D10/D01"  
)
texreg::knitreg(models_m,scalebox = 0.75,
                float.pos="h!",                
                custom.coef.map = customcoef,
                caption.above = T,caption = cap1)
```

```{r homclass-ineq,fig.height=6,fig.width=8,fig.cap=c("Cross-level interaction for Network homogeneity and Economic Inequality"),out.width='100%',results='asis'}
p3<- interplot::interplot(m = int_palma,var1 = "homclass",var2="palmaratio") +
  xlab("Palma ratio (top 10%/ bottom 40%)") + geom_point()+ geom_hline(yintercept = 0) +
    labs(caption = paste0("N=",nobs(int_palma),", Countries=",lme4::ngrps(int_palma)))

p3.pred <- plot_predictions(int_palma, condition = list("homclass",palmaratio=range),gray = F) +
    labs(caption = paste0("N=",nobs(int_palma),", Countries=",lme4::ngrps(int_palma)),
       linetype='Palma Ratio',fill='Palma Ratio',color='Palma Ratio') +
  xlab("Class-based homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")

p4<- interplot::interplot(m = int_pc10,var1 = "homclass",var2="top10") +
  xlab("Share National Income -  top 10%") + geom_point()+ geom_hline(yintercept = 0) +
  labs(caption = paste0("N=",nobs(int_pc10),", Countries=",lme4::ngrps(int_pc10)))  

# plot_predictions(int_pc10, condition = list("homclass",top10=range),gray = F)

p5<- interplot::interplot(m = int_pc50,var1 = "homclass",var2="middle50") +
  xlab("Share National Income - middle 50%") + geom_point()+ geom_hline(yintercept = 0) +
  labs(caption = paste0("N=",nobs(int_pc50),", Countries=",lme4::ngrps(int_pc50)))   

# plot_predictions(int_pc50, condition = list("homclass",middle50=range),gray = F)

p6<- interplot::interplot(m = int_d10d1,var1 = "homclass",var2="d10d1") +
  xlab("Ratio (Top 10%/Bottom 10%)") + geom_point()+ geom_hline(yintercept = 0)+
  labs(caption = paste0("N=",nobs(int_d10d1),", Countries=",lme4::ngrps(int_d10d1)))

p6.pred<- plot_predictions(int_d10d1, condition = list("homclass",d10d1=range),gray = F) +
      labs(caption = paste0("N=",nobs(int_palma),", Countries=",lme4::ngrps(int_palma)),
       linetype='Ratio D10/D01',fill='Ratio D10/D01',color='Ratio D10/D01') +
  xlab("Class-based homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")

grid.arrange(p3,p3.pred,p6,p6.pred,nrow = 2)
```


## Egalitarian economic preferences

```{r mod-homclass-egal,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist=egal3,
                        class3,
                        class5,
                        homclass,
                        Q03pcm,
                        # Q03pcm=Q03rm,
                        # Q03pcm=Q03rm,
                        # Q03pcm=zincpc,
                        # Q03rm=
                        # isei08,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        workst,
                        # isolation,  
                        # MAINSTAT,
                        # activities,
                        # WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt"
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
  na.omit()

# frq(df1$region)
# frq(dfreg$country2)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst + union+ female+agenum +age2 +  (1|country2),data=dfreg)
rob4 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst + union+ female+agenum +age2 + (homclass|country2),data=dfreg)
# anova(rob3,rob4)

# plot_model(rob4,type = "re",show.values = T)

# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# int_homo2 <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+  (homclass + class3*homclass|country2),data=dfreg)
# anova(int_homo,int_homo2)
# plot_model(int_homo2,type = "re",show.values = F,vline.color = "black")

# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
cap1 <- "Multilevel regression for egalitarian preferences, network homogeneity and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Intermediate class (III+IV)' ='Intermediate Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "workstNot in paid work"="Not in labor force",
                 "unionYes" = 'Union membership: Yes',
                 'class3Intermediate class (III+IV):homclass'='Homogeneity x Intermediate Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Service Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modegalindex)",cap1),caption.above=T,scalebox = 0.5,
                                float.pos="h!",
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

```{r coefplot2,eval=FALSE, include=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,dotwhisker,ggplot2,broom.mixed) 


m1_df <-
    broom.mixed::tidy(rob3) %>% filter(term %in%  c("class3Intermediate class (III+IV)",
                                                    "class3Working Class (V+VI+VII)",
                                                    "homclass")) %>% mutate(model = "Model 1")
m2_df <-
    broom.mixed::tidy(int_homo) %>% filter(term %in%  c("class3Intermediate class (III+IV)",
                                                        "class3Working Class (V+VI+VII)",
                                                        "homclass",
                                                        "class3Intermediate class (III+IV):homclass",
                                                        "class3Working Class (V+VI+VII):homclass")) %>% mutate(model = "Model 2")

two_models <- rbind(m1_df)


  dwplot(two_models,
       vline = geom_vline(xintercept = 0,colour = "black",linetype = 1,size=0.01),
       style = "dotwhisker",
       dot_args =  list(size=5),
       whisker_args = list(size=2),
       vars_order = c("homclass",
                      "class3Intermediate class (III+IV)",
          "class3Working Class (V+VI+VII)",
          "class3Intermediate class (III+IV):homclass",
          "class3Working Class (V+VI+VII):homclass")) %>% 

     relabel_predictors(
        c("homclass"="Class based network homogeneity",
          "class3Intermediate class (III+IV)"="Intermediate Class (ref: Service class)",
          "class3Working Class (V+VI+VII)"="Working Class",
          "class3Intermediate class (III+IV):homclass"="Homogeneity x Intermediate Class",
          "class3Working Class (V+VI+VII):homclass"="Homogeneity x Working Class"))+
      ggtitle("Multilevel regression for Network segregation, social class and redistributive preferences") +
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  theme(
        plot.title = element_text(face = "bold"),
        legend.position = c(0.007, 0.01),
        legend.justification = c(0, 0),
        legend.background = element_rect(colour = "grey80"),
        legend.title = element_blank(),
        axis.text.y.left = element_text(face = "bold",size = 12)
  )
```

```{r leverage2, eval=FALSE, include=FALSE}
pacman::p_load(influence.ME,lattice)
# dfbetas-----------------------------------------------------------------------
influence <- influence(rob3, "country2")
dfbetas(influence,parameters=c(1,4)) 
n_groups <- lme4::ngrps(rob3)

influence_est=as.data.frame(dfbetas(influence))
influence_est %>%  filter(homclass > 2/sqrt(n_groups))

plot(influence, which="dfbetas", 
     parameters=c(1,4),
     xlab="DFbetaS", ylab="Country",cutoff = 2/sqrt(n_groups))

# cook-distance-----------------------------------------------------------------
# cooks.distance(rob3, sort = TRUE)
plot(influence, which="cook",
     cutoff=4/n_groups, sort=TRUE,
     xlab="Cooks Distance",
     ylab="Country")

sigtest1<- sigtest(influence, test=-1.96)
sigtest1$homclass
```

```{r marg2,fig.dim=c(4.1,2.6),fig.cap=c("Conditional marginal effects of Network homogeneity on egalitarian economic preferences"),out.width = "75%"}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)   
# Conditional Marginal effect
interplot <- 
interplot::interplot(m = int_homo,var1 = "homclass",var2="class3")
df_int <- interplot$data
df_int <- df_int[c(1,2,4),]
df_int$value <- c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)")
df_int$value <- factor(df_int$value,ordered = T,
                       levels = c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)")) 

df_int %>% 
ggplot() +
  geom_point(aes(x = value,y = coef1)) + 
  geom_errorbar(aes(x = value, ymin = lb, ymax = ub),color="black",width=0.1,size=1) +
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  ylab("Class-based homogeneity")+
  xlab("Social Class")+
  ggtitle("Egalitarian economic preferences") +
  geom_hline(yintercept = 0) + 
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +    
  theme(plot.title = element_text(size = 8))  
```

```{r pred2,fig.height=3.6,fig.width=5.7,fig.cap=c("Conditional linear Predictions for network homogeneity on egalitarian economic Preferences"),out.width = '75%'}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,gridExtra,papaja)        
# Predicted values 

plot_predictions(int_homo, condition = c("homclass","class3")) +
  facet_grid(~factor(class3, levels=c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)")))+
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  xlab("Network homogeneity")+
  ylab("Egalitarian economic preferences") +
  theme(legend.position = "none", legend.title = element_blank())
  # scale_fill_grey(start = 0.40, end = 0.6) +
  # scale_color_grey(start = 0.40, end = 0.6)
```

```{r mod-intermacro-egal,results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjlabelled,haven,stringr,sjPlot)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist=egal3,
                        class3,
                        homclass=homclass_gc,
                        # homclass=eindex,
                        # homclass=ingroup,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        # giniot=gini,
                        # giniot=gv_spen,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        workst) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>%
  na.omit()
# T03dim(dfreg)

main <- "redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2"

giniD_gdp<-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(1|country2)")),data=dfreg)
giniD_rs <-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(homclass|country2)")),data=dfreg)
# anova(giniD_gdp,giniD_rs)
giniD_int<- lmer(formula(paste0(main,"+homclass*gini_disp+logrgdpna","+(homclass|country2)")),data=dfreg)
# summary(giniD_int)

giniM_gdp<- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1|country2),data=dfreg)
giniM_rs<- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+homclass|country2),data=dfreg)
# anova(giniM_gdp,giniM_rs)
giniM_int <- lmer(redist~class3+ homclass*gini_mkt+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+homclass|country2),data=dfreg)


models <- list(giniD_gdp,giniD_rs,giniD_int,
               giniM_gdp,giniM_rs,giniM_int)

texreg::knitreg(models,
                caption=paste("(\\#tab:modinter1)","Cross-level interaction for Network homogeneity and Economic Inequality"),
                caption.above=T,float.pos="h!",
                # include.thresholds=FALSE,
                custom.coef.map=list(homclass="Network Homogeneity",
                                     logrgdpna="log GDP","gini_disp"="Gini (Disposable) ",
                                     "homclass:gini_disp"="Homogeneity x Gini (D)",
                                     "gini_mkt"="Gini (Market) ",
                                     "homclass:gini_mkt"="Homogeneity x Gini (M)"),
                  # groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

\pagebreak
```{r crosslevel-egal}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,gridExtra)       
p1<- interplot::interplot(m = giniD_int,var1 = "homclass",var2="gini_disp")+
  ylab("Class-based homogeneity coefficient")+ xlab("Gini disposable") + 
  geom_point()+ geom_hline(yintercept = 0)

p2<- interplot::interplot(m = giniM_int,var1 = "homclass",var2="gini_mkt") +
  ylab("Class-based homogeneity coefficient")+ xlab("Gini market") +geom_point()+ geom_hline(yintercept = 0)

 
# Predicted values 
predval1 <- 
plot_predictions(giniD_int, condition = list("homclass",gini_disp=range),gray = F) +
  labs(caption = paste0("N=",nobs(giniD_int),", Countries=",lme4::ngrps(giniD_int)),
       colour='Gini (Disposable)',fill='Gini (Disposable)') +
  xlab("Network homogeneity")+
  ylab("Egalitarian economic preferences") +
  theme(legend.position = "right")

# Predicted values 
predval2 <- 
plot_predictions(giniM_int, condition = list("homclass",gini_mkt=range),gray = F)+
  labs(caption = paste0("N=",nobs(giniM_int),", Countries=",lme4::ngrps(giniM_int)),
       colour='Gini (Market)',fill='Gini (Market)') +
  xlab("Network homogeneity")+
  ylab("Egalitarian economic preferences") +
  theme(legend.position = "right")
```

```{r crossginiD-egal, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Network homogeneity and Gini (Disposable)"),out.width='100%'}
grid.arrange(p1,predval1,nrow = 1 
             # top = "Network homogeneity × Gini (Disposable)"   
             )
```

```{r crossginiM-egal, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Network homogeneity and Gini (Market)"),out.width='100%'}
grid.arrange(p2,predval2,nrow = 1  
             # top = "Network homogeneity × Gini (Market)"
             ) 
```

```{r mod-other-macro-egal,fig.height=3,fig.width=6,out.width='70%',results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist=egal3,
                        class3,
                        homclass=homclass_gc,
                        # homclass=homclass_res,
                        Q05pcm,
                        Q03pcm,
                        top10,
                        middle50,
                        palmaratio,
                        d10d1,
                        giniindex,
                        ttheilge1,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
    # filter(!country2 %in% c("Turkey","Estonia")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>%
   na.omit()


int_palma <- lmer(redist~class3+ homclass*palmaratio+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna + (1+homclass|country2),data=dfreg)
int_pc10  <- lmer(redist~class3+ homclass*top10+edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_pc50  <- lmer(redist~class3+homclass*middle50+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_d10d1<- lmer(redist~class3+ homclass*d10d1+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_gini_wiid  <- lmer(redist~class3+ homclass*giniindex+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_theil  <- lmer(redist~class3+ homclass*ttheilge1+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)

models_m <- list(int_palma,int_pc10,int_pc50,int_d10d1,
                 int_gini_wiid,int_theil
                 )

cap1=c("Cross-level interaction for Network homogeneity and Economic Inequality for Egaliatarian economic preferences")
customcoef <- 
list(homclass = "Class-based network homogeneity",
  logrgdpna           = "log GDP",
  palmaratio               = "Palma Ratio",
  "homclass:palmawd"      = "Homogeneity x Palma Ratio",
  top10             = "Share National Income - top 10%",
  "homclass:top10"    = "Homogeneity x top 10",
  middle50             = "Share National Income -  bottom 50%",
  "homclass:middle50"    = "Homogeneity x bottom 50",
  # individualism         = "Individualism Index*",
  # "homclass:individualism" = "Homogeneity x Individualism",
  # gv_spen               = "Gov. Spending (% GDP)*",
  # "homclass:gv_spen"      = "Homogeneity x Gov. Spend.",
    d10d1             = "Ratio D10/D01",
  "homclass:d10d1"    = "Homogeneity x Ratio D10/D01",
    giniindex             = "Gini (WIID)",
  "homclass:giniindex"    = "Homogeneity x Gini (WIID)",
   ttheilge1             = "Theil Index",
  "homclass:ttheilge1"    = "Homogeneity x Theil Index"
)
texreg::knitreg(models_m,scalebox = 0.50,
                float.pos="h!",                
                custom.coef.map = customcoef,
                caption.above = T,caption = cap1)    
```

```{r homclass-ineq-egal,fig.height=6,fig.width=8,fig.cap=c("Cross-level interaction for Network homogeneity and Economic Inequality"),out.width='100%',results='asis'}
p3<- interplot::interplot(m = int_palma,var1 = "homclass",var2="palmaratio") +
  xlab("Palma ratio (top 10%/ bottom 40%)") + geom_point()+ geom_hline(yintercept = 0) +
    labs(caption = paste0("N=",nobs(int_palma),", Countries=",lme4::ngrps(int_palma)))

p3.pred <- plot_predictions(int_palma, condition = list("homclass",palmaratio=range),gray = F) +
    labs(caption = paste0("N=",nobs(int_palma),", Countries=",lme4::ngrps(int_palma)),
       linetype='Palma Ratio',fill='Palma Ratio',color='Palma Ratio') +
  xlab("Class-based homogeneity")+
  ylab("Egalitarian economic preferences") +
  theme(legend.position = "right")

p4<- interplot::interplot(m = int_pc10,var1 = "homclass",var2="top10") +
  xlab("Share National Income -  top 10%") + geom_point()+ geom_hline(yintercept = 0) +
  labs(caption = paste0("N=",nobs(int_pc10),", Countries=",lme4::ngrps(int_pc10)))  

# plot_predictions(int_pc10, condition = list("homclass",top10=range),gray = F)

p5<- interplot::interplot(m = int_pc50,var1 = "homclass",var2="middle50") +
  xlab("Share National Income - middle 50%") + geom_point()+ geom_hline(yintercept = 0) +
  labs(caption = paste0("N=",nobs(int_pc50),", Countries=",lme4::ngrps(int_pc50)))   

# plot_predictions(int_pc50, condition = list("homclass",middle50=range),gray = F)

p6<- interplot::interplot(m = int_d10d1,var1 = "homclass",var2="d10d1") +
  xlab("Ratio (Top 10%/Bottom 10%)") + geom_point()+ geom_hline(yintercept = 0)+
  labs(caption = paste0("N=",nobs(int_d10d1),", Countries=",lme4::ngrps(int_d10d1)))

p6.pred<- plot_predictions(int_d10d1, condition = list("homclass",d10d1=range),gray = F) +
      labs(caption = paste0("N=",nobs(int_palma),", Countries=",lme4::ngrps(int_palma)),
       linetype='Ratio D10/D01',fill='Ratio D10/D01',color='Ratio D10/D01') +
  xlab("Class-based homogeneity")+
  ylab("Egalitarian economic preferences") +
  theme(legend.position = "right")

grid.arrange(p3,p3.pred,p6,p6.pred,nrow = 2)
```

\pagebreak

## Strong ties

```{r mod-strongties,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
# df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
# df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_s,
                        # homclass=eindex_s,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
  na.omit()
# dim(dfreg)

# Models for Redistributive Preferences ----------------------------------------
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+(1|country2),data=dfreg)
# rob4 <- lmer(redist~class3+ homclass*palmaratio+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+(homclass|country2),data=dfreg)
# anova(rob3,rob4)
# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2),data=dfreg)

# Models for Egalitarian Economic Preferences (EEP)-----------------------------
dfreg <- df1 %>% dplyr::select(redist=egal3,
                        class3,
                        homclass=homclass_s,
                        # homclass=eindex_s,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
  na.omit()

base_e<- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base_e)
class_e <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass_e <- lmer(redist~homclass + (1|country2),data=dfreg)
full1_e <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1_e <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2_e <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3_e <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+(1|country2),data=dfreg)
# rob4 <- lmer(redist~class3+ homclass*palmaratio+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+(homclass|country2),data=dfreg)
# anova(rob3,rob4)
# Interactions segregation x class
int_homo_e <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2),data=dfreg)

cap1 <- "Multilevel regression Redistribution and Egalitarian Preferences, network homogeneity (strong) and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity (Strong)",
                 'class3Intermediate class (III+IV)' ='Intermediate class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "workstNot in paid work"="Not in labor force",
                 "unionYes" = 'Union membership: Yes',
                 'class3Intermediate class (III+IV):homclass'='Homogeneity x Intermediate class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Service Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,full1,rob3,int_homo,homclass_e,full1_e,rob3_e,int_homo_e)
texreg::knitreg(models,caption=paste("(\\#tab:modstrongties)",cap1),caption.above=T,scalebox = 0.5,
                                float.pos="h!",
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1,
                custom.header = list("Redistributive preferences" = 1:4, "Egalitarian preferences (Index)" = 5:8),
                )
```

## Weak ties

```{r mod-weakties,results='asis', cache=T}   
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
# df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
# df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
# df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_w,  
                        # homclass=eindex_w,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,d10d1,palmaratio,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
  na.omit()
# dim(dfreg)

# Models for Redistributive Preferences ----------------------------------------
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+(1|country2),data=dfreg)
# rob4 <- lmer(redist~class3+ homclass*palmaratio+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+(homclass|country2),data=dfreg)
# anova(rob3,rob4)
# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2),data=dfreg)

# Models for Egalitarian Economic Preferences (EEP)-----------------------------
dfreg <- df1 %>% dplyr::select(redist=egal3,
                        class3,
                        homclass=homclass_s,
                        # homclass=eindex_s,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
  na.omit()

base_e<- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base_e)
class_e <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass_e <- lmer(redist~homclass + (1|country2),data=dfreg)
full1_e <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1_e <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2_e <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3_e <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+(1|country2),data=dfreg)
# rob4 <- lmer(redist~class3+ homclass*palmaratio+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+(homclass|country2),data=dfreg)
# anova(rob3,rob4)
# Interactions segregation x class
int_homo_e <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2),data=dfreg)

cap1 <- "Multilevel regression Redistribution and Egalitarian Preferences, network homogeneity (weak) and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity (weak)",
                 'class3Intermediate class (III+IV)' ='Intermediate class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "workstNot in paid work"="Not in labor force",
                 "unionYes" = 'Union membership: Yes',
                 'class3Intermediate class (III+IV):homclass'='Homogeneity x Intermediate class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Service Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,full1,rob3,int_homo,homclass_e,full1_e,rob3_e,int_homo_e)
texreg::knitreg(models,caption=paste("(\\#tab:weakties)",cap1),caption.above=T,scalebox = 0.5,
                                float.pos="h!",
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1,
                custom.header = list("Redistributive preferences" = 1:4, "Egalitarian preferences (Index)" = 5:8),
                )
```

\pagebreak

## Respondent class

```{r mod-ownclass, cache=TRUE, results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
# df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
# df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
# df1$class3spo <- relevel(df1$class3spo,ref =  "Intermediate class (III+IV)")

df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3=class3res,
                        class3spo,
                        homclass,
                        # homclass=eindex_res,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+ (1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2),data=dfreg)
rob4 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ class3spo +(1|country2),data=dfreg)
rob5 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ class3spo +(homclass|country2),data=dfreg)

# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ class3spo +(1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and Own social class " 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Intermediate class (III+IV)' ='Intermediate class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "workstNot in paid work"="Not in labor force",
                 "unionYes" = 'Union membership: Yes',
                 'class3Intermediate class (III+IV):homclass'='Homogeneity x Intermediate class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class',
                 'class3spoIntermediate class (III+IV)' ='Intermediate Class (Partner)',
                 "class3spoWorking Class (V+VI+VII)"='Working Class (Partner)'
                 )
coefgroup <- list("Social Class - Resp. (ref: Service Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,rob4,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,scalebox = 1,
                float.pos="h!",
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

<<<<<<< HEAD
\pagebreak 

## Gov's spending and individualism

```{r mod-spend-indv, results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_gc,
                        # homclass=homclass_res,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        giniindex,ttheilge1,
                        gv_spen=gv_spen,
                        top10,
                        middle50,
                        palmaratio,
                        d10d1,
                        rgdpna,
                        individualism,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
    # filter(!country2 %in% c("Turkey","Estonia")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>%
   na.omit()
int_indivi<- lmer(redist~class3+ homclass*individualism+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna + (1+homclass|country2),data=dfreg)
int_govspe<- lmer(redist~class3+ homclass*gv_spen+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna + (1+homclass|country2),data=dfreg)
models_m <- list(int_indivi,int_govspe)
cap1=c("Cross-level interaction for Network homogeneity, Goverment Spending and Individualism")
customcoef <- 
list(homclass = "Class-based network homogeneity",
  logrgdpna           = "log GDP",
  individualism         = "Individualism Index*",
  "homclass:individualism" = "Homogeneity x Individualism",
  gv_spen               = "Gov. Spending (% GDP)*",
  "homclass:gv_spen"      = "Homogeneity x Gov. Spend."
)
texreg::knitreg(models_m,scalebox = 1,
                float.pos="h!",                
                custom.coef.map = customcoef,
                caption.above = T,caption = cap1)
```

```{r homclass-spend-indv, fig.height=6,fig.width=8,fig.cap=c("Cross-level interaction for Network homogeneity, Gov. Spending and Individualism"),out.width='100%',}
p8<- interplot::interplot(m = int_indivi,var1 = "homclass",var2="individualism") +
  xlab("Individualism Index*") + geom_point()+ geom_hline(yintercept = 0)+
  labs(caption = paste0("N=",nobs(int_indivi),", Countries=",lme4::ngrps(int_indivi)))  

predval8 <- 
plot_predictions(int_indivi, condition = list("homclass",individualism=range),gray = F) +
  labs(caption = paste0("N=",nobs(int_indivi),", Countries=",lme4::ngrps(int_indivi)),
       linetype='Individualism') +
  xlab("Class-based homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")


p9<- interplot::interplot(m = int_govspe,var1 = "homclass",var2="gv_spen") +
  xlab("Gov. Spending (% GDP)*") + geom_point()+ geom_hline(yintercept = 0)+
  labs(caption = paste0("N=",nobs(int_govspe),", Countries=",lme4::ngrps(int_govspe)))

predval9 <- 
plot_predictions(int_govspe, condition = list("homclass",gv_spen=range),gray = F) +
  labs(caption = paste0("N=",nobs(int_govspe),", Countries=",lme4::ngrps(int_govspe)),
       linetype='Gov.Spend') +
  xlab("Class-based homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")

grid.arrange(p9,predval9,
             p8,predval8,nrow = 2)
```


\pagebreak  

## Perceived Isolation

```{r mod-isolation,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist,
                        class3,class5,
                        homclass,
                        isolation,
                        Q05pcm,
                        Q03pcm,
                        # isei08,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears, 
                        female,
                        agenum,
                        country2,country,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~isolation + homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +isolation+homclass+female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ isolation+homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ isolation+homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ isolation+homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- lmer(redist~class3*isolation+homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(full1,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, social isolation and social class" 
coefgroup <- list("Social Class (ref: Service Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Isolation x Social Class"=9:10
                  )

coefmap <-  list(isolation ="Perceived Isolation",
                 'class3Intermediate class (III+IV)' ='Intermediate Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "workstNot in paid work"="Not in labor force",
                 "unionYes" = 'Union membership: Yes',
                 'class3Intermediate class (III+IV):isolation'='Homogeneity x Intermediate Class',
                 'class3Working Class (V+VI+VII):isolation'='Homogeneity x Working Class',
                 # know_total="Number contacts"
                 # outgroup="Number outgroup"
                 homclass ="Class-based network homogeneity"
                 )

gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                float.pos="h!",
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )

```

```{r leverage2, eval=FALSE, include=FALSE}
pacman::p_load(influence.ME,lattice)
# dfbetas-----------------------------------------------------------------------
influence <- influence(rob3, "country2")
dfbetas(influence,parameters=c(1,4)) 
n_groups <- lme4::ngrps(rob3)

influence_est=as.data.frame(dfbetas(influence))
influence_est %>%  filter(homclass > 2/sqrt(n_groups))

plot(influence, which="dfbetas", 
     parameters=c("isolation"),
     xlab="DFbetaS", ylab="Country",cutoff = 2/sqrt(n_groups))

# cook-distance-----------------------------------------------------------------
# cooks.distance(rob3, sort = TRUE)
plot(influence, which="cook",
     cutoff=4/n_groups, sort=TRUE,
     xlab="Cooks Distance",
     ylab="Country")

sigtest1<- sigtest(influence, test=-1.96)
sigtest1$homclass
```


```{r marg2,fig.dim=c(4.1,2.6),fig.cap=c("Conditional marginal effects of Perceived Isolation on redistributive preferences"),out.width = "75%"}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
# Conditional Marginal effect
interplot <- 
interplot::interplot(m = int_homo,var1 = "isolation",var2="class3")
df_int <- interplot$data
df_int <- df_int[c(1,2,4),]
df_int$value <- c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)")
df_int$value <- factor(df_int$value,ordered = T,
                       levels = c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)"))

df_int %>% 
ggplot() + 
  geom_point(aes(x = value,y = coef1)) + 
  geom_errorbar(aes(x = value, ymin = lb, ymax = ub),color="black",width=0.1,size=1) +
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  ylab("Perceived Isolation")+
  xlab("Social Class")+
  ggtitle("Redistributive preferences") +
  geom_hline(yintercept = 0) + 
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  theme(plot.title = element_text(size = 8))  
```

```{r pred2,fig.height=3.6,fig.width=5.7,fig.cap=c("Predictions for Redistributive Preferences"),out.width = '75%'}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)       
# Predicted values 
plot_predictions(int_homo, condition = list("isolation","class3"),gray = F)+
  facet_grid(~factor(class3, levels=c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)")))+
    labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  theme(legend.position = "none")+ 
  xlab("Perceived Isolation")+
  ylab("Redistributive preferences")
```

```{r mod-intermacro2,results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass,
                        isolation,
                        # homclass=eindex,
                        # homclass=ingroup,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        workst) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# T03dim(dfreg)

main <- "redist~class3+ isolation+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2 +homclass"

giniD_gdp<-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(1|country2)")),data=dfreg)
giniD_rs <-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(isolation|country2)")),data=dfreg)
# anova(giniD_gdp,giniD_rs)
giniD_int<- lmer(formula(paste0(main,"+isolation*gini_disp+logrgdpna","+(isolation|country2)")),data=dfreg)
# summary(giniD_int)

giniM_gdp<- lmer(redist~class3+ isolation+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1|country2),data=dfreg)
giniM_rs<- lmer(redist~class3+ isolation+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+isolation|country2),data=dfreg)
# anova(giniM_gdp,giniM_rs)
giniM_int <- lmer(redist~class3+ isolation*gini_mkt+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+isolation|country2),data=dfreg)

models <- list(giniD_gdp,giniD_rs,giniD_int,
               giniM_gdp,giniM_rs,giniM_int)

texreg::knitreg(models,
                caption=paste("(\\#tab:modinter1)","Cross-level interaction for Perceived Isolation and Economic Inequality"),
                caption.above=T,
                  # include.thresholds=FALSE,
                  custom.coef.map=list(isolation="Perceived Isolation",
                                       logrgdpna="log GDP","gini_disp"="Gini (Disposable) ",
                                       "isolation:gini_disp"="Isolation x Gini (D)",
                                       "gini_mkt"="Gini (Market) ",
                                       "isolation:gini_mkt"="Isolation x Gini (M)",
                                       homclas="Class-based homogeneity"),
                  # groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r crosslevel2}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,gridExtra)  
p1<- interplot::interplot(m = giniD_int,var1 = "isolation",var2="gini_disp")+
  ylab("Perceived Isolation coefficient")+ xlab("Gini disposable") +
  geom_point()+ geom_hline(yintercept = 0)

p2<- interplot::interplot(m = giniM_int,var1 = "isolation",var2="gini_mkt") +
  ylab("Perceived Isolation coefficient") + xlab("Gini market") +
  geom_point()+ geom_hline(yintercept = 0)

# Predicted values 
predval1 <- 
plot_predictions(giniD_int, condition = list("isolation",gini_disp=range),gray = T) +
  labs(caption = paste0("N=",nobs(giniD_int),", Countries=",lme4::ngrps(giniD_int)),
       linetype='Gini (Disposable)') +
  xlab("Perceived Isolation")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")

# Predicted values 
predval2 <- 
plot_predictions(giniM_int, condition = list("isolation",gini_mkt=range),gray = T)+
  labs(caption = paste0("N=",nobs(giniM_int),", Countries=",lme4::ngrps(giniM_int)),
       linetype='Gini (Market)') +
  xlab("Perceived Isolation")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")
``` 

```{r crossginiD2, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Perceived Isolation and Gini (Disposable)"),out.width='100%'}
grid.arrange(p1,predval1,nrow = 1    
             # Gini (Disposable)top = "Perceived Isolation × Gini (Disposable)"  
             )
```

```{r crossginiM2, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Perceived Isolation and Gini (Market)"),out.width='100%'}
grid.arrange(p2,predval2,nrow = 1    
             # top = "Perceived Isolation × Gini (Market)"  
             )
```

=======
>>>>>>> 2e289b60bf0d198ccb4ec79f00ea6bbd88b5df44
\pagebreak


# References

<div id="refs"></div>


# (APPENDIX) Appendix {-} 

`r if (knitr::is_latex_output()){ '\\appendix'}`          <!-- Si documento es latex, se genera sección de Anexos -->
`r if (knitr::is_latex_output()){ '\\section{Appendix}'}` <!-- Si documento es latex, se genera titulo de Anexos -->
```{r redistribution, echo=FALSE, fig.cap=c("Redistributive preferences by country in the ISSP 2017"), fig.height=4.5, fig.width=7.1, out.width='100%'}
# x country   
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
# df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
df1$redistF <- factor(df1$redist,levels = 1:5,labels = sjlabelled::get_labels(df1$redist))
dfreg <- df1 %>% dplyr::select(redist,
                        class3, 
                        homclass,
                        # homclass=eindex,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1,
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()

percentage_data <- df1 %>%
  group_by(country2, redistF) %>%
  summarise(count = n()) %>%
  group_by(country2) %>%
  na.omit() %>% 
  mutate(percentage = count / sum(count)) %>% 
  arrange(country2,redistF,percentage) %>% 
  mutate(pct_lab = paste0(round(percentage*100,1),"%")) %>% 
  mutate(pct_lab=ifelse(!redistF %in% c("Strongly agree"),NA,pct_lab))

order <- 
percentage_data %>% 
  filter(redistF=="Strongly agree") %>% 
  arrange(percentage) %>% 
  dplyr::select(country2)

order$orden <- 1:31
ggplot(percentage_data, aes(x=country2,y=percentage*100,fill=redistF,group=redistF,label = pct_lab))+
  geom_bar(stat = 'identity') +
  # geom_text(position = position_fill(vjust =100)) +
  scale_y_continuous(name=NULL,labels = scales::percent_format(scale = 1),limits = c(0,101), expand = c(0, 0)) +
  scale_x_discrete(limits=order$country2,name=NULL) +  
  scale_fill_ordinal(guide = guide_legend(reverse = TRUE)) +
  ggtitle(label= "Redistributive preferences") + 
  theme(legend.position = 'bottom',legend.title = element_blank(), text = element_text(size = 12))  +  
  coord_flip()
```
