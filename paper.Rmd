---
title: "Network segregation, Social Isolation and Preference for Redistribution across societies"
css: "input/css/custom.css" # custom CSS para html
linestretch: '1.5'          # interlineado 
link-citations: yes         # citas linkeadas
# date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
date: "`r format(Sys.Date(), '%d %B %Y')`"
author:
# - name: Julio Iturra-Sanhueza
#   affiliation: University of Bremen
#   email: jiturra@uni-bremen.de
#   number: 1
# - name: Justin d'Ottawa
#   affiliation: University of Ottawa
#   number: 2
# - name: Pedro Torres
#   number: 1,2 
# Nota: Autores que comparten filiacion, poner el mismo number y declarar filiación una sola vez.  
# abstract: "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do *eiusmod tempor* incididunt ut labore et dolore magna aliqua. Ut enimad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat."
output:
  bookdown::html_document2:
    toc: yes
    code_folding: hide
    toc_float:
      collapsed: false
      smooth_scroll: false
    number_sections: false   
  bookdown::pdf_document2:
    template: null
    toc: false
    keep_tex: false
    pandoc_args:
      - --template=input/mytemplate.tex #custom template para usar autores con afiliacion  
linkcolor: blue                         # enlaces y citas en color azul
bibliography: input/bib/rgroup-redist.bib     # bibliografia en bibtex
csl: input/bib/apa6.csl
editor_options:
  chunk_output_type: console            # en RStudio, mostrar output en consola
geometry: "left=2cm,right=2cm,top=3cm,bottom=3cm" # márgenes de página
header-includes:
  - \usepackage{times}           # Times New Roman
  - \usepackage{caption}
  - \captionsetup[figure, table]{labelfont={bf},labelformat={default},labelsep=period}
  - \usepackage{graphicx}
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
---

<!-- - considerar ISEI08 como alternativa de social class por la correlacion con homogeneidad -->
<!-- - darle una oportunidad al h-index -->
<!--     - en general es prácticamente lo mismo que el indicador de homogeneidad -->
<!-- - controlaria por social activities index () -->
<!-- - social resources  -->
    


```{r setup, include=FALSE}
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(knitr, kableExtra, dplyr, ggplot2,sjmisc,texreg) # librerias
knitr::opts_chunk$set(warning = FALSE,  # mensaje de warning
                      message = FALSE,  # mensajes/avisos de librerias  
                      cache = F,    # cache de los chunks,usar analisis pesados
                      out.width = '100%',
                      fig.pos= "H",     # posicion figuras H = HERE
                      fig.align = "center",
                      echo = FALSE      # incluir chunk en output
                      )
options(scipen=999) # notacion cientifica
rm(list=ls())       # limpiar workspace
options(knitr.kable.NA = '') # NA en kable = ''
```


```{r}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(theme_minimal())
ggplot2::theme_update(text=element_text(size=10,  family="serif"))  
```

#  Introduction

The escalating economic inequality and the current sanitary crisis have threatened social cohesion among citizens. However, these consequences have been unevenly experienced across the social structure. The upper and intermediate classes, benefiting from privileged access to social resources, have shown resilience. Conversely, working-class families have faced deteriorating material conditions, leading to a heightened sense of marginalisation and increasing the demand for welfare support. Particularly, social resources through network ties have been suggested to have a direct link with an individual’s welfare through instrumental and expressive outcomes, such as providing information or help in moments of need. Consequently, inequalities in access to certain social positions (i.e. occupations) are translated into a lack of social resources beyond individual economic and cultural capital. Additionally, it has been argued that social isolation not only plays a role in terms of resources but given that higher levels of segregation can bolster opinions, it is argued that being isolated from other social classes can polarise attitudes mainly in the working and upper-middle classes. Employing data from the International Social Survey Programme - Social Networks  this research aims to understand to what extent the demand for redistribution is linked to social ties. For addressing this, ego-centred social networks are used to represent the degree of class-based homogeneity of social ties. The results of multilevel estimations show that being socially segregated increases demand for redistribution. Additionally, this influence is conditional to social class, where the working and intermediate classes with highly homogeneous networks demand more governmental redistribution than the upper class. At the macro level, as the current distribution of economic resources influences the opportunity structure, it has been hypothesised that income inequality could bolster the influence of social segregation on the demand for redistribution. However, cross-level interactions do not provide supporting evidence on this behalf. 

network segregation decreases  attachment to society (Otero et al., 2022) 


subjective marginalization increases alienation (Gidron & Hall, 2020)


social ties with lower or upper class influence welfare attitudes aligned to class interests (Paskov & Weisstanner, 2022; Lindh et al., 2021) 


Focus on the sociability/relational dimension and its consequences on inequality attitudes - redistributive and welfare attitudes



The literature review (possible structure)

* Class and political attitudes (Svallfors, Edlund & Lindh)
* Inequality in social networks (Lin, Wright, Bourdieu, Volker)
* Interplay of class, networks and attitudes toward inequality (Lindh, McCall) 

The literature have discussed two complementary social mechanisms that could explain what role does social ties play in shaping people's demand for redistribution. 

<!-- The structure of the social network provide access to social resources. On the one hand, contacts can be translated into resources, access to the life of others that could provide information and life opportunities.  -->

<!-- - stratified access to resources -->
<!-- - class and networks (focus of this paper) -->

<!-- Some research has connected social capital with economic rational dimension, while others have conected it to more value-driven or moralistic dimension  -->

<!-- Both assume direct effects, but other literature such as Otero et al has suggested that experiences might vary across social classes. -->

<!-- For example, we trust other people because we know about them (connected) -->


# Data, variables and methods

**Data**

International Social Survey - Social Networks 2017 


**Variables**

_Redistributive preferences_

A widely used method for evaluating people's views on redistribution is by employing a standard measure commonly found in the literature. The measure involves asking respondents to indicate their level of agreement with the statement, "It is the responsibility of the government to decrease the income gap between individuals with high and low incomes." Respondents are asked to indicate their level of agreement on a scale of one to five, with one being "Strongly agree" and five being "Strongly disagree." In this case, a reverse code is utilized to interpret higher values as indicating greater support for redistribution.

_Social Class_

A synthetic version of the EGP class was used, including three main classes: Service class (I+II), Intermediate class (III+IV) and Working class (V+VI+VII)

_Class-based network homogeneity_

For measuring the personal network of the respondent, a short version of the position generator was included in the survey, which presents a set of ten occupations that seek to represent the hierarchical status order in society [@joye_measuring_2019], declaring four possible response alternatives: "Family or relative", "Close friend", "Someone else I know" or "No one". For this research, a binary variable is created by coding the first three categories as 1 and the last one as 0, representing if the person knows (or not) one of the occupations. The following text corresponds to the original phrasing of the questionnaire:  

> *Here is a list of jobs that people you know may have. These people could be family or relatives, close friends or someone else you know. By "knowing" a person, we mean that you know him/her by name and well enough to contact him/her. If you know several people who have a job from the list below, please only tick the box for the person who you feel closest to. Each of these jobs could be held by a woman or a man.*

Therefore, Table \@ref(tab:posgen) shows the classification of each occupation into three status groups according to their scores in the International Socioeconomic Index (ISEI)[@ganzeboom_internationally_1996].  

```{r posgen}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,knitr,kableExtra)
rm(list=ls())
options(knitr.kable.NA = '') # NA en kable = ''
cap <- "Clasification of occupations of the position generator in the ISSP 2017"
xlsx::read.xlsx(file = "input/tables/tables.xlsx",sheetName = "ties") %>% 
  kable(caption = cap) %>% 
  kable_styling(full_width = F) 
```

Consequently, we calculate the number of contacts that belong to a similar class/status to create the number of ingroup and outgroup contacts. It is considered ingroup (i) when the ego's class matches the Alter's status. This measure represents the proportion of similar contacts, where 0 implies that all contacts are different to Ego's social class, while 1 represents complete network homogeneity. Therefore, higher values represent greater social distance from other groups in society. The calculation of the class-based network homogeneity variables is as follows:  

$$H_i= \frac{\text{Ingroup}}{(\text{Ingroup}+\text{Outgroup})}$$ 

_Perceived Isolation_ 

"The next questions are about how you feel about different aspects of your life. For each one, please indicate how often during the past 4 weeks you have felt that way. How often in the past 4 weeks have you felt that..." 1) "companionship lacking?",(2) "isolated from others?" and (3) "left out?". 

The response categories are  (1)"Never", (2)"Rarely", (3) "Sometimes", (4)"Often" and  (5)"Very often". As the indicators show an acceptable internal consistency (α=.85), an index of the three items was created. Positive values indicate higher perceived isolation. 

**Methods**

- Multilevel regression with random intercept and slopes 

<!-- Across all countries, a nurse (41.2%) and a schoolteacher (39.6%) are mentioned the most often and a human resource manager (19.2%) and a lawyer (22.2%) the least often. Considering the scope of the network, Suriname (42%), the United States (41.4%), and Iceland (41.3%) are the countries in which respondents are connected to the widest array of occupations, while Thailand (13.2%), Japan (15%), and Taiwan (18.9%) represent the other end. The social network thus is larger and more diverse in the former countries -->

# Results

## Descriptive


```{r redistribution,fig.height=4.5,fig.width=7.1,fig.cap=c("Redistributive preferences by country in the ISSP 2017"), out.width = '50%'}
# x country   
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
# df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
df1$redistF <- factor(df1$redist,levels = 1:5,labels = sjlabelled::get_labels(df1$redist))
dfreg <- df1 %>% dplyr::select(redist,
                        class3, 
                        homclass,
                        # homclass=eindex,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1,
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
 
percentage_data <- df1 %>%
  group_by(country2, redistF) %>%
  summarise(count = n()) %>%
  group_by(country2) %>%
  na.omit() %>% 
  mutate(percentage = count / sum(count)) %>% 
  arrange(country2,redistF,percentage) %>% 
  mutate(pct_lab = paste0(round(percentage*100,1),"%")) %>% 
  mutate(pct_lab=ifelse(!redistF %in% c("Strongly agree"),NA,pct_lab))

order <- 
percentage_data %>% 
  filter(redistF=="Strongly agree") %>% 
  arrange(percentage) %>% 
  dplyr::select(country2)

order$orden <- 1:31
ggplot(percentage_data, aes(x=country2,y=percentage*100,fill=redistF,group=redistF,label = pct_lab))+
  geom_bar(stat = 'identity') +
  # geom_text(position = position_fill(vjust =100)) +
  scale_y_continuous(name=NULL,labels = scales::percent_format(scale = 1),limits = c(0,101), expand = c(0, 0)) +
  scale_x_discrete(limits=order$country2,name=NULL) +  
  scale_fill_ordinal(guide = guide_legend(reverse = TRUE)) +
  ggtitle(label= "Redistributive preferences") + 
  theme(legend.position = 'bottom',legend.title = element_blank(), text = element_text(size = 12))  +  
  coord_flip()
```

```{r homogeneity,fig.height=3.4,fig.width=6,fig.cap=c("Class-based network homogeneity by country in the ISSP 2017"), out.width = '50%'}
# x country
dfreg <- bind_cols(dfreg,sjmisc::to_dummy(x = dfreg$class3,suffix = "numeric"))
resits_count <- dfreg %>%
  group_by(country2,country) %>%
  summarise_at(c("redist","homclass",
                 "class3_1","class3_2","class3_3"), mean, na.rm = TRUE) %>% 
  as.data.frame()
resits_count$country3 <- countrycode::countrycode(sourcevar = resits_count$country,origin = "iso3n",destination = "iso3c")

myorder <-  resits_count$country2[order(resits_count$homclass)]
ggplot(data = resits_count,aes(x =country2,y = homclass)) + 
  geom_segment(aes(x=country2, xend=country2, y=0, yend=homclass), color="black") +
  geom_point() +
  scale_x_discrete(limits=myorder) +
  ylab("Class-based homogeneity")+   
  xlab("") +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1.2))    
```

```{r class-hom,fig.height=7,fig.width=7,fig.cap=c("Redistribution, Network homogeneity and Social Class in the ISSP 2017"), out.width = '50%'}
sizetext <- 2.5

predis <-  
resits_count %>%  
ggplot(aes(y=redist, x=homclass)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0.3,0.5))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Class homogeneity")+
  ylab("Redistributive preferences") +
  labs(title = "Redistributive preferences and Class homogeneity",
       caption =paste("r=",round(cor(resits_count$homclass, 
                                     resits_count$redist),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$redist)


p1 <- resits_count %>%  
ggplot(aes(y=homclass, x=class3_3)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Working class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Working class (%)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$class3_3),digits = 2),""))

# cor.test(resits_count$homclass,resits_count$class3_3)

p2 <- resits_count %>%  
ggplot(aes(y=homclass, x=class3_2)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Intermediate class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Intermediate class (%)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$class3_2),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$class3_2)
p3 <- resits_count %>%  
ggplot(aes(y=homclass, x=class3_1)) +
  # geom_point() +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Service class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Service class (%)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$class3_1),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$class3_3)
grid.arrange(predis,p1,p2,p3,nrow = 2)
```


<!-- - perceived isolation x redistribution (1 plot) -->
<!-- - homogeneity x perceived isolation (1 plot) -->

## Individual level

1. Class: 
    - having a working class position is associated with higher redistributive preferences
    - class homogeneity is higher among the working class, and lower in the upper-class

2. Network segregation
    - being more segregated in terms of network homogeneity increase demand for redistribution 
    
<!-- - Perceived isolation -->
<!--   - perceived isolation increases redistributive preferences -->
  
<!-- Note: network segregation decreases perceived isolation *   -->

3. Network segregation x Social Class
    - The influence of homogeneity is positive among the working and intermediate classes, and negative among the upper class 
    
```{r mod-homclass,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)") 
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,class5,
                        homclass,
                        Q05pcm,
                        Q03pcm,
                        # isei08,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        giniindex,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1,
                        isolation,
                        MAINSTAT,
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1 + union+ female+agenum +age2 + (1|country2),data=dfreg)
rob4 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1 + union+ female+agenum +age2 + (homclass|country2),data=dfreg)
# anova(rob3,rob4)
# plot_model(rob4,type = "re",show.values = T)

# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# int_homo2 <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+  (homclass + class3*homclass|country2),data=dfreg)
# anova(int_homo,int_homo2)
# plot_model(int_homo2,type = "re",show.values = F,vline.color = "black")

# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 # know_total="Number contacts"
                 # outgroup="Number outgroup"
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )

```

```{r leverage1, eval=FALSE, include=FALSE}
pacman::p_load(influence.ME,lattice)
# dfbetas-----------------------------------------------------------------------
influence <- influence(rob3, "country2")
dfbetas(influence,parameters=c(1,4)) 
n_groups <- lme4::ngrps(rob3)

influence_est=as.data.frame(dfbetas(influence))
influence_est %>%  filter(homclass > 2/sqrt(n_groups))

plot(influence, which="dfbetas", 
     parameters=c(1,4),
     xlab="DFbetaS", ylab="Country",cutoff = 2/sqrt(n_groups))

# cook-distance-----------------------------------------------------------------
# cooks.distance(rob3, sort = TRUE)
plot(influence, which="cook",
     cutoff=4/n_groups, sort=TRUE,
     xlab="Cooks Distance",
     ylab="Country")

sigtest1<- sigtest(influence, test=-1.96)
sigtest1$homclass
```


```{r marg1,fig.dim=c(4.1,2.6),fig.cap=c("Conditional marginal effects of Network homogeneity on redistributive preferences"),out.width = "50%"}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)   
# Conditional Marginal effect
interplot <- 
interplot::interplot(m = int_homo,var1 = "homclass",var2="class3")
df_int <- interplot$data
df_int <- df_int[c(1,2,4),]
df_int$value <- c("Intermediate class (III+IV)","Service Class (I+II)","Working Class (V+VI+VII)")
df_int$value <- factor(df_int$value,ordered = T,
                       levels = c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)")) 

df_int %>% 
ggplot() +
  geom_point(aes(x = value,y = coef1)) + 
  geom_errorbar(aes(x = value, ymin = lb, ymax = ub),color="black",width=0.1,size=1) +
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  ylab("Class-based homogeneity")+
  xlab("Social Class")+
  ggtitle("Redistributive preferences") +
  geom_hline(yintercept = 0) + 
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +    
  theme(plot.title = element_text(size = 8))  
```

```{r pred1,fig.height=3.6,fig.width=5.7,fig.cap=c("Predictions for Redistributive Preferences"),out.width = '50%'}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,gridExtra,papaja)        
# Predicted values 

plot_predictions(int_homo, condition = c("homclass","class3")) +
  facet_grid(~factor(class3, levels=c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)")))+
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "none", legend.title = element_blank())
  # scale_fill_grey(start = 0.40, end = 0.6) +
  # scale_color_grey(start = 0.40, end = 0.6)
```



\pagebreak
## Macro level

  - expected: economic inequality increases segregation (maybe weak or null effect)
  - expected: economic inequality increase the influence of network homogeneity/segregation
  
```{r ineq-homo,fig.height=4,fig.width=7.5,fig.cap=c("Network Homogeneity and Income Inequality in the ISSP 2017"), out.width = '50%'}
sizetext <- 2.5
resits_count <- dfreg %>%
  group_by(country2,country) %>%
  summarise_at(c("redist","homclass", 
                 "gini_disp","gini_mkt","giniindex"), mean, na.rm = TRUE) %>% 
  as.data.frame()
resits_count$country3 <- countrycode::countrycode(sourcevar = resits_count$country,origin = "iso3n",destination = "iso3c")
p1 <- resits_count %>%  
ggplot(aes(y=homclass, x=gini_disp)) +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Gini (Disposable)")+
  ylab("Class homogeneity") +
  labs(
    # title = "Class homogeneity and Income Inequality (Disposable)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$gini_disp),digits = 2),""))
# cor.test(resits_count$homclass,resits_count$gini_disp)
p2 <- resits_count %>%  
ggplot(aes(y=homclass, x=gini_mkt)) +
  geom_text(label=as.character(resits_count$country3),size=sizetext) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Gini (Market)")+
  ylab("Class homogeneity") +
  labs(
    # title = "Class homogeneity and Income Inequality (Market)",
       caption =paste("r=",round(cor(resits_count$homclass,
                                     resits_count$gini_mkt),digits = 2),"")) 

# cor.test(resits_count$homclass,resits_count$class3_3)
grid.arrange(p1,p2,nrow = 1)
```

  <!-- - expected: in unequal countries the effect of network segregation and perceived isolation will be stronger  -->

```{r mod-intermacro,results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjlabelled,haven,stringr,sjPlot)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_gc,
                        # homclass=eindex,
                        # homclass=ingroup,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        # giniot=gini,
                        giniot=gv_spen,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        labst,
                        labst1,
                        isolation,
                        MAINSTAT) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>%
  na.omit()
# T03dim(dfreg)

main <- "redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2"

giniD_gdp<-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(1|country2)")),data=dfreg)
giniD_rs <-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(homclass|country2)")),data=dfreg)
# anova(giniD_gdp,giniD_rs)
giniD_int<- lmer(formula(paste0(main,"+homclass*gini_disp+logrgdpna","+(homclass|country2)")),data=dfreg)
# summary(giniD_int)

giniM_gdp<- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1|country2),data=dfreg)
giniM_rs<- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+homclass|country2),data=dfreg)
# anova(giniM_gdp,giniM_rs)
giniM_int <- lmer(redist~class3+ homclass*gini_mkt+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+homclass|country2),data=dfreg)
# anova(giniOT_gdp,giniOT_rs)

models <- list(giniD_gdp,giniD_rs,giniD_int,
               giniM_gdp,giniM_rs,giniM_int)

texreg::knitreg(models,
                caption=paste("(\\#tab:modinter1)","Cross-level interaction for Network homogeneity and Economic Inequality"),
                caption.above=T,
                  # include.thresholds=FALSE,
                  custom.coef.map=list(homclass="Network Homogeneity",
                                       logrgdpna="log GDP","gini_disp"="Gini (Disposable) ",
                                       "homclass:gini_disp"="Homogeneity x Gini (D)",
                                       "gini_mkt"="Gini (Market) ",
                                       "homclass:gini_mkt"="Homogeneity x Gini (M)"),
                  # groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r crosslevel}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,gridExtra)       
p1<- interplot::interplot(m = giniD_int,var1 = "homclass",var2="gini_disp")+
  ylab("Class-based homogeneity coefficient")+ xlab("Gini disposable") + 
  geom_point()+ geom_hline(yintercept = 0)

p2<- interplot::interplot(m = giniM_int,var1 = "homclass",var2="gini_mkt") +
  ylab("Class-based homogeneity coefficient")+ xlab("Gini market") +geom_point()+ geom_hline(yintercept = 0)

 
# Predicted values 
predval1 <- 
plot_predictions(giniD_int, condition = list("homclass",gini_disp=range),gray = F) +
  labs(caption = paste0("N=",nobs(giniD_int),", Countries=",lme4::ngrps(giniD_int)),
       colour='Gini (Disposable)',fill='Gini (Disposable)') +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")

# Predicted values 
predval2 <- 
plot_predictions(giniM_int, condition = list("homclass",gini_mkt=range),gray = F)+
  labs(caption = paste0("N=",nobs(giniM_int),", Countries=",lme4::ngrps(giniM_int)),
       colour='Gini (Disposable)',fill='Gini (Disposable)') +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")
```

```{r crossginiD, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Network homogeneity and Gini (Disposable)"),out.width='60%'}
grid.arrange(p1,predval1,nrow = 1 
             # top = "Network homogeneity × Gini (Disposable)"   
             )
```

```{r crossginiM, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Network homogeneity and Gini (Market)"),out.width='60%'}
grid.arrange(p2,predval2,nrow = 1  
             # top = "Network homogeneity × Gini (Market)"
             ) 
```

\pagebreak

# References

<div id="refs"></div>

# Other analysis

- Perceived Isolation
- Network homogeneity (Strong ties)
- Network homogeneity (Weak ties)
- R's and Partner social class
- Homogeneity x other macro variables

## Perceived Isolation

```{r mod-isolation,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
df1$eindex2<- (df1$ingroup-df1$outgroup)/(df1$outgroup+df1$ingroup)

dfreg <- df1 %>% dplyr::select(redist,
                        class3,class5,
                        homclass,
                        isolation,
                        Q05pcm,
                        Q03pcm,
                        # isei08,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears, 
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~isolation + homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +isolation+homclass+female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ isolation+homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ isolation+homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ isolation+homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- lmer(redist~class3*isolation+homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(full1,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, social isolation and social class" 
coefmap <-  list(isolation ="Perceived Isolation",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):isolation'='Isolation x Service Class',
                 'class3Working Class (V+VI+VII):isolation'='Isolation x Working Class',
                  homclass ="Class-based network homogeneity"
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Isolation x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )

```

```{r leverage2, eval=FALSE, include=FALSE}
pacman::p_load(influence.ME,lattice)
# dfbetas-----------------------------------------------------------------------
influence <- influence(rob3, "country2")
dfbetas(influence,parameters=c(1,4)) 
n_groups <- lme4::ngrps(rob3)

influence_est=as.data.frame(dfbetas(influence))
influence_est %>%  filter(homclass > 2/sqrt(n_groups))

plot(influence, which="dfbetas", 
     parameters=c("isolation"),
     xlab="DFbetaS", ylab="Country",cutoff = 2/sqrt(n_groups))

# cook-distance-----------------------------------------------------------------
# cooks.distance(rob3, sort = TRUE)
plot(influence, which="cook",
     cutoff=4/n_groups, sort=TRUE,
     xlab="Cooks Distance",
     ylab="Country")

sigtest1<- sigtest(influence, test=-1.96)
sigtest1$homclass
```


```{r marg2,fig.dim=c(4.1,2.6),fig.cap=c("Conditional marginal effects of Perceived Isolation on redistributive preferences"),out.width = "50%"}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
# Conditional Marginal effect
interplot <- 
interplot::interplot(m = int_homo,var1 = "isolation",var2="class3")
df_int <- interplot$data
df_int <- df_int[c(1,2,4),]
df_int$value <- c("Intermediate class (III+IV)","Service Class (I+II)","Working Class (V+VI+VII)")
df_int$value <- factor(df_int$value,ordered = T,
                       levels = c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)"))

df_int %>% 
ggplot() + 
  geom_point(aes(x = value,y = coef1)) + 
  geom_errorbar(aes(x = value, ymin = lb, ymax = ub),color="black",width=0.1,size=1) +
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  ylab("Perceived Isolation")+
  xlab("Social Class")+
  ggtitle("Redistributive preferences") +
  geom_hline(yintercept = 0) + 
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  theme(plot.title = element_text(size = 8))  
```

```{r pred2,fig.height=3.6,fig.width=5.7,fig.cap=c("Predictions for Redistributive Preferences"),out.width = '50%'}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)       
# Predicted values 
plot_predictions(int_homo, condition = list("isolation","class3"),gray = F)+
  facet_grid(~factor(class3, levels=c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)")))+
    labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo))) +
  theme(legend.position = "none")+ 
  xlab("Perceived Isolation")+
  ylab("Redistributive preferences")
```

```{r mod-intermacro2,results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass,
                        isolation,
                        # homclass=eindex,
                        # homclass=ingroup,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        labst,
                        labst1) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# T03dim(dfreg)

main <- "redist~class3+ isolation+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2 +homclass"

giniD_gdp<-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(1|country2)")),data=dfreg)
giniD_rs <-lmer(formula(paste0(main,"+gini_disp+logrgdpna","+(isolation|country2)")),data=dfreg)
# anova(giniD_gdp,giniD_rs)
giniD_int<- lmer(formula(paste0(main,"+isolation*gini_disp+logrgdpna","+(isolation|country2)")),data=dfreg)
# summary(giniD_int)

giniM_gdp<- lmer(redist~class3+ isolation+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1|country2),data=dfreg)
giniM_rs<- lmer(redist~class3+ isolation+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+isolation|country2),data=dfreg)
# anova(giniM_gdp,giniM_rs)
giniM_int <- lmer(redist~class3+ isolation*gini_mkt+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ gini_mkt + logrgdpna+ (1+isolation|country2),data=dfreg)

models <- list(giniD_gdp,giniD_rs,giniD_int,
               giniM_gdp,giniM_rs,giniM_int)

texreg::knitreg(models,
                caption=paste("(\\#tab:modinter1)","Cross-level interaction for Perceived Isolation and Economic Inequality"),
                caption.above=T,
                  # include.thresholds=FALSE,
                  custom.coef.map=list(isolation="Perceived Isolation",
                                       logrgdpna="log GDP","gini_disp"="Gini (Disposable) ",
                                       "isolation:gini_disp"="Isolation x Gini (D)",
                                       "gini_mkt"="Gini (Market) ",
                                       "isolation:gini_mkt"="Isolation x Gini (M)",
                                       homclas="Class-based homogeneity"),
                  # groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r crosslevel2}
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,gridExtra)  
p1<- interplot::interplot(m = giniD_int,var1 = "isolation",var2="gini_disp")+
  ylab("Perceived Isolation coefficient")+ xlab("Gini disposable") +
  geom_point()+ geom_hline(yintercept = 0)

p2<- interplot::interplot(m = giniM_int,var1 = "isolation",var2="gini_mkt") +
  ylab("Perceived Isolation coefficient") + xlab("Gini market") +
  geom_point()+ geom_hline(yintercept = 0)

# Predicted values 
predval1 <- 
plot_predictions(giniD_int, condition = list("isolation",gini_disp=range),gray = T) +
  labs(caption = paste0("N=",nobs(giniD_int),", Countries=",lme4::ngrps(giniD_int)),
       linetype='Gini (Disposable)') +
  xlab("Perceived Isolation")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")

# Predicted values 
predval2 <- 
plot_predictions(giniM_int, condition = list("isolation",gini_mkt=range),gray = T)+
  labs(caption = paste0("N=",nobs(giniM_int),", Countries=",lme4::ngrps(giniM_int)),
       linetype='Gini (Market)') +
  xlab("Perceived Isolation")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")
``` 

```{r crossginiD2, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Perceived Isolation and Gini (Disposable)"),out.width='50%'}
grid.arrange(p1,predval1,nrow = 1    
             # Gini (Disposable)top = "Perceived Isolation × Gini (Disposable)"  
             )
```

```{r crossginiM2, fig.height=4,fig.width=9.3,fig.cap=c("Cross-level interaction for Perceived Isolation and Gini (Market)"),out.width='50%'}
grid.arrange(p2,predval2,nrow = 1    
             # top = "Perceived Isolation × Gini (Market)"  
             )
```

## Strong & weak ties

___Homogeneity: strong ties___

```{r mod-strongties,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_s,
                        # homclass=eindex_s,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity (strong) and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity (Strong)",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

___Homogeneity: weak ties___

```{r mod-weakties,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_w,
                        # homclass=eindex_w,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity (weak) and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity (Weak)",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

___Homogeneity: respondent class___

```{r mod-ownclass, cache=TRUE, results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$class3spo <- relevel(df1$class3spo,ref =  "Intermediate class (III+IV)")

df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3=class3res,
                        class3spo,
                        homclass,
                        # homclass=eindex_res,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- lmer(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- lmer(redist~ class3+ (1|country2),data=dfreg)
homclass <- lmer(redist~homclass + (1|country2),data=dfreg)
full1 <- lmer(redist~ class3 +homclass+ female+agenum + age2+ (1|country2),data=dfreg)
rob1 <- lmer(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
rob4 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ class3spo +(1|country2),data=dfreg)
rob5 <- lmer(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ class3spo +(homclass|country2),data=dfreg)

# Interactions segregation x class
int_homo <- lmer(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ class3spo +(1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and Own social class " 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class',
                 'class3spoService Class (I+II)' ='Service Class (Partner)',
                 "class3spoWorking Class (V+VI+VII)"='Working Class (Partner)'
                
                 )
coefgroup <- list("Social Class - Resp. (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,rob4,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

## Other macro variables

Source: https://www4.wider.unu.edu/?ind=1&type=ChoroplethSeq&year=70&byCountry=false&slider=buttons


* The **Palma ratio** is the share of all income received by the 10% people with highest disposable income divided by the share of all income received by the 40% people with the lowest disposable income.
<!-- * **90/10 ratio** = the ratio of Decile 10 income to Decile 1 income -->
<!-- * 90/50 ratio = the ratio of Decile 10 income to Decile 5 income (the median) -->
<!-- * 50/10 ratio = the ratio of Decile 5 income (the median) to Decile 1 income. -->

```{r mod-other-macro,fig.height=3,fig.width=6,out.width='70%',results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_gc,
                        # homclass=homclass_res,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        giniindex,ttheilge1,
                        gv_spen=gv_spen,
                        top10,
                        middle50,
                        palmaratio,
                        rgdpna,
                        individualism,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        labst,
                        labst1,
                        isolation,
                        MAINSTAT) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
    # filter(!country2 %in% c("Turkey","Estonia")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>%
   na.omit()


int_palma <- lmer(redist~class3+ isolation+homclass*palmaratio+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+logrgdpna + (1+homclass|country2),data=dfreg)
int_pc10  <- lmer(redist~class3+ isolation+homclass*top10+edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_pc50  <- lmer(redist~class3+ isolation+homclass*middle50+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_gini_wiid  <- lmer(redist~class3+ isolation+homclass*giniindex+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_theil  <- lmer(redist~class3+ isolation+homclass*ttheilge1+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+logrgdpna +(1+homclass|country2),data=dfreg)
int_indivi<- lmer(redist~class3+ isolation+homclass*individualism+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+logrgdpna + (1+homclass|country2),data=dfreg)
int_govspe<- lmer(redist~class3+ isolation+homclass*gv_spen+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+logrgdpna + (1+homclass|country2),data=dfreg)

models_m <- list(int_palma,int_pc10,int_pc50,int_indivi,int_govspe
                 # int_gini_wiid,int_theil
                 )

cap1=c("Cross-level interaction for Network homogeneity and Economic Inequality")
customcoef <- 
list(homclass = "Class-based network homogeneity",
  logrgdpna           = "log GDP",
  palmaratio               = "Palma Ratio",
  "homclass:palmawd"      = "Homogeneity x Palma Ratio",
  top10             = "Share National Income - top 10%",
  "homclass:top10"    = "Homogeneity x top 10",
  middle50             = "Share National Income -  bottom 50%",
  "homclass:middle50"    = "Homogeneity x bottom 50",
  individualism         = "Individualism Index*",
  "homclass:individualism" = "Homogeneity x Individualism",
  gv_spen               = "Gov. Spending (% GDP)*",
  "homclass:gv_spen"      = "Homogeneity x Gov. Spend."
)
texreg::knitreg(models_m,
                custom.coef.map = customcoef,
                caption.above = T,caption = cap1)
```

```{r,fig.height=4,fig.width=12,fig.cap=c("Cross-level interaction for Network homogeneity and Economic Inequality"),out.width='100%',results='asis'}
p3<- interplot::interplot(m = int_palma,var1 = "homclass",var2="palmaratio") +
  xlab("Palma ratio (top 10%/ bottom 40%)") + geom_point()+ geom_hline(yintercept = 0) +
    labs(caption = paste0("N=",nobs(int_palma),", Countries=",lme4::ngrps(int_palma)))

# plot_predictions(int_palma, condition = list("homclass",palmaratio=range),gray = F) +
#   labs(caption = paste0("N=",nobs(int_indivi),", Countries=",lme4::ngrps(int_indivi)),
#        linetype='Palma Ratio') +
#   xlab("Class-based homogeneity")+
#   ylab("Redistributive preferences") +
#   theme(legend.position = "right")

p4<- interplot::interplot(m = int_pc10,var1 = "homclass",var2="top10") +
  xlab("Share National Income -  top 10%") + geom_point()+ geom_hline(yintercept = 0) +
  labs(caption = paste0("N=",nobs(int_pc10),", Countries=",lme4::ngrps(int_pc10)))  

# plot_predictions(int_pc10, condition = list("homclass",top10=range),gray = F) +
#   labs(caption = paste0("N=",nobs(int_indivi),", Countries=",lme4::ngrps(int_indivi)),
#        linetype='Palma Ratio') +
#   xlab("Class-based homogeneity")+
#   ylab("Redistributive preferences") +
#   theme(legend.position = "right")
p5<- interplot::interplot(m = int_pc50,var1 = "homclass",var2="middle50") +
  xlab("Share National Income - middle 50%") + geom_point()+ geom_hline(yintercept = 0) +
  labs(caption = paste0("N=",nobs(int_pc50),", Countries=",lme4::ngrps(int_pc50)))   

# plot_predictions(int_pc50, condition = list("homclass",middle50=range),gray = F) +
#   labs(caption = paste0("N=",nobs(int_indivi),", Countries=",lme4::ngrps(int_indivi)),
#        linetype='Palma Ratio') +
#   xlab("Class-based homogeneity")+
#   ylab("Redistributive preferences") +
#   theme(legend.position = "right")


# interplot::interplot(m = int_gini_wiid,var1 = "homclass",var2="giniindex") +
#   xlab("Gini (WIID)") + geom_point()+ geom_hline(yintercept = 0) +
#     labs(caption = paste0("N=",nobs(int_gini_wiid),", Countries=",lme4::ngrps(int_gini_wiid)))

# interplot::interplot(m = int_theil,var1 = "homclass",var2="ttheilge1") +
#   xlab("Theil Index") + geom_point()+ geom_hline(yintercept = 0) +
#     labs(caption = paste0("N=",nobs(int_theil),", Countries=",lme4::ngrps(int_theil)))

# p6<- interplot::interplot(m = int_r1090,var1 = "homclass",var2="ratio10_50") +
#   xlab("Ratio (90/50)") + geom_point()+ geom_hline(yintercept = 0)+
#   labs(caption = paste0("N=",nobs(int_r1090),", Countries=",lme4::ngrps(int_r1090)))  
grid.arrange(p3,p4,p5,nrow = 1) 
```


```{r , fig.height=6,fig.width=8,fig.cap=c("Cross-level interaction for Network homogeneity, Gov. Spending and Individualism"),out.width='70%',}
# p7<- interplot::interplot(m = int_giniot,var1 = "homclass",var2="giniot") +
#   xlab("Gini Market*") + geom_point()+ geom_hline(yintercept = 0)+
#   labs(caption = paste0("N=",nobs(int_giniot),", Countries=",lme4::ngrps(int_giniot)))  

p8<- interplot::interplot(m = int_indivi,var1 = "homclass",var2="individualism") +
  xlab("Individualism Index*") + geom_point()+ geom_hline(yintercept = 0)+
  labs(caption = paste0("N=",nobs(int_indivi),", Countries=",lme4::ngrps(int_indivi)))  

predval8 <- 
plot_predictions(int_indivi, condition = list("homclass",individualism=range),gray = F) +
  labs(caption = paste0("N=",nobs(int_indivi),", Countries=",lme4::ngrps(int_indivi)),
       linetype='Individualism') +
  xlab("Class-based homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")


p9<- interplot::interplot(m = int_govspe,var1 = "homclass",var2="gv_spen") +
  xlab("Gov. Spending (% GDP)*") + geom_point()+ geom_hline(yintercept = 0)+
  labs(caption = paste0("N=",nobs(int_govspe),", Countries=",lme4::ngrps(int_govspe)))

predval9 <- 
plot_predictions(int_govspe, condition = list("homclass",gv_spen=range),gray = F) +
  labs(caption = paste0("N=",nobs(int_govspe),", Countries=",lme4::ngrps(int_govspe)),
       linetype='Gov.Spend') +
  xlab("Class-based homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")

grid.arrange(p9,predval9,
             p8,predval8,nrow = 2)
```




