---
title: "Class-based network segregation, Economic Inequality and Redistributive Preferences across societies"
css: "input/css/custom.css" # custom CSS para html
fontsize: 12pt
linestretch: '1.15'          # interlineado 
papersize: a4
link-citations: yes         # citas linkeadas
lang: en-US
# date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
date: "`r format(Sys.Date(), '%d %B %Y')`"
author:
- name: Julio Iturra-Sanhueza
  affiliation: Bremen International Graduate School of Social Sciences
  email: jiturra@uni-bremen.de
#   number: 1
# - name: Justin d'Ottawa
#   affiliation: University of Ottawa
#   number: 2
# - name: Pedro Torres
#   number: 1,2 
# Nota: Autores que comparten filiacion, poner el mismo number y declarar filiación una sola vez.  
abstract: | 
  | Escalating economic inequality has increased attention to the link between class-based social ties and redistributive preferences in contemporary societies. However, social classes are not equally affected by inequality regarding their chances of establishing cross-class social relations. While those in the upper and middle classes have greater access to economic and diverse social ties, the working class has been disproportionately affected by social exclusion. Consequently, this leads to a growing divide between their lives and the lives of others, consolidating segregated lifeworlds. Previous research has shown that the link between class relations and redistributive preferences can be enriched from a network perspective. Meeting people from diverse class positions can help individuals become more aware of the lifestyles and worldviews of others. On the one hand, when upper-class networks become more homogeneous, it can lead to lower empathy toward those in need and less support for redistributive policies. On the other hand, when there is segregation in lower-class social networks, it can lead to greater marginalization and a higher demand for welfare support. This study explores how class-based network segregation influences redistributive preferences from a cross-national perspective, employing data from the International Social Survey 2017, which comprised 32,529 individuals in 31 societies. The regression analyses indicate that network homogeneity has a conditional influence on redistributive preferences based on social class. Homogeneous social networks in the working and intermediate classes increase redistributive preferences, while greater homogeneity in the upper classes reduces support for redistribution. In addition, in contexts of greater income inequality, the conditional influence of network segregation weakens, especially for the upper classes. Implications for the study of class relations and policy preferences are discussed.
  | 
  | **Keywords**: social networks, social class, redistributive preferences, income inequality
output:
  bookdown::pdf_document2:
    template: null
    toc: false
    keep_tex: false
    number_sections: true
    pandoc_args:
      - --template=input/mytemplate.tex #custom template para usar autores con afiliacion  
  bookdown::html_document2:
    toc: yes
    code_folding: hide
    number_sections: false
    toc_float:
      collapsed: false
      smooth_scroll: false
         
always_allow_html: true      
linkcolor: gray                         # enlaces y citas en color azul
bibliography: input/bib/rgroup-redist.bib     # bibliografia en bibtex
csl: input/bib/apa6.csl
editor_options:
  chunk_output_type: console            # en RStudio, mostrar output en consola
geometry: "left=2.54cm,right=2.54cm,top=2.54cm,bottom=2.54cm" # márgenes de página
header-includes:
  - \usepackage{times}           # Times New Roman
  - \usepackage{caption}
  - \captionsetup[figure, table]{labelfont={bf},labelformat={default},labelsep=period}
  - \usepackage{graphicx}
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \setlength\parindent{24pt} 
  - \usepackage{fancyhdr}
  - \fancyhead{} 
---

```{r eval=FALSE, include=FALSE}
 # for render in pdf run rmarkdown::render_site("docs/paper.Rmd", output_format = "all")
 # clean #in the yml
 rmarkdown::render("paper1_jiturra.Rmd", output_format = "bookdown::pdf_document2")
 rmarkdown::render("paper1_jiturra.Rmd", output_format = "bookdown::html_document2")
 rmarkdown::render("paper1_jiturra.Rmd", output_format = "bookdown::word_document2")
 
 # install.packages("trackdown")
 trackdown::update_file(file = "paper1_jiturra.Rmd", hide_code = TRUE,gpath = '001_PhD/002dissertation/paper1')
                        
```

<!-- - considerar ISEI08 como alternativa de social class por la correlacion con homogeneidad -->
<!-- - darle una oportunidad al h-index -->
<!--     - en general es prácticamente lo mismo que el indicador de homogeneidad -->
<!-- - controlaria por social activities index () -->
<!-- - social resources  -->
    
```{r setup, include=FALSE}
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(knitr, kableExtra, dplyr, ggplot2,sjmisc,texreg) # librerias
knitr::opts_chunk$set(warning = FALSE,  # mensaje de warning
                      message = FALSE,  # mensajes/avisos de librerias  
                      cache = F,    # cache de los chunks,usar analisis pesados
                      out.width = '100%',
                      fig.pos= "H",     # posicion figuras H = HERE
                      fig.align = "center",
                      echo = FALSE      # incluir chunk en output
                      )
options(scipen=999) # notacion cientifica
rm(list=ls())       # limpiar workspace
options(knitr.kable.NA = '') # NA en kable = ''
```
\pagestyle{fancy}
\fancyhead[R]{\thepage}
\fancyhead[L]{Research Article Draft}

\pagebreak 

# Introduction  

The study of redistributive preferences and social class has been mainly focused on the individual and household situation. Despite this, less attention has been paid to the role of social networks as socialization agents of attitudes toward redistribution. It has been stated that friendship and partnership ties tend to be homogeneous in their characteristics, expressing the tendency to form and consolidate homophilous social networks [@mcpherson_birds_2001;@lazarsfeld_friendship_1954]. Thus, the scope of class analysis in attitude formation urges to be extended to stress the role of social ties and segregation as they involve social processes, such as class identity formation, internalization of shared norms, conflict, and cooperation between classes [@Svallfors2006]. In this respect, recent research has argued that the degree of segregation in the composition of social ties can influence opinions about economic inequality as they function as a window for learning about the lifestyles, economic conditions, and worldviews of other social classes [@mijs_inequality_2018;@otero_power_2023]. However, there is still a knowledge gap to disentangle the network mechanisms involved in political attitude formation about the role of government in enacting redistributive policies to strive against economic inequality [@mccall_americans_2009]. 

The class composition of network ties can influence opinions on redistributive policies, but also the degree of segregation from other social classes in more homogeneous social networks can strengthen the class divide in redistributive preferences  [@lindh_missing_2021;@lee_consider_2023;@paskov_crossclass_2022]. While prior research has predominantly focused on examining the impact of social class through an individualistic lens, it is noteworthy that more attention should be devoted to understanding the role of social environments in class relations. This omission is particularly surprising given that class positions are fundamentally rooted in production relations that make them inherently relational, not only in their economic underpinnings but also in the power dynamics entwined within class conflicts [@wright_comparative_1989]. In addition, the normative basis of class relations introduces the relevance of the dimensions of solidarity and reciprocity, which have been argued to provide the moral basis for legitimacy and popular support for welfare schemes [@mau_moral_2003]. 

Besides the individual dynamics, little is known about how contextual factors affect the relationship between networks and redistributive preferences. Previous studies have shown that wider economic gaps lead to segregated forms of social participation and status composition of social networks [@pichler_patterns_2007;@otero_space_2022]. Indeed, economic inequality reinforces the stratified access to social activities and the social distance between social classes, resulting in an increasing marginalization of the lower classes and consolidating the privileged positions of the upper classes that held better opportunities for diversifying their social activities and interpersonal ties [@lancee_income_2012;@letki_getting_2015;@otero_differences_2023]. Studies on the class-attitude link posit that economic inequality is crucial for understanding how class relations are reflected in redistributive demands as it represents the current state of the distributive class struggle in contemporary capitalist societies [@edlund_democratic_2015;@curtis_how_2015]. The main finding drawn from these studies is that the upper classes tend to hold more egalitarian attitudes in contexts of high inequality, while the attitudes of the working class remain stable regardless of inequality levels. In this discussion, the moral economy explanation argues that the upper classes are more concerned about the integrity of resource allocation procedures as a matter of distributive justice [@sachweh_why_2019]. Conversely, political economy research suggests that the upper classes are more likely to support redistribution policies due to the negative consequences of inequality [@dimick_altruistic_2017]. 

In this context, to our knowledge, no research has comparatively stressed the role of economic inequality in the relationship between network segregation and redistributive preferences. Therefore, the present study aims to answer two research questions. First, at the micro-level, what is the role of class-based network segregation on redistributive preferences? Secondly, at the macro level, to what extent does economic inequality condition the relationship between class-based network segregation and redistributive preferences? To address these questions, we have analyzed data from the International Social Survey Program (ISSP) 2017, which includes a sample of 32,529 individuals across 31 societies. In this regard, the ISSP presents a nonprecedence opportunity as it provides comprehensive information on interpersonal networks, social class, and attitudes toward redistribution.


# Theoretical views on class, social networks, and redistributive preferences

## Class divide in redistributive preferences 

Over the past decades, the study of redistributive preferences in industrialized societies has consistently demonstrated the importance of social class as a key explanatory factor  [@lindh_class_2020, p. 421]. Specifically, class positions have been shown to significantly influence individual opinions on the government's role in various aspects of the economic sphere, such as reducing income disparities or enhancing opportunities for those in economic distress [@mccall_americans_2009]. 

However, class-based explanations of redistributive preferences have mainly been, but not exclusively, focused on the individual or household situation. For instance, it has been claimed that redistributive preferences can be explained through the labor market situation, which comprises access to economic resources and risk exposure [@meltzer_rational_1981;@rehm_risks_2009].
Moreover, as material interests might prevail in scarcity, value-driven motivations are a relevant explanatory factor of redistributive preferences [@Kulin2013;@feldman_humanitarian_2001], becoming salient under greater certainty and weaker under material precariousness [@Maldonadoetal2019].Another group of studies has suggested that given the substantial time workers spend performing their jobs, social relations in the workspace can also imprint normative views that ultimately shape political opinions [@oesch_redrawing_2006]. It is argued that continuous interaction with diverse people that characterize interpersonal services can reinforce egalitarian values [@kitschelt_occupations_2014]. In contrast, the vertical monitoring in managerial occupations and the relevance of autonomy in the case of self-employed can contribute to self-interested and conservative political views [@langsaether_more_2020;@oesch_electoral_2018].

While our understanding of how social class influences public opinion on market-based resource distribution [@andersen_preferences_2018;@lindh_public_2015] and government income redistribution [@curtis_how_2015;@langsaether_more_2020;@brooks_why_2010;@Svallfors2006] is substantial, there remains a significant gap in our knowledge about the impact of class-based social relations from a network perspective on redistributive preferences.  

## Class relations and social networks

It is possible to argue that class relations represent not only resource-based distinctions but also patterns of sociability and exchange observed in the differentiation of social ties. Class relations can also be understood as the degree of cross-class relationship as a structural characteristic of a society, representing a network of social ties between different class positions [@blau_macrosociological_1977]. Empirically, homophily in social relations is a consistent finding in the social network literature [@mcpherson_birds_2001, p.416]. Here, friendship and family tend to be homogeneous in terms of their demographic characteristics that simultaneously intersect with socioeconomic status and class [@bargsted_pautas_2020; @plaza_juntos_2022;@lazarsfeld_friendship_1954]. Acknowledging that socialization preferences indeed play a role in the formation of segregated networks [@visser_attitudes_2004;@homans_human_1951], we argue that attitudinal similarity is the result of segregated social relations, which in turn are strongly linked to structural processes of differentiation that ultimately demarcate the opportunities in the formation of diverse social ties [@feld_focused_1981].

In the discussion on the class composition of social networks, it is possible to find two approaches. On the one hand, one approach has emphasized the role of diversity as the degree of connectedness to dissimilar occupations as social positions that vertically represent access to resources embedded in social networks [@lin_social_2007]. However, diversity is defined as the rate of dissimilar ties or the total ties to certain groups that do not necessarily count with a reference position to describe the network composition. On the other hand, a second approach has underscored the role of network segregation, which has been described as lacking cross-class network ties and is conceptually more proximate to the homophily principle because it is anchored in individual class positions [@otero_open_2021].

Empirically, studies on network diversity have shown that higher civic engagement in formal organizations increases the chances of bridging with diverse people among the upper class, in contrast to the more homogeneous participation of the working class [@pichler_social_2009]. Similar patterns have been found in terms of the composition of social ties, where the upper and intermediate classes hold increasingly diverse and prestigious social environments than the working classes [@cepic_how_2020;@carrascosa_class_2023]. Also, this segregation pattern holds during the life course, where the upper classes hold increasingly diverse social contacts in contrast to the stable networks of the working classes [@volker_social_2020]. In contrast, studies that have focused on segregation suggest that the property dimension is much less permeable than authority-based boundaries, given that class interests increase the social distance between proprietors and workers, while the intermediate class position of supervisors and contact frequency with workers make friendship tie formation more likely [@wright_relative_1992] Similar studies have shown that the intermediate classes' higher permeability contrasts with the working class's more homogeneous networks, suggesting that their limited resources and lower capacity to be socially engaged ultimately result in a lack of social resources that lead to social segregation. In contrast, the upper class is less permeable and homogeneous because it tends to self-select as a practice that ultimately seeks to reproduce its privileged positions [@otero_open_2021]. 


## Network segregation and attitudes toward redistribution 

In addition to individual-based explanations, it is argued that people form opinions in the economic domain based on their social relations. Despite limited research on the link between social networks and redistributive preferences, I identify two broad theoretical approaches that have discussed the role of the social environment in attitude formation.

On the one hand, one approach accentuates the role of beliefs about economic inequality rooted in social comparison processes as an explanation through which people form opinions about redistributive policies [@condon_economic_2020]. This hypothesis can be traced to the studies on class images and perceived class conflicts [@Evans1992;@kelley_class_1995]. Here, the initial argument posits that people form their beliefs through the individual, family, friends, and coworkers’ experiences instead of the whole society, which is described as an availability heuristic that systematically biases inferences about inequality based on the homophily of reference groups [@Evans1992, p. 467]. From this perspective, how people infer the social world is linked to the degree of segregation in their immediate social environment, which influences the intensity and character of the information that ultimately shapes their perceptions of inequality [@mijs_is_2021]. Thus, experience sharing in conversations with socioeconomically diverse networks has been proven to contribute to the accuracy of the images of income and wealth inequalities compared with people in more segregated networks [@summers_deliberating_2022]. Despite this, we argue that this research field has been more focused on the cognitive dimension of preference formation through inequality perceptions, either relying on surveys [@cansunar_who_2021;@garcia-castro_perceived_2022] or experimental manipulations [@Cruces2011;@becker_significant_2021] rather than empirically addressing the role of class segregation in social networks and its claimed influence on attitudes in the economic domain.

In contrast, it has been suggested that the lens of a network approach provides a better picture of class relations that nurture social norms and group identity [@kalmijn_social_2007, p. 550]. This claim resembles the fact that classes are characterized as collectivities with differences in their degrees of cohesion and solidarity, encompassing unequal status-based social interactions that are linked to individual or household material well-being, cultural perspectives, and political preferences that structure broader social experiences [@morris_attenuation_1996, p. 48]. Furthermore, social integration can be affected in societies with lower contact opportunities between different social classes, where social distance among them widened by extreme inequality can create an “empathy gulf” that comprises barriers to imagining others’ lifestyles [@sachweh_moral_2012]. In this matter, spatially segregated interactions may nurture doubts about worthiness when the lower classes contrast themselves with the lifestyles of the upper classes, which might undermine feelings of social inclusion and cohesion [@sachweh_moral_2012]. Consequently, segregation drives the lives of others to become more distant and might have consequences for empathy and solidarity toward others, potentially leading to the perception of fellow citizens as strangers [@otero_lives_2022, p. 758]. Thus, we suggest that attitudes towards redistribution may be influenced by the class situation of both the individual and network ties, where social influence processes can either allineate or divide attitudes according to the characteristics of groups and the level of segregation that allows factual contact opportunities. 

In recent years, we have seen an increase in this network turn of class analysis, contributing to unraveling the relationship between the composition of social ties and attitudes toward inequality. In this regard, it has been shown that the degree of contact between different classes has shown that individuals of the lower class interacting with those of the upper classes may consider economic inequality as justifiable, whereas interactions with those of the lower class may prompt individuals from different social classes to question the fairness of income distribution [@vargassalfate_contact_2023]. Further evidence suggests that class-based contact diversity shortens the social distance between social classes, providing broader images of the living conditions of others, which can trigger greater concerns about inequality [@otero_power_2023] and undermine support for the market distribution of social services [@beck_explorando_2019]. 

In addition, studies that directly addressed the relationship between networks and social classes have been consistent with previous findings. For instance, evidence from Sweden suggests that people tend to assimilate their opinions according to their surrounding friends and acquaintances, which is reinforced by class homophily, where higher contacts in the managerial class negatively influence support for redistribution, while ties to the working class increase it regardless of the individual class position suggesting that “individuals take an impression from others and modify their attitudes accordingly” [@lindh_missing_2021, p. 698]. Similarly, additional socialization sources are cross-class ties through family members. In this sense, the family of origin is crucial for political socialization, where class interests and norms are nurtured in childhood and early adulthood. A study in the United States showed that those tied to the upper class through parental relations support redistribution and progressive taxation less than those with working-class family backgrounds [@lee_consider_2023]. In addition, @paskov_crossclass_2022 argues that the class position of family and partners shapes preferences, while households share risk according to the class position of their members, where class homogeneity in ties divides preferences between lower and upper classes. In contrast, this gradient is blurred as heterogeneity increases according to the class position of the partner and family of origin.

In summary,  the tendency to form homophilous social ties regarding social class is expected to reinforce attitudes and consolidate opinion similarity. Empirically, a weak direct association between homogeneity and redistributive preferences is expected because class segregation does not distinguish between classes as it provides only the _overall_ degree of segregation. In contrast, the focus will be on how class-based network homogeneity is conditional to social class. In simpler terms, this is possible by examining the interaction between network homogeneity and social class. Precisely, this will indicate if being segregated into lower (upper) classes leads to stronger (weaker) redistributive preferences ($H_1$).

## Economic Inequality as context for Class relations and Redistributive Preferences

Studies that have stressed the role of economic inequality on the relationship between social class and redistributive preferences indicate that the lower and the upper classes react differently to rising economic inequality. Theoretically, political economy studies have suggested that high-income individuals are far from monolithic in their redistributive preferences, arguing that their concerns about the harmful _consequences_ of economic inequality (e.g., crime) ultimately motivate altruistic support for redistribution  [@rueda_food_2018;@dimick_models_2018;@dimick_altruistic_2017;@rueda_externalities_2016]. Conversely, the moral economy literature has suggested that the differences among the affluent can be explained as a matter of justice distributive evaluations about the _procedures_ for resource allocation [@liebig_sociology_2016;@atria_economic_2020]. Hence, affluent groups are more sensitive because they perceive that increasing inequality undermines opportunities for social mobility [@sachweh_criticizing_2017]. Likewise, lower perceived inequality of opportunity among the upper classes can motivate support for redistribution as a matter of justice in the conditions for getting ahead [@kim_socioeconomic_2018]. In contrast, low-income individuals perceive ascribed characteristics as more important in constraining the opportunity structure, regardless of current income inequality. [@sachweh_why_2019, p. 656].

Regarding social networks, prior studies have argued that social relations are directly linked to resource access and how these are distributed in society. For instance,  Neckerman & Torche [-@neckerman_inequality_2007, p. 344] suggest that experiencing marginalization is deeply associated with the life chances to participate openly in social life, which can be exacerbated in contexts of greater material inequality. Also, economic inequality can lead to greater perceived status competition [@wilkinson_spirit_2010;@garcia-sanchez_perceived_2024], which in turn hampers the establishment of trustworthy social ties among those facing economic distress [@salgado_expectations_2021]. In contrast, it has also been argued that societies with robust welfare institutions and lower economic inequality foster social engagement in civic and social activities, thereby enhancing social trust between citizens and bolstering social solidarity [@lynch_income_2004;@uslaner_inequality_2005;@kragten_income_2017].

Empirically, comparative evidence shows that already-stratified access to social activities and diverse networks is strengthened in unequal societies
[@lancee_diversity_2017]. In this regard, @pichler_social_2009 show that class differences in participation in civic (formal) and family (informal) networks are deepened in more unequal societies. Similarly, @lancee_income_2012 have found that the stratified civic participation by income level is strengthened as inequality rises. Other studies have shown that low-income individuals hold more extensive close networks and rely on family ties to seek support in unequal societies but rely more on external ties to pursue resources [@letki_getting_2015]. Likewise, economic inequality enhances stratified access to contact network diversity due to greater interdependence between cultural, economic, and social capital [@otero_differences_2023]. Thus, the upper classes can navigate diverse social settings while remaining segregated, whereas the lower classes may experience greater marginalization and segregation because of the choices of others [@otero_open_2021, p.24].

It has been argued that state-organized redistribution reflects political class conflict in a modern industrialized capitalist society, and social classes should not be undervalued as vehicles of antagonism and social tension [@edlund_democratic_2015, p. 323]. In this line, economic inequality is crucial in moderating conflicts as it can impact the political consensus for supporting redistribution between classes. One potential implication is that the decline in social trust, civic participation, and prosocial attitudes could undermine the normative basis for collective solidarity [@uslaner_inequality_2005]. As a result, less cohesive societies can nurture stronger class polarization that undermines egalitarian attitudes [@andersen_preferences_2018], making the middle classes less prone to support policies favoring the working classes. However, in contexts of rising economic inequality, the middle classes tend to have greater political awareness about the causes and incentives of economic inequality [@Svallfors2006, pp. 66–67], as well as its consequences for class conflict and cohesion [@kelley_class_1995]. Additionally, it has been suggested that perceived social conflict decreases in societies with lower material inequality and a predominant middle-class imaginery [@hertel_conflict_2022]. Therefore, in more unequal societies, those who are better-off are more likely to support redistribution than their counterparts in more egalitarian contexts, where their attitudes gradually converge with the interests of the working class [@curtis_how_2015].

To summarise, it has been shown that economic inequality increases the dependency of network segregation with class positions, leading the working classes to be equally segregated regardless of income inequality compared to the increasingly diverse networks of the upper classes [@pichler_social_2009;@otero_differences_2023]. Consequently, it is expected that  class-based network segregation in unequal societies might have a weaker association with redistributive preferences. Thus, economic inequality is expected to _mitigate_ the association of class-based network segregation with redistributive preferences ($H_{2}$). 

<!-- A simplified framework of the hypotheses is shown in Figure X. -->


# Data, variables and method

## Data 

Individual data from the International Social Survey Programme (ISSP) 2017, titled "Social Networks and Social Resources," is utilized [@issp_networks_2017]. Established in 1984, the ISSP is a collaborative research project that conducts cross-national surveys on various topics related to social issues, attitudes, and values. Specifically, the ISSP 2017 survey includes questions on social ties and activities, evaluated through a position generator, as well as inquiries on social resources derived from network members. Additionally, respondents express their views on topics such as social trust and attitudes toward economic inequality. Initially, the dataset comprised 47,027 individual observations across 32 countries. However, Slovenia (SVN) was excluded from the analysis because the key dependent variable was not present in the questionnaire. Consequently, the present study comprises complete information on 32,529 individuals from 31 countries, representing a group of diverse societies in terms of socio-economic and institutional arrangements.

## Variables 

### _Individual level_ {-}

Two indicators available in the questionnaire were used to measure redistributive preferences. First, support for government redistribution (1) is measured by the item 'It is the responsibility of the government to reduce the differences in income between people with high incomes and those with low incomes.' and the egalitarian preferences represented by the item (2) 'For a society to be fair, differences in people's standard of living should be small.' indicators are five-point Likert scales with the categories 'Strongly agree' (1), 'Agree' (2), 'Neither agree nor disagree' (3), 'Disagree' (4) and 'Strongly disagree' (5). Second, due to the correlation between the indicators (r = 0.7) and following previous research, the indicators were reverse-coded to compute the average values. They were then rescaled to create an indicator that ranges from 0 to 100, where higher values reflect stronger redistributive preferences [@svallfors_government_2013].

The Erikson-Goldthorpe-Portocarrero (EGP) Class Scheme is employed [@Erikson1992;@Erikson1979] for measuring social class. The EGP is one of the most consistent and validated measures for social class positions in comparative research [@evans_political_2013] and has demonstrated its validity in regions of the industrialized world, as well as in countries of late industrialization [@solis_class_2019;@torche_unequal_2005;@ishida_trends_2005;@barozet_measurement_2021; @wang_where_2024]. Therefore, using the recently developed DIGCLASS algorithm [@cimentada_digclass_2023],  information regarding (i) occupational codes, (ii) self-employment status, and (iii) the number of workers was used to classify respondents into class positions. In line with previous research on political attitudes, this study utilizes a collapsed version of three classes [@sosnaud_class_2013;@edlund_influence_2003]. Therefore, the class scheme contemplates the (i) Service Class (Higher and Lower managerial and professionals), (ii) Intermediate Class (Routine nonmanual and Self-employed), and (iii) Working Class (Manual supervisors, skilled manual and unskilled manual). 

The position generator is employed to create our measure of network homogeneity based on social class. This instrument has been widely employed in social capital studies, relying on the assumption that access to social resources is based on ties to different positions in the social structure following an ego-centered network approach [@lin_access_1986;@vandergaag_position_2008]. In this case, the position generator displays a list of ten occupations where the respondent declares four possible options through which this tie is classified: "Family or relative", "Close friend", "Someone else I know", and "No one". In the case of the indicator used here, the first three categories are classified as "Knows" = 1 and "Does not know" = 0. Based on this, it is possible to obtain the total number of a person's social ties. Subsequently, the occupations are classified into three groups resembling social class positions [@otero_open_2021;@sapin_issp_2020]. First, the (i) lawyer, (ii) executive of a large firm, and (iii) human resource manager are classified as high-status. Second, the (iv) school teacher,  (v) police officer, and (vi) nurse are considered intermediate-status. Third, (vii) car mechanic, (viii) bus driver,  (iv) hairdresser, and (v) home or office cleaner are low-status occupations. 

As the network status groups are employed as proxies of social class positions, the number of similar or ingroup social ties is calculated according to the respondents' class position and provides the absolute number of similar ties. Subsequently, the number of ingroup ties is divided by the total number of contacts to provide a measure of network homogeneity that seeks to represent the share of similar social ties within the personal network [@otero_lives_2022; @volker_birds_2022]. Here, zero represents that all social ties are *different* (heterogeneity), while one means that all social contacts are *similar* (homogeneity). In substantial terms, higher values represent higher social distance from other social classes in society.

Regarding control variables, the number of social ties is included to guarantee that the observed influence of network homogeneity is independent of network size. Second,  socioeconomic characteristics are sequentially incorporated in the models as they represent the current social status in terms of income, educational skills, and labor market risk [@meltzer_rational_1981;@kitschelt_occupations_2014;@hausermann_highskilled_2015]. In addition, gender, age, and marital status are included in all models as a sociodemographic characteristic to control for the potential influence of gender norms and life course events on attitudes [@alesina_preferences_2005;@waitkus_investigating_2021;@vanheuvelen_intercohort_2018].


<!-- As suggested recently, we have selected a set of control variables based on substantive reasoning informed by the current state of research on social networks and redistributive preferences [@kohler_control_2024]. Our estimations incorporate studies on social capital, network size, and social trust. The volume of social ties within a network can have implications for both instrumental and expressive outcomes, such as job prospects or self-worth evaluations [@contreras_inequality_2019; @kim_social_2021]. Moreover, social trust facilitates the formation of social ties beyond the ingroup, enabling individuals to rely on others and participate in supportive networks that may even serve as substitutes for welfare provision [@jaime-castillo_social_2016]. Furthermore, redistributive preferences can be elucidated through economic self-interest. Typically, individuals with higher incomes oppose redistribution while acknowledging that reducing inequality would entail an increased tax burden [@meltzer_rational_1981]. Education also plays a crucial role, providing individuals with greater security to navigate the dynamics of the labor market. Higher skills are associated with less support for redistribution, as individuals with higher levels of education are better equipped to handle market uncertainties [@kitschelt_occupations_2014]. Similarly, job status reflects integration into the labor market. Outsiders, who are more vulnerable to labor market fluctuations, tend to be more supportive of redistributive policies [@hausermann_highskilled_2015]. Finally, besides serving the self-interest of unionized working-class members, unions also function as political socialization agents, nurturing egalitarian values and altruistic motives rooted in class solidarity [@han_labor_2022]. -->

<!-- Sociodemographic characteristics play a significant role in shaping prosocial attitudes. Women, for instance, often demonstrate a greater capacity for empathy, motivating them to engage in more communal and relational behavior compared to men [@eagly_his_2009]. Moreover, women are frequently employed in interpersonal service occupations characterized by lower wages and higher market risk compared to their male counterparts [@waitkus_investigating_2021]. Age also emerges as a critical factor, with individuals at different life cycle stages exhibiting varying degrees of dependence and exposure to risk. Additionally, different age cohorts encompass distinct experiences of economic and political shocks [@vanheuvelen_intercohort_2018]. Religion further influences attitudes towards redistribution. Religious individuals are generally more supportive of redistribution due to the encouragement of altruistic behavior and prosocial values within religious communities. However, there is also evidence suggesting that religious behavior may decrease support for redistribution by contributing to individual well-being [@arikan_was_2019]. Furthermore, individuals without partners tend to exhibit greater support for redistribution. This suggests that marital ties serve as a support network through which individuals can mobilize resources and social support [@alesina_preferences_2005]. -->

### _Macro level_ {-}

The primary societal characteristic under examination is the current levels of economic inequality, for which we have utilized the Gini Index (post-taxes and transfers) sourced from the World Income Inequality Dataset (WID) [@alvaredo_world_2022]. Additionally, two contextual variables are incorporated as controls in the multilevel models. Firstly, employing the Gross Domestic Product (GDP) available in the WID ensures consistency in the economic inequality estimates independently of economic property [@Schmidt-Catran2016; @finseraas_income_2009]. Secondly, to account for heterogeneity in institutional arrangements stemming from welfare schemes, a measure of the size of the welfare state is included [see @edlund_democratic_2015]. The measure is a standardized and rescaled indicator from 0 to 100 that combines (i) tax revenue as a percentage of GDP [@ilo_world_2022], (ii) welfare generosity as total governmental spending as a share of GDP [@ilo_world_2022], and (iii) the current level of redistribution [@solt_measuring_2020].

## Method

Multilevel linear models account for the hierarchical structure of the data, where individuals are nested within countries. Therefore, the analysis begins with estimating the null model by declaring the nested structure using random intercept. This initial model assesses the intraclass correlation, revealing that 13.5% of the variance in redistributive preferences can be attributed to belonging to higher-level units (countries). Subsequently, the micro-level models are estimated to determine the association between network homogeneity and the interaction with social class to test the _segregation_ hypothesis ($H_1$). Following this, macro-level models are estimated by incorporating random intercepts alongside random slopes for network homogeneity and social class to determine whether economic inequality moderates the effect of the micro-level interaction ($H_2$). Therefore, a three-way cross-level interaction is estimated to determine if income inequality moderates the interaction between network homogeneity and social class [^1]. In the macro-level models, all the individual-level factors are group-mean centered (CWC) to mitigate possible collinearity problems [@hox_multilevel_2010]. Additionally, all the country-level factors have been standardized (z-scores) to ease comparability in the estimations  [@hox_multilevel_2010].

[^1]: Supplementary analyses employing alternative income inequality measures show that the results are robust when using the Inter-decile ratio (D9/D1) and the Top 10/Bottom 50 ratio. Additionally, countries were classified into low, middle-low, middle, middle-high, and high-income inequality groups based on quintiles according to the Gini index. Hence, country-fixed effects regressions are used to control for the cross-country differences and observed and unobserved societal characteristics. The results are consistent with the multilevel estimations.


# Results

## Descriptive

```{r fig1, fig.dim=c(10,5),fig.cap='Cross-country comparison of Redistributive preferences and Social Class ',warning=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         )

df_mean <- 
dfreg %>% 
  group_by(country3) %>% 
  summarise(egal2_c=mean(egal),homclass_c=mean(homclass3_V_res),gini_disp=mean(gini_disp))
df_region <- dfreg %>% group_by(region,country3) %>% summarise(n())
df_full <- dfreg %>% group_by(dclass3res_V) %>% summarise(egal2=mean(egal),homclass=mean(homclass3_V_res),homclass_c=mean(dfreg$homclass3_V_res),egal2_c=mean(dfreg$egal), country3="Sample")
df_plot <- dfreg %>% group_by(country3,dclass3res_V) %>% summarise(egal2=mean(egal),homclass=mean(homclass3_V_res)) %>%left_join(df_mean) %>% left_join(df_region) 
df_plot$dclass3res_V <- factor(df_plot$dclass3res_V,levels = levels(df_plot$dclass3res_V),labels = c("Service Class","Intermediate Class","Working Class"))

# Calculate the difference between the mean value of working class and upper class within each country
homo_class_diff <- df_plot %>%
  dplyr::select(country3,homclass,dclass3res_V) %>% 
  tidyr::pivot_wider(names_from = "dclass3res_V", values_from = "homclass") %>% 
  mutate(diff_working_upper = `Working Class` - `Service Class`) %>% 
  dplyr::select(-`Working Class`, -`Service Class`,-`Intermediate Class`) %>% 
  as.data.frame()

df_plot <- 
dfreg %>% 
  group_by(country3,dclass3res_V) %>% 
  summarise(egal2=mean(egal),homclass=mean(homclass3_V_res)) %>% 
  left_join(df_mean) %>%
  left_join(df_region) %>% as.data.frame() %>% 
  left_join(homo_class_diff)

df_plot2 <- df_plot
df_plot2$dclass3res_V <- "Country"
df_plot2$homclass <- df_plot2$homclass_c
df_plot2$egal2 <- df_plot2$egal2_c 

df_plot3 <- bind_rows(df_plot,df_plot2)
# table(df_plot3$dclass3res_V)
df_plot3$dclass3res_V <- factor(df_plot3$dclass3res_V,
                                levels = c("Country","Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)"),labels = c("Country","Service Class","Intermediate Class","Working Class"))

df_plot3 %>% 
ggplot()+
  geom_hline(yintercept = mean(dfreg$egal),linetype=2)+
  geom_point(aes(x = reorder(country3, egal2_c),y = egal2,
                 shape=dclass3res_V,
                 color=dclass3res_V
                 ),size=3, alpha=2) +
  scale_shape_manual(values = c(4,17, 15, 16)) +
  scale_color_manual(values = c("black","#000000","#666666","#999999")) +
  labs(x=NULL,y="Redistributive Preferences") +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust = 1,size=8),
        legend.title = element_blank())


# ggsave(plot = last_plot(),filename = "slides-macro-redist.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

Figure \@ref(fig:fig1) depicts the distribution of redistributive preferences across countries and social classes. First, it is possible to notice that the United States has lower redistributive preferences, whereas Russia is a society where redistributive preferences are stronger among all social classes. As was expected, in most societies, the working class holds stronger redistributive preferences in contrast to the intermediate and services classes, with four exceptions where the differences are close to zero between both classes. However, it is also notable that there are some differences between the two extreme cases. For example, in the U.S., the working class held lower redistributive preferences (49.1) than the intermediate class (50.6), but still above the service class (46.8). In contrast, in Russia, the general pattern of higher preferences among the working class is maintained, with an escalated decrease in the working (85.5), intermediate (83.5), and service class (83.0). 

Another interesting fact is related to class differences in redistributive preferences. For example, the differences between the service and the working class are close to 2.3 points in the United States. At the same time, Finland represents the average case in the distribution but is also one of the most polarized societies in terms of class-based differences in redistributive preferences, showing a gap of 14.1 points between the upper and the lower classes. Interestingly, Russian society depicts class differences similar to the U.S., with an average difference of 2.4 points. 

```{r fig2, fig.dim=c(10,5),fig.cap='Cross-country comparison of Network homogeneity and Social Class ',warning=FALSE}
df_plot3 %>%
ggplot()+
  geom_point(aes(x = reorder(country3, diff_working_upper),
                 y = homclass,
                 shape=dclass3res_V,
                 color=dclass3res_V),
             size=3, alpha=2) +
  geom_hline(yintercept = mean(dfreg$homclass3_V_res),linetype=2)+
  scale_shape_manual(values = c(4,17, 15, 16)) +
  scale_color_manual(values = c("black","#000000","#666666","#999999")) +
  labs(x=NULL,y="Network homogeneity") +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust = 1,size=8),
        legend.title = element_blank()) 

# ggsave(plot = last_plot(),filename = "slides-macro-homogen.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

Regarding network segregation, Figure \@ref(fig:fig2) depicts the distribution of network homogeneity and social class across countries. In contrast to redistributive preferences, the distribution of network homogeneity is more scattered between countries and social classes. However, it is worth to mention at least two interesting findings. First, looking at the sample average (M = 0.36), we can notice that the variation between countries is low (SD = 0.03), with Thailand being the society with higher levels of network segregation (M = 0.42), and Iceland the one of the lowest (M = 0.31). Second, it is depicted that the working class network homogeneity drives the pattern of homogeneity. As noticed, in most cases observed, the general pattern is that the working class is highly homogeneous in their networks, except in the Philipines, where the intermediate class shows a slightly higher average homogeneity. In addition, the general pattern is that the service class is less segregated than the intermediate and working class. Besides, an interesting fact is that in some cases (e.g., Mexico), although the working class remains highly segregated (above 0.5), the middle and service classes are similar in their network homogeneity. Overall, one of the most substantial findings is that, without any exception, the working class is more segregated than the services class.

```{r fig3, fig.dim=c(10,5),fig.cap='Bivariate relationships between Income Inequality, Network homogeneity and Redistributive preferences',warning=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
set.seed(1234)
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         # gini_disp=scale(gini_disp),
         )
homo_ineq <- dfreg %>%
  # filter(country3 != "HUN") %>%
  group_by(country2,country3) %>%
  summarise_at(c("homclass3_V_res","egal","gini_disp","d10d1"), mean, na.rm = TRUE) %>% 
  as.data.frame()

# Plot Homogeneity and redistributive preferences
homo_ineq$country <- countrycode::countrycode(sourcevar = homo_ineq$country2,origin = "iso3c",destination = "iso2c")

fig_egal_homo <- 
homo_ineq %>%  
ggplot(aes(y=egal, x=homclass3_V_res)) +
  geom_smooth(method = "lm",fullrange=TRUE, color="black",linetype = 2,size=1,se = T) +
  geom_text_repel(label=as.character(homo_ineq$country)) +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") +
  labs(caption =paste("r = ",round(cor(homo_ineq$homclass3_V_res,
                                     homo_ineq$egal, use='complete.obs'),digits = 2)),tag = "A")
fig_homo_gini<- 
homo_ineq %>%  
ggplot(aes(y=homclass3_V_res, x=gini_disp)) +
  geom_smooth(method = "lm",fullrange=TRUE, color="black",linetype = 2,size=1,se = T) +
  # geom_text() +
  geom_text_repel(label=as.character(homo_ineq$country)) +
  xlab("Income Inequality") +
  ylab("Network homogeneity") +
  labs(caption =paste("r = ",round(cor(homo_ineq$homclass3_V_res,
                                     homo_ineq$gini_disp, use='complete.obs'),digits = 2)),tag = "B")
grid.arrange(fig_egal_homo,fig_homo_gini, nrow = 1)

# ggsave(plot = arrangeGrob(fig_egal_homo,fig_homo_gini, nrow = 1),filename = "slides-bivar.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

Moving to the bivariate macro relationships, Figure \@ref(fig:fig3) depicts the correlation between network homogeneity, redistributive preferences, and income inequality, our main societal characteristic of interest. First, according to @cohen_statistical_1988, for effect size criteria, we observe a medium positive and significant association between network homogeneity and redistributive preferences in Panel A (_r_ = 0.45, _p_ <.001). In concordance with the previously depicted distribution, we know that higher levels of network homogeneity are driven by the highly segregated networks of the working classes; what makes it logical that in countries where network homogeneity is high, this might also reflect greater social segregation among the working classes and consequently drive higher redistributive preferences. Second, Panel B depicts a positive but relatively weak and nonsignificant association between income inequality and network homogeneity (_r_ = 0.28, _p_<.01). In other words, average homogeneity also tends to increase in societies with greater income gaps. However, the macro association only shows the general pattern between countries but does not allow us to look deeper into class differences according to the levels of inequality. 

Interestingly, certain countries with higher levels of inequality and network homogeneity are societies that present class differences between the working class and the services class (e.g., Thailand or Mexico). By contrast, more egalitarian countries tend to be less homogeneous and have smaller class differences (e.g., Denmark or Sweden). As an additional exploratory analysis (see Fig. \@ref(fig:figapp1)), we have found that the association between income inequality and the gap in network homogeneity between the upper and lower classes tends to be moderate and statistically significant (_r_ = 0.29, _p_<.01). In other words, income inequality not only increase homogeneity overall but higher social distance between social classes as well.

## Multivariate results

```{r table1, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") 

# dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)
dfreg <- na.omit(dfreg)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
digclas1_VW_1<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner + (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_2<- update(digclas1_VW_1, . ~ . +know_total)
digclas1_VW_3 <- update(digclas1_VW_2, . ~ . + dclass3res_V)
digclas1_VW_5 <- update(digclas1_VW_3, . ~ . + edyears+ Q03pcm+workst)
digclas1_VW_7 <- update(digclas1_VW_5, . ~ . +dclass3res_V*homclass3_V_res)
digclas1_VW <- list(digclas1_VW_1,digclas1_VW_2,
                    digclas1_VW_3,
                    # digclas1_VW_4,
                    digclas1_VW_5,
                    # digclas1_VW_6,
                    digclas1_VW_7)

ccoef <- list(homclass3_V_res="Class-based network homogeneity",
              know_total="Network size",
              # socialtrust="Social Trust",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              # "femaleFemale"="Female (Ref. = Male)",
              # "agenum"="Age",
              # "age2"="Age2",
              "edyears"="Year of Education",
              "Q03pcmT02"="Income (T2)","Q03pcmT03"="Income (T3)","Q03pcmMissing"="Income (No information)",
              "workstNot in paid work" = "Not in paid work (Ref. = In paid work)",
              # "unionYes" ="Union Membership (Ref. = Not Unionized)",
              # "dclass3spo_VIntermediate class (III+IV)" = "Intermediate Class (Partner)",
              # "dclass3spo_VWorking Class (V+VI+VII)" = "Working Class (Partner)",              
              # "dclass3spo_VNo information (Missing, No partner)" = "No information (Not available, No partner)",
              "homclass3_V_res:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_res:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class")


texreg(digclas1_VW,stars = c(0.001, 0.01, 0.05, 0.1),single.row = F,
       caption = paste("(\\#tab:table1)","Multilevel models for Class-based network segregation and Redistributive Preferences"),
       custom.note = "\\item Note: Models include sampling weights. Gender, age, and marital status are included as controls. Standard errors in parentheses. %stars",threeparttable = T,
       caption.above = T,leading.zero = T,
       custom.coef.map = ccoef,
       symbol = "+",scalebox = 0.60,
      groups = list("Social Class (Ref.= Service Class)" = 3:5, "Household Income (Ref.= Tertile I)"= 6:8,
                    # "Partner's Social Class (Ref.= Service Class)" = 12:14,
      "Homogeneity x Social Class"=10:11),
      custom.gof.rows = list("Controls"=rep("Yes",5)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups","Var: Country (Intercept)","Var: Residual"),
       float.pos = "h!",
      # file = "table1.html"
       use.packages = F)
# performance::check_collinearity(digclas1_VW_5)
# performance::check_model(digclas1_VW_5,check="vif")
# performance::icc(digclas1_VW_5)
sjPlot::tab_model(digclas1_VW_5, show.se = F, show.std = TRUE, show.stat = F)
```

The multilevel analysis results are shown in Table \@ref(tab:table1). Regarding our first hypothesis ($H_1$), our central argument is that class segregation has differential consequences on redistributive preferences. In other words, the association between network homogeneity and redistributive preferences is conditional on class position. 

Model 1 integrates our measure of network homogeneity. Initially, as previously noted in the macro associations, individuals with more homogeneous networks tend to exhibit stronger redistributive preferences. This association persists in Model 2, where we control for network size and social trust—two pivotal factors in establishing and consolidating interpersonal networks. However, after including social class in the analysis, the relationship between homogeneity and redistributive preferences appears to reverse, with a reduction in statistical significance (_p_<0.10).

Subsequently, Model 4 incorporates socioeconomic status, employment status, and union membership characteristics. As expected, socioeconomic status is negatively associated with redistributive preferences regarding household economic resources and educational credentials. In addition, we find that people outside the labor market do not differ significantly from those who are economically active in their preferences. In contrast, as expected, being unionized increases redistributive preferences compared to those who have never been union members. Then, Model 5 incorporates the social class of the respondent's partner if such information is available. Thus, it is observed that the social class of the partner follows a similar pattern to that of the respondent, where belonging to the working or intermediate class presents higher redistributive preferences.

Finally, in Model 6, we see that by incorporating the interaction term between network homogeneity and social class, we observe that the working and intermediate class interaction terms are positive and statistically significant. Figure \@ref(fig:fig4) shows increased redistributive preferences in homogeneous working-class networks and the intermediate class. For the service class, the relationship is reversed, where more homogeneous networks for this social class decrease redistributive preferences. Altogether, these results provide evidence of our hypothesis, where a higher level of network segregation is related to a greater polarization of social class interests.
 

```{r fig4, fig.dim=c(10,5),fig.cap='Linear Predictions for Network Homogeneity on Redistributive Preferences by Social Class',warning=FALSE}
int_homo <- digclas1_VW_7
df_pred1 <- 
  predictions(int_homo, condition = c("homclass3_V_res","dclass3res_V"),
              newdata = datagrid(homclass3_V_res = seq(min(dfreg$homclass3_V_res), max(dfreg$homclass3_V_res), by= 0.1),
                                 dclass3res_V = levels(dfreg$dclass3res_V)))
# names(df_pred1)
df_pred1 %>% 
ggplot(aes(y =estimate,x=homclass3_V_res, fill=dclass3res_V, color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=1,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=2,color="black") +
  facet_grid(~factor(dclass3res_V, levels=
                       c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)"),
                     c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)"))) +
  scale_fill_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_y_continuous(limits = c(50,80))+
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
       x="Network homogeneity",y="Redistributive preferences") +
  theme(legend.position = "none", legend.title = element_blank())

# ggsave(plot = last_plot(),filename = "slides-predictions.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)

# int_homo <- digclas1_VW_7
# plot_slopes(digclas1_VW_7, variables = "homclass3_V_res", condition = list("dclass3res_V"))+
# labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
#   geom_hline(yintercept = 0,color="red",linetype=2)+
#        x="Social Class",y="Redistributive preferences",title = "Conditional Marginal Effects for Network Homogeneity")

# ggsave(plot = last_plot(),filename = "slides-marginal.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 10)
```

\newpage

```{r tab2, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(gini_disp))

dfreg$wstate2 <- scale(scale(dfreg$abs_red) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Gini index)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.7,
       caption = paste("(\\#tab:table2)","Multilevel models for Income Inequality, Network segregation and Redistributive Preferences"),
       custom.note = "\\item Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = F,threeparttable = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity x Social Class"=7:8, "Homogeneity x Social Class x Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Country (Intercept)",
                           "Var: Country Homogeneity",
                           "Var: Country Intermediate Class ",
                           "Var: Country Working Class",
                           "Cov: Country (Intercept), Homogeneity",
                           "Cov: Country (Intercept), Intermediate Class ",
                           "Cov: Country (Intercept), Working Class",
                           "Cov: Country Homogeneity, Intermediate Class",
                           "Cov: Country Homogeneity, Working Class",
                           "Cov: Country Intermediate Class, Working Class",
                           "Var: Residual"),
        # file = "table2.html",
       use.packages = F)
```

Table \@ref(tab:table2) presents the results of the multilevel models for income inequality. In Model 1, income inequality demonstrates a positive association, as expected, yet it fails to reach significance. Subsequently, Model 2 incorporates economic prosperity through GDP per capita, revealing a negative and significant relationship (*p* > .05). Furthermore, Model 3 indicates that including the size of the welfare state establishes a positive and significant relationship (_p_ > .05) while GDP per capita maintains its negative association with redistributive preferences (_p_ > .01). In other words, in Model 3, economic prosperity appears to depress redistributive preferences; however, when contextualized within a larger welfare state, greater redistributive preferences are observed.

Finally, Model 4 incorporates the three-way interaction to determine whether the relationship established in $H_1$ is moderated by income inequality. The relationship observed at the micro level retains its original meaning, indicating that segregation in terms of network homogeneity polarizes the economic interests of the classes. Additionally, when observing how this relationship is moderated by the level of inequality in the country, it appears to mitigate, with its intensity decreasing as inequality increases. Figure \@ref(fig:fig5) illustrates how the relationship between network homogeneity and social class is more pronounced when inequality is low and gradually diminishes until it becomes almost absent when inequality is high.

Overall, while Hypothesis 2a posited that greater income differences would amplify social segregation and, consequently, polarize redistributive preferences to a greater extent, the results provide evidence in favor of Hypothesis 2b. This suggests that inequality plays a mitigating role in class segregation regarding redistributive preferences.


```{r fig5, fig.dim=c(12,7),fig.cap='Three-way interaccion Income Inequality, Network segregation and  Redistributive Preferences'}
### Predicted values homo*class*GiniD ---------------------------------------$
# ginid_max<- round(max(dfreg$gini_disp) ,2)
# ginid_min<- round(min(dfreg$gini_disp),2)

ginid_max<- round(mean(dfreg$gini_disp) + sd(dfreg$gini_disp)  ,2)
ginid_min<- round(mean(dfreg$gini_disp) -sd(dfreg$gini_disp) ,2)
ginid_mea<- round(mean(dfreg$gini_disp),2)

df_pred_giniD_gc <-
  predictions(
    homo_V_gini_full2,newdata = datagrid(
      gini_disp = c(ginid_min, ginid_mea, ginid_max),
      wstate2=mean(dfreg$wstate2),
      loggdppercapita=mean(dfreg$loggdppercapita),
      homclass3_V_gc = seq(min(dfreg$homclass3_V_gc)+0.01, max(dfreg$homclass3_V_gc)+0.01, by=0.1),
      dclass3res_V=levels(dfreg$dclass3res_V)
    )
  )

df_pred_giniD_gc <- as.data.frame(df_pred_giniD_gc)
df_pred_giniD_gc$gini_disp <- factor(df_pred_giniD_gc$gini_disp,labels = c("Gini (-1SD)","Gini (Mean)", "Gini (+1SD)"))
df_pred_giniD_gc <- df_pred_giniD_gc %>% filter(dclass3res_V!="Intermediate class (III+IV)")

df_pred_giniD_gc %>% 
  ggplot(aes(y=estimate,x=homclass3_V_gc, fill=dclass3res_V,color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=0.7,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=3, shape = 21,color="black") +
  facet_wrap(~gini_disp) +
  labs(y = "Preferences for Redistribution",
       x="Network homogeneity (CWC)",
       caption = paste0("N=",nobs(homo_V_gini_full2),", Countries=",lme4::ngrps(homo_V_gini_full2))
       ) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Income inequality (post-tax) \n ", breaks = NULL, labels = NULL),
                     ) +
 
   scale_fill_manual(values=c("#323232","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#CCCCCC"))+
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text=element_text(size=15),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))

ggsave(plot = last_plot(),filename = "slides-predict-macro.png",device = "png",
       path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

# Discussion and conclusion

<!-- _Dicussion_  Luego de la presentación de los resultados, acá se comienza a volver a los argumentos del trabajo y se relaciona cada hipótesis con los resultados. Se sugiere ir por orden, y un párrafo para cada hipótesis. -->
In this research, we ask how class-based network segregation is related to preferences for redistribution and to what extent economic inequality conditions this relationship. In this context, the literature on interpersonal networks has shed light on how network structure harbors not only social resources [@lin_access_1986;@otero_open_2021] but also carries the capacity to establish niches that contribute to the formation of political opinions through social influence, as well as the degree of network segregation [@lindh_missing_2021;@paskov_crossclass_2022]. In this case, the micro-level relationship under scrutiny was that class-based network segregation does play a role in redistributive preferences. In contrast to evidence on the undermining role of network homogeneity on social cohesion [@otero_lives_2022], redistributive preferences are not the case. Indeed, we found that greater homogeneity in terms of social class has a polarizing effect on redistributive preferences because it has differentiated attitudinal consequences according to class position. In other words, for working-class members, homogeneity strengthens their redistributive preferences, while in the service class, homogeneity translates into even lower redistributive preferences. 

Our theoretical approach has established that social classes should be understood beyond labor market relationships but as relational networks that can provide an explanatory framework for attitude formation.
Theoretically, what the literature has established as processes of social influence [@lindh_missing_2021] or political socialization [@lee_consider_2023] has echoed in how social closure in interpersonal networks generates distance between different social classes in terms of their redistributive preferences. Here, the extent to which social classes distance themselves in terms of network segregation indeed creates an "empathy gulf" [@sachweh_moral_2012] that can be observed in how the service class is less willing to take action to strive with inequality as a matter of collective commitment when they are highly segregated in homogeneous upper-class environments [@otero_power_2023], in contrast to the increasing redistributive pressures of the marginalized working class. Besides, as network homogeneity represents low cross-class ties, it can be argued that lower social integration [@blau_macrosociological_1977] can undermine social solidarity as it consolidates weaker chances of contact between social classes and the lack of knowledge about the lives of others [@vargassalfate_contact_2023]. 

While the results are substantially consistent at the micro level, our theoretical framework established alternative scenarios regarding the role of economic inequality. In short, our competing hypothesis suggested that income inequality, which represents greater gaps in economic and social resources, should be related to class relations and redistributive preferences. In line with the social cohesion argument, it is suggested that social relations are undermined by economic inequality as it represents the distribution of available resources and, consequently, might _amplify_ the relationship between segregation and redistributive preferences given the increase in social distance between social classes. However, the evidence indicates the opposite as it shows that inequality _mitigates_ the micro-level relationship, which translates into a narrower class gap, mainly through changes in redistributive preferences in the service class. These results resonate with two key pieces of evidence on the role of inequality on (i) class relations and (ii) redistributive preferences. It has been argued that in unequal societies, the better-off class position tends to become more egalitarian in their stances on economic inequality [@edlund_democratic_2015;@sachweh_why_2019]. Additionally, recent cross-national studies suggest that upper classes can consolidate their distinctive position while their advantages allow them to navigate diverse networks at the expense of the marginalization of the poor in contexts of greater inequality [@otero_differences_2023]. 

<!-- _conclusion_-->
This research is a contribution to the field of study on social class and redistributive preferences, but it also contributes to previous studies that have emphasized the role of social ties in redistributive preferences [@newman_my_2014;@edlund_influence_2003;@langsaether_more_2020]. In addition to the micro-level contribution, the cross-national component of this research dialogue with previous studies on the role of income inequality on social networks [@pichler_social_2009;@letki_getting_2015;@otero_differences_2023] and class-based research on redistributive preferences [@edlund_democratic_2015;@curtis_how_2015]. Besides, this research broadly contributes to the ongoing research on social cohesion beyond Western industrialized countries, as our analyses include a heterogeneous group of societies.  

In the end, our research has been reached with limitations. On the side of our dependent variable, a two-item index is a rough proxy of what we conceptually claim as redistributive preferences. It is well established in the literature that the popular responses to economic inequality are diverse regarding how the government strives with economic inequality [@mccall_americans_2009;@garcia-sanchez_two_2022]. In addition, the position generator included in the ISSP is limited in terms of the capability to reflect the class structure more precisely, mainly regarding the self-employed and the intermediate-class occupations. In this regard, we are aware of the limitations of the instrument, and therefore, we present these results with prudence. Finally, it has been established that network formation is structured by contact opportunities [@feld_focused_1981], but values-based interaction also play a role in consolidating networks [@visser_attitudes_2004]. Thus, the cross-sectional nature of our data does not allow us to make causal claims because there could be problems of endogeneity between class position, the composition of social ties, and attitudes. 

To summarize, future survey research should consider better measurement strategies for attitudes in the economic domain, such as market-based social services, willingness to pay taxes as redistributive measures, or direct focalized transfers. In addition, the network dimension can be better approached with a more detailed measurement strategy incorporating other aspects of the occupational structure, such as authority or autonomy in the labor market. Finally, the causality-related issues can be addressed by employing longitudinal designs.      

\newpage

# References

```{=tex}
\scriptsize
\singlespacing
```

<div id="refs"> </div>  <!-- Although <div> is an HTML tag, this method also works for other output formats such as PDF. -->



\newpage

`r if (knitr::is_latex_output()){ '\\appendix'}`

`r if (knitr::is_latex_output()){ '\\section{Appendix}'}`


```{r descriptive, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,sjlabelled,haven,vtable)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  "gini_disp"=wid_gini_disp,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2,country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=gdppercapita/1000,
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         # gini_disp=scale(gini_disp)
         )

# dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

dfreg$wstate<- rowMeans(dfreg[,c("abs_red","ilo_taxrev","ilo_govspe")],na.rm = T)
dfreg$wstate2 <- ((dfreg$wstate-min(dfreg$wstate,na.rm = T))/(max(dfreg$wstate,na.rm = T)-min(dfreg$wstate,na.rm = T)))*100

dfreg1 <- dfreg %>% dplyr::select(
  egal,
  homclass3_V_res,
  know_total,
  # socialtrust,
  dclass3res_V,
  Q03pcm,
  edyears,
  # dclass3spo_V,  
  workst,
  # union,
  female,
  agenum,
  # religion,
  partner,
  "gini_disp",
  loggdppercapita,
  wstate2
  ) 

varlab <- 
c("Redistributive preferences","Class-based network homogeneity",
  "Network size",
  # "Social trust",
  "Social class",
  "Household Income","Education in years",
  # "Partner's Social Class",
  "Labor status",
  # "Union membership",
  "Gender","Age in years",
  # "Religion",
  "Has partner",
  "Income Inequality - Gini Index (post taxes and transfers)",
  "GDP/capita (in 1000 US dollars)",
  "Size of the welfare state (0 to 100 scores)")

sjlabelled::set_label(dfreg1) <- varlab
# names(dfreg) <- varlab


st(dfreg1,labels=T,
   title="Descriptive Statistics for Study Variables",
   out = "latex",
   digits = 2, 
   factor.counts = F,
   factor.numeric = F,
   summ = list(
     c('notNA(x)','mean(x)','sd(x)','min(x)','max(x)'),
     c('notNA(x)','mean(x)')
   ),
   summ.names = list(
     c('N','Mean','SD','Min','Max'),
     c('Count','Percent')   
   ))
```

\newpage

```{r desc-country, echo=FALSE, results='asis'}
dfreg %>% 
  group_by(country3) %>% 
  summarise(n=n(),
            homclass=mean(homclass3_V_res),
            gini_disp=mean(gini_disp),
            loggdppercapita=mean(loggdppercapita),
            wstate=mean(wstate2),) %>% 
  arrange(homclass) %>% 
  kable(digits = 2,booktabs = TRUE,format = "latex", linesep = "",
        caption = "Contextual variables by country",
        col.names = c("Country","N","Network Homogeneity","Gini Index","GDP/capita in $1000","Size of the Welfare State")) %>% 
  kable_styling(full_width = F,latex_options = "scale_down") %>% 
  column_spec(1, width = "3.2cm") %>% 
  column_spec(2:6, width = "3cm") %>% 
  footnote(general = "Data sources are from the ISSP 2017 - Social Networks, WID and ILO. Contextual variables in original scale")
```



```{r figapp1, fig.dim=c(5,5),out.width='50%',fig.cap='Bivariate relationships between Income Inequality and Class differences in network homogeneity',warning=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         # gini_disp=scale(gini_disp),
         )

homo_ineq <- dfreg %>%
  group_by(country2,country3) %>%
  summarise_at(c("homclass3_V_res","egal","gini_disp"), mean, na.rm = TRUE) %>% 
  as.data.frame()

homo_class_diff <- dfreg %>%   
  group_by(country2,country3,dclass3res_V) %>%
  summarise_at(c("egal","homclass3_V_res"), mean, na.rm = TRUE) %>% 
  as.data.frame() %>%
  dplyr::select(country3,homclass3_V_res,dclass3res_V) %>% 
  tidyr::pivot_wider(names_from = "dclass3res_V", values_from = "homclass3_V_res") %>% 
  mutate(diff_working_upper_homo = `Working Class (V+VI+VII)` - `Service Class (I+II)`) %>% 
  as.data.frame()

# Dataset with class differences in network homogeneity
homo_ineq <- homo_ineq %>% left_join(homo_class_diff)

# Plot Homogeneity and redistributive preferences
homo_ineq$country <- countrycode::countrycode(sourcevar = homo_ineq$country2,origin = "iso3c",destination = "iso2c")

fig_homodiff_gini<- 
homo_ineq %>%  
ggplot(aes(y=diff_working_upper_homo, x=gini_disp)) +
  geom_smooth(method = "lm",fullrange=TRUE, color="black",linetype = 2,size=1,se = T) +
  # geom_text() +
  geom_text_repel(label=as.character(homo_ineq$country)) +
  xlab("Income Inequality") +
  ylab("Class Differences in Network homogeneity \n (Working Class - Service Class)") +
  labs(caption =paste("r = ",round(cor(homo_ineq$diff_working_upper_homo,
                                     homo_ineq$gini_disp, use='complete.obs'),digits = 2)),tag = NULL)

grid.arrange(fig_homodiff_gini, nrow = 1)

ggsave(plot = arrangeGrob(fig_homodiff_gini, nrow = 1),filename = "slides-bivar-homodiff.png",device = "png",
       path = here::here("output/images"),width = 1,height = 1,units = "cm",scale = 17)
```

\pagebreak 
# Additional analysis

## Income Inequality Ratios 

```{r tab2-ratio9010, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(d10d1))

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+         
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Ratio 90/10)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.50,
       caption = "Multilevel models for Income Inequality, Network segregation and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity*Social Class"=7:8, "Homogeneity * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Homogeneity",
                           "Var: Group Intermediate Class ",
                           "Var: Group Working Class",
                           "Cov: Group (Intercept), Homogeneity",
                           "Cov: Group (Intercept), Intermediate Class ",
                           "Cov: Group (Intercept), Working Class",
                           "Cov: Group Homogeneity, Intermediate Class",
                           "Cov: Group Homogeneity, Working Class",
                           "Cov: Group Intermediate Class, Working Class",
                           "Var: Residual"),
       use.packages = F)
```

```{r tab2-ratio9050, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(wid_p90p50))

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Ratio 90/50)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.50,
       caption = "Multilevel models for Income Inequality, Network segregation and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity*Social Class"=7:8, "Homogeneity * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Homogeneity",
                           "Var: Group Intermediate Class ",
                           "Var: Group Working Class",
                           "Cov: Group (Intercept), Homogeneity",
                           "Cov: Group (Intercept), Intermediate Class ",
                           "Cov: Group (Intercept), Working Class",
                           "Cov: Group Homogeneity, Intermediate Class",
                           "Cov: Group Homogeneity, Working Class",
                           "Cov: Group Intermediate Class, Working Class",
                           "Var: Residual"),
       use.packages = F)
```

\pagebreak
## Income inequalty groups

```{r table1-ineq-groups, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") 


# dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)

dfreg <- na.omit(dfreg)
tab_countries<- 
  dfreg %>% 
  group_by(country3) %>% 
  summarise(gini_disp=mean(gini_disp)) %>% 
  mutate(gini_q05=ntile(gini_disp,5),
         gini_d10=ntile(gini_disp,10)) %>% as.data.frame() %>% 
  arrange(gini_d10) %>% 
  dplyr::select(-gini_disp)

dfreg <- dfreg %>% left_join(tab_countries,by="country3")


## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$

library(estimatr)

# Quintile 1 (low)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==1),weights = WEIGHT)
digclas1_VW_Q1_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_Q1_2 <- update(digclas1_VW_Q1_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 2 (mid-low)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==2),weights = WEIGHT)
digclas1_VW_Q2_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+age2+edyears+ Q03pcm+workst)
digclas1_VW_Q2_2 <- update(digclas1_VW_Q2_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 3 (middle)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==3),weights = WEIGHT)
digclas1_VW_Q03_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_Q03_2 <- update(digclas1_VW_Q03_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 4 (middle-high)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum + partner +  factor(country2),data=subset(dfreg,gini_q05==4),weights = WEIGHT)
digclas1_VW_Q04_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_Q04_2 <- update(digclas1_VW_Q04_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 5 (high)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==5),weights = WEIGHT)
digclas1_VW_Q05_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+age2+edyears+ Q03pcm+workst)
digclas1_VW_Q05_2<- update(digclas1_VW_Q05_1, . ~ . +dclass3res_V*homclass3_V_res)

digclas1_Q05 <- 
list(digclas1_VW_Q1_1,digclas1_VW_Q1_2,digclas1_VW_Q2_1,digclas1_VW_Q2_2,
     digclas1_VW_Q03_1,digclas1_VW_Q03_2,digclas1_VW_Q04_1,digclas1_VW_Q04_2,
     digclas1_VW_Q05_1,digclas1_VW_Q05_2)

ccoef <- list(homclass3_V_res="Class-based network homogeneity",
              know_total="Network size",
              # socialtrust="Social Trust",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              # "femaleFemale"="Female (Ref. = Male)",
              # "agenum"="Age",
              # "age2"="Age2",
              "edyears"="Year of Education",
              "Q03pcmT02"="Income (T2)","Q03pcmT03"="Income (T3)","Q03pcmMissing"="Income (No information)",
              "workstNot in paid work" = "Not in paid work (Ref. = In paid work)",
              # "unionYes" ="Union Membership (Ref. = Not Unionized)",
              # "dclass3spo_VIntermediate class (III+IV)" = "Intermediate Class (Partner)",
              # "dclass3spo_VWorking Class (V+VI+VII)" = "Working Class (Partner)",              
              # "dclass3spo_VNo information (Missing, No partner)" = "No information (Not available, No partner)",
              "homclass3_V_res:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_res:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class")


header <- list("Q1"=1:2,"Q2"=3:4,"Q3"=5:6,"Q4"=7:8,"Q5"=9:10)
texreg(digclas1_Q05,stars = c(0.001, 0.01, 0.05, 0.1),single.row = F,include.ci = FALSE,custom.header = header,
       caption = paste("(\\#tab:table1-groups)","Fixed effects linear regression models for Class-based network segregation and Redistributive Preferences by Income Inequality Quintiles"),
       custom.note = "Note: Models include sampling weights. Gender, age and marital status are included as controls. Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,
       custom.coef.map = ccoef,
       symbol = "+",scalebox = 0.55,
      groups = list("Social Class (Ref.= Service Class)" = 3:4, "Household Income (Ref.= Tertile I)"= 6:8,  
                    # "Partner's Social Class (Ref.= Service Class)" = 12:14, 
                    "Homogeneity x Social Class"=10:11),
      custom.gof.rows = list("Country FE"=rep("Yes",10)),
      # include.loglik = FALSE,include.aic = FALSE,
      # custom.gof.names = c(NA,NA,"Num. groups","Var: Country (Intercept)","Var: Residual"),
       float.pos = "h!",
      # file = "table1.html"
       use.packages = F)
```


```{r fig1-marg-ineqgrup, fig.dim=c(15,5),fig.cap='Average Marginal Effects of Network homogeneity conditionated by Social class on Redistributive Preferences by Income Inequality Groups',warning=FALSE}
marginal <- bind_rows(
plot_slopes(digclas1_VW_Q1_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=1),
plot_slopes(digclas1_VW_Q2_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F)  %>% mutate(quintile=2),
plot_slopes(digclas1_VW_Q03_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=3),
plot_slopes(digclas1_VW_Q04_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=4),
plot_slopes(digclas1_VW_Q05_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=5))
marginal$quintile <- factor(marginal$quintile,labels = c("Gini (Q1)","Gini Q2","Gini Q3","Gini Q4","Gini Q5"))
marginal$dclass3res_V <- forcats::fct_rev(marginal$dclass3res_V)

ggplot(data=marginal,aes(x = dclass3res_V, y = estimate,ymin= conf.low, ymax=conf.high)) +
  geom_point(size=2) + 
  geom_errorbar(width=.2)+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  geom_hline(yintercept = 0,color="red") +
  facet_grid(~quintile) +
  labs(x=NULL,y="Redistributive preferences"
       # title = "Average Marginal Effects for Class-based network segregation on Redistributive preferences by Social Class and Income Inequality groups"
       )  

```

\pagebreak

## OECD Countries

```{r tab2-ocde, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(gini_disp))

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Gini index)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.60,
       caption = "Multilevel models for Income Inequality, Network segregation and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity*Social Class"=7:8, "Homogeneity * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Homogeneity",
                           "Var: Group Intermediate Class ",
                           "Var: Group Working Class",
                           "Cov: Group (Intercept), Homogeneity",
                           "Cov: Group (Intercept), Intermediate Class ",
                           "Cov: Group (Intercept), Working Class",
                           "Cov: Group Homogeneity, Intermediate Class",
                           "Cov: Group Homogeneity, Working Class",
                           "Cov: Group Intermediate Class, Working Class",
                           "Var: Residual"),
       use.packages = F)
```

```{r fig5-ocde, fig.dim=c(12,7),fig.cap='Three-way interaccion effects for Redistributive Preferences, Network segregation, Social class and Income Inequality'}
### Predicted values homo*class*GiniD ---------------------------------------$
# ginid_max<- round(max(dfreg$gini_disp) ,2)
# ginid_min<- round(min(dfreg$gini_disp),2)

ginid_max<- round(mean(dfreg$gini_disp) + sd(dfreg$gini_disp)  ,2)
ginid_min<- round(mean(dfreg$gini_disp) -sd(dfreg$gini_disp) ,2)
ginid_mea<- round(mean(dfreg$gini_disp),2)

df_pred_giniD_gc <-
  predictions(
    homo_V_gini_full2,newdata = datagrid(
      gini_disp = c(ginid_min, ginid_mea, ginid_max),
      wstate2=mean(dfreg$wstate2),
      loggdppercapita=mean(dfreg$loggdppercapita),
      homclass3_V_gc = seq(min(dfreg$homclass3_V_gc)+0.01, max(dfreg$homclass3_V_gc)+0.01, by=0.1),
      dclass3res_V=levels(dfreg$dclass3res_V)
    )
  )

df_pred_giniD_gc <- as.data.frame(df_pred_giniD_gc)
df_pred_giniD_gc$gini_disp <- factor(df_pred_giniD_gc$gini_disp,labels = c("Gini (-1SD)","Gini (Mean)", "Gini (+1SD)"))
df_pred_giniD_gc <- df_pred_giniD_gc %>% filter(dclass3res_V!="Intermediate class (III+IV)")

df_pred_giniD_gc %>% 
  ggplot(aes(y=estimate,x=homclass3_V_gc, fill=dclass3res_V,color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=0.7,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=3, shape = 21,color="black") +
  facet_wrap(~gini_disp) +
  labs(y = "Preferences for Redistribution",
       x="Network homogeneity (CWC)",
       caption = paste0("N=",nobs(homo_V_gini_full2),", Countries=",lme4::ngrps(homo_V_gini_full2))
       ) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Income inequality (post-tax) \n ", breaks = NULL, labels = NULL),
                     ) +
 
   scale_fill_manual(values=c("#323232","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#CCCCCC"))+
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text=element_text(size=15),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))
```

\pagebreak

## Social distance

First, the average scores of the International Socio-Economic Index of Occupational Status (ISEI) [@ganzeboom_new_2010] for each occupation of the position generator are calculated. Second, the ISEI score of the respondent (R's) is subtracted from the average ISEI points of the personal network. For example, if the R's has an ISEI of 80 and the network ISEI is 50, the social distance will be 30 (80 - 50), a "upward" social distance. Another case could be 50 (R's) minus 80 (network), and the average social distance will be - 30 or "downward" social distance. In addition, When the distance is 0, the network is entirely homogeneous.

To facilitate the interpretation of the indicator, we have calculated a homogeneity indicator based on social distance:

1. The absolute values are calculated to represent the total distance to occupations respect to R's ISEI score.
2. Since we have 0 values representing absolute homogeneity, we rescale the variable by adding 1.
4. We have inverted the values to make higher values represent higher homogeneity.

Thus, higher values represent greater homogeneity regarding R's ISEI score in contrast to the average network ISEI score.

```{r desc-social, eval=FALSE, include=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4,correlation)
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  dclass3spo_V,
  homclass3_V_res=socdist,
  know_total,
  socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  religion,
  union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2,
         homclass3_V_res=homclass3_V_res/10) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN")

dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)

dfreg <- na.omit(dfreg)
```

### Social Distance by ISEI 

```{r table1-socdist, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dummy_df <- df1 %>% dplyr::select(id,
  egal = egal2,dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,edyears,female,agenum,
  # religion,
  partner,
  # union,
  workst,WEIGHT,region,
  "gini_disp"=wid_gini_disp,"gini_mkt",gv_spen,rel_red,abs_red,ilo_taxrev,
  ilo_govspe,d10d1=wid_p90p10,wid_p90p50,top10=wid_sharetop10,rgdpna,gdppercapita,
  oecd,country2, country, country3) %>%
  filter(country2 != "SVN") %>% 
  # filter(oecd == "OECD") %>%
  na.omit() %>% 
  dplyr::select(id)

df1$isei08sp <- car::recode(df1$isei08sp,"NA=0")
df1$isei08 <- car::recode(df1$isei08,"NA=0")

dfreg <- df1 %>% dplyr::select(id,
  egal = egal2,
  dclass3res_V=isei08,
  # dclass3spo_V=isei08sp,
  homclass3_V_res=socdist,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2,
         dclass3res_V=dclass3res_V/10,
         # dclass3spo_V=dclass3spo_V/10,
         homclass3_V_res=homclass3_V_res/10
         ) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN")  %>% 
  filter(id %in% dummy_df$id)
dfreg <- na.omit(dfreg)

# Step 1: Calculate absolute values
absolute_values <- abs(dfreg$homclass3_V_res)
# hist(absolute_values);summary(absolute_values)

# Step 2: Add 1 to all values to eliminate zeros
modified_values <- absolute_values + 0.1
# hist(modified_values);summary(modified_values)

# Step 3: Reverse the order of the scale
reversed_values <- max(modified_values) + 0.1 - modified_values
# hist(reversed_values);summary(reversed_values) 
dfreg$homclass3_V_res <- reversed_values


## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
digclas1_VW_1<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner + (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_2<- update(digclas1_VW_1, . ~ . +know_total)
digclas1_VW_3 <- update(digclas1_VW_2, . ~ . + dclass3res_V)

digclas1_VW_4 <- update(digclas1_VW_3, . ~ . + dclass3res_V+female+agenum)
digclas1_VW_5 <- update(digclas1_VW_3, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_6 <- update(digclas1_VW_3, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_7 <- update(digclas1_VW_6, . ~ . +dclass3res_V*homclass3_V_res)
digclas1_VW <- list(digclas1_VW_1,digclas1_VW_2,
                    digclas1_VW_3,
                    # digclas1_VW_4,
                    digclas1_VW_5,digclas1_VW_6,digclas1_VW_7)

ccoef <- list(homclass3_V_res="Social Distance /10",
              know_total="Network size",
              # socialtrust="Social Trust",
              # "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              # "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              # "femaleFemale"="Female (Ref. = Male)",
              # "agenum"="Age",
              # "age2"="Age2",
              "dclass3res_V"="ISEI/10",
              "edyears"="Year of Education",
              "Q03pcmT02"="Income (T2)","Q03pcmT03"="Income (T3)","Q03pcmMissing"="Income (No information)",
              "workstNot in paid work" = "Not in paid work (Ref. = In paid work)",
              # "unionYes" ="Union Membership (Ref. = Not Unionized)",
              # "dclass3spo_V" = "ISEI/10 (Partner)",
              "homclass3_V_res:dclass3res_V" = "Social Distance*ISEI")


texreg(digclas1_VW,stars = c(0.001, 0.01, 0.05, 0.1),
       caption = paste("(\\#tab:table2)","Multilevel models for Social Distance and Redistributive Preferences"),
       custom.note = "Note: Models include sampling weights. Gender, age, marital status and religion are included as controls. Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,
       custom.coef.map = ccoef,
       symbol = "+",scalebox = 0.60,
      custom.gof.rows = list("Controls"=rep("Yes",6)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups","Var: Country (Intercept)","Var: Residual"),
       float.pos = "h!",
       use.packages = F)
```

\newpage

```{r fig1-marg-socdist, fig.dim=c(10,5),fig.cap='Average Marginal Effects of Social Distance conditionated by ISEI on Redistributive Preferences',warning=FALSE}
int_homo <- digclas1_VW_7
plot_slopes(digclas1_VW_7, variables = "homclass3_V_res", condition = list("dclass3res_V" = "threenum"))+
labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
       x="ISEI",y="Redistributive preferences")
```

```{r fig1-pred-socdist, fig.dim=c(10,5),fig.cap='Linear Predictions for Social Distance on Redistributive Preferences by ISEI',warning=FALSE}
int_homo <- digclas1_VW_7
df_pred1 <- 
  predictions(int_homo, condition = c("homclass3_V_res","dclass3res_V"),
              newdata = datagrid(homclass3_V_res = seq(min(dfreg$homclass3_V_res), max(dfreg$homclass3_V_res), by= 0.5),
                                 dclass3res_V = c(min(dfreg$dclass3res_V),mean(dfreg$dclass3res_V),max(dfreg$dclass3res_V))))

df_pred1$dclass3res_V <- factor(df_pred1$dclass3res_V,labels = c("ISEI (min)","ISEI (Mean)", "ISEI (max)"))

# names(df_pred1)
df_pred1 %>% 
ggplot(aes(y =estimate,x=homclass3_V_res, fill=dclass3res_V, color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=1,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=2,color="black") +
  # facet_grid(~dclass3res_V) +
  scale_fill_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_y_continuous(limits = c(40,100))+
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
       x="Social distance",y="Redistributive preferences") +
  theme(legend.position = "bottom", legend.title = element_blank())
```

\pagebreak

```{r tab2-socdist, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
dummy_df <- df1 %>% dplyr::select(id,
  egal = egal2,dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,know_total,
  # socialtrust,
  Q03pcm,edyears,female,agenum,
  # religion,
  partner,
  # union,
  workst,WEIGHT,region,
  "gini_disp"=wid_gini_disp,"gini_mkt",gv_spen,rel_red,abs_red,ilo_taxrev,
  ilo_govspe,d10d1=wid_p90p10,wid_p90p50,top10=wid_sharetop10,rgdpna,gdppercapita,
  oecd,country2, country, country3) %>%
  filter(country2 != "SVN") %>% 
  # filter(oecd == "OECD") %>%
  na.omit() %>% 
  dplyr::select(id)

df1$isei08sp <- car::recode(df1$isei08sp,"NA=0")
dfreg <- df1 %>% dplyr::select(id,
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V=isei08,
  # dclass3spo_V=isei08sp,
  homclass3_V_res=socdist,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(gini_disp),
         dclass3res_V=dclass3res_V/10,
         # dclass3spo_V=dclass3spo_V/10,
         homclass3_V_res=homclass3_V_res/10
         ) %>% 
  filter(id %in% dummy_df$id)

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))
# Step 1: Calculate absolute values
absolute_values <- abs(dfreg$homclass3_V_res)
# hist(absolute_values);summary(absolute_values)

# Step 2: Add 1 to all values to eliminate zeros
modified_values <- absolute_values + 0.1
# hist(modified_values);summary(modified_values)

# Step 3: Reverse the order of the scale
reversed_values <- max(modified_values) + 0.1 - modified_values
# hist(reversed_values);summary(reversed_values) 

dfreg$homclass3_V_res <- reversed_values


# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

dfreg$dclass3res_V = group_center(as.numeric(dfreg$dclass3res_V), grp = dfreg$country2)



# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)
# dfreg$dclass3spo_V_gc = group_center(dfreg$dclass3spo_V, grp = dfreg$country2)


# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Social Distance (CWC)",
              "dclass3res_V"="ISEI ",
              "gini_disp" = "Income inequality (Gini index)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_V" = "Distance*ISEI",
              "homclass3_V_gc:gini_disp"= "Distance*Income Inequality",
              "dclass3res_V:gini_disp" ="ISEI*Inequality",
              "homclass3_V_gc:dclass3res_V:gini_disp" = "Distance*Working Class*Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.60,
       caption = "Multilevel models for Income Inequality, Social Distance and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      # groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Distance*Social Class"=7:8, "Distance * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Soc. Distance",
                           "Var: Group ISEI",
                           "Cov: Group (Intercept), Soc. Distance",
                           "Cov: Group (Intercept), ISEI",                           
                           "Cov: Group Soc. Distance, ISEI",
                           "Var: Residual"),
       use.packages = F)
```

```{r fig2-socdist, fig.dim=c(12,7),fig.cap='Three-way interaccion effects for Redistributive Preferences, Social Distance, ISEI and Income Inequality'}
### Predicted values homo*class*GiniD ---------------------------------------$
# ginid_max<- round(max(dfreg$gini_disp) ,2)
# ginid_min<- round(min(dfreg$gini_disp),2)

ginid_max<- round(mean(dfreg$gini_disp) + sd(dfreg$gini_disp)  ,2)
ginid_min<- round(mean(dfreg$gini_disp) -sd(dfreg$gini_disp) ,2)
ginid_mea<- round(mean(dfreg$gini_disp),2)

df_pred_giniD_gc <-
  predictions(
    homo_V_gini_full2,newdata = datagrid(
      gini_disp = c(ginid_min, ginid_mea, ginid_max),
      wstate2=mean(dfreg$wstate2),
      loggdppercapita=mean(dfreg$loggdppercapita),
      homclass3_V_gc = seq(min(dfreg$homclass3_V_gc)+0.01, max(dfreg$homclass3_V_gc)+0.01, by=0.5),
      dclass3res_V=c(min(dfreg$dclass3res_V),max(dfreg$dclass3res_V))
    )
  )

df_pred_giniD_gc <- as.data.frame(df_pred_giniD_gc)
df_pred_giniD_gc$gini_disp <- factor(df_pred_giniD_gc$gini_disp,labels = c("Gini (-1SD)","Gini (Mean)", "Gini (+1SD)"))

df_pred_giniD_gc$dclass3res_V <- factor(df_pred_giniD_gc$dclass3res_V,labels = c("ISEI (min)","ISEI (max)"))
# df_pred_giniD_gc <- df_pred_giniD_gc %>% filter(dclass3res_V!="Intermediate class (III+IV)")

df_pred_giniD_gc$dclass3res_V <- as.factor(df_pred_giniD_gc$dclass3res_V)

df_pred_giniD_gc %>% 
  ggplot(aes(y=estimate,x=homclass3_V_gc, fill=dclass3res_V,color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=0.7,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=3, shape = 21,color="black") +
  facet_wrap(~gini_disp) +
  labs(y = "Preferences for Redistribution",
       x="Social Distance (CWC)",
       caption = paste0("N=",nobs(homo_V_gini_full2),", Countries=",lme4::ngrps(homo_V_gini_full2))
       ) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Income inequality (post-tax) \n ", breaks = NULL, labels = NULL),
                     ) +
 
   scale_fill_manual(values=c("#323232","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#CCCCCC"))+
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text=element_text(size=15),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))
```

```{r table1-alternative, eval=FALSE, include=FALSE, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V=dclass6res,
  # homclass3_V_res=homclass3_V_res_part,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") 


# dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)

dfreg <- na.omit(dfreg)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
digclas1_VW_1<- lmer(egal~1 + homclass3_V_res + female+agenum+(1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_2<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner +  (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_3<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner +  (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_4<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner +  know_total + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_6<- lmer(egal~1 + homclass3_V_res + female+agenum+ 
                       partner +  know_total +   
                       dclass3res_V + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_7<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +   know_total +  
                       dclass3res_V +  edyears + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_8<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total + 
                       dclass3res_V +  edyears +  Q03pcm +(1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_9<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total +  
                       dclass3res_V +  edyears +  Q03pcm + workst +(1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_10<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total + 
                       dclass3res_V +  edyears +  Q03pcm + workst + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_10a<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total + 
                       dclass3res_V +  edyears +  Q03pcm + workst + (homclass3_V_res|country2),data=dfreg,weights = WEIGHT)


digclas1_VW_11 <- update(digclas1_VW_10, . ~ . +dclass3res_V*homclass3_V_res)

digclas1_VW <- list(digclas1_VW_1,digclas1_VW_2,digclas1_VW_3,digclas1_VW_4,
                    digclas1_VW_6,digclas1_VW_7,digclas1_VW_8,digclas1_VW_10,digclas1_VW_10a,
                    digclas1_VW_11)

screenreg(digclas1_VW)
plot_slopes(digclas1_VW_11, variables = "homclass3_V_res", by = "dclass3res_V",draw = T)
```

