---
title: "Class-based network segregation, Economic Inequality and Redistributive Preferences across societies"
css: "input/css/custom.css" # custom CSS para html
fontsize: 12pt
linestretch: '1.15'          # interlineado 
papersize: a4
link-citations: yes         # citas linkeadas
lang: en-US
# date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
date: "`r format(Sys.Date(), '%d %b %Y')`"
author:
- name: Julio Iturra-Sanhueza
  affiliation: Bremen International Graduate School of Social Sciences
  email: jiturra@uni-bremen.de
#   number: 1
# - name: Justin d'Ottawa
#   affiliation: University of Ottawa
#   number: 2
# - name: Pedro Torres
#   number: 1,2 
# Nota: Autores que comparten filiacion, poner el mismo number y declarar filiación una sola vez.  
abstract: | 
  | Escalating economic inequality has increased attention to the link between class relations and redistributive preferences in contemporary societies. However, economic inequality unevenly affects class relations and their influence on support for redistribution across societies. While those in the upper and middle classes reinforce their privileged access to resources and diverse networks, the working class has been disproportionately affected by social exclusion as inequality rises. Consequently, inequality consolidates segregated lifeworlds as it increases the divide between the lives and experiences of the different social classes.  Meeting people from diverse class positions can help individuals become more aware of other people's lifestyles and worldviews. Homogeneous upper-class networks may reduce empathy and solidarity towards those in need, resulting in decreased support for redistribution. Conversely, segregated lower-class social networks can lead to increased marginalization and reinforce support for redistribution. This study explores the relationship between class-based network segregation and redistributive preferences employing cross-national data from 32,529 individuals in 31 societies. The main findings suggest that social class conditions the association of network homogeneity on redistributive preferences, where working-class homogeneity drives stronger redistributive preferences, while greater upper-class homogeneity decreases support for redistribution. In addition, the conditional influence of network segregation weakens in unequal societies, especially for the upper classes. Implications for the study of class relations and political attitudes are discussed.
  | 
  | **Keywords**: social networks, segregation, social class, income inequality, redistributive preferences 
output:
  bookdown::pdf_document2:
    template: null
    toc: false
    keep_tex: false
    number_sections: true
    pandoc_args:
      - --template=input/mytemplate.tex #custom template para usar autores con afiliacion  
  bookdown::html_document2:
    toc: yes
    code_folding: hide
    number_sections: false
    toc_float:
      collapsed: false
      smooth_scroll: false
         
always_allow_html: true      
linkcolor: gray                         # enlaces y citas en color azul
bibliography: input/bib/rgroup-redist.bib     # bibliografia en bibtex
csl: input/bib/apa6.csl
editor_options:
  chunk_output_type: console            # en RStudio, mostrar output en consola
geometry: "left=2.54cm,right=2.54cm,top=2.54cm,bottom=2.54cm" # márgenes de página
header-includes:
  # - \usepackage{times}           # Times New Roman
  - \usepackage{helvet}
  - \renewcommand{\familydefault}{\sfdefault} 
  - \usepackage{caption}
  - \captionsetup[figure, table]{labelfont={bf},labelformat={default},labelsep=period}
  - \usepackage{graphicx}
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \setlength\parindent{24pt} 
  - \usepackage{fancyhdr}
  - \fancyhead{} 
---

```{r eval=FALSE, include=FALSE}
 # for render in pdf run rmarkdown::render_site("docs/paper.Rmd", output_format = "all")
 # clean #in the yml
 rmarkdown::render("paper1_jiturra.Rmd", output_format = "bookdown::pdf_document2")
 rmarkdown::render("paper1_jiturra.Rmd", output_format = "bookdown::html_document2")
 rmarkdown::render("paper1_jiturra.Rmd", output_format = "bookdown::word_document2")
 
 # install.packages("trackdown")
 trackdown::update_file(file = "paper1_jiturra.Rmd", hide_code = TRUE,gpath = '001_PhD/002dissertation/paper1')
                        
```

<!-- - considerar ISEI08 como alternativa de social class por la correlacion con homogeneidad -->
<!-- - darle una oportunidad al h-index -->
<!--     - en general es prácticamente lo mismo que el indicador de homogeneidad -->
<!-- - controlaria por social activities index () -->
<!-- - social resources  -->
    
```{r setup, include=FALSE}
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(knitr, kableExtra, dplyr, ggplot2,sjmisc,texreg) # librerias
knitr::opts_chunk$set(warning = FALSE,  # mensaje de warning
                      message = FALSE,  # mensajes/avisos de librerias  
                      cache = T,    # cache de los chunks,usar analisis pesados
                      out.width = '100%',
                      fig.pos= "H",     # posicion figuras H = HERE
                      fig.align = "center",
                      echo = FALSE      # incluir chunk en output
                      )
options(scipen=999) # notacion cientifica
rm(list=ls())       # limpiar workspace
options(knitr.kable.NA = '') # NA en kable = ''
```
\pagestyle{fancy}
\fancyhead[R]{\thepage}
\fancyhead[L]{Research Article Draft}

```{r include=FALSE}
wordcount<- rmdwc::rmdcount(files = "paper1_jiturra.Rmd")
wordcount$words
```

**Word count**:  `r wordcount$words`

\pagebreak 

# Introduction  

During the past decades, the few cross-national studies on redistributive preferences and social class have predominantly focused on the situation of individuals and households [@lindh_class_2020]. Nonetheless, little attention has been paid to the network mechanisms involved in how individuals form their opinions regarding economic inequality and redistributive policies. On the one hand, sociologists have formerly demonstrated that homophily profoundly drives individuals to form similar social ties that consequently nurture social network segregation [@mcpherson_birds_2001;@lazarsfeld_friendship_1954]. In contrast, it is also known that opinions about economic inequality can be affected by class segregation as it provides a window for learning about the economic conditions, lifestyles, and worldviews of other social classes [@mijs_inequality_2018;@otero_power_2023]. Despite this, it can be argued that the scrutiny of redistributive preferences can be enhanced by broadening the comprehension of class relations from a network perspective, providing a comprehensive manner to understand processes of shared norm internalization, class identity formation, and collective solidarity [@Svallfors2006;@goldthorpe_sobre_1992]. In this regard, the present study examines the relationship between class-based network segregation and redistributive preferences in cross-national comparison, focusing on the role of economic inequality as a moderator of the claimed influence of class relations on support for redistribution. 

While prior research has predominantly focused on examining the impact of social class through an individualistic lens, it is noteworthy that more attention should be devoted to understanding the role of social environments in class relations. This omission is particularly surprising given that class positions are fundamentally rooted in production relations that make them inherently relational, not only in their economic underpinnings but also in the power dynamics entwined within class conflicts [@wright_comparative_1989]. In addition, the normative basis of class relations introduces the relevance of the dimensions of solidarity and reciprocity, which have been argued to provide the moral basis for legitimacy and popular support for welfare schemes [@mau_moral_2003]. In this regard, besides the leverage of individual class position, recent efforts have pointed out that whereas the class positions of network ties do affect redistributive preferences, the degree of segregation in a homogeneous class environment can drive attitudes to become even stronger [@lindh_missing_2021;@lee_consider_2023;@paskov_crossclass_2022]. 

While network segregation intensifies the already established class divide in redistributive preferences, little is known about how contextual factors affect the association of class-based network segregation and support for redistribution. On the one hand, studies on the class-attitude link posit that economic inequality is crucial for understanding how class relations are mirrored in redistributive demands as it represents the current state of the distributive class struggle in contemporary capitalist societies [@edlund_democratic_2015;@curtis_how_2015]. A consistent finding on this matter is that the upper classes tend to hold more egalitarian attitudes in contexts of high inequality, while the already high redistributive demands of the working class remain stable regardless of inequality levels [@sachweh_why_2019;@dimick_altruistic_2017]. On the other hand, income inequality leads to more segregated forms of social participation and network composition [@pichler_patterns_2007;@otero_space_2022]. Indeed, inequality reinforces the stratified access to social activities and widens the distance between classes, resulting in an increasing marginalization of the lower classes and consolidating the privileged positions of the upper classes that held better opportunities for diversifying their social activities and interpersonal ties [@lancee_income_2012;@letki_getting_2015;@otero_differences_2023]. Nevertheless, current efforts to examine the impact of income inequality have primarily concentrated on either social networks or support for redistribution. A key question that remains unanswered is the extent to which broader economic disparities can influence the relationship between class-based network segregation and support for redistribution within a comprehensive framework. 

Thus, as no research has comparatively stressed the role of economic inequality in the relationship between class-based network segregation and redistributive preferences, the present study aims to answer two questions:

(1) How does class-based network segregation affect redistributive preferences? 
(2) To what extent does economic inequality moderate the relationship between class-based network segregation and redistributive preferences? 

For the present investigation, a data sample of 32,529 individuals across 31 societies from the International Social Survey Program (ISSP) 2017 is utilized. The ISSP presents a nonprecedence opportunity as it provides comprehensive information on interpersonal networks, social class, and attitudes toward redistribution. 

# Theoretical views on class, social networks, and redistributive preferences

## Class divide in redistributive preferences 

Over the past decades, the study of political attitudes in industrialized societies has consistently demonstrated the relevance of social class as a driver of public opinion [@lindh_class_2020, p. 421]. In this view, the role of class goes beyond the market situation of individuals but drives collective economic interests and moral views about the role of the market and the state [@Svallfors2006]. Here, what has been understood as redistributive preferences entail the public responses to economic inequality regarding the sphere of the role of government actions in aspects such as the reduction of income differences or enhancing opportunities for those in economic despair  [@mccall_americans_2009]. 

However, class-based explanations of redistributive preferences have mainly been, but not exclusively, focused on the individual or household situation. It has been claimed that redistributive preferences can be explained through the labor market situation, which comprises access to economic resources and risk exposure [@meltzer_rational_1981;@rehm_risks_2009].
Moreover, as material interests might prevail in scarcity, value-driven motivations are a relevant explanatory factor of redistributive preferences [@Kulin2013;@feldman_humanitarian_2001], becoming salient under greater certainty and weaker under material precariousness [@Maldonadoetal2019]. Other approaches have suggested that given the substantial time workers spend performing their jobs, social relations in the workspace can imprint normative views that ultimately shape political opinions [@oesch_redrawing_2006]. For instance, continuous and diverse social interactions that characterize interpersonal services can drive empathy and reinforce egalitarian values [@kitschelt_occupations_2014]. In contrast, the vertical monitoring in managerial occupations and the relevance of autonomy in the case of self-employed fortify self-interested and conservative political views [@langsaether_more_2020;@oesch_electoral_2018].

Empirically, the current understanding of the class divides on redistributive preferences is extensive [@andersen_preferences_2018;@lindh_public_2015; @curtis_how_2015;@langsaether_more_2020;@brooks_why_2010;@Svallfors2006]. Nevertheless, besides the market situation of individuals and their households, including class-based social ties raises the relevance of the _class situation_ as it comprises both economic interests and life chances that motivate communal action beyond the individualistic lens [@weber_class_2011, pp. 57-59]. Therefore, the role of social relations on redistributive preferences from a network perspective needs to be developed beyond mere resource interchanges, but as part of the sociability practices that structure class relations. 

## Class relations and social networks

It can be argued that class relations not only represent resource-based distinctions but also patterns of sociability observed in the differentiation of social ties. Class relations can also be understood as the degree of cross-class relationship as a structural characteristic of a society, representing a network of social ties between different class positions [@blau_macrosociological_1977]. Empirically, homophily in social relations is a consistent finding in the social network literature [@mcpherson_birds_2001, p.416]. Hereby, friendship and family ties are prone to be homogeneous in terms of class and demographic characteristics, but distant ties play the role of bridging individuals to other different social groups and contribute to network diversity [@bargsted_pautas_2020; @plaza_juntos_2022;@lazarsfeld_friendship_1954]. In this sense, socialization preferences indeed play a role in the formation of segregated networks [@visser_attitudes_2004;@homans_human_1951]. Nonetheless, it can be argued that attitudinal similarity is the result of segregated social relations, which in turn are linked to structural processes of differentiation that also demarcate the boundaries to form ties with other social positions [@feld_focused_1981].

It is possible to find two approaches in the study of class relations from a network approach. On the one hand, it has emphasized the role of _diversity_ as the degree of connectedness to dissimilar occupations that vertically represent access to resources embedded in social networks [@lin_social_2007]. However, diversity is defined as the rate of dissimilar ties within the network that do not necessarily count with a reference position to describe the network composition. A second approach has underscored the role of _segregation_ as the lack of cross-class network ties. This perspective is conceptually closer to homophily as it is anchored in individual class positions and has empirically been addressed through the concept of network homogeneity [@otero_open_2021].

Empirically, studies on network diversity have shown that higher civic engagement in formal organizations increases the chances of bridging with diverse people among the upper class, in contrast to the more homogeneous participation of the working class [@pichler_social_2009]. Similar patterns have been found in terms of the composition of social ties, where the upper and intermediate classes hold increasingly diverse and prestigious social environments than the working classes [@cepic_how_2020;@carrascosa_class_2023]. Also, this stratified network structure holds during the life course, where the upper classes hold increasingly diverse social contacts in contrast to the stable networks of the working classes [@volker_social_2020]. In contrast, studies that have focused on segregation suggest that the property dimension is much less permeable than authority-based boundaries, arguing that class interests increase the social distance between proprietors and manual workers, while the intermediate class position of supervisors jointly to their higher contact frequency with manual workers make friendship tie formation more likely [@wright_relative_1992]. Similar studies have shown that the intermediate class holds higher permeability in contrast to the more homogeneous networks of the working class, suggesting that their limited life chances and lower capacity to be socially engaged ultimately result in a lack of social resources that lead to social segregation. In contrast, the upper class is less permeable and homogeneous because it tends to self-select as a practice that ultimately seeks to reproduce its privileged positions [@otero_open_2021]. 

## Network segregation and attitudes toward redistribution 

Besides individual class-based mechanisms, it can be argued that their social relations represent a relevant factor in attitude formation. Particularly, despite limited research on the link between social networks and redistributive preferences, two theoretical approaches have discussed the role of social relations in attitude formation: reference groups and class-based networks.

It has been stated that perceptions about economic inequality rooted in social comparison processes with reference groups can explain the formation of redistributive preferences [@condon_economic_2020]. This hypothesis can be traced to the studies on class images and perceived class conflicts [@Evans1992;@kelley_class_1995]. The argument posits that people form their beliefs through family, friends, and coworkers' experiences instead of the whole society, which is described as an availability heuristic that systematically biases inferences about inequality based on the homophily of these reference groups [@Evans1992, p. 467]. Therefore, inferences about the social world are linked to the degree of segregation in the immediate social environment of a person, which influences the intensity and character of the information that ultimately shapes inequality perceptions [@mijs_is_2021]. Accordingly, experience sharing in conversations with socioeconomically diverse networks has been proven to contribute to the accuracy of the images of income and wealth inequalities compared with people in more segregated networks [@summers_deliberating_2022]. Nevertheless, I argue that this body of research has been mainly focused on the cognitive dimension of preference formation through inequality perceptions or beliefs rather than straightforward addressing the claimed influence of network segregation on redistributive preferences [@cansunar_who_2021;@garcia-castro_perceived_2022;@Cruces2011;@becker_significant_2021].

In contrast, a network approach provides a better picture of class relations that nurture social norms and group identity [@kalmijn_social_2007, p. 550]. More precisely, it has been argued that redistributive preferences are influenced by the class situation of both the individual and network ties, where social influence processes can either allineate or divide opinions according to the contacts' class position and how segregated contact opportunities are [@vargassalfate_contact_2023]. This claim resembles the fact that classes are characterized as collectivities with differences in their degrees of cohesion and solidarity, encompassing unequal status-based social interactions that are linked to individual and household material well-being, cultural perspectives, and political preferences that structure broader social experiences [@morris_attenuation_1996, p. 48]. Furthermore, social integration can be affected in societies with lower contact opportunities between different social classes, creating an "empathy gulf" that comprises barriers to imagining others' lifestyles in contexts of rising inequality [@sachweh_moral_2012]. Thus, spatially segregated interactions may nurture doubts about worthiness when the lower classes contrast themselves with the lifestyles of the upper classes, which in turn can undermine feelings of social inclusion and cohesion [@sachweh_moral_2012]. As a result, segregation drives the lives of others to become more distant and might have consequences for empathy and solidarity toward others, potentially leading to the perception of fellow citizens as strangers [@otero_lives_2022, p. 758]. 

<!-- The attention has increased in recent years to how social ties are connected to attitudes toward inequality, and it has been shown that frequent interactions between classes can lead to different attitudinal changes depending on the individuals' social class. For instance, contact with the upper classes drives higher justification of economic inequality among the lower classes, whereas interactions with lower classes may prompt the different social classes to question the fairness of income distribution [@vargassalfate_contact_2023]. Further evidence suggests that class-based contact diversity shortens the social distance between social classes, providing broader images of the living conditions of others, which can trigger greater concerns about inequality [@otero_power_2023] and undermine support for the market distribution of social services [@beck_explorando_2019]. -->

The class position of surrounding family members, friends, and acquaintances influences redistributive preferences as they function as socialization agents that can be bolstered in segregated social networks. In principle, political attitudes are connected to class interests and norms as they are nurtured in the family of origin during childhood and early adulthood. For instance, it has been shown that individuals with network ties to the upper class through parental connections support redistribution and progressive taxation less than those from working-class family backgrounds [@lee_consider_2023]. Also, as households share risk according to the class position of their members, redistributive preferences are not only affected by their family background but also by partners' class positions. For example, @paskov_crossclass_2022 found that working-class ties bolster redistributive preferences but decrease with upper-class ties, becoming much more intense when the class positions of individuals, partners, and parents form a more homogeneous network. Besides, @lindh_missing_2021 found that including friends and acquaintances in the network structure leads individuals with higher ties to the managerial class to decrease their redistributive preferences compared to those with higher sociocultural and working-class ties, suggesting that people tend to consider and adjust their attitudes according to the class position of their contacts [@lindh_missing_2021, p. 698].

In summary, the tendency to form homogenous social ties regarding social class is expected to reinforce attitudes and consolidate opinion similarity. Empirically, a weak direct association between homogeneity and redistributive preferences is expected because class segregation does not distinguish between classes as it provides only the _overall_ degree of segregation. In contrast, the focus is on how class-based network homogeneity is conditional to social class. Empirically, this can be observed through the interaction between network homogeneity and social class. Precisely, this will indicate if being segregated into lower (upper) classes leads to stronger (weaker) redistributive preferences ($H_1$).

## Economic inequality as context for class relations and redistributive preferences

Studies that have stressed the role of economic inequality on the relationship between social class and redistributive preferences indicate that the lower and the upper classes react differently to rising economic inequality. Theoretically, political economists have suggested that high-income individuals are far from monolithic in their redistributive preferences, arguing that their concerns about the harmful _consequences_ of economic inequality (e.g., crime) ultimately motivate altruistic support for redistribution [@rueda_food_2018;@dimick_models_2018;@dimick_altruistic_2017;@rueda_externalities_2016]. Conversely, the moral economy literature in sociology has argued that the differences among the affluent can be explained as a matter of distributive justice evaluations about the _procedures_ for resource allocation [@liebig_sociology_2016;@atria_economic_2020]. Hence, affluent groups are more responsive because they perceive that increasing inequality harms the overall opportunity structure and social mobility chances [@sachweh_criticizing_2017]. Likewise, lower perceived inequality of opportunity among the upper classes can motivate support for redistribution as a matter of justice in the conditions for getting ahead [@kim_socioeconomic_2018]. In contrast, low-income individuals perceive ascribed characteristics as more important in constraining the opportunity structure, regardless of current income inequality [@sachweh_why_2019, p. 656].

Regarding social networks, prior studies have argued that social relations are directly linked to resource access and how these are distributed in society. Here,  Neckerman & Torche [-@neckerman_inequality_2007, p. 344] suggest that experiencing marginalization is deeply associated with the life chances to participate openly in social life, which can be exacerbated in contexts of greater material inequality. Also, economic inequality can lead to greater perceived status competition [@wilkinson_spirit_2010;@garcia-sanchez_perceived_2024], which in turn hampers trustworthy social ties among the low-status individuals [@salgado_expectations_2021]. In contrast, societies with robust welfare institutions and lower economic inequality foster social engagement in civic and social activities, thereby enhancing social trust between citizens and bolstering social solidarity [@uslaner_inequality_2005;@kragten_income_2017].

Empirically, comparative evidence shows that already-stratified access to social activities and diverse networks is strengthened in unequal societies
[@lancee_diversity_2017]. In this regard, @pichler_social_2009 show that class differences in participation in civic (formal) and family (informal) networks are deepened in more unequal societies. Similarly, @lancee_income_2012 have found that the stratified civic participation by income level is strengthened as inequality rises. Other studies have shown that low-income individuals hold more extensive close networks and rely on family ties to seek support in unequal societies but rely more on external ties to pursue resources [@letki_getting_2015]. Likewise, economic inequality enhances stratified access to contact network diversity due to greater interdependence between cultural, economic, and social capital [@otero_differences_2023]. Thus, the upper classes are capable of navigating diverse social settings while remaining segregated, whereas the lower classes may experience greater marginalization and segregation because of the choices of others [@otero_open_2021, p.24].

Theoretically, previous research has stated that state-organized redistribution reflects political class conflict in a modern industrialized capitalist society, and social classes should not be undervalued as vehicles of antagonism and social tension [@edlund_democratic_2015, p. 323]. In this line, economic inequality is crucial in moderating conflicts as it can impact the political consensus for supporting redistribution between classes. One potential implication is that the decline in social trust, civic participation, and prosocial attitudes could undermine the normative basis for collective solidarity [@uslaner_inequality_2005]. As a result, less cohesive societies can nurture a stronger class divide in egalitarian attitudes [@andersen_preferences_2018], making the middle classes less prone to support policies favoring the working classes. Nevertheless, in contexts of rising economic inequality, the middle classes tend to have greater political awareness about the causes and incentives of economic inequality [@Svallfors2006, pp. 66–67], as well as its consequences for class conflict and cohesion [@kelley_class_1995]. Additionally, in societies with lower material inequality and a predominant middle-class imaginery perceived social conflict decreases [@hertel_conflict_2022]. Therefore, in more unequal societies, those who are better-off are more likely to support redistribution than their counterparts in more egalitarian contexts, where their attitudes gradually converge with the interests of the working class [@curtis_how_2015].

To summarise, here it is argued that economic inequality increases the dependency of network segregation with class positions, leading the working classes to be equally segregated regardless of income inequality compared to the increasingly diverse networks of the upper classes [@pichler_social_2009;@otero_differences_2023]. Consequently, it is expected that class-based network segregation in unequal societies might have a weaker association with redistributive preferences. Thus, economic inequality is expected to _mitigate_ the association of class-based network segregation with redistributive preferences ($H_{2}$). 

<!-- A simplified framework of the hypotheses is shown in Figure X. -->

# Data, variables and method

## Data 

The primary individual data source is the "Social Networks and Social Resources" module of the International Social Survey Programme (ISSP)  [@issp_networks_2017]. The ISSP consists of a nationally representative probability sample of the adult population without substitution of each country. Each country applies a properly adapted questionnaire to guarantee the cross-cultural validity of the data and allow meaningful comparisons between countries. The questionnaire includes sections on social networks, attitudes toward economic inequality, and demographic and socioeconomic background characteristics. The complete full sample includes 47,027 observations in 32 countries. However, after inspecting the required information and applying listwise case deletion, the sample employed in the final analyses consists of 32,529 observations in 31 countries [^1]. 

[^1]: Slovenia is excluded from the study because the support for government redistribution measured by 'It is the responsibility of the government to reduce the differences in income between people with high incomes and those with low incomes' was not available in the dataset.

## Variables 

### _Individual level_ {-}

Two indicators available in the questionnaire were used to measure redistributive preferences. First, (1) support for government redistribution is measured by the item 'It is the responsibility of the government to reduce the differences in income between people with high incomes and those with low incomes.' and (2) egalitarian preferences represented by the item 'For a society to be fair, differences in people's standard of living should be small.' indicators are five-point Likert scales with the categories 'Strongly agree' (1), 'Agree' (2), 'Neither agree nor disagree' (3), 'Disagree' (4) and 'Strongly disagree' (5). Second, due to the correlation between the indicators (r = 0.7) and following previous research, the indicators were reverse-coded to compute the average values. They were then rescaled to create an indicator that ranges from 0 to 100, where higher values reflect stronger redistributive preferences [@svallfors_government_2013].

For measuring social class, the Erikson-Goldthorpe-Portocarrero (EGP) class Scheme is employed [@Erikson1992;@Erikson1979]. The EGP is one of the most consistent and validated measures for social class positions in comparative research [@evans_political_2013] and has demonstrated its validity in industrialized and late industrialized societies [@solis_class_2019;@torche_unequal_2005;@ishida_trends_2005;@barozet_measurement_2021; @wang_where_2024]. Therefore, relying on the DIGCLASS algorithm [@cimentada_digclass_2023], information about occupations, self-employment status, and number of employees is used to classify respondents into class positions. Following previous research, a collapsed version of three classes is employed [@sosnaud_class_2013;@edlund_influence_2003]. Accordingly, the class scheme contemplates the Service Class (Higher and Lower managerial and professionals), Intermediate Class (Routine nonmanual and Self-employed), and Working Class (Manual supervisors, skilled manual and unskilled manual).

The position generator is employed for measuring class-based network homogeneity. This instrument has been widely employed in social capital studies and follows an ego-centered approach where social ties to different hierarchical positions in the social structure provide access to social resources [@lin_access_1986;@vandergaag_position_2008]. In this case, a list of ten occupations is displayed and the tie can be classified as "Family or relative", "Close friend", "Someone else I know", or "No one". Here, the first three categories are classified as "Knows" = 1 and "Does not know" = 0. Consequently, the total number of social ties per respondent is obtained. Subsequently, the occupations are classified into three groups that closely resemble social class positions [@otero_open_2021;@sapin_issp_2020]. First, the (i) lawyer, (ii) executive of a large firm, and (iii) human resource manager are classified as high-status. Second, the (iv) school teacher, (v) police officer, and (vi) nurse are considered middle-status. Third, (vii) car mechanic, (viii) bus driver, (iv) hairdresser, and (v) home or office cleaner are low-status occupations.

As the network status groups are employed as proxies of social class positions, the number of similar or ingroup social ties is calculated according to the respondent class position and provides the absolute number of similar ties. Subsequently, the number of ingroup ties is divided by the total number of contacts to provide a measure of network homogeneity that seeks to represent the share of similar social ties within the personal network [@otero_lives_2022; @volker_birds_2022]. Here, zero represents that all social ties are *different* (heterogeneity), while one means that all social contacts are *similar* (homogeneity). In substantial terms, higher values represent higher social distance from other social classes in society.

First, the number of social ties is included to guarantee that the association of network homogeneity is independent of network size. Second,  socioeconomic characteristics are sequentially incorporated in the models as they represent the current social status through income, education, and labor market status [@meltzer_rational_1981;@kitschelt_occupations_2014;@hausermann_highskilled_2015]. Third, gender, age, and marital status are included in all models as a sociodemographic characteristic to control for the potential influence of gender norms and life course events on attitudes [@alesina_preferences_2005;@waitkus_investigating_2021;@vanheuvelen_intercohort_2018].


<!-- As suggested recently, we have selected a set of control variables based on substantive reasoning informed by the current state of research on social networks and redistributive preferences [@kohler_control_2024]. Our estimations incorporate studies on social capital, network size, and social trust. The volume of social ties within a network can have implications for both instrumental and expressive outcomes, such as job prospects or self-worth evaluations [@contreras_inequality_2019; @kim_social_2021]. Moreover, social trust facilitates the formation of social ties beyond the ingroup, enabling individuals to rely on others and participate in supportive networks that may even serve as substitutes for welfare provision [@jaime-castillo_social_2016]. Furthermore, redistributive preferences can be elucidated through economic self-interest. Typically, individuals with higher incomes oppose redistribution while acknowledging that reducing inequality would entail an increased tax burden [@meltzer_rational_1981]. Education also plays a crucial role, providing individuals with greater security to navigate the dynamics of the labor market. Higher skills are associated with less support for redistribution, as individuals with higher levels of education are better equipped to handle market uncertainties [@kitschelt_occupations_2014]. Similarly, job status reflects integration into the labor market. Outsiders, who are more vulnerable to labor market fluctuations, tend to be more supportive of redistributive policies [@hausermann_highskilled_2015]. Finally, besides serving the self-interest of unionized working-class members, unions also function as political socialization agents, nurturing egalitarian values and altruistic motives rooted in class solidarity [@han_labor_2022]. -->

<!-- Sociodemographic characteristics play a significant role in shaping prosocial attitudes. Women, for instance, often demonstrate a greater capacity for empathy, motivating them to engage in more communal and relational behavior compared to men [@eagly_his_2009]. Moreover, women are frequently employed in interpersonal service occupations characterized by lower wages and higher market risk compared to their male counterparts [@waitkus_investigating_2021]. Age also emerges as a critical factor, with individuals at different life cycle stages exhibiting varying degrees of dependence and exposure to risk. Additionally, different age cohorts encompass distinct experiences of economic and political shocks [@vanheuvelen_intercohort_2018]. Religion further influences attitudes towards redistribution. Religious individuals are generally more supportive of redistribution due to the encouragement of altruistic behavior and prosocial values within religious communities. However, there is also evidence suggesting that religious behavior may decrease support for redistribution by contributing to individual well-being [@arikan_was_2019]. Furthermore, individuals without partners tend to exhibit greater support for redistribution. This suggests that marital ties serve as a support network through which individuals can mobilize resources and social support [@alesina_preferences_2005]. -->

### _Macro level_ {-}

To comparatively measure economic inequality, I include the Gini index (post-taxes and transfers) from the World Income Inequality Dataset (WID) [@alvaredo_world_2022].  In addition, two contextual variables are incorporated as controls in the multilevel regression. Firstly, employing the Gross Domestic Product (GDP) in constant 2017 USD (PPP) ensures consistency in the economic inequality estimates independently of economic property [@wiid_2023]. Secondly, to account for heterogeneity in institutional arrangements stemming from welfare schemes, a measure of the size of the welfare state is included [see @edlund_democratic_2015]. The measure is a standardized and rescaled indicator from 0 to 100 that combines (i) tax revenue as a percentage of GDP [@ilo_world_2022], (ii) welfare generosity as total governmental spending as a share of GDP [@ilo_world_2022], and (iii) the current level of redistribution [@solt_measuring_2020].

## Method

Multilevel linear regression models are employed in all the analyses for accounting by the hierarchical structure of the data given that individuals are nested within countries. Therefore, the analysis begins with estimating the null model by declaring the nested structure using random intercept. This initial model assesses the intraclass correlation, revealing that 13.5% of the variance in redistributive preferences can be attributed to belonging to higher-level units. Subsequently, the micro-level models are estimated to determine the association between network homogeneity and the interaction with social class to test hypothesis 1. Following this, macro-level models are estimated by incorporating random intercepts alongside random slopes for network homogeneity and social class. This set estimates a three-way cross-level interaction to determine if income inequality moderates the interaction between network homogeneity and social class to test hypothesis 2 [^2]. In the latter model, all the individual-level variables are group-mean centered (CWC) to mitigate collinearity problems between the lower and higher-level predictors and spurious cross-level interaction coefficients [@aguinis_bestpractice_2013]. Additionally, all the country-level factors have been standardized (z-scores) to ease comparability in the estimations [@hox_multilevel_2010]. For this purpose, the package `lme4` [@bates_fitting_2015] for the statistical package `R` is employed in all the analyses.

[^2]: Supplementary analyses employing alternative income inequality measures show that the results are robust when using the Inter-decile ratio (D9/D1) and the Top 10/Bottom 50 ratio. Additionally, countries were classified into low, middle-low, middle, middle-high, and high-income inequality groups based on quintiles according to the Gini index. Hence, country-fixed effects regressions are used to control for the cross-country differences and observed and unobserved societal characteristics. The results are consistent with the multilevel estimations.

# Results

## Descriptive

```{r fig1, fig.dim=c(10,5),fig.cap='Cross-country comparison of Redistributive preferences and Social Class ',warning=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         )

df_mean <- 
dfreg %>% 
  group_by(country3) %>% 
  summarise(egal2_c=mean(egal),homclass_c=mean(homclass3_V_res),gini_disp=mean(gini_disp))
df_region <- dfreg %>% group_by(region,country3) %>% summarise(n())
df_full <- dfreg %>% group_by(dclass3res_V) %>% summarise(egal2=mean(egal),homclass=mean(homclass3_V_res),homclass_c=mean(dfreg$homclass3_V_res),egal2_c=mean(dfreg$egal), country3="Sample")
df_plot <- dfreg %>% group_by(country3,dclass3res_V) %>% summarise(egal2=mean(egal),homclass=mean(homclass3_V_res)) %>%left_join(df_mean) %>% left_join(df_region) 
df_plot$dclass3res_V <- factor(df_plot$dclass3res_V,levels = levels(df_plot$dclass3res_V),labels = c("Service Class","Intermediate Class","Working Class"))

# Calculate the difference between the mean value of working class and upper class within each country
homo_class_diff <- df_plot %>%
  dplyr::select(country3,homclass,dclass3res_V) %>% 
  tidyr::pivot_wider(names_from = "dclass3res_V", values_from = "homclass") %>% 
  mutate(diff_working_upper = `Working Class` - `Service Class`) %>% 
  dplyr::select(-`Working Class`, -`Service Class`,-`Intermediate Class`) %>% 
  as.data.frame()

egal_class_diff <- df_plot %>%
  dplyr::select(country3,egal2,dclass3res_V) %>% 
  tidyr::pivot_wider(names_from = "dclass3res_V", values_from = "egal2") %>% 
  mutate(diff_working_upper_egal = `Working Class` - `Service Class`) %>% 
  dplyr::select(-`Working Class`, -`Service Class`,-`Intermediate Class`) %>% 
  as.data.frame()

df_plot <- 
dfreg %>% 
  group_by(country3,dclass3res_V) %>% 
  summarise(egal2=mean(egal),homclass=mean(homclass3_V_res)) %>% 
  left_join(df_mean) %>%
  left_join(df_region) %>% as.data.frame() %>% 
  left_join(homo_class_diff) %>% 
  left_join(egal_class_diff)

df_plot2 <- df_plot
df_plot2$dclass3res_V <- "Country"
df_plot2$homclass <- df_plot2$homclass_c
df_plot2$egal2 <- df_plot2$egal2_c 

df_plot3 <- bind_rows(df_plot,df_plot2)
# table(df_plot3$dclass3res_V)
df_plot3$dclass3res_V <- factor(df_plot3$dclass3res_V,
                                levels = c("Country","Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)"),labels = c("Country","Service Class","Intermediate Class","Working Class"))

df_plot3 %>% 
ggplot()+
  geom_hline(yintercept = mean(dfreg$egal),linetype=2)+
  geom_point(aes(x = reorder(country3, egal2_c),y = egal2,
                 shape=dclass3res_V,
                 color=dclass3res_V
                 ),size=3, alpha=2) +
  scale_shape_manual(values = c(4,17, 15, 16)) +
  scale_color_manual(values = c("black","#000000","#666666","#999999")) +
  labs(x=NULL,y="Redistributive Preferences") +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust = 1,size=8),
        legend.title = element_blank())


# ggsave(plot = last_plot(),filename = "slides-macro-redist.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

Figure \@ref(fig:fig1) depicts the distribution of redistributive preferences across countries and social classes. First, it is possible to notice that the United States has lower redistributive preferences, whereas Russia is a society where redistributive preferences are stronger among all social classes. As was expected, in most societies, the working class holds stronger redistributive preferences in contrast to the intermediate and services classes, with four exceptions where the differences are close to zero between both classes. However, it is also notable that there are some differences between the two extreme cases. For example, in the U.S., the working class held lower redistributive preferences (49.1) than the intermediate class (50.6), but still above the service class (46.8). In contrast, in Russia, the general pattern of higher preferences among the working class is maintained, with an escalated decrease in the working (85.5), intermediate (83.5), and service class (83.0). 

Another interesting fact is related to class differences in redistributive preferences. For example, the differences between the service and the working class are close to 2.3 points in the United States. At the same time, Finland represents the average case in the distribution but is also one of societies with the greater class divide in redistributive preferences, showing a gap of 14.1 points between the upper and the lower classes. Interestingly, Russian society depicts class differences similar to the U.S., with an average difference of 2.4 points. 

```{r fig2, fig.dim=c(10,5),fig.cap='Cross-country comparison of Network homogeneity and Social Class ',warning=FALSE}
df_plot3 %>%
ggplot()+
  geom_point(aes(x = reorder(country3, diff_working_upper),
                 y = homclass,
                 shape=dclass3res_V,
                 color=dclass3res_V),
             size=3, alpha=2) +
  geom_hline(yintercept = mean(dfreg$homclass3_V_res),linetype=2)+
  scale_shape_manual(values = c(4,17, 15, 16)) +
  scale_color_manual(values = c("black","#000000","#666666","#999999")) +
  labs(x=NULL,y="Network homogeneity") +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust = 1,size=8),
        legend.title = element_blank())  
# mean(df_plot3$homclass)
# sd(df_plot3$homclass)
# ggsave(plot = last_plot(),filename = "slides-macro-homogen.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

Regarding network segregation, Figure \@ref(fig:fig2) depicts the distribution of network homogeneity and social class across countries. In contrast to redistributive preferences, the distribution of network homogeneity is more scattered between countries and social classes. However, it is worth to mention at least two interesting findings. First, looking at the sample average (M = 0.36), it can be noticed that the variation between countries is low (SD = 0.08), with Thailand being the society with higher levels of network segregation (M = 0.43), and Iceland among lowest (M = 0.31). Second, it is depicted that the working class network homogeneity drives the pattern of homogeneity. In addition, the general pattern is that the service class is less segregated than the intermediate and working class. Besides, an interesting fact is that in some cases (e.g., Mexico), although the working class remains highly segregated (above 0.5), the intermediate and service classes are similar in their network homogeneity. As noticed, in most cases observed, the general pattern is that the working class is highly homogeneous in their networks, except in the Philippines, where the intermediate class shows a slightly higher average homogeneity. Overall, one of the most substantial findings is that the working class is more segregated than the services class.

```{r fig3, fig.dim=c(10,5),fig.cap='Bivariate relationships between Income Inequality, Network homogeneity and Redistributive preferences',warning=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
set.seed(1234)
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         # gini_disp=scale(gini_disp),
         )
homo_ineq <- dfreg %>%
  # filter(country3 != "HUN") %>%
  group_by(country2,country3) %>%
  summarise_at(c("homclass3_V_res","egal","gini_disp","d10d1"), mean, na.rm = TRUE) %>% 
  as.data.frame()

# Plot Homogeneity and redistributive preferences
homo_ineq$country <- countrycode::countrycode(sourcevar = homo_ineq$country2,origin = "iso3c",destination = "iso2c")

fig_egal_homo <- 
homo_ineq %>%  
ggplot(aes(y=egal, x=homclass3_V_res)) +
  geom_smooth(method = "lm",fullrange=TRUE, color="black",linetype = 2,size=1,se = T) +
  geom_text_repel(label=as.character(homo_ineq$country)) +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") +
  labs(caption =paste("r = ",round(cor(homo_ineq$homclass3_V_res,
                                     homo_ineq$egal, use='complete.obs'),digits = 2)),tag = "A")
fig_homo_gini<- 
homo_ineq %>%  
ggplot(aes(y=homclass3_V_res, x=gini_disp)) +
  geom_smooth(method = "lm",fullrange=TRUE, color="black",linetype = 2,size=1,se = T) +
  # geom_text() +
  geom_text_repel(label=as.character(homo_ineq$country)) +
  xlab("Income Inequality") +
  ylab("Network homogeneity") +
  labs(caption =paste("r = ",round(cor(homo_ineq$homclass3_V_res,
                                     homo_ineq$gini_disp, use='complete.obs'),digits = 2)),tag = "B")
grid.arrange(fig_egal_homo,fig_homo_gini, nrow = 1)

# ggsave(plot = arrangeGrob(fig_egal_homo,fig_homo_gini, nrow = 1),filename = "slides-bivar.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

Moving to the bivariate macro relationships, Figure \@ref(fig:fig3) depicts the correlation between network homogeneity, redistributive preferences, and income inequality, our main societal characteristic of interest. First,  Panel A depicts a medium positive and significant association between network homogeneity and redistributive preferences (_r_ = 0.43, _p_ <.001). In concordance with the previously depicted distribution, the higher levels of network homogeneity are driven by the highly segregated networks of the working classes; what makes it logical that in countries where network homogeneity is high, this might also reflect greater social segregation among the working classes and consequently drive higher redistributive preferences. Second, Panel B depicts a positive but relatively weak and non significant association between income inequality and network homogeneity (_r_ = 0.28, _p_<.01). In other words, average homogeneity also tends to increase in societies with greater income gaps. However, the macro association only shows the general pattern between countries but does not allow us to look deeper into class differences according to the levels of inequality. 

Interestingly, certain countries with higher levels of inequality and network homogeneity are societies that present class differences between the working class and the services class (e.g., Thailand or Mexico). By contrast, more egalitarian countries tend to be less homogeneous and have smaller class differences (e.g., Denmark or Sweden). Besides, a supplementary analysis (see Fig. \@ref(fig:figapp1)) demonstrates that the association between income inequality and the gap in network homogeneity between the upper and lower classes tends to be moderate and statistically significant (_r_ = 0.3, _p_<.01). In other words, income inequality not only increase homogeneity overall but higher social distance between social classes as well.

## Multivariate results

```{r table1, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") 

# dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)
dfreg <- na.omit(dfreg)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
digclas1_VW_1<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner + (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_2<- update(digclas1_VW_1, . ~ . +know_total)
digclas1_VW_3 <- update(digclas1_VW_2, . ~ . + dclass3res_V)
digclas1_VW_5 <- update(digclas1_VW_3, . ~ . + edyears+ Q03pcm+workst)
digclas1_VW_7 <- update(digclas1_VW_5, . ~ . +dclass3res_V*homclass3_V_res)
digclas1_VW <- list(digclas1_VW_1,digclas1_VW_2,
                    digclas1_VW_3,
                    # digclas1_VW_4,
                    digclas1_VW_5,
                    # digclas1_VW_6,
                    digclas1_VW_7)

ccoef <- list(homclass3_V_res="Class-based network homogeneity",
              know_total="Network size",
              # socialtrust="Social Trust",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              # "femaleFemale"="Female (Ref. = Male)",
              # "agenum"="Age",
              # "age2"="Age2",
              "edyears"="Year of Education",
              "Q03pcmT02"="Income (T2)","Q03pcmT03"="Income (T3)","Q03pcmMissing"="Income (No information)",
              "workstNot in paid work" = "Not in paid work (Ref. = In paid work)",
              # "unionYes" ="Union Membership (Ref. = Not Unionized)",
              # "dclass3spo_VIntermediate class (III+IV)" = "Intermediate Class (Partner)",
              # "dclass3spo_VWorking Class (V+VI+VII)" = "Working Class (Partner)",              
              # "dclass3spo_VNo information (Missing, No partner)" = "No information (Not available, No partner)",
              "homclass3_V_res:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_res:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class")


texreg(digclas1_VW,stars = c(0.001, 0.01, 0.05, 0.1),single.row = F,
       caption = paste("(\\#tab:table1)","Multilevel models for network homogeneity and redistributive preferences"),
       custom.note = "\\item Note: Models include sampling weights. Gender, age, and marital status are included as controls. Standard errors in parentheses. %stars",threeparttable = T,
       caption.above = T,leading.zero = T,
       custom.coef.map = ccoef,
       symbol = "+",scalebox = 0.60,
      groups = list("Social Class (Ref.= Service Class)" = 3:5, "Household Income (Ref.= Tertile I)"= 6:8,
                    # "Partner's Social Class (Ref.= Service Class)" = 12:14,
      "Homogeneity x Social Class"=10:11),
      custom.gof.rows = list("Controls"=rep("Yes",5)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups","Var: Country (Intercept)","Var: Residual"),
       float.pos = "h!",
      # file = "table1.html"
       use.packages = F)
# performance::check_collinearity(digclas1_VW_5)
# performance::check_model(digclas1_VW_5,check="vif")
# performance::icc(digclas1_VW_5)
```

The multilevel analysis results are shown in Table \@ref(tab:table1). Regarding the first hypothesis, the central argument is that class segregation has differential consequences on redistributive preferences. In other words, the association between network homogeneity and redistributive preferences is conditional on class position. 

Model 1 integrates our measure of network homogeneity. Initially, as previously noted in the macro associations, individuals with more homogeneous networks tend to exhibit stronger redistributive preferences. This association is robust to network size in Model 2. However, after including social class in Model 3, the relationship between homogeneity and redistributive preferences appears to reverse, with a reduction in statistical significance (_p_> .05). Subsequently, Model 4 incorporates income, education in years and employment status. As expected, socioeconomic status is negatively associated with redistributive preferences regarding household economic resources and educational credentials. In addition,  people outside the labor market do not differ significantly from those who are economically active in their preferences. Finally,  incorporating the interaction term between network homogeneity and social class, Model 5 shows that the working and intermediate class interaction terms are positive and statistically significant. Based on Model 5, Figure \@ref(fig:fig4) shows increased redistributive preferences in homogeneous working-class networks and the intermediate class. For the service class, the relationship is reversed, where more homogeneous networks for this social class decrease redistributive preferences. Altogether, these results provide evidence in favor of hypothesis 1, where the class divide in redistributive preferences becomes stronger for individuals with more homogeneous social networks.

<!-- estimate std.error  statistic            p.value  conf.low conf.high -->
<!--  2.976180 0.8970721  3.3176597 0.0009077501054860  1.217951  4.734409 -->
<!--  1.029445 1.1996805  0.8580992 0.3908376677138878 -1.321886  3.380775 -->
<!-- -7.440596 1.1013920 -6.7556289 0.0000000000142217 -9.599284 -5.281907 -->


```{r fig4, fig.dim=c(10,5),fig.cap='Interaction of network homogeneity and social class on redistributive preferences',warning=FALSE}
int_homo <- digclas1_VW_7
df_pred1 <- 
  predictions(int_homo, condition = c("homclass3_V_res","dclass3res_V"),
              newdata = datagrid(homclass3_V_res = seq(min(dfreg$homclass3_V_res), max(dfreg$homclass3_V_res), by= 0.1),
                                 dclass3res_V = levels(dfreg$dclass3res_V)))
# names(df_pred1)
df_pred1 %>% 
ggplot(aes(y =estimate,x=homclass3_V_res, fill=dclass3res_V, color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=1,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=2,color="black") +
  facet_grid(~factor(dclass3res_V, levels=
                       c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)"),
                     c("Working Class","Intermediate Class","Service Class"))) +
  scale_fill_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_y_continuous(limits = c(55,80))+
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
       x="Network homogeneity",y="Redistributive preferences (0 - 100)") +
  theme(legend.position = "none", legend.title = element_blank())

ggsave(plot = last_plot(),filename = "slides-predictions.png",device = "png",
       path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)

# int_homo <- digclas1_VW_7
# plot_slopes(digclas1_VW_7, variables = "homclass3_V_res", condition = list("dclass3res_V"),draw = F)+
# labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
#      x="Social Class",y="Redistributive preferences",title = "Conditional Marginal Effects for Network Homogeneity")+
#   geom_hline(yintercept = 0,color="red",linetype=2)
       

# ggsave(plot = last_plot(),filename = "slides-marginal.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 10)
```

\newpage

```{r tab2, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(gini_disp))

dfreg$wstate2 <- scale(scale(dfreg$abs_red) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Gini index)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity x Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class*Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.7,
       caption = paste("(\\#tab:table2)","Multilevel models for income inequality, network homogeneity and redistributive preferences"),
       custom.note = "\\item Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = F,threeparttable = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity x Social Class"=7:8, "Homogeneity x Social Class x Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Country (Intercept)",
                           "Var: Country Homogeneity",
                           "Var: Country Intermediate Class ",
                           "Var: Country Working Class",
                           "Cov: Country (Intercept), Homogeneity",
                           "Cov: Country (Intercept), Intermediate Class ",
                           "Cov: Country (Intercept), Working Class",
                           "Cov: Country Homogeneity, Intermediate Class",
                           "Cov: Country Homogeneity, Working Class",
                           "Cov: Country Intermediate Class, Working Class",
                           "Var: Residual"),
        # file = "table2.html",
       use.packages = F)
```

Table \@ref(tab:table2) presents the results of the multilevel models for income inequality. In Model 1, income inequality demonstrates a positive association, as expected, yet it fails to reach significance. Subsequently, Model 2 incorporates economic prosperity through GDP per capita, revealing a negative and significant relationship (*p* > .05). Furthermore, Model 3 indicates that including the size of the welfare state establishes a positive and significant relationship (_p_ > .05). In contrast, GDP per capita maintains its negative association with redistributive preferences (_p_ > .01). In other words, in Model 3, economic prosperity appears to depress redistributive preferences. Nevertheless, higher redistributive preferences are observed in countries with more generous welfare states.

Finally, Model 4 incorporates the three-way interaction to determine whether the interaction of network homogeneity and social class on redistributive preferences is moderated by income inequality. First, the relationship observed at the micro level retains its original meaning, indicating that segregation in terms of network homogeneity strengthens the class divide in redistributive preferences. Second, the three-way interaction suggests that higher economic inequality weakens the interaction of network homogeneity and social class. To better illustrate this result, Figure \@ref(fig:fig5) depicts how the relationship between network homogeneity and social class is more pronounced in societies of lower income inequality and gradually diminishes as inequality increases. In other words, the results provide evidence in favor of Hypothesis 2, suggesting that the greater class divide in redistributive preferences observed in more segregated class-based social networks weakens as income inequality increases. 


```{r fig5, fig.dim=c(12,7),fig.cap='Three-way interaction of network homogeneity, social class and income inequality on redistributive preferences'}
### Predicted values homo*class*GiniD ---------------------------------------$
# ginid_max<- round(max(dfreg$gini_disp) ,2)
# ginid_min<- round(min(dfreg$gini_disp),2)

ginid_max<- round(mean(dfreg$gini_disp) + sd(dfreg$gini_disp)  ,2)
ginid_min<- round(mean(dfreg$gini_disp) -sd(dfreg$gini_disp) ,2)
ginid_mea<- round(mean(dfreg$gini_disp),2)

df_pred_giniD_gc <-
  predictions(
    homo_V_gini_full2,newdata = datagrid(
      gini_disp = c(ginid_min, ginid_mea, ginid_max),
      wstate2=mean(dfreg$wstate2),
      loggdppercapita=mean(dfreg$loggdppercapita),
      homclass3_V_gc = seq(min(dfreg$homclass3_V_gc)+0.01, max(dfreg$homclass3_V_gc)+0.01, by=0.1),
      dclass3res_V=levels(dfreg$dclass3res_V)
    )
  )

df_pred_giniD_gc <- as.data.frame(df_pred_giniD_gc)
df_pred_giniD_gc$gini_disp <- factor(df_pred_giniD_gc$gini_disp,labels = c("Gini (-1SD)","Gini (Mean)", "Gini (+1SD)"))
df_pred_giniD_gc <- df_pred_giniD_gc %>% filter(dclass3res_V!="Intermediate class (III+IV)")

df_pred_giniD_gc %>% 
  ggplot(aes(y=estimate,x=homclass3_V_gc, fill=dclass3res_V,color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=0.7,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=3, shape = 21,color="black") +
  facet_wrap(~gini_disp) +
  labs(y = "Redistributive preferences (0 - 100)",
       x="Network homogeneity (CWC)",
       caption = paste0("N=",nobs(homo_V_gini_full2),", Countries=",lme4::ngrps(homo_V_gini_full2))
       ) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Income inequality (post-tax) \n ", breaks = NULL, labels = NULL),
                     ) +
 
   scale_fill_manual(values=c("#323232","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#CCCCCC"))+
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text=element_text(size=15),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))

ggsave(plot = last_plot(),filename = "slides-predict-macro.png",device = "png",
       path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

# Discussion and conclusion

<!-- _Dicussion_  Luego de la presentación de los resultados, acá se comienza a volver a los argumentos del trabajo y se relaciona cada hipótesis con los resultados. Se sugiere ir por orden, y un párrafo para cada hipótesis. -->

This research asked how class-based network segregation is related to redistributive preferences and to what extent economic inequality moderates this relationship. The literature on interpersonal networks has shed light on how network structure harbors not only social resources [@lin_access_1986;@otero_open_2021] but also carries the capacity to establish niches that contribute to the formation of political opinions through social influence, as well as the degree of network segregation [@lindh_missing_2021;@paskov_crossclass_2022]. In contrast to the previous evidence on the direct diminishing influence of network homogeneity on social cohesion [@otero_lives_2022], the evidence presented in this study suggests that class segregation in terms of network homogeneity widens the already established class divide in redistributive preferences. Here, the interaction of class-based network homogeneity and social class shows that for working-class members, homogeneity strengthens their redistributive preferences, while in the service class, homogeneity translates into even lower redistributive preferences. 

The theoretical framework of this research posits that the study of the class divide in redistributive preferences should not exclusively address social classes regarding relations in the labor market but observe class in terms of the sociability structure in interpersonal networks. The literature has established that processes of social influence [@lindh_missing_2021] and political socialization [@lee_consider_2023] represent mechanisms that echo how social closure in interpersonal networks can trace a divide in redistributive preferences between social classes. This 'empathy gulf' [@sachweh_moral_2012] can be observed in how the service class is less willing to take action to strive against inequality as a matter of collective commitment when they are highly segregated in homogeneous upper-class environments, in contrast to the increasing redistributive pressures of the marginalized working class [@otero_power_2023]. Additionally, as network homogeneity represents low cross-class ties, it can be argued that lower social integration can undermine social solidarity [@blau_macrosociological_1977], as it consolidates weaker chances of contact between social classes and the lack of knowledge about the lives of others [@vargassalfate_contact_2023]. 

Besides the micro-level findings, this study has shown that economic inequality moderates the relationship between network segregation and redistributive preferences, which has not previously been discussed in an integrative empirical framework. On this behalf, the results from the multilevel models indicate that inequality _mitigates_ the micro-level relationship, which translates into a narrower class gap in redistributive preferences, mainly through changes in the service class. Empirically, 
these results resonate with evidence related to the role of inequality in class relations and redistributive preferences. It has been argued that in unequal societies, the better-off class tends to become more egalitarian in their attitudes toward economic inequality [@edlund_democratic_2015;@sachweh_why_2019]. Also, the results engage with the fact that upper classes can consolidate their distinctive position while their advantages allow them to navigate diverse networks at the expense of the marginalization of the poor in contexts of greater inequality [@otero_differences_2023]. 

In the theoretical framework adopted, economic inequality establishes the field for class relations and conflict that are consequently crystallized in political attitudes, where the class divide in redistributive preferences represents one aspect of the economic domain [@lindh_class_2020]. In addition, class relations can also be understood as networks of social connections between different class positions. Thus, social influence as a network mechanism on redistributive preferences can also be framed as the social force that intensifies class-based mechanisms such as self-interests and values in segregated networks [@lindh_missing_2021]. Here, the observed weaker interaction between class and homogeneity in more unequal countries can be interpreted in two non-exclusive manners. 
First, network diversity becomes more stratified as inequality increases, meaning that networks in the upper classes become less homogeneous as inequality rises. Second, given that the upper classes hold more egalitarian stances in more unequal societies, it is plausible to argue that class homogeneity can also reinforce opinion similarity when redistributive preferences are higher in the upper class. Therefore, network segregation could influence opinions by either weakening or reinforcing attitudes based on the average opinion about redistributing within a class.

<!-- _conclusion_-->

This research is a contribution to the field of study on social class and redistributive preferences, but it also contributes to previous studies that have emphasized the role of social ties in redistributive preferences [@newman_my_2014;@edlund_influence_2003;@langsaether_more_2020]. In addition, the cross-national component of this research dialogue with previous studies on the role of income inequality on social networks [@pichler_social_2009;@letki_getting_2015;@otero_differences_2023] and class-based research on redistributive preferences [@edlund_democratic_2015;@curtis_how_2015]. Overall, the diversity of societies analyzed contributes to the literature on redistributive preferences and social networks beyond affluent industrialized countries.

However, the present study entails some limitations. On the side of the dependent variable, a two-item index is a rough proxy of what is conceptually claimed as redistributive preferences. For example, poverty relief, tax reforms, or market regulations represent concrete actions on how governments strive with popular responses to economic inequality [@mccall_americans_2009;@garcia-sanchez_two_2022]. Additionally, the position generator included in the questionnaire is limited in its capability to reflect social classes more precisely, particularly the self-employed and intermediate-class positions. Hereby, the results should be taken with prudence as the measurement limitations are recognized. Finally, as structural contact opportunities and value-based interactions jointly shape social network composition, the cross-sectional data employed prevents causal claims from being made as endogeneity problems between class position, network composition, and attitudes are recognized. 

Future research should improve measurement strategies by including already established survey questions on attitudes toward market distribution of social services or willingness to pay taxes as redistributive measures. Additionally, class-based social networks can be improved by including other aspects of the market situation of network ties, such as self-employment status or authority in the workplace. Finally, longitudinal analyses can contribute to disentangling the causal mechanism involved in the link between social class, networks, and political attitudes.





\newpage

# References

```{=tex}
\scriptsize
\singlespacing
```

<div id="refs"> </div>  <!-- Although <div> is an HTML tag, this method also works for other output formats such as PDF. -->



\newpage

`r if (knitr::is_latex_output()){ '\\appendix'}`

`r if (knitr::is_latex_output()){ '\\section{Appendix}'}`


```{r status-ocup, echo=FALSE, cache=TRUE, results='asis'}
pacman::p_load(dplyr,knitr,kableExtra)  
# Create the data frame
df <- data.frame(
  # Item = c("c", "d", "a", "g", "h", "i", "j", "e", "b", "f"),
  Occupation = c("Home or office cleaner", "Hairdresser/barber", "Bus/lory driver", "Car mechanic", 
                 "Nurse", "Police officer", "School teacher", "Human resource manager", 
                 "Executive of large firm", "Lawyer"),
  ISEI08 = c(17, 32, 36, 38, 48, 54, 63, 68, 70, 85)
) %>% 
  arrange(-ISEI08)
kable(df,linesep = "",booktabs=TRUE,caption = "ISEI scores assigned to occupations included in the position generator instrument") %>%
  kable_styling(full_width = F,font_size = 10,latex_options = "HOLD_position") %>%
  column_spec(1,width = "10cm") %>%
  pack_rows("Higher-status positions", 1, 3) %>%
  column_spec(2) %>% 
  pack_rows("Middle-status positions", 4, 6) %>% 
  pack_rows("Lower-status positions", 7, 10) 
```



```{r descriptive, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,sjlabelled,haven,vtable)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  "gini_disp"=wid_gini_disp,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2,country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=gdppercapita/1000,
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         # gini_disp=scale(gini_disp)
         )

# dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

dfreg$wstate<- rowMeans(dfreg[,c("abs_red","ilo_taxrev","ilo_govspe")],na.rm = T)
dfreg$wstate2 <- ((dfreg$wstate-min(dfreg$wstate,na.rm = T))/(max(dfreg$wstate,na.rm = T)-min(dfreg$wstate,na.rm = T)))*100

dfreg1 <- dfreg %>% dplyr::select(
  egal,
  homclass3_V_res,
  know_total,
  # socialtrust,
  dclass3res_V,
  Q03pcm,
  edyears,
  # dclass3spo_V,  
  workst,
  # union,
  female,
  agenum,
  # religion,
  partner,
  "gini_disp",
  loggdppercapita,
  wstate2
  ) 

varlab <- 
c("Redistributive preferences","Class-based network homogeneity",
  "Network size",
  # "Social trust",
  "Social class",
  "Household Income","Education in years",
  # "Partner's Social Class",
  "Labor status",
  # "Union membership",
  "Gender","Age in years",
  # "Religion",
  "Has partner",
  "Income Inequality - Gini Index (post taxes and transfers)",
  "GDP/capita (in 1000 US dollars)",
  "Size of the welfare state (0 to 100 scores)")

sjlabelled::set_label(dfreg1) <- varlab
# names(dfreg) <- varlab


st(dfreg1,labels=T,
   title="Descriptive Statistics for Study Variables",
   out = "latex",
   digits = 2, 
   factor.counts = F,
   factor.numeric = F,
   summ = list(
     c('notNA(x)','mean(x)','sd(x)','min(x)','max(x)'),
     c('notNA(x)','mean(x)')
   ),
   summ.names = list(
     c('N','Mean','SD','Min','Max'),
     c('Count','Percent')   
   ))
```

\newpage

```{r desc-country, echo=FALSE, results='asis'}
dfreg %>% 
  group_by(country3) %>% 
  summarise(n=n(),
            homclass=mean(homclass3_V_res),
            gini_disp=mean(gini_disp),
            loggdppercapita=mean(loggdppercapita),
            wstate=mean(wstate2),) %>% 
  arrange(homclass) %>% 
  kable(digits = 2,booktabs = TRUE,format = "latex", linesep = "",
        caption = "Contextual variables by country",
        col.names = c("Country","N","Network Homogeneity","Gini Index","GDP/capita in $1000","Size of the Welfare State")) %>% 
  kable_styling(full_width = F,latex_options = "scale_down") %>% 
  column_spec(1, width = "3.2cm") %>% 
  column_spec(2:6, width = "3cm") %>% 
  footnote(general = "Data sources are from the ISSP 2017 - Social Networks, WID and ILO. Contextual variables in original scale")
```



```{r figapp1, fig.dim=c(5,5),out.width='50%',fig.cap='Bivariate relationships between Income Inequality and Class differences in network homogeneity',warning=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         # gini_disp=scale(gini_disp),
         )

homo_ineq <- dfreg %>%
  group_by(country2,country3) %>%
  summarise_at(c("homclass3_V_res","egal","gini_disp"), mean, na.rm = TRUE) %>% 
  as.data.frame()

homo_class_diff <- dfreg %>%   
  group_by(country2,country3,dclass3res_V) %>%
  summarise_at(c("egal","homclass3_V_res"), mean, na.rm = TRUE) %>% 
  as.data.frame() %>%
  dplyr::select(country3,homclass3_V_res,dclass3res_V) %>% 
  tidyr::pivot_wider(names_from = "dclass3res_V", values_from = "homclass3_V_res") %>% 
  mutate(diff_working_upper_homo = `Working Class (V+VI+VII)` - `Service Class (I+II)`) %>% 
  as.data.frame()

# Dataset with class differences in network homogeneity
homo_ineq <- homo_ineq %>% left_join(homo_class_diff)

# Plot Homogeneity and redistributive preferences
homo_ineq$country <- countrycode::countrycode(sourcevar = homo_ineq$country2,origin = "iso3c",destination = "iso2c")

fig_homodiff_gini<- 
homo_ineq %>%  
ggplot(aes(y=diff_working_upper_homo, x=gini_disp)) +
  geom_smooth(method = "lm",fullrange=TRUE, color="black",linetype = 2,size=1,se = T) +
  # geom_text() +
  geom_text_repel(label=as.character(homo_ineq$country)) +
  xlab("Income Inequality") +
  ylab("Class Differences in Network homogeneity \n (Working Class - Service Class)") +
  labs(caption =paste("r = ",round(cor(homo_ineq$diff_working_upper_homo,
                                     homo_ineq$gini_disp, use='complete.obs'),digits = 2)),tag = NULL)

grid.arrange(fig_homodiff_gini, nrow = 1)

ggsave(plot = arrangeGrob(fig_homodiff_gini, nrow = 1),filename = "slides-bivar-homodiff.png",device = "png",
       path = here::here("output/images"),width = 1,height = 1,units = "cm",scale = 17)
```

\pagebreak 



# Supplementary analysis

## Income inequality ratios 

```{r tab2-ratio9010, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(d10d1))

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+         
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Ratio 90/10)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.50,
       caption = "Multilevel models for Income Inequality, Network segregation and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity*Social Class"=7:8, "Homogeneity * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Homogeneity",
                           "Var: Group Intermediate Class ",
                           "Var: Group Working Class",
                           "Cov: Group (Intercept), Homogeneity",
                           "Cov: Group (Intercept), Intermediate Class ",
                           "Cov: Group (Intercept), Working Class",
                           "Cov: Group Homogeneity, Intermediate Class",
                           "Cov: Group Homogeneity, Working Class",
                           "Cov: Group Intermediate Class, Working Class",
                           "Var: Residual"),
       use.packages = F)
```

```{r tab2-ratio9050, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(wid_p90p50))

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Ratio 90/50)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.50,
       caption = "Multilevel models for Income Inequality, Network segregation and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity*Social Class"=7:8, "Homogeneity * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Homogeneity",
                           "Var: Group Intermediate Class ",
                           "Var: Group Working Class",
                           "Cov: Group (Intercept), Homogeneity",
                           "Cov: Group (Intercept), Intermediate Class ",
                           "Cov: Group (Intercept), Working Class",
                           "Cov: Group Homogeneity, Intermediate Class",
                           "Cov: Group Homogeneity, Working Class",
                           "Cov: Group Intermediate Class, Working Class",
                           "Var: Residual"),
       use.packages = F)
```

\pagebreak
## Income inequality groups

```{r table1-ineq-groups, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") 


# dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)

dfreg <- na.omit(dfreg)
tab_countries<- 
  dfreg %>% 
  group_by(country3) %>% 
  summarise(gini_disp=mean(gini_disp)) %>% 
  mutate(gini_q05=ntile(gini_disp,5),
         gini_d10=ntile(gini_disp,10)) %>% as.data.frame() %>% 
  arrange(gini_d10) %>% 
  dplyr::select(-gini_disp)

dfreg <- dfreg %>% left_join(tab_countries,by="country3")


## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$

library(estimatr)

# Quintile 1 (low)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==1),weights = WEIGHT)
digclas1_VW_Q1_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_Q1_2 <- update(digclas1_VW_Q1_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 2 (mid-low)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==2),weights = WEIGHT)
digclas1_VW_Q2_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+age2+edyears+ Q03pcm+workst)
digclas1_VW_Q2_2 <- update(digclas1_VW_Q2_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 3 (middle)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==3),weights = WEIGHT)
digclas1_VW_Q03_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_Q03_2 <- update(digclas1_VW_Q03_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 4 (middle-high)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum + partner +  factor(country2),data=subset(dfreg,gini_q05==4),weights = WEIGHT)
digclas1_VW_Q04_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_Q04_2 <- update(digclas1_VW_Q04_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 5 (high)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==5),weights = WEIGHT)
digclas1_VW_Q05_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+age2+edyears+ Q03pcm+workst)
digclas1_VW_Q05_2<- update(digclas1_VW_Q05_1, . ~ . +dclass3res_V*homclass3_V_res)

digclas1_Q05 <- 
list(digclas1_VW_Q1_1,digclas1_VW_Q1_2,digclas1_VW_Q2_1,digclas1_VW_Q2_2,
     digclas1_VW_Q03_1,digclas1_VW_Q03_2,digclas1_VW_Q04_1,digclas1_VW_Q04_2,
     digclas1_VW_Q05_1,digclas1_VW_Q05_2)

ccoef <- list(homclass3_V_res="Class-based network homogeneity",
              know_total="Network size",
              # socialtrust="Social Trust",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              # "femaleFemale"="Female (Ref. = Male)",
              # "agenum"="Age",
              # "age2"="Age2",
              "edyears"="Year of Education",
              "Q03pcmT02"="Income (T2)","Q03pcmT03"="Income (T3)","Q03pcmMissing"="Income (No information)",
              "workstNot in paid work" = "Not in paid work (Ref. = In paid work)",
              # "unionYes" ="Union Membership (Ref. = Not Unionized)",
              # "dclass3spo_VIntermediate class (III+IV)" = "Intermediate Class (Partner)",
              # "dclass3spo_VWorking Class (V+VI+VII)" = "Working Class (Partner)",              
              # "dclass3spo_VNo information (Missing, No partner)" = "No information (Not available, No partner)",
              "homclass3_V_res:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_res:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class")


header <- list("Q1"=1:2,"Q2"=3:4,"Q3"=5:6,"Q4"=7:8,"Q5"=9:10)
texreg(digclas1_Q05,stars = c(0.001, 0.01, 0.05, 0.1),single.row = F,include.ci = FALSE,custom.header = header,
       caption = paste("(\\#tab:table1-groups)","Fixed effects linear regression models for Class-based network segregation and Redistributive Preferences by Income Inequality Quintiles"),
       custom.note = "Note: Models include sampling weights. Gender, age and marital status are included as controls. Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,
       custom.coef.map = ccoef,
       symbol = "+",scalebox = 0.55,
      groups = list("Social Class (Ref.= Service Class)" = 3:4, "Household Income (Ref.= Tertile I)"= 6:8,  
                    # "Partner's Social Class (Ref.= Service Class)" = 12:14, 
                    "Homogeneity x Social Class"=10:11),
      custom.gof.rows = list("Country FE"=rep("Yes",10)),
      # include.loglik = FALSE,include.aic = FALSE,
      # custom.gof.names = c(NA,NA,"Num. groups","Var: Country (Intercept)","Var: Residual"),
       float.pos = "h!",
      # file = "table1.html"
       use.packages = F)
```


```{r fig1-marg-ineqgrup, fig.dim=c(15,5),fig.cap='Average Marginal Effects of Network homogeneity conditioned by Social class on Redistributive Preferences by Income Inequality Groups',warning=FALSE}
marginal <- bind_rows(
plot_slopes(digclas1_VW_Q1_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=1),
plot_slopes(digclas1_VW_Q2_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F)  %>% mutate(quintile=2),
plot_slopes(digclas1_VW_Q03_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=3),
plot_slopes(digclas1_VW_Q04_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=4),
plot_slopes(digclas1_VW_Q05_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=5))
marginal$quintile <- factor(marginal$quintile,labels = c("Gini (Q1)","Gini Q2","Gini Q3","Gini Q4","Gini Q5"))
marginal$dclass3res_V <- forcats::fct_rev(marginal$dclass3res_V)

ggplot(data=marginal,aes(x = dclass3res_V, y = estimate,ymin= conf.low, ymax=conf.high)) +
  geom_point(size=2) + 
  geom_errorbar(width=.2)+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  geom_hline(yintercept = 0,color="red") +
  facet_grid(~quintile) +
  labs(x=NULL,y="Redistributive preferences"
       # title = "Average Marginal Effects for Class-based network segregation on Redistributive preferences by Social Class and Income Inequality groups"
       )  

```

\pagebreak

<!-- ## OECD Countries -->

```{r tab2-ocde, eval=FALSE, cache=TRUE, include=FALSE, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1) 
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(gini_disp))

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Gini index)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.60,
       caption = "Multilevel models for Income Inequality, Network segregation and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity*Social Class"=7:8, "Homogeneity * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Homogeneity",
                           "Var: Group Intermediate Class ",
                           "Var: Group Working Class",
                           "Cov: Group (Intercept), Homogeneity",
                           "Cov: Group (Intercept), Intermediate Class ",
                           "Cov: Group (Intercept), Working Class",
                           "Cov: Group Homogeneity, Intermediate Class",
                           "Cov: Group Homogeneity, Working Class",
                           "Cov: Group Intermediate Class, Working Class",
                           "Var: Residual"),
       use.packages = F)
```

```{r fig5-ocde, eval = FALSE,include = FALSE,fig.dim=c(12,7),fig.cap='Three-way interaccion effects for Redistributive Preferences, Network segregation, Social class and Income Inequality'}
### Predicted values homo*class*GiniD ---------------------------------------$
# ginid_max<- round(max(dfreg$gini_disp) ,2)
# ginid_min<- round(min(dfreg$gini_disp),2)

ginid_max<- round(mean(dfreg$gini_disp) + sd(dfreg$gini_disp)  ,2)
ginid_min<- round(mean(dfreg$gini_disp) -sd(dfreg$gini_disp) ,2)
ginid_mea<- round(mean(dfreg$gini_disp),2)

df_pred_giniD_gc <-
  predictions(
    homo_V_gini_full2,newdata = datagrid(
      gini_disp = c(ginid_min, ginid_mea, ginid_max),
      wstate2=mean(dfreg$wstate2),
      loggdppercapita=mean(dfreg$loggdppercapita),
      homclass3_V_gc = seq(min(dfreg$homclass3_V_gc)+0.01, max(dfreg$homclass3_V_gc)+0.01, by=0.1),
      dclass3res_V=levels(dfreg$dclass3res_V)
    )
  )

df_pred_giniD_gc <- as.data.frame(df_pred_giniD_gc)
df_pred_giniD_gc$gini_disp <- factor(df_pred_giniD_gc$gini_disp,labels = c("Gini (-1SD)","Gini (Mean)", "Gini (+1SD)"))
df_pred_giniD_gc <- df_pred_giniD_gc %>% filter(dclass3res_V!="Intermediate class (III+IV)")

df_pred_giniD_gc %>% 
  ggplot(aes(y=estimate,x=homclass3_V_gc, fill=dclass3res_V,color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=0.7,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=3, shape = 21,color="black") +
  facet_wrap(~gini_disp) +
  labs(y = "Preferences for Redistribution",
       x="Network homogeneity (CWC)",
       caption = paste0("N=",nobs(homo_V_gini_full2),", Countries=",lme4::ngrps(homo_V_gini_full2))
       ) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Income inequality (post-tax) \n ", breaks = NULL, labels = NULL),
                     ) +
 
   scale_fill_manual(values=c("#323232","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#CCCCCC"))+
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text=element_text(size=15),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))
```

\pagebreak

## Social Distance by ISEI 

First, the average scores of the International Socio-Economic Index of Occupational Status (ISEI) [@ganzeboom_new_2010] for each occupation of the position generator are calculated. Second, the ISEI score of the respondent (R's) is subtracted from the average ISEI points of the personal network. For example, if the R's has an ISEI of 80 and the network ISEI is 50, the social distance will be 30 (80 - 50), a "upward" social distance. Another case could be 50 (R's) minus 80 (network), and the average social distance will be - 30 or "downward" social distance. In addition, when the distance is 0, the network is entirely homogeneous.

To facilitate the interpretation of the indicator, the homogeneity indicator based on social distance is calculated:

1. The absolute values are calculated to represent the total distance to occupations concerning R's ISEI score.
2. Since there are values of 0 representing absolute homogeneity, the variable is rescaled by summing 1.
3. The values were inverted to make higher values represent higher homogeneity.

Thus, higher values represent greater homogeneity regarding R's ISEI score in contrast to the average network ISEI score.

```{r desc-social, eval=FALSE, include=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4,correlation)
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  dclass3spo_V,
  homclass3_V_res=socdist,
  know_total,
  socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  religion,
  union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2,
         homclass3_V_res=homclass3_V_res/10) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN")

dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)

dfreg <- na.omit(dfreg)
```


```{r table1-socdist, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dummy_df <- df1 %>% dplyr::select(id,
  egal = egal2,dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,edyears,female,agenum,
  # religion,
  partner,
  # union,
  workst,WEIGHT,region,
  "gini_disp"=wid_gini_disp,"gini_mkt",gv_spen,rel_red,abs_red,ilo_taxrev,
  ilo_govspe,d10d1=wid_p90p10,wid_p90p50,top10=wid_sharetop10,rgdpna,gdppercapita,
  oecd,country2, country, country3) %>%
  filter(country2 != "SVN") %>% 
  # filter(oecd == "OECD") %>%
  na.omit() %>% 
  dplyr::select(id)

df1$isei08sp <- car::recode(df1$isei08sp,"NA=0")
df1$isei08 <- car::recode(df1$isei08,"NA=0")

dfreg <- df1 %>% dplyr::select(id,
  egal = egal2,
  dclass3res_V=isei08,
  # dclass3spo_V=isei08sp,
  homclass3_V_res=socdist,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2,
         dclass3res_V=dclass3res_V/10,
         # dclass3spo_V=dclass3spo_V/10,
         homclass3_V_res=homclass3_V_res/10
         ) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN")  %>% 
  filter(id %in% dummy_df$id)
dfreg <- na.omit(dfreg)

# Step 1: Calculate absolute values
absolute_values <- abs(dfreg$homclass3_V_res)
# hist(absolute_values);summary(absolute_values)

# Step 2: Add 1 to all values to eliminate zeros
modified_values <- absolute_values + 0.1
# hist(modified_values);summary(modified_values)

# Step 3: Reverse the order of the scale
reversed_values <- max(modified_values) + 0.1 - modified_values
# hist(reversed_values);summary(reversed_values) 
dfreg$homclass3_V_res <- reversed_values


## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
digclas1_VW_1<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner + (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_2<- update(digclas1_VW_1, . ~ . +know_total)
digclas1_VW_3 <- update(digclas1_VW_2, . ~ . + dclass3res_V)

digclas1_VW_4 <- update(digclas1_VW_3, . ~ . + dclass3res_V+female+agenum)
digclas1_VW_5 <- update(digclas1_VW_3, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_6 <- update(digclas1_VW_3, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_7 <- update(digclas1_VW_6, . ~ . +dclass3res_V*homclass3_V_res)
digclas1_VW <- list(digclas1_VW_1,digclas1_VW_2,
                    digclas1_VW_3,
                    # digclas1_VW_4,
                    digclas1_VW_5,digclas1_VW_6,digclas1_VW_7)

ccoef <- list(homclass3_V_res="Social Distance /10",
              know_total="Network size",
              # socialtrust="Social Trust",
              # "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              # "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              # "femaleFemale"="Female (Ref. = Male)",
              # "agenum"="Age",
              # "age2"="Age2",
              "dclass3res_V"="ISEI/10",
              "edyears"="Year of Education",
              "Q03pcmT02"="Income (T2)","Q03pcmT03"="Income (T3)","Q03pcmMissing"="Income (No information)",
              "workstNot in paid work" = "Not in paid work (Ref. = In paid work)",
              # "unionYes" ="Union Membership (Ref. = Not Unionized)",
              # "dclass3spo_V" = "ISEI/10 (Partner)",
              "homclass3_V_res:dclass3res_V" = "Social Distance*ISEI")


texreg(digclas1_VW,stars = c(0.001, 0.01, 0.05, 0.1),
       caption = paste("(\\#tab:table2)","Multilevel models for Social Distance and Redistributive Preferences"),
       custom.note = "Note: Models include sampling weights. Gender, age, marital status and religion are included as controls. Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,
       custom.coef.map = ccoef,
       symbol = "+",scalebox = 0.60,
      custom.gof.rows = list("Controls"=rep("Yes",6)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups","Var: Country (Intercept)","Var: Residual"),
       float.pos = "h!",
       use.packages = F)
```

\newpage

```{r fig1-marg-socdist, fig.dim=c(10,5),fig.cap='Average Marginal Effects of Social Distance conditioned by ISEI on Redistributive Preferences',warning=FALSE}
int_homo <- digclas1_VW_7
plot_slopes(digclas1_VW_7, variables = "homclass3_V_res", condition = list("dclass3res_V" = "threenum"))+
labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
       x="ISEI",y="Redistributive preferences")
```

```{r fig1-pred-socdist, fig.dim=c(10,5),fig.cap='Linear Predictions for Social Distance on Redistributive Preferences by ISEI',warning=FALSE}
int_homo <- digclas1_VW_7
df_pred1 <- 
  predictions(int_homo, condition = c("homclass3_V_res","dclass3res_V"),
              newdata = datagrid(homclass3_V_res = seq(min(dfreg$homclass3_V_res), max(dfreg$homclass3_V_res), by= 0.5),
                                 dclass3res_V = c(min(dfreg$dclass3res_V),mean(dfreg$dclass3res_V),max(dfreg$dclass3res_V))))

df_pred1$dclass3res_V <- factor(df_pred1$dclass3res_V,labels = c("ISEI (min)","ISEI (Mean)", "ISEI (max)"))

# names(df_pred1)
df_pred1 %>% 
ggplot(aes(y =estimate,x=homclass3_V_res, fill=dclass3res_V, color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=1,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=2,color="black") +
  # facet_grid(~dclass3res_V) +
  scale_fill_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_y_continuous(limits = c(40,100))+
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
       x="Social distance",y="Redistributive preferences") +
  theme(legend.position = "bottom", legend.title = element_blank())
```

\pagebreak

```{r tab2-socdist, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
dummy_df <- df1 %>% dplyr::select(id,
  egal = egal2,dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,know_total,
  # socialtrust,
  Q03pcm,edyears,female,agenum,
  # religion,
  partner,
  # union,
  workst,WEIGHT,region,
  "gini_disp"=wid_gini_disp,"gini_mkt",gv_spen,rel_red,abs_red,ilo_taxrev,
  ilo_govspe,d10d1=wid_p90p10,wid_p90p50,top10=wid_sharetop10,rgdpna,gdppercapita,
  oecd,country2, country, country3) %>%
  filter(country2 != "SVN") %>% 
  # filter(oecd == "OECD") %>%
  na.omit() %>% 
  dplyr::select(id)

df1$isei08sp <- car::recode(df1$isei08sp,"NA=0")
dfreg <- df1 %>% dplyr::select(id,
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V=isei08,
  # dclass3spo_V=isei08sp,
  homclass3_V_res=socdist,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(gini_disp),
         dclass3res_V=dclass3res_V/10,
         # dclass3spo_V=dclass3spo_V/10,
         homclass3_V_res=homclass3_V_res/10
         ) %>% 
  filter(id %in% dummy_df$id)

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))
# Step 1: Calculate absolute values
absolute_values <- abs(dfreg$homclass3_V_res)
# hist(absolute_values);summary(absolute_values)

# Step 2: Add 1 to all values to eliminate zeros
modified_values <- absolute_values + 0.1
# hist(modified_values);summary(modified_values)

# Step 3: Reverse the order of the scale
reversed_values <- max(modified_values) + 0.1 - modified_values
# hist(reversed_values);summary(reversed_values) 

dfreg$homclass3_V_res <- reversed_values


# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

dfreg$dclass3res_V = group_center(as.numeric(dfreg$dclass3res_V), grp = dfreg$country2)



# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)
# dfreg$dclass3spo_V_gc = group_center(dfreg$dclass3spo_V, grp = dfreg$country2)


# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Social Distance (CWC)",
              "dclass3res_V"="ISEI ",
              "gini_disp" = "Income inequality (Gini index)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_V" = "Distance*ISEI",
              "homclass3_V_gc:gini_disp"= "Distance*Income Inequality",
              "dclass3res_V:gini_disp" ="ISEI*Inequality",
              "homclass3_V_gc:dclass3res_V:gini_disp" = "Distance*Working Class*Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.60,
       caption = "Multilevel models for Income Inequality, Social Distance and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      # groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Distance*Social Class"=7:8, "Distance * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Soc. Distance",
                           "Var: Group ISEI",
                           "Cov: Group (Intercept), Soc. Distance",
                           "Cov: Group (Intercept), ISEI",                           
                           "Cov: Group Soc. Distance, ISEI",
                           "Var: Residual"),
       use.packages = F)
```

```{r fig2-socdist, fig.dim=c(12,7),fig.cap='Three-way interaccion effects for Redistributive Preferences, Social Distance, ISEI and Income Inequality'}
### Predicted values homo*class*GiniD ---------------------------------------$
# ginid_max<- round(max(dfreg$gini_disp) ,2)
# ginid_min<- round(min(dfreg$gini_disp),2)

ginid_max<- round(mean(dfreg$gini_disp) + sd(dfreg$gini_disp)  ,2)
ginid_min<- round(mean(dfreg$gini_disp) -sd(dfreg$gini_disp) ,2)
ginid_mea<- round(mean(dfreg$gini_disp),2)

df_pred_giniD_gc <-
  predictions(
    homo_V_gini_full2,newdata = datagrid(
      gini_disp = c(ginid_min, ginid_mea, ginid_max),
      wstate2=mean(dfreg$wstate2),
      loggdppercapita=mean(dfreg$loggdppercapita),
      homclass3_V_gc = seq(min(dfreg$homclass3_V_gc)+0.01, max(dfreg$homclass3_V_gc)+0.01, by=0.5),
      dclass3res_V=c(min(dfreg$dclass3res_V),max(dfreg$dclass3res_V))
    )
  )

df_pred_giniD_gc <- as.data.frame(df_pred_giniD_gc)
df_pred_giniD_gc$gini_disp <- factor(df_pred_giniD_gc$gini_disp,labels = c("Gini (-1SD)","Gini (Mean)", "Gini (+1SD)"))

df_pred_giniD_gc$dclass3res_V <- factor(df_pred_giniD_gc$dclass3res_V,labels = c("ISEI (min)","ISEI (max)"))
# df_pred_giniD_gc <- df_pred_giniD_gc %>% filter(dclass3res_V!="Intermediate class (III+IV)")

df_pred_giniD_gc$dclass3res_V <- as.factor(df_pred_giniD_gc$dclass3res_V)

df_pred_giniD_gc %>% 
  ggplot(aes(y=estimate,x=homclass3_V_gc, fill=dclass3res_V,color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=0.7,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=3, shape = 21,color="black") +
  facet_wrap(~gini_disp) +
  labs(y = "Preferences for Redistribution",
       x="Social Distance (CWC)",
       caption = paste0("N=",nobs(homo_V_gini_full2),", Countries=",lme4::ngrps(homo_V_gini_full2))
       ) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Income inequality (post-tax) \n ", breaks = NULL, labels = NULL),
                     ) +
 
   scale_fill_manual(values=c("#323232","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#CCCCCC"))+
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text=element_text(size=15),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))
```

```{r table1-alternative, eval=FALSE, include=FALSE, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V=dclass6res,
  # homclass3_V_res=homclass3_V_res_part,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") 


# dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)

dfreg <- na.omit(dfreg)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
digclas1_VW_1<- lmer(egal~1 + homclass3_V_res + female+agenum+(1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_2<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner +  (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_3<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner +  (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_4<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner +  know_total + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_6<- lmer(egal~1 + homclass3_V_res + female+agenum+ 
                       partner +  know_total +   
                       dclass3res_V + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_7<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +   know_total +  
                       dclass3res_V +  edyears + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_8<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total + 
                       dclass3res_V +  edyears +  Q03pcm +(1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_9<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total +  
                       dclass3res_V +  edyears +  Q03pcm + workst +(1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_10<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total + 
                       dclass3res_V +  edyears +  Q03pcm + workst + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_10a<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total + 
                       dclass3res_V +  edyears +  Q03pcm + workst + (homclass3_V_res|country2),data=dfreg,weights = WEIGHT)


digclas1_VW_11 <- update(digclas1_VW_10, . ~ . +dclass3res_V*homclass3_V_res)

digclas1_VW <- list(digclas1_VW_1,digclas1_VW_2,digclas1_VW_3,digclas1_VW_4,
                    digclas1_VW_6,digclas1_VW_7,digclas1_VW_8,digclas1_VW_10,digclas1_VW_10a,
                    digclas1_VW_11)

screenreg(digclas1_VW)
plot_slopes(digclas1_VW_11, variables = "homclass3_V_res", by = "dclass3res_V",draw = T)
```

