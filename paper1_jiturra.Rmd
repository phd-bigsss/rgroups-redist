---
title: "Class-based network segregation, Economic Inequality and Redistributive Preferences across societies"
css: "input/css/custom.css" # custom CSS para html
fontsize: 12pt
linestretch: '1.15'          # interlineado 
papersize: a4
link-citations: yes         # citas linkeadas
lang: en-US
# date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
date: "`r format(Sys.Date(), '%d %B %Y')`"
author:
- name: Julio Iturra-Sanhueza
  affiliation: Bremen International Graduate School of Social Sciences
  email: jiturra@uni-bremen.de
#   number: 1
# - name: Justin d'Ottawa
#   affiliation: University of Ottawa
#   number: 2
# - name: Pedro Torres
#   number: 1,2 
# Nota: Autores que comparten filiacion, poner el mismo number y declarar filiación una sola vez.  
abstract: | 
  | The escalating economic inequality and the current sanitary crisis have threatened social solidarity among citizens. However, these consequences have been unevenly experienced across the social structure where the upper and intermediate classes, benefiting from privileged access to social resources, have shown resilience. Conversely, working-class families have faced deteriorating material conditions, leading to a heightened sense of marginalization and increasing the demand for welfare support. Particularly, social resources through network ties have been suggested to have a direct link with an individual's welfare through instrumental and expressive outcomes, such as providing information or help in moments of need. Consequently, it has been argued that social isolation not only plays a role in terms of social resources, but higher levels of segregation can bolster opinions, suggesting that being isolated from other social classes can polarise attitudes mainly in the working and upper-middle classes. In this regard, based on the ISSP 2017 -  Social Networks (N=31,191),  multilevel estimations suggest that the influence of network homogeneity is conditional to social class, where the working and intermediate classes with high homogeneous networks hold higher redistributive preferences than the upper classes. Additionally, income inequality has been shown to decrease the polarizing effect of network segregation, mainly among the upper classes, when overall inequality is high. In sum, this study highlights the role of both social class and network segregation together to understand redistributive preferences, as well as their implications for policies and cohesion.
  | 
  | **Keywords**: network segregation, redistributive preferences, economic inequality
output:
  bookdown::pdf_document2:
    template: null
    toc: false
    keep_tex: false
    number_sections: true
    pandoc_args:
      - --template=input/mytemplate.tex #custom template para usar autores con afiliacion  
  bookdown::html_document2:
    toc: yes
    code_folding: hide
    number_sections: false
    toc_float:
      collapsed: false
      smooth_scroll: false
         
always_allow_html: true      
linkcolor: gray                         # enlaces y citas en color azul
bibliography: input/bib/rgroup-redist.bib     # bibliografia en bibtex
csl: input/bib/apa6.csl
editor_options:
  chunk_output_type: console            # en RStudio, mostrar output en consola
geometry: "left=2.54cm,right=2.54cm,top=2.54cm,bottom=2.54cm" # márgenes de página
header-includes:
  - \usepackage{times}           # Times New Roman
  - \usepackage{caption}
  - \captionsetup[figure, table]{labelfont={bf},labelformat={default},labelsep=period}
  - \usepackage{graphicx}
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \setlength\parindent{24pt} 
  - \usepackage{fancyhdr}
  - \fancyhead{} 
---

```{r eval=FALSE, include=FALSE}
 # for render in pdf run rmarkdown::render_site("docs/paper.Rmd", output_format = "all")
 # clean #in the yml
 rmarkdown::render("paper1_jiturra.Rmd", output_format = "bookdown::pdf_document2")
 rmarkdown::render("paper1_jiturra.Rmd", output_format = "bookdown::html_document2")
 rmarkdown::render("paper1_jiturra.Rmd", output_format = "bookdown::word_document2")
 
 # install.packages("trackdown")
 trackdown::update_file(file = "paper1_jiturra.Rmd", hide_code = TRUE,gpath = '001_PhD/002dissertation/paper1')
                        
```

<!-- - considerar ISEI08 como alternativa de social class por la correlacion con homogeneidad -->
<!-- - darle una oportunidad al h-index -->
<!--     - en general es prácticamente lo mismo que el indicador de homogeneidad -->
<!-- - controlaria por social activities index () -->
<!-- - social resources  -->
    
```{r setup, include=FALSE}
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(knitr, kableExtra, dplyr, ggplot2,sjmisc,texreg) # librerias
knitr::opts_chunk$set(warning = FALSE,  # mensaje de warning
                      message = FALSE,  # mensajes/avisos de librerias  
                      cache = F,    # cache de los chunks,usar analisis pesados
                      out.width = '100%',
                      fig.pos= "H",     # posicion figuras H = HERE
                      fig.align = "center",
                      echo = FALSE      # incluir chunk en output
                      )
options(scipen=999) # notacion cientifica
rm(list=ls())       # limpiar workspace
options(knitr.kable.NA = '') # NA en kable = ''
```
\pagestyle{fancy}
\fancyhead[R]{\thepage}
\fancyhead[L]{Research Article Draft}

\pagebreak 
# Introduction  

Rising economic inequality over the past decades [@piketty_capital_2014] and the recent sanitary crisis have raised citizens' concerns about economic inequality, pushing governments to enact redistributive policies, which has tested the capacity of welfare systems to provide sufficient risk protection for their citizens [@breznau_welfare_2021]. However, the privileged access to resources held by the upper and intermediate classes has consolidated their resilience capacity in times of greater economic hardship, allowing them to maintain a relatively stable standard of living, in contrast to the decline in the material conditions of working-class families [@moawad_myth_2023]. In this regard, it has been claimed that economic gaps in economic resources also have a greater effect on social relations. Studies on the role of economic inequality have argued that social bonding can be threatened when economic inequality increases, undermines how people perceive each other, their opportunities to participate in social life, and the capacity to knit networks that contribute to social integration [@lancee_income_2012;@letki_getting_2015]. Therefore, experiencing segregated networks is one of the consequences of greater economic gaps as it represents greater distance between the different social classes  [@pichler_patterns_2007;@otero_space_2022]. In this regard, it has been argued that segregation can threaten social cohesion and solidarity [@joye_measuring_2019], which in turn can undermine public support for welfare schemes and redistribution [@baldassarri_diversity_2020]. 

The sociological tradition has understood social classes through the labor market situation of occupations in terms of employment relations, skill level, and authority within the workplace [@Erikson1992;@Erikson1979]. Likewise, classes represent relations in the labor market and trace lines in terms of status relations as the foundations for opportunities for action and the consolidation of lifestyles [@weber_economy_1978]. 
In this matter, the class situation of individuals and households also trace distinctions in various domains of social life, such as cultural consumption behavior [@Chan2007;@torche_social_2007], ideological preferences [@evans_decline_1993], and popular opinions about the welfare state and redistribution [@Svallfors2006]. Regarding the latter, despite the claims of a displacement of the distributive struggle between classes by other group identities [@clark_declining_1993;@inglehart_culture_1990], past decade research has persistently demonstrated that class positions indeed still explain economic attitudes towards the welfare state and redistribution [@lindh_class_2020, p. 421]. Thus, the claimed blurring of the class cleavage has not been strongly supported while the class differences have been evidenced in perceived class conflicts [@perez_class_2023;@edlund_democratic_2015], attitudes on market-based inequality [@andersen_preferences_2018;@lindh_public_2015], and redistributive preferences [@curtis_how_2015;@langsaether_more_2020;@brooks_why_2010]. 

However, the study of redistributive preferences has been mainly focused on the individual and household situation. In contrast, less attention has been paid to the sociability structures embedded in class relations regarding social tie formation. In this regard, how people form their friendship and partnership ties tends to be homogeneous because of the tendency towards homophily in forming interpersonal networks [@mcpherson_birds_2001;@lazarsfeld_friendship_1954]. Hereby, we argue that the scope of class analysis in attitude formation urges to be extended to stress the role of social ties and segregation as they involve social processes, such as class identity formation, internalization of shared norms, conflict, and cooperation between classes. In this regard, recent research has argued that the degree of segregation in the composition of social ties is a window for learning about others' lifestyles, economic conditions, and worldviews [@mijs_inequality_2018;@otero_power_2023]. However, there has been no systematic dialogue regarding the role of social ties on preferences for redistribution from a social network perspective. Therefore, this research aims to contribute to the ongoing literature on class-based network segregation on attitudes toward redistribution [@lindh_missing_2021;@lee_consider_2023;@paskov_crossclass_2022].

While prior research has predominantly focused on examining the impact of social class through an individualistic lens, it is noteworthy that more attention must be devoted to understanding the role of social environments in class relations. This omission is particularly surprising given that class positions are fundamentally rooted in production relations that make them inherently relational, not only in their economic underpinnings but also in the power dynamics entwined within class conflicts [@wright_comparative_1989]. In addition, the normative basis of class relations introduces the relevance of the dimensions of solidarity and reciprocity, which have been argued to provide the moral basis for legitimacy and popular support for welfare schemes [@mau_moral_2003]. This research aims to contribute to the literature on preferences toward redistribution from a relational perspective, focusing on how the structural properties of networks can influence people's preferences toward economic redistribution. 

Our research seeks to provide answers to two key questions. Firstly, at the micro-level, what is the role of class-based network segregation on redistributive preferences? Secondly, at the macro-level, does economic inequality play a role in the relationship between class-based network segregation and redistributive preferences? To achieve this, we have analyzed data from the International Social Survey Program (ISSP) 2017, which comprises a sample of 31,191 individuals across 31 countries globally. In this regard, the ISSP has a unique opportunity to date since it includes information on interpersonal networks through the position generator, the core questions for class position allocation, and attitudes toward economic inequality and redistribution.

# Theoretical views on class, social networks, and redistributive preferences

## Class relations and social networks

As social relations within the occupational structure serve as the foundation for class analysis, widening our examination to other dimensions of social life, such as family dynamics, the development of friendships, and diverse social activities, can significantly enrich the scope of class analysis, particularly concerning its relevance in political attitudes formation. In principle, social stratification scholars have traditionally considered differentiation as observable patterns of association given by the intersection of status and group membership, which can be understood as relational networks between positions [@blau_inequality_1977]. Empirically, homophily is one of the most significant findings in network research, understood as the higher likelihood of tie formation between people of similar characteristics [@mcpherson_birds_2001, p.416] that trace friendship and family ties, such as age and gender, as well as segregated social environments alongside ethnicity and socioeconomic status [@bargsted_pautas_2020; @plaza_juntos_2022;@lazarsfeld_friendship_1954]. In addition, psychosocial factors such as socialization preferences and group dynamics also play a role in segregation processes, considering that isolated social environments decrease the interchange of worldviews, reinforcing in-group selectivity and value similarity [@visser_attitudes_2004;@homans_human_1951]. Nonetheless, without denying the relevance of socialization preferences, segregation has been predominantly explained through social differentiation in social activities as foci of contact opportunities that ultimately consolidate social networks [@feld_focused_1981; @mcpherson_network_2019]. From this perspective, we argue that class relations represent not only resource-based distinctions but also patterns of sociability and exchange observed in the differentiation of social ties.

How classes are formed also provides insight into social relations and sociability practices. In sociology, classes are understood as the basis for action given their labor market situation, which ultimately shapes their access to opportunities and resources [@weber_economy_1978]. According to the habitus theory, classes incur a series of distinctive practices pivoted in cultural capital as the basis for mutual recognition [@bourdieu_distinction_1984]. From this approach, classes seek to improve their positions through the intergenerational transmission of resources, where similarities in friendship and family choices play a crucial role in reproducing privileged social positions. Additionally, while symbolic resources reinforce status distinctions, access to exclusive social activities in the upper class increases segregation at the expense of excluding lower classes [@bourdieu_reproduccion_1981]. Ultimately, classes consolidate their demographic and cultural identities by mobilizing resources and shared sociability practices, ensuring the intergenerational reproduction of their structural positions [@goldthorpe_sobre_1992]. Hence, the socialization of common lifestyles and shared worldviews facilitates the consolidation of social classes, where access to resources embedded in social networks follows a pattern of accumulation that ultimately leads to social segregation in both the upper and lower bounds of the social structure.
 
Previous research on social class and tie formation has suggested that class permeability in social networks, understood as the formation of cross-class social ties, can be traced differently across property and authority boundaries. Empirically, evidence from Western industrialized societies has shown that the formation of friendship ties between owners and the working class is significantly less likely, in contrast to the tendency of higher tie formation between supervisors and manual workers. This suggests that the property dimension is much less permeable than authority-based boundaries, given that class interests increase the social distance between proprietors and workers, while the intermediate class position of supervisors and contact frequency with workers make friendship tie formation more likely [@wright_relative_1992]. Similarly, evidence from Chile has shown that the higher permeability of the intermediate classes contrasts with the more homogeneous networks of the working class, suggesting that their limited resources and lower capacity to be socially engaged ultimately result in a lack of social resources that lead to social isolation, whereas the upper class is less permeable and homogenous because of its tendency to self-select as a practice that ultimately seeks to reproduce their privileged status positions [@otero_open_2021]. 

By contrast, cross-class embeddedness can be described in terms of social activities, generational changes, and the life course. In this regard, @pichler_social_2009 suggest that higher civic engagement in formal organizations increases the chances of bridging with diverse people among the upper class, in contrast to the working class, which tends to be more homogeneous in civic engagement behavior. Similarly, other studies in Europe and South America have shown that the upper and intermediate classes hold increasingly diverse and prestigious social environments than the working classes, where being socially mobile helps to improve both dimensions in tie formation [@cepic_how_2020;@carrascosa_class_2023]. Nevertheless, it does not equalize the weight of the class background compared with those that are intergenerationally stable in the upper class. Additionally, the little longitudinal evidence suggests that networks change following a dynamic of cumulative advantages regarding its composition in terms of prestige and diversity, where upper classes improve in both dimensions, while the lower class shows more stability across the life course [@volker_social_2020]. 

Altogether, these studies account for class-based network segregation, as the degree of connectedness of an individual to different occupations is meant to represent social resources embedded in social networks vertically in the social structure [@lin_social_2007]. Drawing on this approach, stratification scholars have focused on how social connections are distributed across class structure as a matter of social integration [@blau_macrosociological_1977]. In addition, homogeneity is described as lacking cross-class network ties and is conceptually more proximate to the homophily principle because it is anchored in individual class positions. Simultaneously, _diversity_ is defined as the rate of dissimilar ties or simply the total ties to certain groups that do not necessarily count with a reference position to describe the network composition. Hence, both approaches provide alternatives for studying social class from a network perspective, which has been increasingly discussed in the stratification literature and scholarly discussion about social class and political attitudes. 

## Network segregation and attitudes toward redistribution 

Besides from the individual approach to attitude formation, we argue that people also form opinions in the economic domain based on their social relations. Despite limited research on the link between social ties and attitudes in the economic domain, we identify two broad theoretical approaches that have discussed the role of the social environment in attitude formation.

On the one hand, one approach accentuates the role of beliefs about economic inequality rooted in social comparison processes as an explanation through which people form opinions about redistributive policies [@condon_economic_2020]. This hypothesis can be traced to the studies on class images and perceived class conflicts [@Evans1992;@kelley_class_1995]. Here, the initial argument is that people form their beliefs through the individual, family, friends, and coworkers’ experiences instead of the whole society, which is described as an availability heuristic that systematically biases inferences about inequality based on the homophily of reference groups [@Evans1992, p. 467]. From this perspective, how people infer the social world is linked to the degree of segregation in their immediate social environment, which influences the intensity and character of the information that ultimately shapes their perceptions of inequality [@mijs_is_2021]. Thus, experience sharing in conversations with socioeconomically diverse networks has been proven to contribute to the accuracy of the images of income and wealth inequalities compared with people in more isolated discussion networks [@summers_deliberating_2022]. Despite this, we argue that this research field has been more focused on the cognitive dimension of preference formation through inequality perceptions, either relying on surveys [e.g. @cansunar_who_2021;@garcia-castro_perceived_2022] or experimental manipulations [e.g. @Cruces2011;@becker_significant_2021] rather than empirically addressing the role of class segregation in social networks and its claimed influence on attitudes in the economic domain.

In contrast, it has been suggested that the lens of a network approach provides a better picture of class relations that nurture social norms and group identity [@kalmijn_social_2007, p. 550]. This claim resembles the fact that classes are characterized as collectivities with differences in their degrees of cohesion and solidarity, encompassing unequal status-based social interactions that are linked to individual or household material well-being, cultural perspectives, and political preferences that structure broader social experiences [@morris_attenuation_1996, p. 48]. Furthermore, social integration can be affected in societies with lower contact opportunities between different social classes, where social distance among them widened by extreme inequality can create an “empathy gulf” that comprises barriers to imagining others’ lifestyles [@sachweh_moral_2012]. In this matter, spatially segregated interactions may nurture doubts about worthiness when the lower classes contrast themselves with the lifestyles of the upper classes, which might undermine feelings of social inclusion and cohesion [@sachweh_moral_2012]. Consequently, segregation drives the lives of others to become more distant and might have consequences for empathy and solidarity toward others, potentially leading to the perception of fellow citizens as strangers [@otero_lives_2022, p. 758]. Thus, we suggest that attitudes towards redistribution may be influenced by the class situation of both the individual and network ties, where social influence processes can either align or polarize attitudes according to the characteristics of groups and the level of segregation that allows factual contact opportunities. 

In recent years, we have seen an increase in this network turn of class analysis, contributing to unraveling the relationship between the composition of social ties and attitudes toward inequality. In this regard, it has been shown that the degree of contact between different classes has shown that individuals of the lower class interacting with those of the upper classes may consider economic inequality as justifiable, whereas interactions with those of the lower class may prompt individuals from different social classes to question the fairness of income distribution [@vargassalfate_contact_2023]. Further evidence suggests that class-based contact diversity shortens the social distance between social classes, providing broader images of the living conditions of others, which can trigger greater concerns about inequality [@otero_power_2023] and undermine support for the market distribution of social services [@beck_explorando_2019]. 

In addition, studies that directly addressed the relationship between networks and social classes have been consistent with previous findings. For instance, evidence from Sweden suggests that people tend to assimilate their opinions according to their surrounding friends and acquaintances, which is reinforced by class homophily, where higher contacts in the managerial class negatively influence support for redistribution, while ties to the working class increase it regardless of the individual class position suggesting that “individuals take an impression from others and modify their attitudes accordingly” [@lindh_missing_2021, p. 698]. Similarly, additional socialization sources are cross-class ties through family members. In this sense, the family of origin is crucial for political socialization, where class interests and norms are nurtured in childhood and early adulthood. A study in the United States showed that those tied to the upper class through parental relations support redistribution and progressive taxation less than those with working-class family backgrounds [@lee_consider_2023]. In addition, @paskov_crossclass_2022 argues that the class position of family and partners shapes preferences, while households share risk according to the class position of their members, where class homogeneity in ties polarizes preferences between lower and upper classes. In contrast, this gradient is blurred as heterogeneity increases according to the class position of the partner and family of origin.

In summary, we argue that class-embedded social relations play a substantial role in shaping support for redistribution. In this sense, the tendency to form homophilous social ties in terms of social class reinforces attitudes and consolidates opinion similarity. Thus, we hypothesize that segregation in similar class environments polarizes individual class interests so that segregated lower (upper) classes hold more (less) redistributive preferences ($H_1$).

##  Consequences of Economic Inequality on Social Networks and Redistributive Preferences

### Consequences of Economic Inequality on Social Networks 

The consequences of inequality in social relationships are diverse. Theoretically, it has been stated that economic inequality deepens material and symbolic differences between members of a society, where those in the most favored positions generally become more distant from those with access to fewer resources. Consequently, lower resources can constrain or discourage people from actively participating in social life, ultimately affecting the chances of meeting others with different economic conditions and lifestyles [@neckerman_inequality_2007, p. 344]. In this discussion, one approach has stressed the role of subjective experiences of inequality in social relations, arguing that a broader gap in economic resources has consequences on perceived competition and status anxiety [@wilkinson_spirit_2010;@garcia-sanchez_perceived_2024]. Therefore, driving stronger experiences of relative deprivation undermines trust in others, given the difficulties of setting shared goals and perceiving others as part of a collectivity that pursues the common good [@salgado_expectations_2021]. In contrast, the neo-materialist approach sets the attention on resource availability and attributes much less importance to subjective experiences, arguing that more economically equal societies are also characterized by extended welfare institutions that seek to diminish the consequences of unequal access to resources that provide better conditions for people to be socially engaged by improving social trust and individual well-being [@lynch_income_2004;@uslaner_inequality_2005;@kragten_income_2017]. In sum, living in more unequal societies goes hand in hand with more extraordinary experiences of uncertainty, which at the same time may be hindered by a lack of trust in the broader social context, affecting the motives to participate in social activities that play a fundamental role in establishing ties between dissimilar groups, either by status or social class [@lancee_diversity_2017].

Empirically, the few studies on this subject share the assumption that economic inequality translates into social distance in terms of class and status positions, which is the basis for consolidating network segregation. Cross-national comparisons in Europe show that the patterns of participation and association in formal organizations, as well as those of informal networks in providing social support, are manifested in the form of complementarity or substitution according to the cultural relevance of family or friendship networks and the character of the welfare regime [@pichler_patterns_2007]. By contrast, @pichler_social_2009 accounts for the role of income inequality on participation in formal and informal networks, showing that more unequal societies depress the extensiveness of formal participation but not the frequency. In addition, it is one of the few studies that show how, in more unequal societies, class differences in participation are deepened in the diversity of formal participation networks. Similarly, @lancee_income_2012 shows that economic inequality reduces participation. However, in formal networks, the inhibiting effect of inequality is better evidenced, being less relevant to participation in informal networks. In addition, they show that in more unequal societies, the stratification of participation by income level is strengthened, favoring those with greater resources and marginalizing the poorest.

In contrast to studies on participation in formal and informal networks, recent research has emphasized economic inequality in the structure of interpersonal networks. For instance, @letki_getting_2015 argued that economic inequality may constrain access to more extensive networks and the chances of receiving support through them. First, they found that individuals in lower-income groups have smaller networks than those in wealthier groups and are less likely to access resources through them. However, as inequality increases, low-income individuals hold much more extensive family networks but are less inclined towards utilizing their social ties to access resources than middle- and higher-income groups. They suggest that "the poor see maintaining ties with a large extended family as crucial for accessing needed help, which they are unlikely to reach through non-kinship ties" [@letki_getting_2015, p. 244]. By contrast, @otero_differences_2023 found that income inequality is not directly associated with the network structure. However, they found that income inequality can enhance the relationship between educational level, occupational status, and the diversity of social ties. They suggest that income inequality can exacerbate social stratification, creating greater interdependence between cultural, economic, and social capital. Hence, they argue that the unique positions held by the upper classes enable them to navigate different social settings while remaining segregated, whereas the lower classes may experience greater marginalization and isolation because of the choices of others [@otero_open_2021, p.24]. In this regard, if we assume that economic inequality sets the conditions for sociability, a possible consequence may be that the degree of segregation in interpersonal networks and its influence on popular views about economic inequality is also affected by the extent of income differences.

### Consequences of Economic Inequality on Redistributive Preferences

As mentioned, economic inequality influences social relations overall or strengthens inequalities throughout the social structure. However, studies on redistributive preferences have provided mixed evidence of the direct impact of income inequality on support for redistribution [@evans_strong_2018;@trump_income_2023]. In turn, an open discussion has been raised regarding why those in the upper social strata are more sensitive to changes in economic inequality than those in the lower strata. 

Theoretically, two approaches were considered in this discussion. On the one hand, some studies have suggested that high-income individuals are far from monolithic in their redistributive preferences, arguing that, although the rational interest model maintains its general implications, there are nuances within the upper-income strata regarding their greater concerns about the negative externalities of economic inequality (e.g., crime), which ultimately motivate altruistic support for redistribution  [@rueda_food_2018;@dimick_models_2018;@dimick_altruistic_2017;@rueda_externalities_2016]. Additionally, another body of literature has suggested that the differences among the affluent can be understood from a distributive justice framework that focuses on the justice evaluation under which economic resources are allocated [@liebig_sociology_2016]. The central argument suggests that affluent groups are more sensitive to economic inequality changes as they perceive that the overall opportunity structure is affected. In contrast, low-income individuals tend to perceive that the ascribed characteristics are stronger in constraining the opportunity structure, regardless of current income inequality [@sachweh_why_2019, p. 656]. Likewise, it has been argued that perceived inequality of opportunity can motivate support for redistribution as a matter of justice in the conditions for getting ahead, showing that this is particularly present in individuals in higher socioeconomic positions [@kim_socioeconomic_2018]. Therefore, if the degree of segregation in social networks is related to polarization in redistributive attitudes, we believe that income inequality might also play a role in the relationship between class relations and redistributive attitudes.

Empirically, while an important part of the studies addressing the role of economic inequality and redistribution preferences has focused on income, it is also possible to find efforts that emphasize the role of social class. In the first case, comparative studies in various societies have demonstrated (1) the relevance of income position and (2) the sensitivity of high-income groups to material inequality [@Schmidt-Catran2016; @franetovic_preferences_2022; @finseraas_income_2009]. However, class-based studies have contributed equally to the elucidation of this relationship. For example, @edlund_democratic_2015 established that the demand for state-organized redistribution reflects the level of political class conflict in a modern industrialized society. Thus, their argument suggests that inequality plays a key role in moderating these conflicts because there is evidence of greater political consensus supporting redistribution in societies with greater material inequality. They emphasize that social classes should not be undervalued as vehicles of antagonism and social tension [@edlund_democratic_2015, p. 323].

Similarly, @curtis_how_2015 suggest two possible implications for the class cleavage in redistributive preferences in contexts of rising economic inequality. One argument suggests that the decline in social cohesion expressed in trust, civic participation, and prosocial attitudes might undermine the normative basis for collective solidarity [@uslaner_inequality_2005]. As a result, less cohesive societies can nurture stronger class polarization that undermines egalitarian attitudes [@andersen_preferences_2018], making the middle classes less prone to support policies favoring the working classes. In contrast, the other argument posits that in the context of greater economic inequality, the middle classes tend to have greater political awareness about the causes and incentives of economic inequality [@Svallfors2006, pp. 66–67], as well as its consequences for class conflict and cohesion [@kelley_class_1995]. Additionally, it has been suggested that the degree of perceived social conflict decreases in societies with lower material inequality and a predominant middle-class imaginery [@hertel_conflict_2022]. Therefore, in more unequal societies, those who are better-off are more likely to support redistribution than their counterparts in more egalitarian contexts, where their attitudes gradually converge with the interests of the working class.

To summarize, the current state of research has led us to establish two competing scenarios based on the reviewed evidence and theoretical assumptions regarding the role of economic inequality in the relationship between class-based segregation and redistributive preferences. On the one hand, if we assume that social relations are eroded in more unequal societies, social classes might be more distant due to lower social trust and participation in formal and informal networks. Therefore, one possible expectation is that in unequal societies, the influence of class segregation on redistribution preferences will be stronger ($H_{2a}$). In contrast, if we assume that economic inequality has unequal consequences for those in the bottom and top rungs of the class structure in terms of cross-class embeddedness. In that case, it might be possible that the working classes are equally segregated regardless of income inequality compared to the more diverse contact and activity networks of the upper classes. Likewise, in line with evidence that suggests that the upper classes tend to be more concerned about the causes and consequences of economic inequality, our alternative expectation is that inequality will mitigate the role of network segregation on redistribution preferences, particularly among the upper classes ($H_{2b}$).

# Data, variables and method

## Data 

Individual data from the International Social Survey Programme (ISSP) 2017, titled "Social Networks and Social Resources," is utilized [@issp_networks_2017]. Established in 1984, the ISSP is a collaborative research project that conducts cross-national surveys on various topics related to social issues, attitudes, and values. Specifically, the ISSP 2017 survey includes questions on social ties and activities, evaluated through a position generator, as well as inquiries on social resources derived from network members. Additionally, respondents express their views on topics such as social trust and attitudes toward economic inequality. Initially, the dataset comprised 47,027 individual observations across 32 countries. However, Slovenia (SVN) was excluded from the analysis because the key dependent variable was not present in the questionnaire. Consequently, the present study comprises complete information on 31,191 individuals from 31 countries, representing a group of diverse societies in terms of socio-economic and institutional arrangements.

## Variables 

### _Individual level_ {-}

**Redistributive preferences**: Two indicators available in the questionnaire were used to measure redistributive preferences.  First, support for government redistribution (1) is measured by the item 'It is the responsibility of the government to reduce the differences in income between people with high incomes and those with low incomes.' and the egalitarian preferences represented by the item (2) 'For a society to be fair, differences in people's standard of living should be small.' indicators are five-point Likert scales with the categories 'Strongly agree' (1), 'Agree' (2), 'Neither agree nor disagree' (3), 'Disagree' (4) and 'Strongly disagree' (5). Thus, based on previous research and the high degree of correlation between the indicators (_r_ = 0.7), we proceed to reverse-code and create a standardized average index ranging from 1 to 100, where higher values represent greater redistributive preferences [@svallfors_government_2013].

**Social class**:  The Erikson-Goldthorpe-Portocarrero (EGP) Class Scheme is employed [@Erikson1992;@Erikson1979], one of the most consistent and validated measure for social class positions in comparative research [@evans_political_2013] and has demonstrated its validity in regions of the industrialized world, as well as in countries of late industrialization [@solis_class_2019;@torche_unequal_2005;@ishida_trends_2005;@barozet_measurement_2021; @wang_where_2024]. Thus, based on the recently developed DIGCLASS algorithm, we draw on the available information regarding (i) occupations, (ii) self-employment status and (iii) the number of workers [@cimentada_digclass_2023]. As a result, following previous research on political attitudes, a collapsed version of three big classes is employed, including the Service Class (I+II),  Intermediate Class (III+IV), and Working Class (V+VI+VII) [@sosnaud_class_2013;@edlund_influence_2003]. 

**Class-based network segregation**: To create our measure of network homogeneity based on social class, we employed the position generator available in the questionnaire. This instrument has been widely employed in social capital studies, relying on the assumption that access to social resources is based on ties to different positions in the social structure following an ego-centered network approach [@lin_access_1986;@vandergaag_position_2008]. In this case, the position generator shows a list of ten occupations where the respondent declares four possible options through which this tie is classified: "Family or relative", "Close friend", "Someone else I know", and "No one". In the case of the indicator used here, the first three categories are classified as "Knows" = 1 and "Does not know" = 0. Based on this, it is possible to obtain the total number of a person's social ties. Subsequently, the occupations were classified into three groups resembling social class positions [@otero_open_2021]. First, the Lawyer, Executive of a large firm, and Human resource manager are classified as high-status. Then, a School teacher, Police officer, and Nurse are considered as intermediate-status. Finally, a car mechanic, bus driver, hairdresser, and home or office cleaner are considered low-status occupations.

After this, we calculated the number of social ties for each status group. Consequently, the group closer to their class position obtains a proxy of the number of ingroup social ties. Finally, the number of ingroup ties is divided by the total number of contacts to provide a measure of network homogeneity that seeks to represent the share of similar social ties within the personal network [@otero_lives_2022; @volker_birds_2022]. Here, zero represents that all social ties are *different* (heterogeneity), while one means that all social contacts are similar (homogeneity). In substantial terms, higher values represent greater social distance from other social classes in society.

As suggested recently, we have selected a set of control variables based on substantive reasoning informed by the current state of research on social networks and redistributive preferences [@kohler_control_2024]. Our estimations incorporate studies on social capital, network size, and social trust. The volume of social ties within a network can have implications for both instrumental and expressive outcomes, such as job prospects or self-worth evaluations [@contreras_inequality_2019; @kim_social_2021]. Moreover, social trust facilitates the formation of social ties beyond the ingroup, enabling individuals to rely on others and participate in supportive networks that may even serve as substitutes for welfare provision [@jaime-castillo_social_2016]. Furthermore, redistributive preferences can be elucidated through economic self-interest. Typically, individuals with higher incomes oppose redistribution while acknowledging that reducing inequality would entail an increased tax burden [@meltzer_rational_1981]. Education also plays a crucial role, providing individuals with greater security to navigate the dynamics of the labor market. Higher skills are associated with less support for redistribution, as individuals with higher levels of education are better equipped to handle market uncertainties [@kitschelt_occupations_2014]. Similarly, job status reflects integration into the labor market. Outsiders, who are more vulnerable to labor market fluctuations, tend to be more supportive of redistributive policies [@hausermann_highskilled_2015]. Finally, besides serving the self-interest of unionized working-class members, unions also function as political socialization agents, nurturing egalitarian values and altruistic motives rooted in class solidarity [@han_labor_2022].

Sociodemographic characteristics play a significant role in shaping prosocial attitudes. Women, for instance, often demonstrate a greater capacity for empathy, motivating them to engage in more communal and relational behavior compared to men [@eagly_his_2009]. Moreover, women are frequently employed in interpersonal service occupations characterized by lower wages and higher market risk compared to their male counterparts [@waitkus_investigating_2021]. Age also emerges as a critical factor, with individuals at different life cycle stages exhibiting varying degrees of dependence and exposure to risk. Additionally, different age cohorts encompass distinct experiences of economic and political shocks [@vanheuvelen_intercohort_2018]. Religion further influences attitudes towards redistribution. Religious individuals are generally more supportive of redistribution due to the encouragement of altruistic behavior and prosocial values within religious communities. However, there is also evidence suggesting that religious behavior may decrease support for redistribution by contributing to individual well-being [@arikan_was_2019]. Furthermore, individuals without partners tend to exhibit greater support for redistribution. This suggests that marital ties serve as a support network through which individuals can mobilize resources and social support [@alesina_preferences_2005].

### _Macro level_ {-}

The primary societal characteristic under examination is the current levels of economic inequality, for which we have utilized the Gini Index (post-taxes and transfers) sourced from the World Income Inequality Dataset (WID) [@alvaredo_world_2022]. Additionally, two contextual variables have been incorporated as controls in the multilevel models. Firstly, economic prosperity has been considered to ensure consistency in the estimates for economic inequality, drawing from the World Income Inequality Dataset (WID) [@Schmidt-Catran2016; @finseraas_income_2009]. Secondly, to account for heterogeneity in institutional arrangements stemming from welfare schemes, a measure of the size of the welfare state has been included [see @edlund_democratic_2015]. This measure, as an index, considers three dimensions: (i) tax revenue as a percentage of gross domestic product (GDP) [@ilo_world_2022]; (ii) welfare generosity as total governmental spending as a share of GDP [@ilo_world_2022]; and (iii) the current level of redistribution [@solt_measuring_2020].

## Method

Multilevel linear models account for the hierarchical structure of the data, where individuals are nested within countries. Therefore, our first analysis begins with estimating the null model by declaring the nested structure using random intercept. This initial model allows us to assess the intraclass correlation, revealing that 13.7% of the variance in redistributive preferences can be attributed to belonging to higher-level units (countries). Subsequently, the micro-level models are estimated to determine the association between network homogeneity as well as the interaction with social class for testing our _segregation_ hypothesis ($H_1$). Following this, macro-level models are estimated by incorporating random intercepts alongside random slopes for network homogeneity and social class to determine whether economic inequality moderates the effect of the micro-level interaction ($H_2$). Therefore, we estimate a three-way cross-level interaction to determine if the current levels of income inequality affect the interactions between network homogeneity and social class.  In the macro-level models, all the individual-level factors are group-mean centered (CWC) to mitigate possible problems of collinearity [@hox_multilevel_2010]. Additionally, all the country-level factors have been standardized (z-scores) to ease comparability in the estimations  [@hox_multilevel_2010].

# Results

## Descriptive

```{r fig1, fig.dim=c(10,5),fig.cap='Cross-country comparison of Redistributive preferences and Social Class ',warning=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  dclass3spo_V,
  homclass3_V_res,
  know_total,
  socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  religion,
  partner,
  union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         )

df_mean <- 
dfreg %>% 
  group_by(country3) %>% 
  summarise(egal2_c=mean(egal),homclass_c=mean(homclass3_V_res),gini_disp=mean(gini_disp))
df_region <- dfreg %>% group_by(region,country3) %>% summarise(n())
df_full <- dfreg %>% group_by(dclass3res_V) %>% summarise(egal2=mean(egal),homclass=mean(homclass3_V_res),homclass_c=mean(dfreg$homclass3_V_res),egal2_c=mean(dfreg$egal), country3="Sample")
df_plot <- dfreg %>% group_by(country3,dclass3res_V) %>% summarise(egal2=mean(egal),homclass=mean(homclass3_V_res)) %>%left_join(df_mean) %>% left_join(df_region) 
df_plot$dclass3res_V <- factor(df_plot$dclass3res_V,levels = levels(df_plot$dclass3res_V),labels = c("Service Class","Intermediate Class","Working Class"))

# Calculate the difference between the mean value of working class and upper class within each country
homo_class_diff <- df_plot %>%
  dplyr::select(country3,homclass,dclass3res_V) %>% 
  tidyr::pivot_wider(names_from = "dclass3res_V", values_from = "homclass") %>% 
  mutate(diff_working_upper = `Working Class` - `Service Class`) %>% 
  dplyr::select(-`Working Class`, -`Service Class`,-`Intermediate Class`) %>% 
  as.data.frame()

df_plot <- 
dfreg %>% 
  group_by(country3,dclass3res_V) %>% 
  summarise(egal2=mean(egal),homclass=mean(homclass3_V_res)) %>% 
  left_join(df_mean) %>%
  left_join(df_region) %>% as.data.frame() %>% 
  left_join(homo_class_diff)

df_plot2 <- df_plot
df_plot2$dclass3res_V <- "Country"
df_plot2$homclass <- df_plot2$homclass_c
df_plot2$egal2 <- df_plot2$egal2_c 

df_plot3 <- bind_rows(df_plot,df_plot2)
# table(df_plot3$dclass3res_V)
df_plot3$dclass3res_V <- factor(df_plot3$dclass3res_V,
                                levels = c("Country","Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)"),labels = c("Country","Service Class","Intermediate Class","Working Class"))

df_plot3 %>% 
ggplot()+
  geom_hline(yintercept = mean(dfreg$egal),linetype=2)+
  geom_point(aes(x = reorder(country3, egal2_c),y = egal2,
                 shape=dclass3res_V,
                 color=dclass3res_V
                 ),size=3, alpha=2) +
  scale_shape_manual(values = c(4,17, 15, 16)) +
  scale_color_manual(values = c("black","#000000","#666666","#999999")) +
  labs(x=NULL,y="Redistributive Preferences") +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust = 1,size=8),
        legend.title = element_blank())


# ggsave(plot = last_plot(),filename = "slides-macro-redist.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

Figure \@ref(fig:fig1) depicts the distribution of redistributive preferences across countries and social classes. First, it is possible to notice that the United States has lower redistributive preferences, whereas Russia is a society where redistributive preferences are stronger among all social classes. As was expected, in most societies, the working class holds stronger redistributive preferences in contrast to the intermediate and services classes, with four exceptions where the differences are close to zero between both classes. However, it is also notable that there are some differences between the two extreme cases. For example, in the U.S., the working class held lower redistributive preferences (49.1) than the intermediate class (50.6), but still above the service class (46.8). In contrast, in Russia, the general pattern of higher preferences among the working class is maintained, with an escalated decrease in the working (85.5), intermediate (83.5), and service class (83.0). 

Another interesting fact is related to class differences in redistributive preferences. For example, the differences between the service and the working class are close to 2.3 points in the United States. At the same time, Finland represents the average case in the distribution but is also one of the most polarized societies in terms of class-based differences in redistributive preferences, showing a gap of 14.1 points between the upper and the lower classes. Interestingly, Russian society depicts class differences similar to the U.S., with an average difference of 2.4 points. 

```{r fig2, fig.dim=c(10,5),fig.cap='Cross-country comparison of Network homogeneity and Social Class ',warning=FALSE}
df_plot3 %>%
ggplot()+
  geom_point(aes(x = reorder(country3, diff_working_upper),
                 y = homclass,
                 shape=dclass3res_V,
                 color=dclass3res_V),
             size=3, alpha=2) +
  geom_hline(yintercept = mean(dfreg$homclass3_V_res),linetype=2)+
  scale_shape_manual(values = c(4,17, 15, 16)) +
  scale_color_manual(values = c("black","#000000","#666666","#999999")) +
  labs(x=NULL,y="Network homogeneity") +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x=element_text(angle=45,hjust = 1,size=8),
        legend.title = element_blank()) 

# ggsave(plot = last_plot(),filename = "slides-macro-homogen.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

Regarding network segregation, Figure \@ref(fig:fig2) depicts the distribution of network homogeneity and social class across countries. In contrast to redistributive preferences, the distribution of network homogeneity is more scattered between countries and social classes. However, it is worth to mention at least two interesting findings. First, looking at the sample average (M = 0.36), we can notice that the variation between countries is low (SD = 0.03), with Thailand being the society with higher levels of network segregation (M = 0.42), and Iceland the one of the lowest (M = 0.31). Second, it is depicted that the working class network homogeneity drives the pattern of homogeneity. As noticed, in most cases observed, the general pattern is that the working class is highly homogeneous in their networks, except in the Philipines, where the intermediate class shows a slightly higher average homogeneity. In addition, the general pattern is that the service class is less segregated than the intermediate and working class. Besides, an interesting fact is that in some cases (e.g., Mexico), although the working class remains highly segregated (above 0.5), the middle and service classes are similar in their network homogeneity. Overall, one of the most substantial findings is that, without any exception, the working class is more segregated than the services class.

```{r fig3, fig.dim=c(10,5),fig.cap='Bivariate relationships between Income Inequality, Network homogeneity and Redistributive preferences',warning=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  dclass3spo_V,
  homclass3_V_res,
  know_total,
  socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  religion,
  partner,
  union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         # gini_disp=scale(gini_disp),
         )
homo_ineq <- dfreg %>%
  # filter(country3 != "HUN") %>%
  group_by(country2,country3) %>%
  summarise_at(c("homclass3_V_res","egal","gini_disp","d10d1"), mean, na.rm = TRUE) %>% 
  as.data.frame()

# Plot Homogeneity and redistributive preferences
homo_ineq$country <- countrycode::countrycode(sourcevar = homo_ineq$country2,origin = "iso3c",destination = "iso2c")

fig_egal_homo <- 
homo_ineq %>%  
ggplot(aes(y=egal, x=homclass3_V_res)) +
  geom_smooth(method = "lm",fullrange=TRUE, color="black",linetype = 2,size=1,se = T) +
  geom_text_repel(label=as.character(homo_ineq$country)) +
  xlab("Network homogeneity")+
  ylab("Redistributive preferences") +
  labs(caption =paste("r = ",round(cor(homo_ineq$homclass3_V_res,
                                     homo_ineq$egal, use='complete.obs'),digits = 2)),tag = "A")
fig_homo_gini<- 
homo_ineq %>%  
ggplot(aes(y=homclass3_V_res, x=gini_disp)) +
  geom_smooth(method = "lm",fullrange=TRUE, color="black",linetype = 2,size=1,se = T) +
  # geom_text() +
  geom_text_repel(label=as.character(homo_ineq$country)) +
  xlab("Income Inequality") +
  ylab("Network homogeneity") +
  labs(caption =paste("r = ",round(cor(homo_ineq$homclass3_V_res,
                                     homo_ineq$gini_disp, use='complete.obs'),digits = 2)),tag = "B")
grid.arrange(fig_egal_homo,fig_homo_gini, nrow = 1)

# ggsave(plot = arrangeGrob(fig_egal_homo,fig_homo_gini, nrow = 1),filename = "slides-bivar.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

Moving to the bivariate macro relationships, Figure \@ref(fig:fig3) depicts the correlation between network homogeneity, redistributive preferences, and income inequality, our main societal characteristic of interest. First, according to @cohen_statistical_1988, for effect size criteria, we observe a medium positive and significant association between network homogeneity and redistributive preferences in Panel A (_r_ = 0.45, _p_ <.001). In concordance with the previously depicted distribution, we know that higher levels of network homogeneity are driven by the highly segregated networks of the working classes; what makes it logical that in countries where network homogeneity is high, this might also reflect greater social isolation among the working classes and consequently drive higher redistributive preferences. Second, Panel B depicts a positive but relatively weak and nonsignificant association between income inequality and network homogeneity (_r_ = 0.28, _p_<.01). In other words, average homogeneity also tends to increase in societies with greater income gaps. However, the macro association only shows the general pattern between countries but does not allow us to look deeper into class differences according to the levels of inequality. 

Interestingly, certain countries with higher levels of inequality and network homogeneity are societies that present class differences between the working class and the services class (e.g., Thailand or Mexico). By contrast, more egalitarian countries tend to be less homogeneous and have smaller class differences (e.g., Denmark or Sweden). As an additional exploratory analysis (see Fig. \@ref(fig:figapp1)), we have found that the association between income inequality and the gap in network homogeneity between the upper and lower classes tends to be moderate and statistically significant (_r_ = 0.29, _p_<.01). In other words, income inequality not only increase homogeneity overall but higher social distance between social classes as well.

## Multivariate results

```{r table1, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") 

# dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)
dfreg <- na.omit(dfreg)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
digclas1_VW_1<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner + (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_2<- update(digclas1_VW_1, . ~ . +know_total)
digclas1_VW_3 <- update(digclas1_VW_2, . ~ . + dclass3res_V)
digclas1_VW_5 <- update(digclas1_VW_3, . ~ . + edyears+ Q03pcm+workst)
digclas1_VW_7 <- update(digclas1_VW_5, . ~ . +dclass3res_V*homclass3_V_res)
digclas1_VW <- list(digclas1_VW_1,digclas1_VW_2,
                    digclas1_VW_3,
                    # digclas1_VW_4,
                    digclas1_VW_5,
                    # digclas1_VW_6,
                    digclas1_VW_7)

ccoef <- list(homclass3_V_res="Class-based network homogeneity",
              know_total="Network size",
              # socialtrust="Social Trust",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              # "femaleFemale"="Female (Ref. = Male)",
              # "agenum"="Age",
              # "age2"="Age2",
              "edyears"="Year of Education",
              "Q03pcmT02"="Income (T2)","Q03pcmT03"="Income (T3)","Q03pcmMissing"="Income (No information)",
              "workstNot in paid work" = "Not in paid work (Ref. = In paid work)",
              # "unionYes" ="Union Membership (Ref. = Not Unionized)",
              # "dclass3spo_VIntermediate class (III+IV)" = "Intermediate Class (Partner)",
              # "dclass3spo_VWorking Class (V+VI+VII)" = "Working Class (Partner)",              
              # "dclass3spo_VNo information (Missing, No partner)" = "No information (Not available, No partner)",
              "homclass3_V_res:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_res:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class")


texreg(digclas1_VW,stars = c(0.001, 0.01, 0.05, 0.1),single.row = F,
       caption = paste("(\\#tab:table1)","Multilevel models for Class-based network segregation and Redistributive Preferences"),
       custom.note = "Note: Models include sampling weights. Gender, age, and marital status are included as controls. Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,
       custom.coef.map = ccoef,
       symbol = "+",scalebox = 0.60,
      groups = list("Social Class (Ref.= Service Class)" = 3:5, "Household Income (Ref.= Tertile I)"= 6:8,
                    # "Partner's Social Class (Ref.= Service Class)" = 12:14,
      "Homogeneity x Social Class"=10:11),
      custom.gof.rows = list("Controls"=rep("Yes",5)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups","Var: Country (Intercept)","Var: Residual"),
       float.pos = "h!",
      # file = "table1.html"
       use.packages = F)
# performance::check_collinearity(digclas1_VW_6)
# performance::check_model(digclas1_VW_6,check="vif")
```

The multilevel analysis results are shown in Table \@ref(tab:table1). Regarding our first hypothesis ($H_1$), our central argument is that class segregation has differential consequences on redistributive preferences. In other words, the association between network homogeneity and redistributive preferences is conditional on class position. 

Model 1 integrates our measure of network homogeneity. Initially, as previously noted in the macro associations, individuals with more homogeneous networks tend to exhibit stronger redistributive preferences. This association persists in Model 2, where we control for network size and social trust—two pivotal factors in establishing and consolidating interpersonal networks. However, after including social class in the analysis, the relationship between homogeneity and redistributive preferences appears to reverse, with a reduction in statistical significance (_p_<0.10).

Subsequently, Model 4 incorporates socioeconomic status, employment status, and union membership characteristics. As expected, socioeconomic status is negatively associated with redistributive preferences regarding household economic resources and educational credentials. In addition, we find that people outside the labor market do not differ significantly from those who are economically active in their preferences. In contrast, as expected, being unionized increases redistributive preferences compared to those who have never been union members. Then, Model 5 incorporates the social class of the respondent's partner if such information is available. Thus, it is observed that the social class of the partner follows a similar pattern to that of the respondent, where belonging to the working or intermediate class presents higher redistributive preferences.

Finally, in Model 6, we see that by incorporating the interaction term between network homogeneity and social class, we observe that the working and intermediate class interaction terms are positive and statistically significant. Figure \@ref(fig:fig4) shows increased redistributive preferences in homogeneous working-class networks and the intermediate class. For the service class, the relationship is reversed, where more homogeneous networks for this social class decrease redistributive preferences. Altogether, these results provide evidence of our hypothesis, where a higher level of network segregation is related to a greater polarization of social class interests.
 

```{r fig4, fig.dim=c(10,5),fig.cap='Linear Predictions for Network Homogeneity on Redistributive Preferences by Social Class',warning=FALSE}
int_homo <- digclas1_VW_7
df_pred1 <- 
  predictions(int_homo, condition = c("homclass3_V_res","dclass3res_V"),
              newdata = datagrid(homclass3_V_res = seq(min(dfreg$homclass3_V_res), max(dfreg$homclass3_V_res), by= 0.1),
                                 dclass3res_V = levels(dfreg$dclass3res_V)))
# names(df_pred1)
df_pred1 %>% 
ggplot(aes(y =estimate,x=homclass3_V_res, fill=dclass3res_V, color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=1,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=2,color="black") +
  facet_grid(~factor(dclass3res_V, levels=
                       c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)"),
                     c("Working Class (V+VI+VII)","Intermediate class (III+IV)","Service Class (I+II)"))) +
  scale_fill_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_y_continuous(limits = c(50,80))+
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
       x="Network homogeneity",y="Redistributive preferences") +
  theme(legend.position = "none", legend.title = element_blank())

# ggsave(plot = last_plot(),filename = "slides-predictions.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)

# int_homo <- digclas1_VW_7
# plot_slopes(digclas1_VW_7, variables = "homclass3_V_res", condition = list("dclass3res_V"))+
# labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
#   geom_hline(yintercept = 0,color="red",linetype=2)+
#        x="Social Class",y="Redistributive preferences",title = "Conditional Marginal Effects for Network Homogeneity")

# ggsave(plot = last_plot(),filename = "slides-marginal.png",device = "png",
#        path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 10)
```

\newpage

```{r tab2, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(gini_disp))

dfreg$wstate2 <- scale(scale(dfreg$abs_red) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Gini index)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.7,
       caption = paste("(\\#tab:table2)","Multilevel models for Income Inequality, Network segregation and Redistributive Preferences"),
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity x Social Class"=7:8, "Homogeneity x Social Class x Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Country (Intercept)",
                           "Var: Country Homogeneity",
                           "Var: Country Intermediate Class ",
                           "Var: Country Working Class",
                           "Cov: Country (Intercept), Homogeneity",
                           "Cov: Country (Intercept), Intermediate Class ",
                           "Cov: Country (Intercept), Working Class",
                           "Cov: Country Homogeneity, Intermediate Class",
                           "Cov: Country Homogeneity, Working Class",
                           "Cov: Country Intermediate Class, Working Class",
                           "Var: Residual"),
        # file = "table2.html",
       use.packages = F)
```

Table \@ref(tab:table2) presents the results of the multilevel models for income inequality. In Model 1, income inequality demonstrates a positive association, as expected, yet it fails to reach significance. Subsequently, Model 2 incorporates economic prosperity through GDP per capita, revealing a negative and significant relationship (*p* > .05). Furthermore, Model 3 indicates that including the size of the welfare state establishes a positive and significant relationship (_p_ > .05) while GDP per capita maintains its negative association with redistributive preferences (_p_ > .01). In other words, in Model 3, economic prosperity appears to depress redistributive preferences; however, when contextualized within a larger welfare state, greater redistributive preferences are observed.

Finally, Model 4 incorporates the three-way interaction to determine whether the relationship established in $H_1$ is moderated by income inequality. The relationship observed at the micro level retains its original meaning, indicating that segregation in terms of network homogeneity polarizes the economic interests of the classes. Additionally, when observing how this relationship is moderated by the level of inequality in the country, it appears to mitigate, with its intensity decreasing as inequality increases. Figure \@ref(fig:fig5) illustrates how the relationship between network homogeneity and social class is more pronounced when inequality is low and gradually diminishes until it becomes almost absent when inequality is high.

Overall, while Hypothesis 2a posited that greater income differences would amplify social segregation and, consequently, polarize redistributive preferences to a greater extent, the results provide evidence in favor of Hypothesis 2b. This suggests that inequality plays a mitigating role in class segregation regarding redistributive preferences.


```{r fig5, fig.dim=c(12,7),fig.cap='Three-way interaccion Income Inequality, Network segregation and  Redistributive Preferences'}
### Predicted values homo*class*GiniD ---------------------------------------$
# ginid_max<- round(max(dfreg$gini_disp) ,2)
# ginid_min<- round(min(dfreg$gini_disp),2)

ginid_max<- round(mean(dfreg$gini_disp) + sd(dfreg$gini_disp)  ,2)
ginid_min<- round(mean(dfreg$gini_disp) -sd(dfreg$gini_disp) ,2)
ginid_mea<- round(mean(dfreg$gini_disp),2)

df_pred_giniD_gc <-
  predictions(
    homo_V_gini_full2,newdata = datagrid(
      gini_disp = c(ginid_min, ginid_mea, ginid_max),
      wstate2=mean(dfreg$wstate2),
      loggdppercapita=mean(dfreg$loggdppercapita),
      homclass3_V_gc = seq(min(dfreg$homclass3_V_gc)+0.01, max(dfreg$homclass3_V_gc)+0.01, by=0.1),
      dclass3res_V=levels(dfreg$dclass3res_V)
    )
  )

df_pred_giniD_gc <- as.data.frame(df_pred_giniD_gc)
df_pred_giniD_gc$gini_disp <- factor(df_pred_giniD_gc$gini_disp,labels = c("Gini (-1SD)","Gini (Mean)", "Gini (+1SD)"))
df_pred_giniD_gc <- df_pred_giniD_gc %>% filter(dclass3res_V!="Intermediate class (III+IV)")

df_pred_giniD_gc %>% 
  ggplot(aes(y=estimate,x=homclass3_V_gc, fill=dclass3res_V,color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=0.7,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=3, shape = 21,color="black") +
  facet_wrap(~gini_disp) +
  labs(y = "Preferences for Redistribution",
       x="Network homogeneity (CWC)",
       caption = paste0("N=",nobs(homo_V_gini_full2),", Countries=",lme4::ngrps(homo_V_gini_full2))
       ) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Income inequality (post-tax) \n ", breaks = NULL, labels = NULL),
                     ) +
 
   scale_fill_manual(values=c("#323232","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#CCCCCC"))+
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text=element_text(size=15),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))

ggsave(plot = last_plot(),filename = "slides-predict-macro.png",device = "png",
       path = here::here("output/images"),width = 2,height = 1,units = "cm",scale = 15)
```

# Discussion and conclusion

<!-- _Dicussion_  Luego de la presentación de los resultados, acá se comienza a volver a los argumentos del trabajo y se relaciona cada hipótesis con los resultados. Se sugiere ir por orden, y un párrafo para cada hipótesis. -->
In this research, we ask how class-based network segregation is related to preferences for redistribution and to what extent economic inequality conditions this relationship. In this context, the literature on interpersonal networks has shed light on how network structure harbors not only social resources [@lin_access_1986;@otero_open_2021] but also carries the capacity to establish niches that contribute to the formation of political opinions through social influence, as well as the degree of network segregation [@lindh_missing_2021;@paskov_crossclass_2022]. In this case, the micro-level relationship under scrutiny was that class-based network segregation does play a role in redistributive preferences. In contrast to evidence on the undermining role of network homogeneity on social cohesion [@otero_lives_2022], redistributive preferences are not the case. Indeed, we found that greater homogeneity in terms of social class has a polarizing effect on redistributive preferences because it has differentiated attitudinal consequences according to class position. In other words, for working-class members, homogeneity strengthens their redistributive preferences, while in the service class, homogeneity translates into even lower redistributive preferences. 

Our theoretical approach has established that social classes should be understood beyond labor market relationships but as relational networks that can provide an explanatory framework for attitude formation.
Theoretically, what the literature has established as processes of social influence [@lindh_missing_2021] or political socialization [@lee_consider_2023] has echoed in how social closure in interpersonal networks generates distance between different social classes in terms of their redistributive preferences. Here, the extent to which social classes distance themselves in terms of network segregation indeed creates an "empathy gulf" [@sachweh_moral_2012] that can be observed in how the service class is less willing to take action to strive with inequality as a matter of collective commitment when they are highly segregated in homogeneous upper-class environments [@otero_power_2023], in contrast to the increasing redistributive pressures of the marginalized working class. Besides, as network homogeneity represents low cross-class ties, it can be argued that lower social integration [@blau_inequality_1977] can undermine social solidarity as it consolidates weaker chances of contact between social classes and the lack of knowledge about the lives of others [@vargassalfate_contact_2023]. 

While the results are substantially consistent at the micro level, our theoretical framework established alternative scenarios regarding the role of economic inequality. In short, our competing hypothesis suggested that income inequality, which represents greater gaps in economic and social resources, should be related to class relations and redistributive preferences. In line with the social cohesion argument, it is suggested that social relations are undermined by economic inequality as it represents the distribution of available resources and, consequently, might _amplify_ the relationship between segregation and redistributive preferences given the increase in social distance between social classes. However, the evidence indicates the opposite as it shows that inequality _mitigates_ the micro-level relationship, which translates into a narrower class gap, mainly through changes in redistributive preferences in the service class. These results resonate with two key pieces of evidence on the role of inequality on (i) class relations and (ii) redistributive preferences. It has been argued that in unequal societies, the better-off class position tends to become more egalitarian in their stances on economic inequality [@edlund_democratic_2015;@sachweh_why_2019]. Additionally, recent cross-national studies suggest that upper classes can consolidate their distinctive position while their advantages allow them to navigate diverse networks at the expense of the marginalization of the poor in contexts of greater inequality [@otero_differences_2023]. 

<!-- _conclusion_-->
This research is a contribution to the field of study on social class and redistributive preferences, but it also contributes to previous studies that have emphasized the role of social ties in redistributive preferences [@newman_my_2014;@edlund_influence_2003;@langsaether_more_2020]. In addition to the micro-level contribution, the cross-national component of this research dialogue with previous studies on the role of income inequality on social networks [@pichler_social_2009;@letki_getting_2015;@otero_differences_2023] and class-based research on redistributive preferences [@edlund_democratic_2015;@curtis_how_2015]. Besides, this research broadly contributes to the ongoing research on social cohesion beyond Western industrialized countries, as our analyses include a heterogeneous group of societies.  

In the end, our research has been reached with limitations. On the side of our dependent variable, a two-item index is a rough proxy of what we conceptually claim as redistributive preferences. It is well established in the literature that the popular responses to economic inequality are diverse regarding how the government strives with economic inequality [@mccall_americans_2009;@garcia-sanchez_two_2022]. In addition, the position generator included in the ISSP is limited in terms of the capability to reflect the class structure more precisely, mainly regarding the self-employed and the intermediate-class occupations. In this regard, we are aware of the limitations of the instrument, and therefore, we present these results with prudence. Finally, it has been established that network formation is structured by contact opportunities [@feld_focused_1981], but values-based interaction also play a role in consolidating networks [@visser_attitudes_2004]. Thus, the cross-sectional nature of our data does not allow us to make causal claims because there could be problems of endogeneity between class position, the composition of social ties, and attitudes. 

To summarize, future survey research should consider better measurement strategies for attitudes in the economic domain, such as market-based social services, willingness to pay taxes as redistributive measures, or direct focalized transfers. In addition, the network dimension can be better approached with a more detailed measurement strategy incorporating other aspects of the occupational structure, such as authority or autonomy in the labor market. Finally, the causality-related issues can be addressed by employing longitudinal designs.      

\newpage

# References

```{=tex}
\scriptsize
\singlespacing
```

<div id="refs"> </div>  <!-- Although <div> is an HTML tag, this method also works for other output formats such as PDF. -->



\newpage

`r if (knitr::is_latex_output()){ '\\appendix'}`

`r if (knitr::is_latex_output()){ '\\section{Appendix}'}`


```{r descriptive, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,sjlabelled,haven,vtable)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  "gini_disp"=wid_gini_disp,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2,country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=gdppercapita/1000,
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         # gini_disp=scale(gini_disp)
         )

# dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

dfreg$wstate<- rowMeans(dfreg[,c("abs_red","ilo_taxrev","ilo_govspe")],na.rm = T)
dfreg$wstate2 <- ((dfreg$wstate-min(dfreg$wstate,na.rm = T))/(max(dfreg$wstate,na.rm = T)-min(dfreg$wstate,na.rm = T)))*100

dfreg1 <- dfreg %>% dplyr::select(
  egal,
  homclass3_V_res,
  know_total,
  # socialtrust,
  dclass3res_V,
  Q03pcm,
  edyears,
  # dclass3spo_V,  
  workst,
  # union,
  female,
  agenum,
  # religion,
  partner,
  "gini_disp",
  loggdppercapita,
  wstate2
  ) 

varlab <- 
c("Redistributive preferences","Class-based network homogeneity",
  "Network size",
  # "Social trust",
  "Social class",
  "Household Income","Education in years",
  # "Partner's Social Class",
  "Labor status",
  # "Union membership",
  "Gender","Age in years",
  # "Religion",
  "Has partner",
  "Income Inequality - Gini Index (post taxes and transfers)",
  "GDP/capita (in 1000 US dollars)",
  "Size of the welfare state (0 to 100 scores)")

sjlabelled::set_label(dfreg1) <- varlab
# names(dfreg) <- varlab


st(dfreg1,labels=T,
   title="Descriptive Statistics for Study Variables",
   out = "latex",
   digits = 2, 
   factor.counts = F,
   factor.numeric = F,
   summ = list(
     c('notNA(x)','mean(x)','sd(x)','min(x)','max(x)'),
     c('notNA(x)','mean(x)')
   ),
   summ.names = list(
     c('N','Mean','SD','Min','Max'),
     c('Count','Percent')   
   ))
```

\newpage

```{r desc-country, echo=FALSE, results='asis'}
dfreg %>% 
  group_by(country3) %>% 
  summarise(n=n(),
            homclass=mean(homclass3_V_res),
            gini_disp=mean(gini_disp),
            loggdppercapita=mean(loggdppercapita),
            wstate=mean(wstate2),) %>% 
  arrange(homclass) %>% 
  kable(digits = 2,booktabs = TRUE,format = "latex", linesep = "",
        caption = "Contextual variables by country",
        col.names = c("Country","N","Network Homogeneity","Gini Index","GDP/capita in $1000","Size of the Welfare State")) %>% 
  kable_styling(full_width = F,latex_options = "scale_down") %>% 
  column_spec(1, width = "3.2cm") %>% 
  column_spec(2:6, width = "3cm") %>% 
  footnote(general = "Data sources are from the ISSP 2017 - Social Networks, WID and ILO. Contextual variables in original scale")
```



```{r figapp1, fig.dim=c(5,5),out.width='50%',fig.cap='Bivariate relationships between Income Inequality and Class differences in network homogeneity',warning=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  gdppercapita,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         # gini_disp=scale(gini_disp),
         )

homo_ineq <- dfreg %>%
  group_by(country2,country3) %>%
  summarise_at(c("homclass3_V_res","egal","gini_disp"), mean, na.rm = TRUE) %>% 
  as.data.frame()

homo_class_diff <- dfreg %>%   
  group_by(country2,country3,dclass3res_V) %>%
  summarise_at(c("egal","homclass3_V_res"), mean, na.rm = TRUE) %>% 
  as.data.frame() %>%
  dplyr::select(country3,homclass3_V_res,dclass3res_V) %>% 
  tidyr::pivot_wider(names_from = "dclass3res_V", values_from = "homclass3_V_res") %>% 
  mutate(diff_working_upper_homo = `Working Class (V+VI+VII)` - `Service Class (I+II)`) %>% 
  as.data.frame()

# Dataset with class differences in network homogeneity
homo_ineq <- homo_ineq %>% left_join(homo_class_diff)

# Plot Homogeneity and redistributive preferences
homo_ineq$country <- countrycode::countrycode(sourcevar = homo_ineq$country2,origin = "iso3c",destination = "iso2c")

fig_homodiff_gini<- 
homo_ineq %>%  
ggplot(aes(y=diff_working_upper_homo, x=gini_disp)) +
  geom_smooth(method = "lm",fullrange=TRUE, color="black",linetype = 2,size=1,se = T) +
  # geom_text() +
  geom_text_repel(label=as.character(homo_ineq$country)) +
  xlab("Income Inequality") +
  ylab("Class Differences in Network homogeneity \n (Working Class - Service Class)") +
  labs(caption =paste("r = ",round(cor(homo_ineq$diff_working_upper_homo,
                                     homo_ineq$gini_disp, use='complete.obs'),digits = 2)),tag = NULL)

grid.arrange(fig_homodiff_gini, nrow = 1)

ggsave(plot = arrangeGrob(fig_homodiff_gini, nrow = 1),filename = "slides-bivar-homodiff.png",device = "png",
       path = here::here("output/images"),width = 1,height = 1,units = "cm",scale = 17)
```

\pagebreak 
# Additional analysis

## Income Inequality Ratios 

```{r tab2-ratio9010, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(d10d1))

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+         
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Ratio 90/10)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.50,
       caption = "Multilevel models for Income Inequality, Network segregation and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity*Social Class"=7:8, "Homogeneity * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Homogeneity",
                           "Var: Group Intermediate Class ",
                           "Var: Group Working Class",
                           "Cov: Group (Intercept), Homogeneity",
                           "Cov: Group (Intercept), Intermediate Class ",
                           "Cov: Group (Intercept), Working Class",
                           "Cov: Group Homogeneity, Intermediate Class",
                           "Cov: Group Homogeneity, Working Class",
                           "Cov: Group Intermediate Class, Working Class",
                           "Var: Residual"),
       use.packages = F)
```

```{r tab2-ratio9050, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(wid_p90p50))

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Ratio 90/50)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.50,
       caption = "Multilevel models for Income Inequality, Network segregation and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity*Social Class"=7:8, "Homogeneity * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Homogeneity",
                           "Var: Group Intermediate Class ",
                           "Var: Group Working Class",
                           "Cov: Group (Intercept), Homogeneity",
                           "Cov: Group (Intercept), Intermediate Class ",
                           "Cov: Group (Intercept), Working Class",
                           "Cov: Group Homogeneity, Intermediate Class",
                           "Cov: Group Homogeneity, Working Class",
                           "Cov: Group Intermediate Class, Working Class",
                           "Var: Residual"),
       use.packages = F)
```

\pagebreak
## Income inequalty groups

```{r table1-ineq-groups, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") 


# dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)

dfreg <- na.omit(dfreg)
tab_countries<- 
  dfreg %>% 
  group_by(country3) %>% 
  summarise(gini_disp=mean(gini_disp)) %>% 
  mutate(gini_q05=ntile(gini_disp,5),
         gini_d10=ntile(gini_disp,10)) %>% as.data.frame() %>% 
  arrange(gini_d10) %>% 
  dplyr::select(-gini_disp)

dfreg <- dfreg %>% left_join(tab_countries,by="country3")


## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$

library(estimatr)

# Quintile 1 (low)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==1),weights = WEIGHT)
digclas1_VW_Q1_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_Q1_2 <- update(digclas1_VW_Q1_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 2 (mid-low)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==2),weights = WEIGHT)
digclas1_VW_Q2_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+age2+edyears+ Q03pcm+workst)
digclas1_VW_Q2_2 <- update(digclas1_VW_Q2_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 3 (middle)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==3),weights = WEIGHT)
digclas1_VW_Q03_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_Q03_2 <- update(digclas1_VW_Q03_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 4 (middle-high)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum + partner +  factor(country2),data=subset(dfreg,gini_q05==4),weights = WEIGHT)
digclas1_VW_Q04_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_Q04_2 <- update(digclas1_VW_Q04_1, . ~ . +dclass3res_V*homclass3_V_res)

# Quintile 5 (high)
digclas1_VW_1<- lm(egal~1 + homclass3_V_res +know_total+female+agenum+ partner + factor(country2),data=subset(dfreg,gini_q05==5),weights = WEIGHT)
digclas1_VW_Q05_1 <- update(digclas1_VW_1, . ~ . + dclass3res_V+female+agenum+age2+edyears+ Q03pcm+workst)
digclas1_VW_Q05_2<- update(digclas1_VW_Q05_1, . ~ . +dclass3res_V*homclass3_V_res)

digclas1_Q05 <- 
list(digclas1_VW_Q1_1,digclas1_VW_Q1_2,digclas1_VW_Q2_1,digclas1_VW_Q2_2,
     digclas1_VW_Q03_1,digclas1_VW_Q03_2,digclas1_VW_Q04_1,digclas1_VW_Q04_2,
     digclas1_VW_Q05_1,digclas1_VW_Q05_2)

ccoef <- list(homclass3_V_res="Class-based network homogeneity",
              know_total="Network size",
              # socialtrust="Social Trust",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              # "femaleFemale"="Female (Ref. = Male)",
              # "agenum"="Age",
              # "age2"="Age2",
              "edyears"="Year of Education",
              "Q03pcmT02"="Income (T2)","Q03pcmT03"="Income (T3)","Q03pcmMissing"="Income (No information)",
              "workstNot in paid work" = "Not in paid work (Ref. = In paid work)",
              # "unionYes" ="Union Membership (Ref. = Not Unionized)",
              # "dclass3spo_VIntermediate class (III+IV)" = "Intermediate Class (Partner)",
              # "dclass3spo_VWorking Class (V+VI+VII)" = "Working Class (Partner)",              
              # "dclass3spo_VNo information (Missing, No partner)" = "No information (Not available, No partner)",
              "homclass3_V_res:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_res:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class")


header <- list("Q1"=1:2,"Q2"=3:4,"Q3"=5:6,"Q4"=7:8,"Q5"=9:10)
screenreg(digclas1_Q05,stars = c(0.001, 0.01, 0.05, 0.1),single.row = F,include.ci = FALSE,custom.header = header,
       caption = paste("(\\#tab:table1-groups)","Fixed effects linear regression models for Class-based network segregation and Redistributive Preferences by Income Inequality Quintiles"),
       custom.note = "Note: Models include sampling weights. Gender, age and marital status are included as controls. Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,
       custom.coef.map = ccoef,
       symbol = "+",scalebox = 0.55,
      groups = list("Social Class (Ref.= Service Class)" = 3:4, "Household Income (Ref.= Tertile I)"= 6:8,  
                    # "Partner's Social Class (Ref.= Service Class)" = 12:14, 
                    "Homogeneity x Social Class"=10:11),
      custom.gof.rows = list("Country FE"=rep("Yes",10)),
      # include.loglik = FALSE,include.aic = FALSE,
      # custom.gof.names = c(NA,NA,"Num. groups","Var: Country (Intercept)","Var: Residual"),
       float.pos = "h!",
      # file = "table1.html"
       use.packages = F)
```


```{r fig1-marg-ineqgrup, fig.dim=c(15,5),fig.cap='Average Marginal Effects of Network homogeneity conditionated by Social class on Redistributive Preferences by Income Inequality Groups',warning=FALSE}
marginal <- bind_rows(
plot_slopes(digclas1_VW_Q1_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=1),
plot_slopes(digclas1_VW_Q2_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F)  %>% mutate(quintile=2),
plot_slopes(digclas1_VW_Q03_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=3),
plot_slopes(digclas1_VW_Q04_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=4),
plot_slopes(digclas1_VW_Q05_2, variables = "homclass3_V_res", by = "dclass3res_V",draw = F) %>% mutate(quintile=5))
marginal$quintile <- factor(marginal$quintile,labels = c("Gini (Q1)","Gini Q2","Gini Q3","Gini Q4","Gini Q5"))
marginal$dclass3res_V <- forcats::fct_rev(marginal$dclass3res_V)

ggplot(data=marginal,aes(x = dclass3res_V, y = estimate,ymin= conf.low, ymax=conf.high)) +
  geom_point(size=2) + 
  geom_errorbar(width=.2)+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  geom_hline(yintercept = 0,color="red") +
  facet_grid(~quintile) +
  labs(x=NULL,y="Redistributive preferences"
       # title = "Average Marginal Effects for Class-based network segregation on Redistributive preferences by Social Class and Income Inequality groups"
       )  

```

\pagebreak

## OECD Countries

```{r tab2-ocde, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(gini_disp))

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))

# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)

# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Class-based network homogeneity (CWC)",
              "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              "gini_disp" = "Income inequality (Gini index)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV)" = "Homogeneity*Intermediate Class",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII)" = "Homogeneity*Working Class",
              "homclass3_V_gc:gini_disp"= "Homogeneity*Income Inequality",
              "homclass3_V_gc:dclass3res_VIntermediate class (III+IV):gini_disp" = "Homogeneity*Intermediate Class*Income Inequality",
              "homclass3_V_gc:dclass3res_VWorking Class (V+VI+VII):gini_disp" = "Homogeneity*Working Class *Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.60,
       caption = "Multilevel models for Income Inequality, Network segregation and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Homogeneity*Social Class"=7:8, "Homogeneity * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Homogeneity",
                           "Var: Group Intermediate Class ",
                           "Var: Group Working Class",
                           "Cov: Group (Intercept), Homogeneity",
                           "Cov: Group (Intercept), Intermediate Class ",
                           "Cov: Group (Intercept), Working Class",
                           "Cov: Group Homogeneity, Intermediate Class",
                           "Cov: Group Homogeneity, Working Class",
                           "Cov: Group Intermediate Class, Working Class",
                           "Var: Residual"),
       use.packages = F)
```

```{r fig5-ocde, fig.dim=c(12,7),fig.cap='Three-way interaccion effects for Redistributive Preferences, Network segregation, Social class and Income Inequality'}
### Predicted values homo*class*GiniD ---------------------------------------$
# ginid_max<- round(max(dfreg$gini_disp) ,2)
# ginid_min<- round(min(dfreg$gini_disp),2)

ginid_max<- round(mean(dfreg$gini_disp) + sd(dfreg$gini_disp)  ,2)
ginid_min<- round(mean(dfreg$gini_disp) -sd(dfreg$gini_disp) ,2)
ginid_mea<- round(mean(dfreg$gini_disp),2)

df_pred_giniD_gc <-
  predictions(
    homo_V_gini_full2,newdata = datagrid(
      gini_disp = c(ginid_min, ginid_mea, ginid_max),
      wstate2=mean(dfreg$wstate2),
      loggdppercapita=mean(dfreg$loggdppercapita),
      homclass3_V_gc = seq(min(dfreg$homclass3_V_gc)+0.01, max(dfreg$homclass3_V_gc)+0.01, by=0.1),
      dclass3res_V=levels(dfreg$dclass3res_V)
    )
  )

df_pred_giniD_gc <- as.data.frame(df_pred_giniD_gc)
df_pred_giniD_gc$gini_disp <- factor(df_pred_giniD_gc$gini_disp,labels = c("Gini (-1SD)","Gini (Mean)", "Gini (+1SD)"))
df_pred_giniD_gc <- df_pred_giniD_gc %>% filter(dclass3res_V!="Intermediate class (III+IV)")

df_pred_giniD_gc %>% 
  ggplot(aes(y=estimate,x=homclass3_V_gc, fill=dclass3res_V,color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=0.7,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=3, shape = 21,color="black") +
  facet_wrap(~gini_disp) +
  labs(y = "Preferences for Redistribution",
       x="Network homogeneity (CWC)",
       caption = paste0("N=",nobs(homo_V_gini_full2),", Countries=",lme4::ngrps(homo_V_gini_full2))
       ) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Income inequality (post-tax) \n ", breaks = NULL, labels = NULL),
                     ) +
 
   scale_fill_manual(values=c("#323232","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#CCCCCC"))+
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text=element_text(size=15),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))
```

\pagebreak

## Social distance

First, the average scores of the International Socio-Economic Index of Occupational Status (ISEI) [@ganzeboom_three_2003] for each occupation of the position generator are calculated. Second, the ISEI score of the respondent (R's) is subtracted from the average ISEI points of the personal network. For example, if the R's has an ISEI of 80 and the network ISEI is 50, the social distance will be 30 (80 - 50), a "upward" social distance. Another case could be 50 (R's) minus 80 (network), and the average social distance will be - 30 or "downward" social distance. In addition, When the distance is 0, the network is entirely homogeneous.

To facilitate the interpretation of the indicator, we have calculated a homogeneity indicator based on social distance:

1. The absolute values are calculated to represent the total distance to occupations respect to R's ISEI score.
2. Since we have 0 values representing absolute homogeneity, we rescale the variable by adding 1.
4. We have inverted the values to make higher values represent higher homogeneity.

Thus, higher values represent greater homogeneity regarding R's ISEI score in contrast to the average network ISEI score.

```{r desc-social, eval=FALSE, include=FALSE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4,correlation)
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V,
  dclass3spo_V,
  homclass3_V_res=socdist,
  know_total,
  socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  religion,
  union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2,
         homclass3_V_res=homclass3_V_res/10) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN")

dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)

dfreg <- na.omit(dfreg)
```

### Social Distance by ISEI 

```{r table1-socdist, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

dummy_df <- df1 %>% dplyr::select(id,
  egal = egal2,dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,edyears,female,agenum,
  # religion,
  partner,
  # union,
  workst,WEIGHT,region,
  "gini_disp"=wid_gini_disp,"gini_mkt",gv_spen,rel_red,abs_red,ilo_taxrev,
  ilo_govspe,d10d1=wid_p90p10,wid_p90p50,top10=wid_sharetop10,rgdpna,gdppercapita,
  oecd,country2, country, country3) %>%
  filter(country2 != "SVN") %>% 
  # filter(oecd == "OECD") %>%
  na.omit() %>% 
  dplyr::select(id)

df1$isei08sp <- car::recode(df1$isei08sp,"NA=0")
df1$isei08 <- car::recode(df1$isei08,"NA=0")

dfreg <- df1 %>% dplyr::select(id,
  egal = egal2,
  dclass3res_V=isei08,
  # dclass3spo_V=isei08sp,
  homclass3_V_res=socdist,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2,
         dclass3res_V=dclass3res_V/10,
         # dclass3spo_V=dclass3spo_V/10,
         homclass3_V_res=homclass3_V_res/10
         ) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN")  %>% 
  filter(id %in% dummy_df$id)
dfreg <- na.omit(dfreg)

# Step 1: Calculate absolute values
absolute_values <- abs(dfreg$homclass3_V_res)
# hist(absolute_values);summary(absolute_values)

# Step 2: Add 1 to all values to eliminate zeros
modified_values <- absolute_values + 0.1
# hist(modified_values);summary(modified_values)

# Step 3: Reverse the order of the scale
reversed_values <- max(modified_values) + 0.1 - modified_values
# hist(reversed_values);summary(reversed_values) 
dfreg$homclass3_V_res <- reversed_values


## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
digclas1_VW_1<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner + (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_2<- update(digclas1_VW_1, . ~ . +know_total)
digclas1_VW_3 <- update(digclas1_VW_2, . ~ . + dclass3res_V)

digclas1_VW_4 <- update(digclas1_VW_3, . ~ . + dclass3res_V+female+agenum)
digclas1_VW_5 <- update(digclas1_VW_3, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_6 <- update(digclas1_VW_3, . ~ . + dclass3res_V+female+agenum+edyears+ Q03pcm+workst)
digclas1_VW_7 <- update(digclas1_VW_6, . ~ . +dclass3res_V*homclass3_V_res)
digclas1_VW <- list(digclas1_VW_1,digclas1_VW_2,
                    digclas1_VW_3,
                    # digclas1_VW_4,
                    digclas1_VW_5,digclas1_VW_6,digclas1_VW_7)

ccoef <- list(homclass3_V_res="Social Distance /10",
              know_total="Network size",
              # socialtrust="Social Trust",
              # "dclass3res_VIntermediate class (III+IV)"="Intermediate Class",
              # "dclass3res_VWorking Class (V+VI+VII)"="Working Class",
              # "femaleFemale"="Female (Ref. = Male)",
              # "agenum"="Age",
              # "age2"="Age2",
              "dclass3res_V"="ISEI/10",
              "edyears"="Year of Education",
              "Q03pcmT02"="Income (T2)","Q03pcmT03"="Income (T3)","Q03pcmMissing"="Income (No information)",
              "workstNot in paid work" = "Not in paid work (Ref. = In paid work)",
              # "unionYes" ="Union Membership (Ref. = Not Unionized)",
              # "dclass3spo_V" = "ISEI/10 (Partner)",
              "homclass3_V_res:dclass3res_V" = "Social Distance*ISEI")


texreg(digclas1_VW,stars = c(0.001, 0.01, 0.05, 0.1),
       caption = paste("(\\#tab:table2)","Multilevel models for Social Distance and Redistributive Preferences"),
       custom.note = "Note: Models include sampling weights. Gender, age, marital status and religion are included as controls. Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,
       custom.coef.map = ccoef,
       symbol = "+",scalebox = 0.60,
      custom.gof.rows = list("Controls"=rep("Yes",6)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups","Var: Country (Intercept)","Var: Residual"),
       float.pos = "h!",
       use.packages = F)
```

\newpage

```{r fig1-marg-socdist, fig.dim=c(10,5),fig.cap='Average Marginal Effects of Social Distance conditionated by ISEI on Redistributive Preferences',warning=FALSE}
int_homo <- digclas1_VW_7
plot_slopes(digclas1_VW_7, variables = "homclass3_V_res", condition = list("dclass3res_V" = "threenum"))+
labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
       x="ISEI",y="Redistributive preferences")
```

```{r fig1-pred-socdist, fig.dim=c(10,5),fig.cap='Linear Predictions for Social Distance on Redistributive Preferences by ISEI',warning=FALSE}
int_homo <- digclas1_VW_7
df_pred1 <- 
  predictions(int_homo, condition = c("homclass3_V_res","dclass3res_V"),
              newdata = datagrid(homclass3_V_res = seq(min(dfreg$homclass3_V_res), max(dfreg$homclass3_V_res), by= 0.5),
                                 dclass3res_V = c(min(dfreg$dclass3res_V),mean(dfreg$dclass3res_V),max(dfreg$dclass3res_V))))

df_pred1$dclass3res_V <- factor(df_pred1$dclass3res_V,labels = c("ISEI (min)","ISEI (Mean)", "ISEI (max)"))

# names(df_pred1)
df_pred1 %>% 
ggplot(aes(y =estimate,x=homclass3_V_res, fill=dclass3res_V, color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=1,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=2,color="black") +
  # facet_grid(~dclass3res_V) +
  scale_fill_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#989898","#CCCCCC"))+
  scale_y_continuous(limits = c(40,100))+
  labs(caption = paste0("N=",nobs(int_homo),", Countries=",lme4::ngrps(int_homo)),
       x="Social distance",y="Redistributive preferences") +
  theme(legend.position = "bottom", legend.title = element_blank())
```

\pagebreak

```{r tab2-socdist, results='asis', cache=TRUE}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2

df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
dummy_df <- df1 %>% dplyr::select(id,
  egal = egal2,dclass3res_V,
  # dclass3spo_V,
  homclass3_V_res,know_total,
  # socialtrust,
  Q03pcm,edyears,female,agenum,
  # religion,
  partner,
  # union,
  workst,WEIGHT,region,
  "gini_disp"=wid_gini_disp,"gini_mkt",gv_spen,rel_red,abs_red,ilo_taxrev,
  ilo_govspe,d10d1=wid_p90p10,wid_p90p50,top10=wid_sharetop10,rgdpna,gdppercapita,
  oecd,country2, country, country3) %>%
  filter(country2 != "SVN") %>% 
  # filter(oecd == "OECD") %>%
  na.omit() %>% 
  dplyr::select(id)

df1$isei08sp <- car::recode(df1$isei08sp,"NA=0")
dfreg <- df1 %>% dplyr::select(id,
  egal = egal2,
  # starts_with("class3"),
  # starts_with("digclass3"),
  # starts_with("dclass3"),
  # starts_with("homclass"),
  dclass3res_V=isei08,
  # dclass3spo_V=isei08sp,
  homclass3_V_res=socdist,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  # religion,
  partner,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  abs_red,
  ilo_taxrev,
  ilo_govspe,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") %>% 
  na.omit() %>% 
    mutate(loggdppercapita=scale(gdppercapita/1000),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2, 
         gini_disp=scale(gini_disp),
         dclass3res_V=dclass3res_V/10,
         # dclass3spo_V=dclass3spo_V/10,
         homclass3_V_res=homclass3_V_res/10
         ) %>% 
  filter(id %in% dummy_df$id)

dfreg$wstate2 <- scale(scale(dfreg$abs_red*100) + scale(dfreg$ilo_taxrev) + scale(dfreg$ilo_govspe))
# Step 1: Calculate absolute values
absolute_values <- abs(dfreg$homclass3_V_res)
# hist(absolute_values);summary(absolute_values)

# Step 2: Add 1 to all values to eliminate zeros
modified_values <- absolute_values + 0.1
# hist(modified_values);summary(modified_values)

# Step 3: Reverse the order of the scale
reversed_values <- max(modified_values) + 0.1 - modified_values
# hist(reversed_values);summary(reversed_values) 

dfreg$homclass3_V_res <- reversed_values


# Variable Group-Centering ------------------------------------------------$
dfreg <- 
  dfreg %>% 
  mutate(to_dummy(female),
         # to_dummy(union),
         to_dummy(workst),
         # dummy for categorical variables-------------------------------------$
         to_dummy(Q03pcm),
         # to_dummy(dclass3spo_V)
  )
dfreg$female_gc = group_center(dfreg$female_2, grp = dfreg$country2)
# dfreg$union_gc = group_center(dfreg$union_2, grp = dfreg$country2)
dfreg$workst_gc = group_center(dfreg$workst_2, grp = dfreg$country2)
dfreg$edyears_gc = group_center(dfreg$edyears, grp = dfreg$country2)
dfreg$agenum_gc = group_center(dfreg$agenum, grp = dfreg$country2)
dfreg$age2_gc = group_center(dfreg$age2, grp = dfreg$country2)
# dfreg$socialtrust_gc = group_center(dfreg$socialtrust, grp = dfreg$country2)
dfreg$homclass3_V_gc <-group_center(dfreg$homclass3_V_res, grp = dfreg$country2)
dfreg$know_total_gc = group_center(dfreg$know_total, grp = dfreg$country2)
# dfreg$religion_gc = group_center(as.numeric(dfreg$religion), grp = dfreg$country2)
dfreg$partner_gc = group_center(as.numeric(dfreg$partner), grp = dfreg$country2)

dfreg$dclass3res_V = group_center(as.numeric(dfreg$dclass3res_V), grp = dfreg$country2)



# Household Income Tercile
dfreg$Q03pcm_1_gc = group_center(dfreg$Q03pcm_1, grp = dfreg$country2)
dfreg$Q03pcm_2_gc = group_center(dfreg$Q03pcm_2, grp = dfreg$country2)
dfreg$Q03pcm_3_gc = group_center(dfreg$Q03pcm_3, grp = dfreg$country2)
dfreg$Q03pcm_NA_gc = group_center(dfreg$Q03pcm_4, grp = dfreg$country2)

# Partner Social Class
# dfreg$dclass3spo_V_1_gc = group_center(dfreg$dclass3spo_V_1, grp = dfreg$country2)
# dfreg$dclass3spo_V_2_gc = group_center(dfreg$dclass3spo_V_2, grp = dfreg$country2)
# dfreg$dclass3spo_V_3_gc = group_center(dfreg$dclass3spo_V_3, grp = dfreg$country2)
# dfreg$dclass3spo_V_NA_gc = group_center(dfreg$dclass3spo_V_4, grp = dfreg$country2)
# dfreg$dclass3spo_V_gc = group_center(dfreg$dclass3spo_V, grp = dfreg$country2)


# drop dummies
dfreg <- dplyr::select(dfreg,-c(female_1,female_2,
                                # union_1,union_2,
                                workst_1,
                                workst_2,Q03pcm_1,Q03pcm_2,Q03pcm_2,Q03pcm_4,
                                # dclass3spo_V_1,dclass3spo_V_2,dclass3spo_V_3,dclass3spo_V_4
                                ))

# dfreg$gini_disp <- scale(dfreg$gini_disp)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
homo_V_gini <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_wstate2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_gdp_controls <-
  lmer(egal~
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2 +
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

homo_V_gini_full2 <- 
  lmer(egal~ 
         homclass3_V_gc+
         know_total_gc+
         # socialtrust_gc+
         dclass3res_V+
         # dclass3spo_V_2_gc+dclass3spo_V_3_gc+dclass3spo_V_NA_gc+
         female_gc+agenum_gc+
         # age2_gc+
         partner_gc+
         edyears_gc+Q03pcm_2_gc+Q03pcm_3_gc+Q03pcm_NA_gc+
         # union_gc+
         workst_gc+ 
         gini_disp +loggdppercapita + wstate2+
         homclass3_V_gc*
         dclass3res_V*
         gini_disp + 
         (homclass3_V_gc+dclass3res_V|country2),data=dfreg,weights = WEIGHT)

digclas1_macro <- list(homo_V_gini,
                       homo_V_gini_gdp,
                       homo_V_gini_gdp_wstate2,
                       homo_V_gini_full2)

ccoef <- list(homclass3_V_gc="Social Distance (CWC)",
              "dclass3res_V"="ISEI ",
              "gini_disp" = "Income inequality (Gini index)",
              loggdppercapita = "GDP/capita",
              wstate2="Size of the welfare state",
              "homclass3_V_gc:dclass3res_V" = "Distance*ISEI",
              "homclass3_V_gc:gini_disp"= "Distance*Income Inequality",
              "dclass3res_V:gini_disp" ="ISEI*Inequality",
              "homclass3_V_gc:dclass3res_V:gini_disp" = "Distance*Working Class*Income Inequality")

texreg(digclas1_macro,stars = c(0.001, 0.01, 0.05, 0.1),symbol = "+",scalebox = 0.60,
       caption = "Multilevel models for Income Inequality, Social Distance and Redistributive Preferences",
       custom.note = "Note: Models include sampling weights and individual level controls centered within cluster (group mean). Standard errors in parentheses. %stars",
       caption.above = T,leading.zero = T,single.row = T,
       custom.coef.map = ccoef,
      # groups = list("Social Class (Ref.= Service Class)" = 2:3,"Macro-level factors"=4:6, "Distance*Social Class"=7:8, "Distance * Social Class * Income Inequality"=10:11),
       float.pos = "h!",
      custom.gof.rows = list("Controls"=rep("Yes",4)),include.loglik = FALSE,include.aic = FALSE,
      custom.gof.names = c(NA,NA,"Num. groups",
                           "Var: Group (Intercept)",
                           "Var: Group Soc. Distance",
                           "Var: Group ISEI",
                           "Cov: Group (Intercept), Soc. Distance",
                           "Cov: Group (Intercept), ISEI",                           
                           "Cov: Group Soc. Distance, ISEI",
                           "Var: Residual"),
       use.packages = F)
```

```{r fig2-socdist, fig.dim=c(12,7),fig.cap='Three-way interaccion effects for Redistributive Preferences, Social Distance, ISEI and Income Inequality'}
### Predicted values homo*class*GiniD ---------------------------------------$
# ginid_max<- round(max(dfreg$gini_disp) ,2)
# ginid_min<- round(min(dfreg$gini_disp),2)

ginid_max<- round(mean(dfreg$gini_disp) + sd(dfreg$gini_disp)  ,2)
ginid_min<- round(mean(dfreg$gini_disp) -sd(dfreg$gini_disp) ,2)
ginid_mea<- round(mean(dfreg$gini_disp),2)

df_pred_giniD_gc <-
  predictions(
    homo_V_gini_full2,newdata = datagrid(
      gini_disp = c(ginid_min, ginid_mea, ginid_max),
      wstate2=mean(dfreg$wstate2),
      loggdppercapita=mean(dfreg$loggdppercapita),
      homclass3_V_gc = seq(min(dfreg$homclass3_V_gc)+0.01, max(dfreg$homclass3_V_gc)+0.01, by=0.5),
      dclass3res_V=c(min(dfreg$dclass3res_V),max(dfreg$dclass3res_V))
    )
  )

df_pred_giniD_gc <- as.data.frame(df_pred_giniD_gc)
df_pred_giniD_gc$gini_disp <- factor(df_pred_giniD_gc$gini_disp,labels = c("Gini (-1SD)","Gini (Mean)", "Gini (+1SD)"))

df_pred_giniD_gc$dclass3res_V <- factor(df_pred_giniD_gc$dclass3res_V,labels = c("ISEI (min)","ISEI (max)"))
# df_pred_giniD_gc <- df_pred_giniD_gc %>% filter(dclass3res_V!="Intermediate class (III+IV)")

df_pred_giniD_gc$dclass3res_V <- as.factor(df_pred_giniD_gc$dclass3res_V)

df_pred_giniD_gc %>% 
  ggplot(aes(y=estimate,x=homclass3_V_gc, fill=dclass3res_V,color=dclass3res_V,ymin=conf.low, ymax=conf.high)) +
  geom_ribbon(alpha=0.8,size=0.7,linetype="solid",color="black") +
  geom_line(size=1,color="black") +
  geom_point(size=3, shape = 21,color="black") +
  facet_wrap(~gini_disp) +
  labs(y = "Preferences for Redistribution",
       x="Social Distance (CWC)",
       caption = paste0("N=",nobs(homo_V_gini_full2),", Countries=",lme4::ngrps(homo_V_gini_full2))
       ) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "Income inequality (post-tax) \n ", breaks = NULL, labels = NULL),
                     ) +
 
   scale_fill_manual(values=c("#323232","#CCCCCC"))+
  scale_color_manual(values=c("#323232","#CCCCCC"))+
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text=element_text(size=15),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))
```

```{r table1-alternative, eval=FALSE, include=FALSE, results='asis'}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))

if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg,MLMusingR,lme4)  
rm(list=ls())

load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(
  egal = egal2,
  dclass3res_V=dclass6res,
  # homclass3_V_res=homclass3_V_res_part,
  homclass3_V_res,
  know_total,
  # socialtrust,
  Q03pcm,
  edyears,
  female,
  agenum,
  partner,
  # religion,
  # union,
  workst,
  WEIGHT,
  region,
  "gini_disp"=wid_gini_disp,
  "gini_mkt",
  gv_spen,
  rel_red,
  d10d1=wid_p90p10,
  wid_p90p50,
  top10=wid_sharetop10,
  rgdpna,
  gdppercapita,
  oecd,
  country2, country, country3,
) %>%
  mutate(logrgdpna = log(rgdpna),
         loggdppercapita=log(gdppercapita),
         edyears2 = edyears ^ 2,
         age2 = agenum ^ 2) %>%
  # filter(oecd == "OECD") %>%
  filter(country2 != "SVN") 


# dfreg$dclass3spo_V <- car::recode(dfreg$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))
# df1$dclass3spo_V <- car::recode(df1$dclass3spo_V,"NA='No information (Missing, No partner)'",levels = c("Service Class (I+II)","Intermediate class (III+IV)","Working Class (V+VI+VII)","No information (Missing, No partner)"))

# sjPlot::tab_xtab(df1$dclass3spo_V,df1$PARTLIV)

dfreg <- na.omit(dfreg)

## Model -  EGP3 - DIGCLASS - V to Working -----------------------------$
digclas1_VW_1<- lmer(egal~1 + homclass3_V_res + female+agenum+(1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_2<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner +  (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_3<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner +  (1|country2),data=dfreg,weights = WEIGHT)
digclas1_VW_4<- lmer(egal~1 + homclass3_V_res + female+agenum+ partner +  know_total + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_6<- lmer(egal~1 + homclass3_V_res + female+agenum+ 
                       partner +  know_total +   
                       dclass3res_V + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_7<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +   know_total +  
                       dclass3res_V +  edyears + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_8<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total + 
                       dclass3res_V +  edyears +  Q03pcm +(1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_9<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total +  
                       dclass3res_V +  edyears +  Q03pcm + workst +(1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_10<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total + 
                       dclass3res_V +  edyears +  Q03pcm + workst + (1|country2),data=dfreg,weights = WEIGHT)

digclas1_VW_10a<- lmer(egal~1 + homclass3_V_res + female+agenum+
                       partner +  know_total + 
                       dclass3res_V +  edyears +  Q03pcm + workst + (homclass3_V_res|country2),data=dfreg,weights = WEIGHT)


digclas1_VW_11 <- update(digclas1_VW_10, . ~ . +dclass3res_V*homclass3_V_res)

digclas1_VW <- list(digclas1_VW_1,digclas1_VW_2,digclas1_VW_3,digclas1_VW_4,
                    digclas1_VW_6,digclas1_VW_7,digclas1_VW_8,digclas1_VW_10,digclas1_VW_10a,
                    digclas1_VW_11)

screenreg(digclas1_VW)
plot_slopes(digclas1_VW_11, variables = "homclass3_V_res", by = "dclass3res_V",draw = T)
```

