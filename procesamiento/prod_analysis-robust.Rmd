---
title: "Robustness checks"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
css: "input/css/custom.css" # custom CSS para html
linestretch: '1.5'          # interlineado 
link-citations: yes         # citas linkeadas
output:
  bookdown::html_document2:
    toc: yes
    code_folding: hide
    toc_float: 
      collapsed: true
      smooth_scroll: false
      number_sections: false    
  bookdown::pdf_document2:
    template: null
    toc: false
    keep_tex: false
    pandoc_args:
      - --template=input/mytemplate.tex #custom template para usar autores con afiliacion  
---

```{r setup, include=FALSE}
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(knitr, kableExtra, dplyr, ggplot2,sjmisc,texreg) # librerias
knitr::opts_chunk$set(warning = FALSE,  # mensaje de warning
                      message = FALSE,  # mensajes/avisos de librerias  
                      cache = TRUE,    # cache de los chunks,usar analisis pesados
                      out.width = '100%',
                      fig.pos= "H",     # posicion figuras H = HERE
                      fig.align = "center",
                      echo = FALSE      # incluir chunk en output
                      )
options(scipen=999) # notacion cientifica
rm(list=ls())       # limpiar workspace
options(knitr.kable.NA = '') # NA en kable = ''
```
#  Intro

- maintain class R's and calculate homogeneity
- keep Partner class apart as a control


```{r ord-micro,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,ordinal)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
df1$redistF <- as.factor(df1$redist)

dfreg <- df1 %>% dplyr::select(redist=redistF,
                        class3,
                        homclass,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- clmm(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- clmm(redist~ class3+ (1|country2),data=dfreg)
homclass <- clmm(redist~homclass + (1|country2),data=dfreg)
full1 <- clmm(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
# rob1 <- clmm(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
# rob2 <- clmm(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- clmm(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- clmm(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r ord-strongties,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,ordinal)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
df1$redistF <- as.factor(df1$redist)
dfreg <- df1 %>% dplyr::select(redist=redistF,
                        class3,
                        homclass=homclass_s,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- clmm(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- clmm(redist~ class3+ (1|country2),data=dfreg)
homclass <- clmm(redist~homclass + (1|country2),data=dfreg)
full1 <- clmm(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
# rob1 <- clmm(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
# rob2 <- clmm(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- clmm(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- clmm(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity (strong) and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity (Strong)",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r orde-weakties,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,ordinal)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
df1$redistF <- as.factor(df1$redist)
dfreg <- df1 %>% dplyr::select(redist=redistF,
                        class3,
                        homclass=homclass_w,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- clmm(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- clmm(redist~ class3+ (1|country2),data=dfreg)
homclass <- clmm(redist~homclass + (1|country2),data=dfreg)
full1 <- clmm(redist~ class3 +homclass+ female+agenum + age2+(1|country2),data=dfreg)
# rob1 <- clmm(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
# rob2 <- clmm(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- clmm(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+(1|country2),data=dfreg)
# Interactions segregation x class
int_homo <- clmm(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity (Weak) and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity (Weak)",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r ownclass, cache=TRUE, results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,ordinal)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$class3 <- relevel(df1$class3,ref =  "Intermediate class (III+IV)")
df1$class3res <- relevel(df1$class3res,ref =  "Intermediate class (III+IV)")
df1$class3spo <- relevel(df1$class3spo,ref =  "Intermediate class (III+IV)")
df1$labst1 <-car::recode(df1$labst,"'No information'='Not in labour force'")
df1$redistF <- as.factor(df1$redist)

dfreg <- df1 %>% dplyr::select(redist=redistF,
                        class3=class3res,
                        class3spo,
                        # homclass,
                        homclass=homclass_res,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        rgdpna,
                        edyears,
                        female,
                        agenum,
                        country2,country,
                        union,
                        labst,
                        labst1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
  # filter(!country2 %in% c("Turkey","Estonia")) %>%
  na.omit()
# dim(dfreg)

# lineal
base <- clmm(redist~1 + (1|country2),data=dfreg); icc1<- performance::icc(base)
class <- clmm(redist~ class3+ (1|country2),data=dfreg)
homclass <- clmm(redist~homclass + (1|country2),data=dfreg)
full1 <- clmm(redist~ class3 +homclass+ female+agenum + age2+ (1|country2),data=dfreg)
rob1 <- clmm(redist~class3+ homclass+ edyears+ female+ agenum+ age2+(1|country2),data=dfreg)
rob2 <- clmm(redist~class3+ homclass+ edyears+ Q03pcm+ female+ agenum +age2+(1|country2),data=dfreg)
rob3 <- clmm(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ (1|country2),data=dfreg)
rob4 <- clmm(redist~class3+ homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ class3spo +(1|country2),data=dfreg)

# Interactions segregation x class
int_homo <- clmm(redist~class3*homclass+ edyears+ Q03pcm+ labst1+ union+ female+agenum +age2+ class3spo +(1|country2),data=dfreg)
# models <- list(homclass,class,full1,
#                # rob1,rob2,
#                rob4)
# texreg::screenreg(int_homo,single.row = F)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and Own social class " 
coefmap <-  list(homclass ="Class-based network homogeneity - Resp.",
                 'class3Service Class (I+II)' ='Service Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                  "labst1Not in labour force"="Not in labor force",
                 "unionYes" = 'Union: Yes',
                 'class3Service Class (I+II):homclass'='Homogeneity x Service Class',
                 'class3Working Class (V+VI+VII):homclass'='Homogeneity x Working Class',
                 'class3spoService Class (I+II)' ='Service Class (Partner)',
                 "class3spoWorking Class (V+VI+VII)"='Working Class (Partner)'
                
                 )
coefgroup <- list("Social Class - Resp. (ref: Intermediate Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","No","No","Yes","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA)

models <- list(homclass,class,full1,rob3,rob4,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```


