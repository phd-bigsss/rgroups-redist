---
title: "AnÃ¡lisis de datos"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output: 
  html_document: 
    toc: yes
    code_folding: hide
    toc_float: 
      collapsed: true
      smooth_scroll: false
      number_sections: true
editor_options: 
  chunk_output_type: console
---

# Setup

```{r setup}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
options(scipen=9999) # desactivar notacion cientifica
```

# Descriptive

```{r ineq-attitudes}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2)
load(here::here("input/data/proc/study1.RData"))
  # Declare ggplot2 features
ggplot2::theme_set(
  ggplot2::theme(
    panel.background = ggplot2::element_rect(fill = "gray85",
                                             colour = "gray85"),
    panel.border = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_text(size = 13,
                                        hjust = 1),
    title = ggplot2::element_text(size = 13,
                                  face = "bold"),
    legend.text = ggplot2::element_text(size = 12),
    plot.caption = ggplot2::element_text(size = 10,
                                         face = "plain",
                                         hjust = 1)
  )
)

df1 %>%
    dplyr::select(perineq,prefineq,pertransfer,redist) %>%
    na.omit() %>% 
    sjPlot::plot_likert(geom.colors = "PuBu",
                        grid.range  =  c (1.2 , 1),
                        # title = "a. Perception meritocratic",
                          geom.size = c(0.62),
                          catcount = 4,
                          expand.grid = T,
                          values  =  "sum.outside",
                          reverse.colors = T,
                          reverse.scale = T,
                          show.n = FALSE,cat.neutral = 3,
                        show.prc.sign = T,
                        title = '') +
    ggplot2::theme(legend.position = "bottom")

ggsave(plot = last_plot(),filename = "ineq-attitudes.png",device = "png",
       path = here::here("output"),width = 2,height = 1,units = "cm",scale = 15)
```

```{r welfare}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2,scales)
load(here::here("input/data/proc/study1.RData"))
df1 %>%
    dplyr::select(whealth,wcarelder) %>%
    na.omit() %>% 
    sjPlot::plot_likert(geom.colors = "PuBu",
                        grid.range  =  c (1 , 1),
                        # title = "a. Perception meritocratic",
                          geom.size = c(0.62),
                          catcount = 5,
                          expand.grid = T,
                          # values  =  "sum.outside",
                          reverse.colors = T,
                          reverse.scale = T,
                          show.n = FALSE,show.prc.sign = T,
                        title = 'Who do you think should primarily provide...') +
    scale_colour_discrete(labels = function(x) str_wrap(x, width = 10))+
    ggplot2::theme(legend.position = "bottom")

ggsave(plot = last_plot(),filename = "welf-attitudes.png",device = "png",
       path = here::here("output"),width = 2,height = 1,units = "cm",scale = 16)
```

```{r perc-integration}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2,scales)
load(here::here("input/data/proc/study1.RData"))
df1 %>%
    dplyr::select(starts_with("pi_")) %>%
    na.omit() %>% 
    sjPlot::plot_likert(geom.colors = "PuBu",
                        grid.range  =  c (0.2 , 1),
                        # title = "a. Perception meritocratic",
                          geom.size = c(0.62),
                          catcount = 5,
                          expand.grid = T,
                          # values  =  "sum.outside",
                          reverse.colors = T,
                          reverse.scale = T,
                          show.n = FALSE,show.prc.sign = T,sort.frq = "pos.asc",
                        title = 'How often in the past 4 weeks have you felt that...') +
    scale_colour_discrete(labels = function(x) str_wrap(x, width = 10))+ 
    ggplot2::theme(legend.position = "bottom")

ggsave(plot = last_plot(),filename = "perc-integration.png",device = "png",
       path = here::here("output"),width = 2,height = 1,units = "cm",scale = 15)

df1 %>%
    dplyr::select(starts_with("pi_")) %>% 
  psych::alpha()
```

```{r}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2,scales)
load(here::here("input/data/proc/study1.RData"))
df1$pi_nteg<- rowMeans(df1[,c("pi_compa","pi_isola","pi_left")],na.rm = T)
dfcor <- 
df1 %>%
    dplyr::select(pi_nteg,class6,sstatus,redist) %>% 
  as.data.frame()

levels(df1$class6)
table(df1$know_total)
table(df1$n_high)
table(df1$n_middle)
table(df1$n_low)

# dfcor$hhdepriv <- as.factor(dfcor$hhdepriv)
# dfcor$sstatus <- as.numeric(dfcor$sstatus)
cormat<- polycor::hetcor(dfcor,parallel = T,thresholds = F)

jpeg(file=here::here("output/network-structure.jpeg"),units = "cm",width = 17,height = 15,res = 300)
# Set up the layout for the multi-panel plot
par(mfrow = c(1, 1))
# Create the histograms
# hist(df1$prestige, main = sjlabelled::get_label(df1$prestige),xlab = NULL)
# hist(df1$diversity, main = sjlabelled::get_label(df1$diversity),xlab = NULL)
hist(df1$homclass, main = sjlabelled::get_label(df1$homclass),xlab = NULL)
dev.off()

sjPlot::plot_frq(df1$class3,show.n = F) +
  theme_grey()
ggsave(plot = last_plot(),filename = "class6.png",device = "png",
       path = here::here("output"),width = 1.5,height = 1,units = "cm",scale = 10)


jpeg(file=here::here("output/n_known.jpeg"),units = "cm",width = 15,height = 15,res = 300)
# Set up the layout for the multi-panel plot
par(mfrow = c(2, 2))

# Create the histograms
hist(df1$n_low, main = sjlabelled::get_label(df1$n_low),xlab = NULL)
hist(df1$n_middle, main = sjlabelled::get_label(df1$n_middle),xlab = NULL)
hist(df1$n_high, main = sjlabelled::get_label(df1$n_high),xlab = NULL)
hist(df1$know_total, main = sjlabelled::get_label(df1$know_total),xlab = NULL)
# hist(df1$prestige, main = sjlabelled::get_label(df1$prestige),xlab = NULL)
# hist(df1$diversity, main = sjlabelled::get_label(df1$diversity),xlab = NULL)
dev.off()



sjPlot::plot_grpfrq(var.cnt = df1$know_total,var.grp = df1$class3,type = 'box',geom.colors = "Blues")
ggsave(plot = last_plot(),filename = "known_total_class6.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 15)

sjPlot::plot_grpfrq(var.cnt = df1$diversity,var.grp = df1$class3,type = 'box',geom.colors = "Blues")
ggsave(plot = last_plot(),filename = "diversity_class6.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 15)

sjPlot::plot_grpfrq(var.cnt = df1$prestige,var.grp = df1$class3,type = 'box',geom.colors = "Blues")
ggsave(plot = last_plot(),filename = "prestige_class6.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 15)


sjPlot::plot_grpfrq(var.cnt = df1$homclass,var.grp = df1$class3,type = 'box',geom.colors = "Blues")
ggsave(plot = last_plot(),filename = "homclass_class6.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 15)

sjlabelled::set_label(df1$pi_nteg) <- "Perceived social isolation"
sjPlot::plot_grpfrq(var.cnt = df1$pi_nteg,var.grp = df1$class3,type = 'box',geom.colors = "Blues",ylim = c(1,5))
ggsave(plot = last_plot(),filename = "pint_class3.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 15)
```


# Descriptive x country

```{r redistribution}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2)
load(here::here("input/data/proc/study1.RData"))
df1$country<- as.numeric(df1$country)
df1$country2 <- countrycode::countrycode(sourcevar = df1$country,origin = "iso3n",destination = "country.name")
df1$redistF <- factor(df1$redist,levels = 1:5,labels = sjlabelled::get_labels(df1$redist))

df1 %>%
  group_by(country2, ) %>%
  summarise(redist = mean(redist, na.rm = T)) %>% 
  View()



percentage_data <- df1 %>%
  group_by(country2, redistF) %>%
  summarise(count = n()) %>%
  group_by(country2) %>%
  na.omit() %>% 
  mutate(percentage = count / sum(count)) %>% 
  arrange(country2,redistF,percentage) %>% 
  mutate(pct_lab = paste0(round(percentage*100,1),"%")) %>% 
  mutate(pct_lab=ifelse(!redistF %in% c("Strongly agree"),NA,pct_lab))

order <- 
percentage_data %>% 
  filter(redistF=="Strongly agree") %>% 
  arrange(percentage) %>% 
  dplyr::select(country2)

order$orden <- 1:31
ggplot(percentage_data, aes(x=country2,y=percentage*100,fill=redistF,group=redistF,label = pct_lab))+
  geom_bar(stat = 'identity') +
  # geom_text(position = position_fill(vjust =100)) +
  scale_y_continuous(name=NULL,labels = scales::percent_format(scale = 1),limits = c(0,101), expand = c(0, 0)) +
  scale_x_discrete(limits=order$country2,name=NULL) +  
  scale_fill_ordinal(guide = guide_legend(reverse = TRUE)) +
  theme_classic() +
  ggtitle(label= "Government's responsibility: reduce the differences in income between people with high incomes and those with low incomes.") + 
  theme(legend.position = 'bottom',legend.title = element_blank())  +
  coord_flip()

ggsave(plot = last_plot(),filename = "wredist_cn.png",device = "png",
       path = here::here("output"),width = 2,height = 1,units = "cm",scale = 15)


df1$pi_nteg<- rowMeans(df1[,c("pi_compa","pi_isola","pi_left")],na.rm = T)
resits_count <- df1 %>%
  group_by(country,country2) %>%
  summarise(redist = mean(redist,na.rm = T),
            homclass = mean(homclass,na.rm = T),
            pi_nteg = mean(pi_nteg,na.rm = T),
            pi_ntegm = median(pi_nteg,na.rm = T)
            ) %>%
  na.omit()

cor(df1[,c("redist","homclass","pi_nteg")],use = "complete.obs")

ggplot(data = resits_count,aes(x = homclass,y = redist,label=country2)) +
  xlab("Class-based homogeneity") +
  ylab("Redistributive preferences")+  
  labs(alt = "A",caption = "r=0.42") +  
  geom_smooth(method = "lm") +
  geom_text() 

myorder <-  resits_count$country2[order(resits_count$homclass)]
ggplot(data = resits_count,aes(x =country2,y = homclass)) + 
  geom_segment(aes(x=country2, xend=country2, y=0, yend=homclass), color="black") +
  geom_point() +
  scale_x_discrete(limits=myorder) +
  ylab("Class-based homogeneity")+
  xlab("") +
  theme(axis.text.x = element_text(angle = 45))

ggsave(plot = last_plot(),filename = "homclass_cn.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 20)

myorder <-  resits_count$country2[order(resits_count$pi_nteg)]
ggplot(data = resits_count,aes(x =country2,y = pi_nteg)) + 
  geom_segment(aes(x=country2, xend=country2, y=0, yend=pi_nteg), color="black") +
  geom_point() +
  scale_x_discrete(limits=myorder) +
  ylab("Perceived isolation")+
  xlab("") +
  theme(axis.text.x = element_text(angle = 45))

ggsave(plot = last_plot(),filename = "p_isolat_cn.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 20)
```

```{r health}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2)
load(here::here("input/data/proc/study1.RData"))
df1$country2 <- countrycode::countrycode(sourcevar = df1$country,origin = "iso3n",destination = "country.name")

df1$whealthF <- factor(df1$whealth,levels = 1:5,labels = sjlabelled::get_labels(df1$whealth))

percentage_data <- df1 %>%
  group_by(country2, whealthF) %>%
  summarise(count = n()) %>%
  group_by(country2) %>%
  na.omit() %>% 
  mutate(percentage = count / sum(count)) %>% 
  arrange(country2,whealthF,percentage) %>% 
  mutate(pct_lab = paste0(round(percentage*100,1),"%")) %>% 
  mutate(pct_lab=ifelse(!whealthF %in% c("Government"),NA,pct_lab))

order <- 
percentage_data %>% 
  filter(whealthF=="Government") %>% 
  arrange(percentage) %>% 
  select(country2)

order$orden <- 1:32
ggplot(percentage_data, aes(x=country2,y=percentage*100,fill=whealthF,group=whealthF,label = pct_lab))+
  geom_bar(stat = 'identity') +
  geom_text(position = position_fill(vjust = 90)) + 
  scale_y_continuous(name=NULL,labels = scales::percent_format(scale = 1),limits = c(0,101), expand = c(0, 0)) +
  scale_x_discrete(limits=order$country2,name=NULL) +  
  scale_fill_ordinal(guide = guide_legend(reverse = TRUE)) +
  theme_classic() +
  ggtitle(label= "Who do you think should primarily provide: health") + 
  theme(legend.position = 'bottom',legend.title = element_blank())  +
  coord_flip()

ggsave(plot = last_plot(),filename = "whealth_cn.png",device = "png",
       path = here::here("output"),width = 2,height = 1,units = "cm",scale = 15)
```

```{r elderlycare}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2)
load(here::here("input/data/proc/study1.RData"))
df1$country2 <- countrycode::countrycode(sourcevar = df1$country,origin = "iso3n",destination = "country.name")
df1$wcarelderF <- factor(df1$wcarelder,levels = 1:5,labels = sjlabelled::get_labels(df1$wcarelder))
percentage_data <- df1 %>%
  group_by(country2, wcarelderF) %>%
  summarise(count = n()) %>%
  group_by(country2) %>%
  na.omit() %>% 
  mutate(percentage = count / sum(count)) %>% 
  arrange(country2,wcarelderF,percentage) %>% 
  mutate(pct_lab = paste0(round(percentage*100,1),"%")) %>% 
  mutate(pct_lab=ifelse(!wcarelderF %in% c("Government"),NA,pct_lab))

order <- 
percentage_data %>% 
  filter(wcarelderF=="Government") %>% 
  arrange(percentage) %>% 
  select(country2)

order$orden <- 1:32
ggplot(percentage_data, aes(x=country2,y=percentage*100,fill=wcarelderF,group=wcarelderF,label = pct_lab))+
  geom_bar(stat = 'identity') +
  geom_text(position = position_fill(vjust = 95)) + 
  scale_y_continuous(name=NULL,labels = scales::percent_format(scale = 1),limits = c(0,101), expand = c(0, 0)) +
  scale_x_discrete(limits=order$country2,name=NULL) +  
  scale_fill_ordinal(guide = guide_legend(reverse = TRUE)) +
  theme_classic() +
  ggtitle(label= "Who do you think should primarily provide: elderly care") + 
  theme(legend.position = 'bottom',legend.title = element_blank())  +
  coord_flip()

ggsave(plot = last_plot(),filename = "wcareelder_cn.png",device = "png",
       path = here::here("output"),width = 2,height = 1,units = "cm",scale = 15)
```

```{r class5}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2)
load(here::here("input/data/proc/study1.RData"))
df1$country2 <- countrycode::countrycode(sourcevar = df1$country,origin = "iso3n",destination = "country.name")
percentage_data <- df1 %>%
  group_by(country2, class5) %>%
  summarise(count = n()) %>%
  group_by(country2) %>%
  na.omit() %>% 
  mutate(percentage = count / sum(count)) %>% 
  arrange(country2,class5,percentage)

percentage_data$class5 <- forcats::fct_rev(percentage_data$class5)

order <- 
percentage_data %>% 
  filter(class5=="Service class (I+II)") %>% 
  arrange(percentage) %>% 
  select(country2)

order$orden <- 1:32
ggplot(percentage_data, aes(x=country2,y=percentage*100,fill=class5,group=class5))+
  geom_bar(stat = 'identity')+
  scale_y_continuous(name=NULL,labels = scales::percent_format(scale = 1),limits = c(0,101), expand = c(0, 0)) +
  scale_x_discrete(limits=order$country2,name=NULL) +  
  scale_fill_ordinal(guide = guide_legend(reverse = TRUE)) +
  theme_classic() +
  ggtitle(label= "Social class by country") + 
  theme(legend.position = 'bottom',legend.title = element_blank())  +
  coord_flip()

ggsave(plot = last_plot(),filename = "class5_cn.png",device = "png",
       path = here::here("output"),width = 2,height = 1,units = "cm",scale = 15)
```


```{r class3}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2)
load(here::here("input/data/proc/study1.RData"))

df1$country2 <- sjlabelled::to_character(df1$country) 
percentage_data <- df1 %>%
  group_by(country2, class3) %>%
  summarise(count = n()) %>%
  group_by(country2) %>%
  na.omit() %>% 
  mutate(percentage = count / sum(count)) %>% 
  arrange(country2,class3,percentage)

percentage_data$class3 <- forcats::fct_rev(percentage_data$class3)

order <- 
percentage_data %>% 
  filter(class3=="Working Class (V+VI+VII)") %>% 
  arrange(percentage) %>% 
  select(country2)

order$orden <- 1:32
ggplot(percentage_data, aes(x=country2,y=percentage,fill=class3,group=class3))+
  geom_bar(stat = 'identity')+
  # geom_text(aes(label=number_of_errors),position = position_stack(0.5))+
  scale_y_continuous(labels = NULL) +
  scale_x_discrete(limits=order$country2) +  
  scale_fill_ordinal() +
  theme_classic() +
  theme(legend.position = 'bottom')  +
  coord_flip()
```

```{r correlation-socap}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,ggplot2)
load(here::here("input/data/proc/study1.RData"))
# df1$class6 <- forcats::fct_rev(factor(df1$class6,ordered = T))
cormat1 <- 
df1 %>% 
    select('redist',wcarelder,whealth,isei_tot,isei_max,isei_range,"class6") %>% 
  na.omit() %>% 
  polycor::hetcor(parallel = T)

  corrplot::corrplot(cormat1$correlations,
    method = "color",
    addCoef.col = "#000390",
    type = "upper",
    tl.col = "black",
    col=colorRampPalette(c("white","#0068DC"))(12),
    bg = "white",
    na.label = "-")
  text(4.7, 0.6, paste0("Source: Authors calculation based on ISSP 2017",
                             " (N = ",")"),   
       cex = 0.75)
```

```{r correlation-segregation}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,ggplot2)
load(here::here("input/data/proc/study1.RData"))
# df1$class6 <- forcats::fct_rev(factor(df1$class6,ordered = T))
cormat1 <- 
df1 %>% 
    select('redist',homclass,homclass_s,homclass_w,pi_nteg,class3,) %>% 
  na.omit() %>% 
  polycor::hetcor(parallel = T)

  corrplot::corrplot(cormat1$correlations,
    method = "color",
    addCoef.col = "#000390",
    type = "upper",
    tl.col = "black",
    col=colorRampPalette(c("white","#0068DC"))(12),
    bg = "white",
    na.label = "-")
  text(4.7, 0.6, paste0("Source: Authors calculation based on ISSP 2017",
                             " (N = ",")"),   
       cex = 0.75)
```

```{r}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,GGally,ggplot2,scales)
load(here::here("input/data/proc/study1.RData"))
df1$country2 <- sjlabelled::to_character(df1$country)
library(scales)

df1 %>% 
  filter(!is.na(class5)) %>%
ggplot(aes(x = class5, y = isei_avg))+
  geom_boxplot(outlier.shape = NA)+
  stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="red", fill="red")+
  ylim(25, 75) +
  facet_wrap(.~country2, scales = "free")+ 
  scale_x_discrete(labels=c("I+II","IIIa+b","IVa+b+c","V+VI","VIIa+b"))+
  ggtitle(sjlabelled::get_label(df1$isei_avg))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

df1 %>% 
  # filter(!is.na(class5)) %>% 
ggplot(aes(x = class5, y = hindex_10))+
  geom_boxplot(outlier.shape = NA)+
  stat_summary(fun.y=mean, geom="point", shape=20, size=2, color="red", fill="red")+
  ylim(0, 1) +
  facet_wrap(.~country2, scales = "free")+ 
  scale_x_discrete(labels=c("I+II","IIIa+b","IVa+b+c","V+VI","VIIa+b"))+
  ggtitle(sjlabelled::get_label(df1$hindex_10))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

df1 %>% 
  filter(!is.na(class6)) %>% 
ggplot(aes(x = class6, y = hindex_10))+
  geom_boxplot(outlier.shape = NA)+
  facet_wrap(.~country2, scales = "free")+ 
  scale_x_discrete(labels=c("I","II","IIIa+b","IVa+b+c","V+VI","VIIa+b"))+
  ggtitle(sjlabelled::get_label(df1$hindex_10))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

levels(df1$class5)
```

# macro correlations

```{r}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,sjmisc,ggplot2,haven)
load(here::here("input/data/proc/study1_country.RData"))
df2$country2 <- countrycode::countrycode(sourcevar = df2$country,origin = "iso3n",destination = "country.name")
df2$country3 <- countrycode::countrycode(sourcevar = df2$country,origin = "iso3n",destination = "iso3c")
df2 <- bind_cols(df2,sjmisc::to_dummy(x = df2$class3,suffix = "numeric"))

macro_data <- df2 %>%
  group_by(country2,country3) %>%
  summarise_at(c("redist","homclass","pi_isola","tr_courts","tr_inte","gini_disp","gini_mkt",
                 "class3_1","class3_2","class3_3","gv_spen"), mean, na.rm = TRUE) %>% 
  as.data.frame()

macro_data %>%  
ggplot(aes(y=redist, x=homclass)) +
  # geom_point() +
  geom_text(label=as.character(macro_data$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Class homogeneity")+
  ylab("Redistributive preferences") +
  labs(title = "Redistributive preferences and Class homogeneity",
       caption =paste("r=",round(cor(macro_data$homclass,
                                     macro_data$redist, use='complete.obs'),digits = 2)))

ggsave(plot = last_plot(),filename = "macro_homo_redist.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 20)

macro_data %>%  
ggplot(aes(y=redist, x=pi_isola)) +
  # geom_point() +
  geom_text(label=as.character(macro_data$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Perceived isolation")+
  ylab("Redistributive preferences") +
  labs(title = "Redistributive preferences and Perceived isolation",
       caption =paste("r=",round(cor(macro_data$pi_isola,
                                     macro_data$redist, use='complete.obs'),digits = 2)))

ggsave(plot = last_plot(),filename = "macro_pisol_redist.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 20)

macro_data %>%  
ggplot(aes(y=pi_isola, x=homclass)) +
  # geom_point() +
  geom_text(label=as.character(macro_data$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Class homogeneity")+
  ylab("Perceived isolation") +
  labs(title = "Perceived isolation and Class homogeneity",
       caption =paste("r=",round(cor(macro_data$homclass,
                                     macro_data$pi_isola),digits = 2)))
ggsave(plot = last_plot(),filename = "macro_homo_pisol.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 20)


macro_data %>%  
ggplot(aes(y=homclass, x=class3_3)) +
  # geom_point() +
  geom_text(label=as.character(macro_data$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Working class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Working class (%)",
       caption =paste("r=",round(cor(macro_data$homclass,
                                     macro_data$class3_3),digits = 2)))

ggsave(plot = last_plot(),filename = "macro_working_homo.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 20)

macro_data %>%  
ggplot(aes(y=homclass, x=class3_2)) +
  # geom_point() +
  geom_text(label=as.character(macro_data$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Intermediate class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Intermediate class (%)",
       caption =paste("r=",round(cor(macro_data$homclass,
                                     macro_data$class3_2),digits = 2)))

ggsave(plot = last_plot(),filename = "macro_middle_homo.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 20)

macro_data %>%  
ggplot(aes(y=homclass, x=class3_1)) +
  # geom_point() +
  geom_text(label=as.character(macro_data$country3)) +
  # scale_x_continuous(limits = c(0,1))+
  # scale_y_continuous(limits = c(1,5))+
  geom_smooth(method = "lm",fullrange=TRUE) +
  xlab("Service class (%)")+
  ylab("Class homogeneity") +
  labs(title = "Class homogeneity and Service class (%)",
       caption =paste("r=",round(cor(macro_data$homclass,
                                     macro_data$class3_1),digits = 2)))

ggsave(plot = last_plot(),filename = "macro_service_homo.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 20)

```





# Check on homogeneity

```{r}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,haven,sjmisc,GGally,ggplot2)
load(here::here("input/data/proc/study1_country.RData"))

test <- df2

frq(df2$class11d)

test$egp3_v1 <- car::recode(test$class11d,"1:2=1;c(3,4,5,6)=2;7:10=3",as.factor = T,levels = c(1,2,3))
test$egp3_v2 <- car::recode(test$digclass11d,"1:2=1;c(3,4,5,6)=2;7:10=3",as.factor = T,levels = c(1,2,3))
test$egp3_v3 <- car::recode(test$dclass11d,"1:2=1;c(3,4,5,6)=2;7:10=3",as.factor = T,levels = c(1,2,3))

frq(test$egp3_v1)
frq(test$egp3_v2)
frq(test$egp3_v3)
frq(test$class3)

test$ingroup1 <- NA 
test$ingroup1 <- ifelse(test$egp3_v1==1,test$n_high,test$ingroup1)
test$ingroup1 <- ifelse(test$egp3_v1==2,test$n_middle,test$ingroup1)
test$ingroup1 <- ifelse(test$egp3_v1==3,test$n_low,test$ingroup1)

test$ingroup2 <- NA 
test$ingroup2 <- ifelse(test$egp3_v2==1,test$n_high,test$ingroup2)
test$ingroup2 <- ifelse(test$egp3_v2==2,test$n_middle,test$ingroup2)
test$ingroup2 <- ifelse(test$egp3_v2==3,test$n_low,test$ingroup2)

test$ingroup3 <- NA 
test$ingroup3 <- ifelse(test$egp3_v3==1,test$n_high,test$ingroup2)
test$ingroup3 <- ifelse(test$egp3_v3==2,test$n_middle,test$ingroup2)
test$ingroup3 <- ifelse(test$egp3_v3==3,test$n_low,test$ingroup2)

test$homclass_v1 <- as.numeric(test$ingroup1/test$know_total)

test$homclass_v2 <- as.numeric(test$ingroup2/test$know_total)

test$homclass_v3 <- as.numeric(test$ingroup3/test$know_total)

sjPlot::plot_frq(test$homclass_v1,type = "density")
sjPlot::plot_frq(test$homclass_v2,type = "density")
sjPlot::plot_frq(test$homclass_v3,type = "density")
sjPlot::plot_frq(df2$homclass)
```

```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal,texreg)  
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- test %>% dplyr::select(
                        class3=class6,
                        homclass=homclass,
                        Q03pcm,
                        edyears,
                        female,
                        agenum,
                        union,
                        workst,
                        WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt",
                        rgdpna,
                        oecd,
                        country2,country
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         edyears2=edyears^2,
         age2=agenum^2) %>%
  na.omit()

# Models 
base <- lmer(homclass~1 + (1|country2),data=dfreg,weights = WEIGHT); icc1<- performance::icc(base)
homclass<- update(base, . ~ . +class3)
full1 <- update(homclass, . ~ . + female+agenum+age2)
rob1 <- update(full1, . ~ . + class3+edyears+ Q03pcm+union+workst)
rob2 <- update(rob1, . ~ . -(1|country2) + (homclass|country2))
# anova(rob1,rob2)
# Interactions segregation x class
int_homo <- update(rob1, . ~ . +class3*homclass)

models <- list(homclass,full1,rob1,int_homo)
knitreg(list(homclass,full1,rob1))
```


