---
title: "Data preparation"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output: 
  html_document: 
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
      number_sections: yes
    code_folding: show  
    number_sections: yes
editor_options: 
  chunk_output_type: console
---

# Setup

```{r setup}
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      echo = TRUE 
                      )
options(scipen=9999) # desactivar notacion cientifica
if (!require("pacman")) install.packages("pacman") # instalar pacman
load(here::here("input/data/proc/study1.RData"))
pacman::p_load(dplyr,sjmisc,sjPlot,sjlabelled,tidyverse,haven,MLMusingR)
```

# Country level

```{r}
countries <- 
df1 %>% 
  group_by(country) %>% 
  summarise(n=n())
countries$ccode <- as.numeric(countries$country)
countries$countryname <- as_character(countries$country)
```


Revisar:

https://wid.world/codes-dictionary#post-tax-income

```{r}
wid_gini <- haven::read_dta(here::here("input/data/original/wid_gini.dta"))
wid_ratios <- haven::read_dta(here::here("input/data/original/wid_ratios.dta"))
wid_shares <- haven::read_dta(here::here("input/data/original/wid_shares.dta"))
# wid_gini_2018 <- wid_gini %>% filter(year==2018)
# wid_gini_2018$year[wid_gini_2018$year==2018] <- 2016
# wid_gini_2018$country_yr <- stringi::stri_replace_all(str = wid_gini_2018$country_yr,replacement = "2016",regex = "2018")

wid_df <-wid_ratios  %>% 
  dplyr::left_join(wid_shares,by="country_yr") %>% 
  dplyr::left_join(wid_gini,by="country_yr") 

names(wid_df)
# summary(wid_df)
wid_df <- 
wid_df %>% 
  dplyr::select(country=country.x,year=year.x,country_yr,starts_with("wid_"))

wid_df$ccode <- countrycode::countrycode(sourcevar = wid_df$country,origin = "iso2c",destination = "iso3n")

summary(wid_df)
wid_df_fill<- 
wid_df %>%
  group_by(country) %>% 
  fill(wid_p90p10, .direction = "up") %>%
  fill(wid_sp90p10, .direction = "up") %>%
  fill(wid_gini_disp, .direction = "up")
summary(wid_df_fill)
  
wid_df1 <- wid_df_fill %>% filter(year==2017) %>% select(ccode,starts_with("wid_"))
wid_df1$country <- NULL
sjPlot::tab_corr(wid_df1)
```


**World Income Inequality Database (WIID)** 

> UNU-WIDER, World Income Inequality Database (WIID) Companion dataset (wiidcountry and/or wiidglobal). Version 30 June 2022. https://doi.org/10.35188/UNU-WIDER/WIIDcomp-300622

```{r , eval=FALSE, include=FALSE}
wiid_long<- haven::read_dta(here::here("input/data/original/WIID_30JUN2022_0/WIID_30JUN2022_0.dta"))
wiid_long$ccode <- countrycode::countrycode(sourcevar = wiid_long$c3,origin = "iso3c",destination = "iso3n")

wiid_long1 <- 
wiid_long %>% 
  filter(ccode %in% countries$ccode) %>% 
  filter(year==2017)
```

```{r}
wiid <- 
  read.csv(file = here::here("input/data/original/wid-percentiles/wiid-data-2015-2020.csv"),sep = ";")
names(wiid) <- tolower(names(wiid))
names(wiid) <- gsub('\\.', '', names(wiid))
wiid$ccode <- countrycode::countrycode(sourcevar = wiid$iso,origin = "iso3c",destination = "iso3n")

wiid_d10d01 <- 
  read.csv(file = here::here("input/data/original/wid-percentiles/wiid-data-D10D01-ratio.csv"),sep = ";")

names(wiid_d10d01) <- tolower(names(wiid_d10d01))
names(wiid_d10d01) <- gsub('\\.', '', names(wiid_d10d01))
wiid_d10d01$ccode <- countrycode::countrycode(sourcevar = wiid_d10d01$iso,origin = "iso3c",destination = "iso3n")
wiid_d10d01 <- 
  wiid_d10d01 %>%  
  filter(ccode %in% countries$ccode) %>% 
  filter(year==2017) %>% 
  select(ccode,everything(),-iso,-country,-year,-giniindex) 

wiid_s80s10 <- 
  read.csv(file = here::here("input/data/original/wid-percentiles/wiid-data-P80P20.csv"),sep = ";")
names(wiid_s80s10) <- tolower(names(wiid_s80s10))
names(wiid_s80s10) <- gsub('\\.', '', names(wiid_s80s10))
wiid_s80s10$ccode <- countrycode::countrycode(sourcevar = wiid_s80s10$iso,origin = "iso3c",destination = "iso3n")

wiid_s80s10 <- 
  wiid_s80s10 %>%  
  filter(ccode %in% countries$ccode) %>% 
  filter(year==2017) %>% 
  select(ccode,everything(),-iso,-country,-year,-giniindex) 

wiid_2017 <- 
wiid %>% 
  filter(ccode %in% countries$ccode) %>% 
  filter(year==2017) %>% 
  select(ccode,everything(),-iso,-country,-year) %>% 
  left_join(wiid_d10d01,by="ccode") %>% 
  left_join(wiid_s80s10,by="ccode")
```



**Solt SWDIID**

```{r Solt}
load(file = here::here("input/data/original/swiid9_5/swiid9_5.rda"))
solt <- 
swiid_summary %>% dplyr::select(country,year,gini_disp,gini_mkt,abs_red,rel_red) %>% dplyr::filter(year %in% c(2016))
summary(solt)
solt$ccode <- countrycode::countrycode(sourcevar = solt$country,origin = "country.name",destination = "iso3n")
solt$country <- NULL
solt_2017 <-  solt %>% filter(ccode %in% countries$ccode) %>% 
  dplyr::select(ccode,gini_disp,gini_mkt)

solt_2017$abs_red <- solt_2017$gini_mkt - solt_2017$gini_disp 
solt_2017$rel_red <- solt_2017$abs_red/solt_2017$gini_mkt
summary(solt_2017)
```

**Otero et.al (2023)**

```{r otero23}
otero <- 
  read.csv(file = here::here("input/data/original/otero23.csv"),sep = ";")
otero$ccode <- countrycode::countrycode(sourcevar = otero$iso3n,origin = "iso2c",destination = "iso3n")
otero$gdp <- gsub('\\,', '',otero$gdp) 
otero<- otero %>% select(ccode,gv_spen,individualism)
```

**ILO Data**

```{r}
ilo_data <- read.csv(file = here::here("input/data/original/ILO-data/WEOApr2022all.csv"))
frq(ilo_data$Subject.Descriptor)

ilo_data_1 <- ilo_data %>% filter(Subject.Descriptor %in% c("General government total expenditure","General government revenue"), Units == "Percent of GDP")
ilo_data_1$ccode <- countrycode::countrycode(sourcevar = ilo_data_1$ISO,origin = "iso3c",destination = "iso3n") 
ilo_data_1<- ilo_data_1 %>% filter(ccode %in% countries$ccode)
ilo_data_1 <- ilo_data_1 %>% select(ccode,WEO.Country.Code:Country.Series.specific.Notes,X2010:X2020)
names(ilo_data_1) <- tolower(names(ilo_data_1))
names(ilo_data_1) <- str_replace_all(string = names(ilo_data_1),pattern = "x",replacement = "Y_")

ilo_tax <- ilo_data_1 %>% filter(weo.subject.code=="GGR_NGDP") 
ilo_spe <- ilo_data_1 %>% filter(weo.subject.code=="GGX_NGDP") 
# Example wide format data

# Convert from wide to long format
long_ilo_tax <- ilo_tax %>%
  select(ccode,Y_2010:Y_2016) %>% 
  pivot_longer(cols = starts_with("Y_"),
               names_to = "year",
               names_prefix = "Y_",
               values_to = "ilo_taxrev")
long_ilo_tax$ilo_taxrev <- as.numeric(long_ilo_tax$ilo_taxrev)

long_ilo_spe <- ilo_spe %>%
  select(ccode,Y_2010:Y_2016) %>% 
  pivot_longer(cols = starts_with("Y_"),
               names_to = "year",
               names_prefix = "Y_",
               values_to = "ilo_govspe")

long_ilo_spe$ilo_govspe <- as.numeric(long_ilo_spe$ilo_govspe)

ilo_df <- left_join(long_ilo_tax,long_ilo_spe) %>% filter(year==2016)

# long_ilo_spe$country <- countrycode::countrycode(sourcevar = long_ilo_spe$ccode,origin = "iso3n",destination = "iso3c") 

# Plot points connected by a line representing time
# ggplot(long_ilo_spe, aes(x = factor(year), y = govspe, group = factor(country), color = factor(country))) +
#   geom_line() +
#   geom_point(size = 3) +
#   labs(title = "Points Connected by a Line Representing Time", x = "Year", y = "Value") +
#   # scale_x_discrete(labels = c("2016", "2017", "2018")) +
#   theme_minimal()
# 
# 
# # Plot points connected by a line representing time
# ggplot(long_ilo_tax, aes(x = factor(year), y = taxrev, group = factor(country), color = factor(country))) +
#   geom_line() +
#   geom_point(size = 3) +
#   labs(title = "Points Connected by a Line Representing Time", x = "Year", y = "Value") +
#   # scale_x_discrete(labels = c("2016", "2017", "2018")) +
#   theme_minimal()

```



**GDP: PEN data**
```{r pen-data}
pendata<- haven::read_dta(file = here::here("input/data/original/pen-world/pwt1001.dta"))
pendata$ccode <- countrycode::countrycode(sourcevar = pendata$countrycode,origin = "iso3c",destination = "iso3n")
pen_2017 <- pendata %>% filter(ccode %in% countries$ccode,year %in% 2017) %>% select(ccode,everything(),-country,-countrycode,-currency_unit,-year)
```

*OCDE data*
```{r ocde}
ocde<- 
  read.csv(file = here::here("input/data/original/ocde-countries.csv"),sep = ",")

ocde$ccode <- countrycode::countrycode(sourcevar = ocde$iso3n,origin = "iso3c",destination = "iso3n")
ocde <- ocde[,c("ccode","oecd")]
```


```{r merge}
macro_data <- 
  left_join(wiid_2017,solt_2017) %>%
  left_join(pen_2017) %>% 
  left_join(otero) %>%
  left_join(ocde) %>% 
  left_join(wid_df1) %>% 
  left_join(ilo_df)

save(macro_data,file = here::here("input/data/proc/study1_macro_data.RData"))

df1$ccode <- as.numeric(df1$country)
df2 <- left_join(df1,macro_data,by="ccode")
df2 <- 
df2 %>% mutate(country2=countrycode::countrycode(sourcevar = ccode,origin = "iso3n",destination = "iso3c"),
               country3=countrycode::countrycode(sourcevar = ccode,origin = "iso3n",destination = "country.name"),
               region=countrycode::countrycode(sourcevar = ccode,origin = "iso3n",destination = "region23")) %>% 
  select(ccode,country2,country3,everything())
```

# Class inequality 

```{r}
summary(df1$incomepcap)

df_class3_ineq <- 
df2 %>%   
  group_by(country2,dclass3res_V) %>%
  summarise_at(c("incomepcap","ednum","wid_gini_disp"), mean, na.rm = TRUE) %>% 
  as.data.frame() %>%
  na.omit() %>% 
  dplyr::select(country2,dclass3res_V,incomepcap,ednum,wid_gini_disp) %>% 
  tidyr::pivot_wider(names_from = "dclass3res_V", values_from = c("incomepcap","ednum")) %>% 
  mutate(ratio_class_inc = `incomepcap_Service Class (I+II)`/`incomepcap_Working Class (V+VI+VII)`,
         ratio_class_educ  = `ednum_Service Class (I+II)`/`ednum_Working Class (V+VI+VII)`) %>% 
  as.data.frame() 

df_class3_ineq %>% select(wid_gini_disp,ratio_class_inc,ratio_class_educ) %>% tab_corr()

df_class6_ineq <- 
df2 %>%   
  group_by(country2,dclass6res) %>%
  summarise_at(c("incomepcap","ednum","wid_gini_disp"), mean, na.rm = TRUE) %>% 
  as.data.frame() %>%
  na.omit() %>% 
  dplyr::select(country2,dclass6res,incomepcap,ednum,wid_gini_disp) %>% 
  tidyr::pivot_wider(names_from = "dclass6res", values_from = c("incomepcap","ednum")) %>% 
  mutate(ratio_class_inc = `incomepcap_Upper Service class`/`incomepcap_Unskilled working class`,
         ratio_class_educ  = `ednum_Upper Service class`/`ednum_Unskilled working class`) %>% 
  as.data.frame() 
df_class_ineq %>% select(wid_gini_disp,ratio_class_inc,ratio_class_educ) %>% tab_corr()
```

```{r}

income_data

# Example data
# Assuming you have a data frame called 'income_data' with columns: country, social_class, and average_income

# Calculate all pairs of income ratios within each country
income_ratios <- income_data %>%
  group_by(country) %>%
  mutate(income_ratio = combn(average_income, 2, FUN = function(x) x[1] / x[2])) %>%
  ungroup()

# Print the result
print(income_ratios)



```


```{r save}
save(df2,file = here::here("input/data/proc/study1_country.RData"))
# haven::write_dta(data = df2,path = here::here("input/data/proc/study1_country.dta"))
sjPlot::view_df(df2,file =here::here("input/data/proc/codebook-s1.html") )
```
