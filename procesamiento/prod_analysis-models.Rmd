---
title: "Multilevel regression models"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output: 
  html_document: 
    toc: yes
    code_folding: hide
    toc_float: 
      collapsed: true
      smooth_scroll: false
      number_sections: true
editor_options: 
  chunk_output_type: console
---

- mantener clase RÂ´s y calcular homogeneidad
- mantener clase de Partner a parte como un control


```{r setup}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
options(scipen=9999) # desactivar notacion cientifica
```

# Modelos

dicotomizar homogeneidad en 1=50% similar,49% similar

## Ordinal

```{r mod-homclass,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass,
                        Q03pcm,
                        edyears,
                        female,
                        agenum,
                        union,
                        workst,
                        WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt",
                        rgdpna,
                        oecd,
                        country2,country
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         edyears2=edyears^2,
         age2=agenum^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("JPN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("PHL")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(!country2 %in% c("MEX")) %>%
# filter(!country2 %in% c("HUN")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(!region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
    # filter(oecd=="OECD") %>%
  na.omit()

# Models 
base <- clmm(factor(redist)~1 + (1|country2),data=dfreg,weights = WEIGHT); icc1<- performance::icc(base)
homclass<- update(base, . ~ . +homclass)
full1 <- update(homclass, . ~ . + class3+female+agenum+age2)
rob1 <- update(full1, . ~ . + class3+edyears+ Q03pcm+union+workst)
rob2 <- update(rob1, . ~ . -(1|country2) + (homclass|country2),nAGQ = 5L)
anova(rob1,rob2)
# Interactions segregation x class
int_homo <- update(rob1, . ~ . +class3*homclass)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Intermediate class (III+IV)' ='Intermediate Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                 "workstNot in paid work"="Not in labor force",
                 "unionYes" = 'Union membership: Yes',
                 'homclass:class3Intermediate class (III+IV)'='Homogeneity x Intermediate Class',
                 'homclass:class3Working Class (V+VI+VII)'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Service Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","Yes","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA,NA)

models <- list(homclass,full1,rob1,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                                float.pos="h!",
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r mod-intermacro,results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjlabelled,haven,stringr,sjPlot,ordinal)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass,
                        Q03pcm,
                        edyears,
                        female,
                        agenum,
                        union,
                        workst,
                        WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt",
                        rgdpna,
                        oecd,
                        country2,country
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         edyears2=edyears^2,
         age2=agenum^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("JPN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("PHL")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(!country2 %in% c("MEX")) %>%
# filter(!country2 %in% c("HUN")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(!region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
    # filter(oecd=="OECD") %>%
  na.omit()
# T03dim(dfreg)

main <- "redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2)"
base <- clmm(formula(main),data=dfreg,weights = WEIGHT)
giniD_gdp<- update(base, . ~ . +gini_disp+logrgdpna)
giniD_rs <- update(giniD_gdp, . ~ . - (1|country2) + (homclass|country2))
# anova(giniD_gdp,giniD_rs)
giniD_int<- update(giniD_rs, . ~ . + homclass*gini_disp + (homclass|country2))
# summary(giniD_int)

giniM_gdp<- update(base, . ~ . +gini_mkt+logrgdpna)
giniM_rs <- update(giniM_gdp, . ~ . - (1|country2) + (homclass|country2))
# anova(giniM_gdp,giniM_rs)
giniM_int <- update(giniM_rs, . ~ . + homclass*gini_mkt + (homclass|country2))
summary(giniM_int)
models <- list(giniD_gdp,giniD_rs,giniD_int,
               giniM_gdp,giniM_rs,giniM_int)

texreg::knitreg(models,
                caption=paste("(\\#tab:modinter1)","Cross-level interaction for Network homogeneity and Economic Inequality"),
                caption.above=T,float.pos="h!",
                # include.thresholds=FALSE,
                custom.coef.map=list(homclass="Network Homogeneity",
                                     logrgdpna="log GDP","gini_disp"="Gini (Disposable) ",
                                     "homclass:gini_disp"="Homogeneity x Gini (D)",
                                     "gini_mkt"="Gini (Market) ",
                                     "homclass:gini_mkt"="Homogeneity x Gini (M)"),
                  # groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```






## Gov's spending and individualism

```{r mod-spend-indv, results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass=homclass_gc,
                        # homclass=homclass_res,
                        Q05pcm,
                        Q03pcm,
                        gini_disp,
                        gini_mkt,
                        giniot=gini,
                        giniindex,ttheilge1,
                        gv_spen=gv_spen,
                        top10,
                        middle50,
                        palmaratio,
                        d10d1,
                        rgdpna,
                        individualism,
                        edyears,
                        female,
                        agenum,
                        country2,
                        union,
                        workst
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         age2=agenum^2,
         edyears2=edyears^2) %>%
    # filter(!country2 %in% c("Turkey","Estonia")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>%
   na.omit()
int_indivi<- lmer(redist~class3+ homclass*individualism+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna + (1+homclass|country2),data=dfreg)
int_govspe<- lmer(redist~class3+ homclass*gv_spen+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+logrgdpna + (1+homclass|country2),data=dfreg)
models_m <- list(int_indivi,int_govspe)
cap1=c("Cross-level interaction for Network homogeneity, Goverment Spending and Individualism")
customcoef <- 
list(homclass = "Class-based network homogeneity",
  logrgdpna           = "log GDP",
  individualism         = "Individualism Index*",
  "homclass:individualism" = "Homogeneity x Individualism",
  gv_spen               = "Gov. Spending (% GDP)*",
  "homclass:gv_spen"      = "Homogeneity x Gov. Spend."
)
texreg::knitreg(models_m,scalebox = 1,
                float.pos="h!",                
                custom.coef.map = customcoef,
                caption.above = T,caption = cap1)
```

```{r homclass-spend-indv, fig.height=6,fig.width=8,fig.cap=c("Cross-level interaction for Network homogeneity, Gov. Spending and Individualism"),out.width='100%',}
p8<- interplot::interplot(m = int_indivi,var1 = "homclass",var2="individualism") +
  xlab("Individualism Index*") + geom_point()+ geom_hline(yintercept = 0)+
  labs(caption = paste0("N=",nobs(int_indivi),", Countries=",lme4::ngrps(int_indivi)))  

predval8 <- 
plot_predictions(int_indivi, condition = list("homclass",individualism=range),gray = F) +
  labs(caption = paste0("N=",nobs(int_indivi),", Countries=",lme4::ngrps(int_indivi)),
       linetype='Individualism') +
  xlab("Class-based homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")


p9<- interplot::interplot(m = int_govspe,var1 = "homclass",var2="gv_spen") +
  xlab("Gov. Spending (% GDP)*") + geom_point()+ geom_hline(yintercept = 0)+
  labs(caption = paste0("N=",nobs(int_govspe),", Countries=",lme4::ngrps(int_govspe)))

predval9 <- 
plot_predictions(int_govspe, condition = list("homclass",gv_spen=range),gray = F) +
  labs(caption = paste0("N=",nobs(int_govspe),", Countries=",lme4::ngrps(int_govspe)),
       linetype='Gov.Spend') +
  xlab("Class-based homogeneity")+
  ylab("Redistributive preferences") +
  theme(legend.position = "right")

grid.arrange(p9,predval9,
             p8,predval8,nrow = 2)
```


