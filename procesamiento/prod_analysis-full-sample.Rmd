---
title: "Multilevel regression models"
subtitle: "Full sample"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output: 
  html_document: 
    toc: yes
    code_folding: hide
    toc_float: 
      collapsed: true
      smooth_scroll: false
      number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
options(scipen=9999) # desactivar notacion cientifica
```

# Modelos

dicotomizar homogeneidad en 1=50% similar,49% similar

# Ordinal

```{r mod-homclass-ordinal,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
dfreg <- df1 %>% dplyr::select(redist,
                        class3,
                        homclass,
                        Q03pcm,
                        edyears,
                        female,
                        agenum,
                        union,
                        workst,
                        WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt",
                        rgdpna,
                        oecd,
                        country2,country
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         edyears2=edyears^2,
         age2=agenum^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("JPN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("PHL")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(!country2 %in% c("MEX")) %>%
# filter(!country2 %in% c("HUN")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(!region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
    # filter(oecd=="OECD") %>%
  na.omit()

# Models 
base <- clmm(factor(redist)~1 + (1|country2),data=dfreg,weights = WEIGHT); icc1<- performance::icc(base)
homclass<- update(base, . ~ . +homclass)
full1 <- update(homclass, . ~ . + class3+female+agenum+age2)
rob1 <- update(full1, . ~ . + edyears+ Q03pcm+union+workst)
rob2 <- update(rob1, . ~ . -(1|country2) + (homclass|country2))
anova(rob1,rob2)
# Interactions segregation x class
int_homo <- update(rob1, . ~ . +class3*homclass)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Intermediate class (III+IV)' ='Intermediate Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                 "workstNot in paid work"="Not in labor force",
                 "unionYes" = 'Union membership: Yes',
                 'homclass:class3Intermediate class (III+IV)'='Homogeneity x Intermediate Class',
                 'homclass:class3Working Class (V+VI+VII)'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Service Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","Yes","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA,NA)

models <- list(homclass,full1,rob1,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                                float.pos="h!",
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r mod-intermacro-ordinal,results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjlabelled,haven,stringr,sjPlot,ordinal,brms)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$redistF <- as.factor(df1$redist)
dfreg <- df1 %>% dplyr::select(redist=redistF,
                        class3,
                        homclass,
                        Q03pcm,
                        edyears,
                        female,
                        agenum,
                        union,
                        workst,
                        WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt",
                        rgdpna,
                        oecd,
                        country2,country
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         edyears2=edyears^2,
         age2=agenum^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("JPN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("PHL")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(!country2 %in% c("MEX")) %>%
# filter(!country2 %in% c("HUN")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(!region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
    # filter(oecd=="OECD") %>%
  na.omit()
# T03dim(dfreg)

main <- "redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2)"
base <- clmm(formula(main),data=dfreg,weights = WEIGHT,Hess = T)
giniD_gdp<- update(base, . ~ . +gini_disp+logrgdpna)
giniD_rs <- update(giniD_gdp, . ~ . - (1|country2) + (homclass|country2))
# anova(giniD_gdp,giniD_rs)
giniD_int<- update(giniD_rs, . ~ . + homclass*gini_disp + (homclass|country2))
# summary(giniD_int)

giniM_gdp<- update(base, . ~ . +gini_mkt+logrgdpna)
giniM_rs <- update(giniM_gdp, . ~ . - (1|country2) + (homclass|country2))
# anova(giniM_gdp,giniM_rs)
giniM_int <- update(giniM_rs, . ~ . + homclass*gini_mkt + (homclass|country2))
summary(giniM_int)
models <- list(giniD_gdp,giniD_rs,giniD_int,
               giniM_gdp,giniM_rs,giniM_int)

texreg::knitreg(models,
                caption=paste("(\\#tab:modinter1)","Cross-level interaction for Network homogeneity and Economic Inequality"),
                caption.above=T,float.pos="h!",
                # include.thresholds=FALSE,
                custom.coef.map=list(homclass="Network Homogeneity",
                                     logrgdpna="log GDP","gini_disp"="Gini (Disposable) ",
                                     "homclass:gini_disp"="Homogeneity x Gini (D)",
                                     "gini_mkt"="Gini (Market) ",
                                     "homclass:gini_mkt"="Homogeneity x Gini (M)"),
                  # groups = coefgroup,
                  # custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r mod-other-macro-ordinal,fig.height=3,fig.width=6,out.width='70%',results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$redistF <- as.factor(df1$redist)
dfreg <- df1 %>% dplyr::select(redist=redistF,
                        class3,
                        homclass,
                        Q03pcm,
                        edyears,
                        female,
                        agenum,
                        union,
                        workst,
                        WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt",
                        rgdpna,
                        oecd,
                        country2,country,
                        palmaratio,
                        top10,
                        middle50,
                        d10d1,
                        giniindex,
                        ttheilge1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         edyears2=edyears^2,
         age2=agenum^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("JPN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("PHL")) %>%
  # filter(!country2 %in% c("THA")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(!country2 %in% c("MEX")) %>%
# filter(!country2 %in% c("HUN")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(!region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
    # filter(oecd=="OECD") %>%
  na.omit()


main <- "redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ logrgdpna +(homclass|country2)"
base <- clmm(formula(main),data=dfreg,weights = WEIGHT)
int_palma <- update(base, . ~ . +homclass*palmaratio)
int_pc10  <- update(base, . ~ . +homclass*top10)
int_pc50  <- update(base, . ~ . +homclass*middle50)
int_d10d1 <- update(base, . ~ . +homclass*d10d1)
int_gini_wiid <- update(base, . ~ . +homclass*giniindex)
int_theil  <- update(base, . ~ . +homclass*ttheilge1)

models_m <- list(int_palma,int_pc10,int_pc50,int_d10d1,
                 int_gini_wiid,int_theil
                 )

cap1=c("Cross-level interaction for Network homogeneity and Economic Inequality")
customcoef <- 
list(homclass = "Class-based network homogeneity",
  logrgdpna           = "log GDP",
  palmaratio               = "Palma Ratio",
  "homclass:palmawd"      = "Homogeneity x Palma Ratio",
  top10             = "Share National Income - top 10%",
  "homclass:top10"    = "Homogeneity x top 10",
  middle50             = "Share National Income -  bottom 50%",
  "homclass:middle50"    = "Homogeneity x bottom 50",
  # individualism         = "Individualism Index*",
  # "homclass:individualism" = "Homogeneity x Individualism",
  # gv_spen               = "Gov. Spending (% GDP)*",
  # "homclass:gv_spen"      = "Homogeneity x Gov. Spend.",
    d10d1             = "Ratio D10/D01",
  "homclass:d10d1"    = "Homogeneity x Ratio D10/D01"  
)
texreg::knitreg(models_m,scalebox = 0.75,
                float.pos="h!",                
                # custom.coef.map = customcoef,
                caption.above = T,caption = cap1)
```

# Binary logit 

```{r mod-homclass-binary,results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,marginaleffects,sjlabelled,haven,stringr,ordinal)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$redistB <- car::recode(df1$redist,"4:5=1;1:3=0",as.factor = T)
dfreg <- df1 %>% dplyr::select(redist=redistB,
                        class3,
                        homclass,
                        Q03pcm,
                        edyears,
                        female,
                        agenum,
                        union,
                        workst,
                        WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt",
                        rgdpna,
                        oecd,
                        country2,country
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         edyears2=edyears^2,
         age2=agenum^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("JPN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("PHL")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(!country2 %in% c("MEX")) %>%
# filter(!country2 %in% c("HUN")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(!region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
    # filter(oecd=="OECD") %>%
  na.omit()

# Models 
base <- glmer(redist~1 + (1|country2),data=dfreg,weights = WEIGHT,family = "binomial"); icc1<- performance::icc(base)
homclass<- update(base, . ~ . +homclass)
full1 <- update(homclass, . ~ . + class3+female+agenum+age2)
rob1 <- update(full1, . ~ . + class3+edyears+ Q03pcm+union+workst)
rob2 <- update(rob1, . ~ . -(1|country2) + (homclass|country2),nAGQ = 5L)
# anova(rob1,rob2)
# Interactions segregation x class
int_homo <- update(rob1, . ~ . +class3*homclass)

cap1 <- "Multilevel regression for redistributive preferences, network homogeneity and social class" 
coefmap <-  list(homclass ="Class-based network homogeneity",
                 'class3Intermediate class (III+IV)' ='Intermediate Class',
                 'class3Working Class (V+VI+VII)' ='Working Class',
                 "Q03pcmT02" = "Middle",
                 "Q03pcmT03" = "High",
                 "edyears" = 'Education in years',
                 "workstNot in paid work"="Not in labor force",
                 "unionYes" = 'Union membership: Yes',
                 'homclass:class3Intermediate class (III+IV)'='Homogeneity x Intermediate Class',
                 'homclass:class3Working Class (V+VI+VII)'='Homogeneity x Working Class'
                 )
coefgroup <- list("Social Class (ref: Service Class)"=2:3,
                  "Income Tercile (ref: Low)"=4:5,
                  "Homogeneity x Social Class"=9:10
                  )
gofrow <-  list(Controls=c("No","Yes","Yes","Yes"))
gof1<-  c(NA,NA,"Num. Countries:","Var: Group",NA,NA)

models <- list(homclass,full1,rob1,int_homo)
texreg::knitreg(models,caption=paste("(\\#tab:modredist)",cap1),caption.above=T,
                                float.pos="h!",
                  include.thresholds=FALSE,
                  custom.coef.map=coefmap,
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  # custom.gof.names = gof1
                )
```

```{r mod-intermacro-binary,results='asis'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjlabelled,haven,stringr,sjPlot,ordinal,brms)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$redistB <- car::recode(df1$redist,"4:5=1;1:3=0",as.factor = T)
dfreg <- df1 %>% dplyr::select(redist=redistB,
                        class3,
                        homclass,
                        Q03pcm,
                        edyears,
                        female,
                        agenum,
                        union,
                        workst,
                        WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt",
                        rgdpna,
                        oecd,
                        country2,country
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         edyears2=edyears^2,
         age2=agenum^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("JPN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("PHL")) %>%
  # filter(!country2 %in% c("FIN")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(!country2 %in% c("MEX")) %>%
# filter(!country2 %in% c("HUN")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(!region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
    # filter(oecd=="OECD") %>%
  na.omit()
# T03dim(dfreg)

main <- "redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ (1|country2)"
base <- glmer(formula(main),data=dfreg,weights = WEIGHT,family = "binomial")
giniD_gdp<- update(base, . ~ . +gini_disp+logrgdpna)
giniD_rs <- update(giniD_gdp, . ~ . - (1|country2) + (homclass|country2))
# anova(giniD_gdp,giniD_rs)
giniD_int<- update(giniD_rs, . ~ . + homclass*gini_disp + (homclass|country2))
summary(giniD_int)

giniM_gdp<- update(base, . ~ . +gini_mkt+logrgdpna)
giniM_rs <- update(giniM_gdp, . ~ . - (1|country2) + (homclass|country2))
# anova(giniM_gdp,giniM_rs)
giniM_int <- update(giniM_rs, . ~ . + homclass*gini_mkt + (homclass|country2))
summary(giniM_int)
models <- list(giniD_gdp,giniD_rs,giniD_int,
               giniM_gdp,giniM_rs,giniM_int)

texreg::knitreg(models,
                caption=paste("(\\#tab:modinter1)","Cross-level interaction for Network homogeneity and Economic Inequality"),
                caption.above=T,float.pos="h!",
                include.thresholds=FALSE,
                custom.coef.map=list(homclass="Network Homogeneity",
                                     logrgdpna="log GDP","gini_disp"="Gini (Disposable) ",
                                     "homclass:gini_disp"="Homogeneity x Gini (D)",
                                     "gini_mkt"="Gini (Market) ",
                                     "homclass:gini_mkt"="Homogeneity x Gini (M)"),
                  groups = coefgroup,
                  custom.gof.rows=gofrow,
                  include.loglik = FALSE,include.aic = FALSE,
                  custom.gof.names = gof1
                )
```

```{r mod-other-macro-binary,fig.height=3,fig.width=6,out.width='70%',results='asis', cache=T}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,sjmisc,ggplot2,interplot,sjPlot,sjlabelled,haven,stringr,gridExtra)  
rm(list=ls())
load(here::here("input/data/proc/study1_country.RData"));df1 <- df2
df1$redistB <- car::recode(df1$redist,"4:5=1;1:3=0",as.factor = T)
dfreg <- df1 %>% dplyr::select(redist=redistB,
                        class3,
                        homclass,
                        Q03pcm,
                        edyears,
                        female,
                        agenum,
                        union,
                        workst,
                        WEIGHT,
                        region,
                        "gini_disp",
                        "gini_mkt",
                        rgdpna,
                        oecd,
                        country2,country,
                        palmaratio,
                        top10,
                        middle50,
                        d10d1,
                        giniindex,
                        ttheilge1
                        ) %>% 
  mutate(logrgdpna=log(rgdpna),
         edyears2=edyears^2,
         age2=agenum^2) %>%
  # filter(!country2 %in% c("CHN")) %>%
  # filter(!country2 %in% c("TWN")) %>%
  # filter(!country2 %in% c("JPN")) %>%
  # filter(!country2 %in% c("ZAF")) %>%
  # filter(!country2 %in% c("PHL")) %>%
  # filter(!country2 %in% c("THA")) %>%
  # filter(!country2 %in% c("USA")) %>%
  # filter(!country2 %in% c("GBR")) %>%
  # filter(!country2 %in% c("ISL")) %>%
  # filter(!country2 %in% c("TUR","EST")) %>%
  # filter(!country2 %in% c("MEX")) %>%
# filter(!country2 %in% c("HUN")) %>%
  # filter(MAINSTAT %in% c(1,2)) %>%
  # filter(agenum %in% c(25:65)) %>% # Paskov & Weisstanner
  # filter(PARTLIV %in% c(0,1,2,3)) %>%
  # filter(!region %in% c("Northern America","South America")) %>%
  # filter(Q03pcm!="Missing") %>%
    # filter(oecd=="OECD") %>%
  na.omit()


main <- "redist~class3+ homclass+ edyears+ Q03pcm+ workst+ union+ female+agenum +age2+ logrgdpna +(homclass|country2)"
base <- glmer(formula(main),data=dfreg,weights = WEIGHT,family = "binomial")
int_palma <- update(base, . ~ . +homclass*palmaratio)
int_pc10  <- update(base, . ~ . +homclass*top10)
int_pc50  <- update(base, . ~ . +homclass*middle50)
int_d10d1 <- update(base, . ~ . +homclass*d10d1)
int_gini_wiid <- update(base, . ~ . +homclass*giniindex)
int_theil  <- update(base, . ~ . +homclass*ttheilge1)

models_m <- list(int_palma,int_pc10,int_pc50,int_d10d1,
                 int_gini_wiid,int_theil
                 )

cap1=c("Cross-level interaction for Network homogeneity and Economic Inequality")
customcoef <- 
list(homclass = "Class-based network homogeneity",
  logrgdpna           = "log GDP",
  palmaratio               = "Palma Ratio",
  "homclass:palmawd"      = "Homogeneity x Palma Ratio",
  top10             = "Share National Income - top 10%",
  "homclass:top10"    = "Homogeneity x top 10",
  middle50             = "Share National Income -  bottom 50%",
  "homclass:middle50"    = "Homogeneity x bottom 50",
  # individualism         = "Individualism Index*",
  # "homclass:individualism" = "Homogeneity x Individualism",
  # gv_spen               = "Gov. Spending (% GDP)*",
  # "homclass:gv_spen"      = "Homogeneity x Gov. Spend.",
    d10d1             = "Ratio D10/D01",
  "homclass:d10d1"    = "Homogeneity x Ratio D10/D01"  
)
texreg::knitreg(models_m,scalebox = 0.75,
                float.pos="h!",                
                # custom.coef.map = customcoef,
                caption.above = T,caption = cap1)
```
